<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8"></meta>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
        <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
        <meta name="description" content="MAGIC Web Mapping Home"></meta>
        <meta name="author" content="David Herbert, British Antarctic Survey"></meta>  
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <!-- default header name is X-CSRF-TOKEN -->
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        <link rel="icon" type="image/vnd.microsoft.icon" href="/bas.ico"></link>
        <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/bas.ico"></link>
        <title>MAGIC Web Mapping Home</title>

        <link href="/static/css/bootstrap.min.css" rel="stylesheet"></link>
        <link href="/static/css/nav.css" rel="stylesheet"></link>
        <link href="/static/css/font-awesome.min.css" rel="stylesheet" type="text/css"></link>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        <script src="/static/js/jquery.js"></script>        
        <script src="/static/js/bootstrap.min.js"></script>
        <script src="/static/js/bootbox.min.js"></script>
        <script src="/static/js/init.js"></script>
    </head>

    <body>
        <div id="wrapper">
            <div th:include="fragments/nav :: layout(strap='MAGIC Web Mapping Home')"></div>
            <div class="container">
                <div class="well well-sm">
                    <h3>Welcome to the MAGIC Web Mapping Centre</h3>            
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Select an action</h3>
                    </div>
                    <div class="panel-body">
                        <div th:switch="${#httpServletRequest.remoteUser}">
                            <div th:case="null">
                                <div class="alert alert-info">
                                    You are not currently logged in.  The list of maps below is therefore, restricted to those available for public viewing, and creating a new map will
                                    require you to authenticate.  BAS users can do so with their SOUTH/Photo Database passwords.  Other users will be advised of their credentials.
                                </div>
                                <form>
                                    <div class="form-group">
                                        <label for="select-map">
                                            Select a map
                                        </label>                                
                                        <select class="form-control" id="select-map">                                                      
                                        </select>
                                    </div>
                                    <button id="select-map-go" type="button" class="btn btn-primary">Load map</button>
                                    <button id="create-map" type="button" class="btn btn-primary">Log in to create/update maps</button>
                                </form>
                            </div>
                            <div th:case="*">
                                <div class="alert alert-info">
                                    You are currently logged in as <span th:text="${#httpServletRequest.remoteUser}"></span>.  Select a map to view below.
                                </div>
                                <form>
                                    <div class="form-group">
                                        <label for="select-map">
                                            Select a map
                                        </label>                                
                                        <select class="form-control" id="select-map">                                                      
                                        </select>
                                    </div>
                                    <button id="select-map-go" type="button" class="btn btn-primary">Load map</button>
                                    <button id="create-map" type="button" class="btn btn-primary">Create/update a map</button> 
                                    <button id="delete-map" type="button" class="btn btn-danger">Delete a map</button> 
                                </form>
                            </div>
                        </div>                        
                    </div>
                </div>    
            </div>
        </div>
        <!-- /#wrapper -->
        <script type="text/javascript">
            /*<![CDATA[*/

            function populateMapList() {
                var select = $("#select-map");
                select.html("");
                $.getJSON(magic.config.paths.baseurl + "/maps/dropdown", function (data) {                    
                    $.each(data, function (idx, mo) {
                        var opt = $("<option>", {value: mo["name"]});
                        opt.text(mo["title"]);
                        select.append(opt);
                    });
                });
            }

            $(document).ready(function () {
                /* Logout behaviour */
                $("#log-out-user").click(function (evt) {
                    evt.preventDefault();
                    $("#logout-form").submit();
                });
                $("#select-map-go").click(function () {
                    window.open(magic.config.paths.baseurl + "/home/" + $("#select-map").val(), "_blank");
                });
                $("#create-map").click(function () {
                    window.location = magic.config.paths.baseurl + "/creator";
                });
                $("#delete-map").click(function () {
                    var mapName = $("#select-map").val();
                    var mapText = $("#select-map option:selected").text();
                    bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete ' + mapText + '</div>', function (result) {
                        if (result) {
                            /* Do the deletion */
                            var jqxhr = $.ajax({
                                url: magic.config.paths.baseurl + "/maps/deletebyname/" + mapName,
                                method: "DELETE",
                                beforeSend: function(xhr) {
                                    var csrfHeaderVal = $("meta[name='_csrf']").attr("content");
                                    var csrfHeader = $("meta[name='_csrf_header']").attr("content");
                                    xhr.setRequestHeader(csrfHeader, csrfHeaderVal)
                                }
                            })
                            .done(function () {
                                populateMapList();
                            })
                            .fail(function () {
                                bootbox.alert("Failed to delete map " + mapText);
                            });                            
                            bootbox.hideAll();
                        } else {
                            bootbox.hideAll();
                        }
                    });
                });
                populateMapList();
            });
            /*]]>*/
        </script>
        <form id="logout-form" method="POST" th:action="@{/logout}"></form>
    </body>
</html>
