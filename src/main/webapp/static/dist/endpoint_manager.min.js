var magic={config:{paths:{baseurl:window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}},modules:{},classes:{endpoint_manager:{}},runtime:{pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")}}};setInterval("magic.runtime.pingSession()",3e6),magic.modules.Common=function(){return{inches_per_unit:{ins:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36,nmi:1852*39.37},default_styles:{Point:{image:"circle",radius:5,fill:"rgba(255,255,0,0.5)",stroke:"#ff0",width:1},LineString:{stroke:"#f00",width:3},Polygon:{fill:"rgba(0,255,255,0.5)",stroke:"#0ff",width:1},MultiPoint:{image:"circle",radius:5,fill:"rgba(255,0,255,0.5)",stroke:"#f0f",width:1},MultiLineString:{stroke:"#0f0",width:3},MultiPolygon:{fill:"rgba(0,0,255,0.5)",stroke:"#00f",width:1}},color_palette:["#FF6403","#800000","#DD0907","#F20884","#4700A5","#0000D3","#02ABEA","#1FB714","#006412","#562C05","#90713A","#808080","#404040","#000000"],rgbToDec:function(rgb,opacity){rgb=rgb||"#000000",opacity=jQuery.isNumeric(opacity)?opacity:1,rgb=eval("0x"+rgb.replace(/#/,""));var components={r:(16711680&rgb)>>16,g:(65280&rgb)>>8,b:255&rgb};return"rgba("+components.r+","+components.g+","+components.b+","+opacity+")"},scrollViewportToElement:function(a){var b=a.getBoundingClientRect();b.bottom>window.innerHeight&&a.scrollIntoView(!1),b.top<0&&a.scrollIntoView()},buttonFeedbackSet:function(a,b,c,d,e){return c||(c="sm"),d||(d="Save"),'<div class="btn-toolbar col-'+c+'-12" role="toolbar" style="margin-bottom:10px"><div class="btn-group btn-group-'+c+'"><button id="'+a+'-go" class="btn btn-'+c+' btn-primary" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="'+b+'"><span class="fa fa-floppy-o"></span> '+d+'</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-ok" class="btn btn-'+c+' btn-success" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Ok"><span class="fa fa-check post-ok"></span> Ok</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-error" class="btn btn-'+c+' btn-danger" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Error"><span class="fa fa-times-circle post-error"></span> Error</button></div>'+(!0===e?'<div class="btn-group btn-group-'+c+'"><button id="'+a+'-cancel" class="btn btn-'+c+' btn-danger" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="Cancel"><span class="fa fa-times-circle"></span> Cancel</button></div>':"")+"</div>"},buttonClickFeedback:function(a,b,c){var d,e=jQuery("#"+a+"-go"),f=jQuery("#"+a+"-fb-ok"),g=jQuery("#"+a+"-fb-error");e.hide(),b?(f.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return f.fadeIn(300).delay(1200).fadeOut(300)}):(g.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return g.fadeIn(600).delay(6e3).fadeOut(600)}),jQuery.when(d()).done(function(){e.show()})},fetchStyle:function(a,b,c){var d=this.default_styles[a];if(d){var e={};return a.toLowerCase().indexOf("point")>=0?e.image=this.getPointImageStyle(b):a.toLowerCase().indexOf("linestring")>=0?e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1}):(e.fill=new ol.style.Fill({color:this.rgbToDec(this.color_palette[b],.5)}),e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1})),c&&(e.text=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:c,textAlign:"left",fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[b])}),stroke:new ol.style.Stroke({color:"#ffffff",width:1})})),[new ol.style.Style(e)]}return null},getPointImageStyle:function(a){var b=a%4;return 0==b?new ol.style.Circle({fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),radius:5,stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):1==b?new ol.style.RegularShape({rotation:0,points:5,radius1:7,radius2:2,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):2==b?new ol.style.RegularShape({points:4,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):3==b?new ol.style.RegularShape({points:3,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):void 0},labelVisibility:function(a,b,c,d){if(!a.get("_ignoreHovers")){var e=null;if(a.getStyleFunction())e=jQuery.proxy(a.getStyleFunction(),a)()[0];else if(a.getStyle())e=a.getStyle();else if(jQuery.isFunction(b.getStyleFunction)&&b.getStyleFunction()){var f=b.getStyleFunction()(a,0);e=jQuery.isArray(f)?f[0]:f}else jQuery.isFunction(b.getStyle)&&b.getStyle()&&(e=b.getStyle());if(e&&e.getText()){var g=e.clone(),h=g.getText();if(h&&h.getText()){var i=h.getText();c?h.setText(i+(d>1?" (+"+(d-1)+")":"")):h.setText(i.replace(/\s+\(\+\d+\)$/,""));var j=h.getStroke(),k=j.getColor();jQuery.isArray(k)?(k[3]=c?"1.0":"0.0",j.setColor(k)):j.setColor(k.substring(0,k.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")");var l=h.getFill(),m=l.getColor();jQuery.isArray(m)?(m[3]=c?"1.0":"0.0",l.setColor(m)):l.setColor(m.substring(0,m.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")"),a.setStyle(g),a.changed()}}}},proxyUrl:function(a){var b=a;return 0!=a.indexOf(window.location.protocol+"//"+window.location.hostname)&&(b=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(a)),b},getWxsRequestUrl:function(a,b,c){var d="";switch(b.toLowerCase()){case"getcapabilities":d=magic.modules.Endpoints.getOgcEndpoint(a,"wms")+(-1!=a.indexOf("?")?"&":"?")+"request=GetCapabilities&service=wms";break;case"describefeaturetype":d=magic.modules.Endpoints.getOgcEndpoint(a,"wfs")+"?version=1.0.0&request=DescribeFeatureType&typename="+c}return d},getCapabilities:function(a,b,c){if(magic.runtime.map_context.capabilities[a])b(magic.runtime.map_context.capabilities[a],c);else{var d=new ol.format.WMSCapabilities;jQuery.get(this.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(e){try{var f=jQuery.parseJSON(JSON.stringify(d.read(e)));if(f){var g=null;if("Capability"in f&&"Layer"in f.Capability&&"Layer"in f.Capability.Layer&&jQuery.isArray(f.Capability.Layer.Layer)){var h=f.Capability.Layer.Layer;g={},this.getFeatureTypes(g,h)}null!=g?(magic.runtime.map_context.capabilities[a]=g,b(magic.runtime.map_context.capabilities[a],c)):b(null,c,"No feature types found in GetCapabilities response from "+a)}else b(null,c,"Malformed GetCapabilities response from "+a)}catch(d){b(null,c,"Parsing GetCapabilities response from "+a+" failed with error "+d.message)}},this)).fail(function(d,e,f){var g="Failed to WMS GetCapabilities document from "+a+", error was : "+f;401==e&&(g="Not authorised to retrieve WMS GetCapabilities document from "+a),b(null,c,g)})}},defaultMouseover:function(a){var b=0,c=!1,d=null;return a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(a,e){if(null!=e&&!0!==a.get("_ignoreHovers"))return!0===a.get("_customHover")?(d=null,c=!0):0==b&&(d={feature:a,layer:e}),b++,c},this)),!c&&b>0&&this.labelVisibility(d.feature,d.layer,!0,b),jQuery("#"+a.map.getTarget()).css("cursor",d?"pointer":"help"),d},defaultMouseout:function(a){a&&a.feature&&!0!==a.feature.get("_customHover")&&this.labelVisibility(a.feature,a.layer,!1,1)},featuresAtPixel:function(a){var b=[];return a.map.forEachFeatureAtPixel(a.pixel,function(a,c){if(null!=c){var d=a.get("features");if(d&&jQuery.isArray(d))jQuery.each(d,function(a,d){if(!d.get("ignoreClicks")&&d.getGeometry()){var e=d.getProperties();b.push(jQuery.extend({},e,{layer:c}))}});else if(!a.get("_ignoreClicks")&&a.getGeometry()){var e=a.getProperties();b.push(jQuery.extend({},e,{layer:c}))}}},{layerFilter:function(a){return a.getVisible()&&a.get("metadata")&&!0===a.get("metadata").is_interactive}},this),b},getFeatureTypes:function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a[c.Name]=c:"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatureTypes(a,c.Layer)},this))},populateSelect:function(a,b,c,d,e,f){var g=null;a.find("option").remove(),!0===f&&a.append(jQuery("<option>",{value:"",selected:""==e?" selected":"",text:"Please select"})),b.sort(function(a,b){var e=a[d]?a[d].toLowerCase():a[c].toLowerCase(),f=b[d]?b[d].toLowerCase():b[c].toLowerCase();return e<f?-1:e>f?1:0}),jQuery.each(b,function(b,f){var h=jQuery("<option>",{value:f[c]}),i=f[d]||f[c];h.text(i),a.append(h),e&&f[c]==e&&(g=h)}),null!=g&&g.prop("selected","selected")},jsonToForm:function(a,b,c){jQuery.each(a,function(a,d){var e=d.field,f=d.default,g=jQuery("#"+c+"-"+e),h="object"==typeof b[e]?JSON.stringify(b[e]):b[e];"checkbox"==g.attr("type")||"radio"==g.attr("type")?g.prop("checked",b&&e in b?!0===h:f):"url"==g.attr("type")?g.val(b?e in b?h:"":f):g.val(b&&e in b?h:f)})},formToJson:function(a,b){var c={};return jQuery.each(a,function(a,d){var e=d.field,f=jQuery("#"+b+"-"+e);switch(f.attr("type")){case"checkbox":case"radio":c[e]=!!f.prop("checked");break;default:var g=f.val();"number"==f.attr("type")&&jQuery.isNumeric(g)&&(g=Math.floor(g)==g?parseInt(g):parseFloat(g)),f.attr("required")&&""==g?c[e]=d.default:c[e]=g}}),c},flagInputError:function(a){var b=a.closest("div.form-group");b&&b.addClass("has-error")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'"><p>A problem occurred - more details below:</p><p>'+a+"</p></div>")},resetFormIndicators:function(){jQuery("div.form-group").removeClass("has-error")},getScript:function(a,b){jQuery.ajax({type:"GET",url:a,success:b,dataType:"script",cache:!0})},csvToArray:function(a){var b,c="",d=[""],e=[d],f=0,g=0,h=!0;for(b in a)b=a[b],'"'===b?(h&&b===c&&(d[f]+=b),h=!h):","===b&&h?b=d[++f]="":"\n"===b&&h?("\r"===c&&(d[f]=d[f].slice(0,-1)),d=e[++g]=[b=""],f=0):d[f]+=b,c=b;return e},sortedUniqueArray:function(a){var b=[];if(!a||0==a.length)return b;var c={};return b=jQuery.map(a,function(a){return a in c?null:(c[a]=1,a)}),b.sort(),b},isUrl:function(a){if("string"==typeof a){var b=/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;return a.match(b)}return!1},isNameLike:function(a){a=a.toLowerCase();for(var b=["^name.*$","^callsign$","^[^n]*name$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLongitudeLike:function(a){a=a.toLowerCase();for(var b=["^lon.*$","^x$","^xcoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLatitudeLike:function(a){a=a.toLowerCase();for(var b=["^lat.*$","^y$","^ycoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isDatetimeLike:function(a){a=a.toLowerCase();for(var b=["^date.*$","^time.*$","^utc$","^[^u]*update.*$","timestamp$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},dateFormat:function(a,b){if(!a)return"";var c=a,d=new Date(a);if(-1==a.toLowerCase().indexOf("invalid")){var e=d.getDate();e=(e<10?"0":"")+e;var f=d.getMonth()+1;f=(f<10?"0":"")+f;var g=d.getFullYear();c="dmy"==b?e+"-"+f+"-"+g:g+"-"+f+"-"+e}return c},fileSize:function(a){var b=Math.log(a)/Math.log(1024)|0;return(a/Math.pow(1024,b)).toFixed(2)+" "+(0==b?"bytes":"kMGTPEZY"[b-1]+"B")},JsonEscape:function(a){var b=a.replace(/\&/g,"&amp;");return b=b.replace(/\"/g,"&quot;")},JsonUnescape:function(a){var b=a.replace(/\&quot;/g,'"');return b=b.replace(/\&amp;/g,"&")},linkify:function(a,b){if(!a)return"";if("string"==typeof a){if(-1!=a.indexOf("<a"))return a;if(a.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>';if(a.match(/^https?:\/\//)&&a.indexOf("?")>0){if(a.substring(0,a.indexOf("?")).match(/\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>'}var c=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,d=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/\w+@[a-zA-Z_]+?(?:\.[a-zA-Z]{2,6})+/gim;return b?a.replace(c,'<a href="$&" title="$&" target="_blank">'+b+"</a>").replace(d,'$1<a href="http://$2" target="_blank">'+b+"</a>").replace(e,'<a href="mailto:$&">'+b+"</a>"):a.replace(c,'<a href="$&" title="$&" target="_blank">[external resource]</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$&">$&</a>')}return a},chunk:function(a,b){return void 0===b&&(b=2),a.match(RegExp(".{1,"+b+"}","g")).join("<br>")},ellipsis:function(a,b){if(a.length<=b)return a;var c=a.substr(0,b),d=c.lastIndexOf(" ");return c=-1==d||d<b/2?c.substr(0,b-3)+"...":c.substr(0,d)+"..."},stringDivider:function(a,b,c){if(a.length>b){for(var d=b;d>0&&" "!=a[d]&&"-"!=a[d];d--);if(d>0){var e;e="-"==a.substring(d,d+1)?a.substring(0,d+1):a.substring(0,d);var f=a.substring(d+1);return e+c+stringDivider(f,b,c)}}return a},objectLength:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},initCap:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},unitConverter:function(a,b,c,d){d=d||1;var e=0,f=b,g=c;return f in this.inches_per_unit&&g in this.inches_per_unit&&(1==d||2==d)&&(e=a*Math.pow(this.inches_per_unit[f]/this.inches_per_unit[g],d),e=e.toFixed(3)+" "+g+(2==d?"<sup>2</sup>":"")),e},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},toRadians:function(a){return a*Math.PI/180},toDegrees:function(a){return 180*a/Math.PI},floatsEqual:function(a,b,c){return Math.abs(a-b)<=c},floatInRange:function(a,b,c,d){return(a>b||Math.abs(a-b)<=d)&&(a<c||Math.abs(a-c)<=d)}}}(),magic.classes.CustomFormInput=function(a){this.id=a.id,this.tipText=a.tipText,this.tipPosition=a.tipPosition,this.defaultValue=a.defaultValue,this.required=a.required,this.element=jQuery("#"+this.id)},magic.classes.CustomFormInput.prototype.getElement=function(){return this.element},magic.classes.TagsInput=function(a){if(a=jQuery.extend({},{tipText:"",tipPosition:"left",required:!1,defaultValue:"",tagValidator:function(a){return!0}},a),magic.classes.CustomFormInput.call(this,a),this.tagValidator=a.tagValidator,this.tipText=this.tipText||this.element.data("original-title"),this.element.length>0&&(this.element.tagsinput({trimValue:!0,allowDuplicates:!1,cancelConfirmKeysOnEmpty:!1}),this.tipText)){var b=this.element.closest("div").find(".bootstrap-tagsinput :input");b&&(b.attr("data-toggle","tooltip"),b.attr("data-placement",this.tipPosition),b.attr("title",this.tipText))}this.setValue(this.defaultValue)},magic.classes.TagsInput.prototype=Object.create(magic.classes.CustomFormInput.prototype),magic.classes.TagsInput.prototype.constructor=magic.classes.TagsInput,magic.classes.TagsInput.prototype.reset=function(){this.element.tagsinput("removeAll")},magic.classes.TagsInput.prototype.setValue=function(a){a?(jQuery.isArray(a)||(a=a.split(",")),a.length>0&&jQuery.each(a,jQuery.proxy(function(a,b){this.element.tagsinput("add",b)},this))):this.reset()},magic.classes.TagsInput.prototype.getValue=function(a){return!0===a?this.element.tagsinput("items"):this.element.val()},magic.classes.TagsInput.prototype.validate=function(){var a=!this.required||""!=this.getValue(!1),b=this.element.closest("div.form-group");if(a){var c=this.getValue(!0);if(c.length>0){a=jQuery.grep(c,jQuery.proxy(function(a){return this.tagValidator(a)},this)).length==c.length}}return a?b.removeClass("has-error"):b.addClass("has-error"),a},magic.classes.MultiSelectInput=function(a){a=jQuery.extend({},{tipText:"",tipPosition:"left",required:!1,defaultValue:""},a),magic.classes.CustomFormInput.call(this,a),this.tipText=this.tipText||this.element.data("original-title"),this.element.attr("multiple","multiple"),this.element.addClass("selectpicker"),this.element.selectpicker({iconBase:"fa",tickIcon:"fa-check"}),this.element.closest("div.bootstrap-select").tooltip({title:this.tipText,placement:this.tipPosition,container:"body"}),""==this.defaultValue?this.reset():this.setValue(this.defaultValue)},magic.classes.MultiSelectInput.prototype=Object.create(magic.classes.CustomFormInput.prototype),magic.classes.MultiSelectInput.prototype.constructor=magic.classes.MultiSelectInput,magic.classes.MultiSelectInput.prototype.reset=function(){this.element.selectpicker("deselectAll")},magic.classes.MultiSelectInput.prototype.setValue=function(a){a?(jQuery.isArray(a)||(a=a.split(",")),a.length>0&&this.element.selectpicker("val",a)):this.reset()},magic.classes.MultiSelectInput.prototype.getValue=function(a){return a?this.element.val():this.element.val().join(",")},magic.classes.MultiSelectInput.prototype.validate=function(){var a=this.element.closest("div.form-group"),b=!this.required||""!=this.getValue(!1);return b?a.removeClass("has-error"):a.addClass("has-error"),b},magic.classes.endpoint_manager.EndpointManagerPanel=function(){this.prefix="endpoint-manager",this.searchForm=jQuery("#"+this.prefix+"-searchform"),this.searchSelect=jQuery("#"+this.prefix+"-search"),this.updateForm=jQuery("#"+this.prefix+"-update-form"),this.updateFormFields=[{field:"id",default:""},{field:"coast_layers",default:""},{field:"graticule_layer",default:""},{field:"low_bandwidth",default:!1},{field:"name",default:""},{field:"url",default:""},{field:"proxied_url",default:""},{field:"rest_endpoint",default:""},{field:"url_aliases",default:"",plugin:"tagsinput"},{field:"location",default:""},{field:"srs",default:"",plugin:"multiselect"},{field:"has_wfs",default:!0},{field:"is_user_service",default:!1}],this.pluginFields={},jQuery.each(jQuery.grep(this.updateFormFields,function(a){return"plugin"in a},!1),jQuery.proxy(function(a,b){switch(b.plugin){case"tagsinput":this.pluginFields[b.field]=new magic.classes.TagsInput({id:this.prefix+"-"+b.field,tagValidator:function(a){return magic.modules.Common.isUrl(a)}});break;case"multiselect":this.pluginFields[b.field]=new magic.classes.MultiSelectInput({id:this.prefix+"-"+b.field,required:!0})}},this)),this.buttons={create:jQuery("#"+this.prefix+"-btn-create"),update:jQuery("#"+this.prefix+"-btn-update"),delete:jQuery("#"+this.prefix+"-btn-delete"),cancel:jQuery("#"+this.prefix+"-btn-cancel")},this.selectedEndpointId=null,this.formDirty=!1,this.updateForm.find(":input:not(:button)").on("change keyup",jQuery.proxy(function(){this.buttons.update.prop("disabled",!1),this.formDirty=!0},this)),this.searchSelect.on("change",jQuery.proxy(function(a){this.formDirty?bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">You have unsaved changes - proceed?</div>',jQuery.proxy(function(a){a&&this.getEndpointData(this.searchSelect.val())},this)):this.getEndpointData(this.searchSelect.val())},this)),this.buttons.create.on("click",jQuery.proxy(this.createHandler,this)),this.buttons.update.on("click",jQuery.proxy(this.updateHandler,this)),this.buttons.delete.on("click",jQuery.proxy(this.deleteHandler,this)),this.buttons.cancel.on("click",jQuery.proxy(this.cancelHandler,this)),this.loadEndpoints(jQuery.proxy(this.resetForm,this))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.getEndpointData=function(a){jQuery.getJSON(magic.config.paths.baseurl+"/endpoints/get/"+a,jQuery.proxy(function(a){this.resetForm(),this.payloadToForm(a),this.setButtonStatuses({create:!0,update:!1,delete:!0,cancel:!0}),this.selectedEndpointId=a.id},this)).fail(jQuery.proxy(function(b){magic.modules.Common.showAlertModal("Failed to load endpoint with id "+a+" : "+this.alertResponse(b),"warning")},this))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.createHandler=function(a){jQuery(a.currentTarget).tooltip("hide"),this.formDirty?bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">You have unsaved changes - proceed?</div>',jQuery.proxy(function(a){a&&this.resetForm(!0)},this)):this.resetForm(!0)},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.updateHandler=function(a){jQuery(a.currentTarget).tooltip("hide");var b=magic.config.paths.baseurl+"/endpoints/"+(null==this.selectedEndpointId?"save":"update/"+this.selectedEndpointId);this.validate()&&(console.log(JSON.stringify(this.formToPayload())),jQuery.ajax({url:b,data:JSON.stringify(this.formToPayload()),method:"PUT",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")},success:jQuery.proxy(function(a){this.buttonClickFeedback("update",!0,"ok"),this.resetForm(!0)},this),fail:jQuery.proxy(function(a){this.buttonClickFeedback("delete",!1,this.alertResponse(a))},this)}))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.cancelHandler=function(a){jQuery(a.currentTarget).tooltip("hide"),this.resetForm()},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.deleteHandler=function(a){jQuery(a.currentTarget).tooltip("hide"),null!=this.selectedEndpointId&&bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Really delete this endpoint?</div>',jQuery.proxy(function(a){a&&jQuery.ajax({url:magic.config.paths.baseurl+"/endpoints/delete/"+this.selectedEndpointId,method:"DELETE",beforeSend:function(a){var b=jQuery("meta[name='_csrf']").attr("content"),c=jQuery("meta[name='_csrf_header']").attr("content");a.setRequestHeader(c,b)}}).done(jQuery.proxy(function(){this.buttonClickFeedback("delete",!0,"Successfully deleted endpoint"),this.loadEndpoints(jQuery.proxy(this.resetForm,this))},this)).fail(jQuery.proxy(function(a){this.buttonClickFeedback("delete",!1,this.alertResponse(a))},this))},this))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.loadEndpoints=function(a){jQuery.getJSON(magic.config.paths.baseurl+"/endpoints/dropdown",jQuery.proxy(function(b){jQuery.isArray(b)?magic.modules.Common.populateSelect(this.searchSelect,b,"id","name","",!0):magic.modules.Common.showAlertModal("Malformed data received while loading endpoints - server may be down?","warning"),jQuery.isFunction(a)&&a()},this)).fail(jQuery.proxy(function(a){magic.modules.Common.showAlertModal("Error loading endpoints : "+this.alertResponse(a),"warning")},this))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.resetForm=function(a){a=a||!1,this.selectedEndpointId=null,a&&this.searchForm.get(0).reset(),this.updateForm.get(0).reset(),jQuery("#"+this.prefix+"-location").val(""),jQuery.each(this.pluginFields,jQuery.proxy(function(a,b){b.reset()},this)),magic.modules.Common.resetFormIndicators(),this.setButtonStatuses(),this.formDirty=!1},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.payloadToForm=function(a){magic.modules.Common.jsonToForm(jQuery.grep(this.updateFormFields,function(a){return"plugin"in a},!0),a,this.prefix),jQuery.each(this.pluginFields,jQuery.proxy(function(b,c){c.setValue(a[b])},this)),this.formDirty=!1},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.formToPayload=function(){var a=magic.modules.Common.formToJson(jQuery.grep(this.updateFormFields,function(a){return"plugin"in a},!0),this.prefix);return jQuery.each(this.pluginFields,jQuery.proxy(function(b,c){a[b]=c.getValue(!1)},this)),a.low_bandwidth="cambridge"!=a.location,a},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.validate=function(){var a=!0;return magic.modules.Common.resetFormIndicators(),jQuery.each(this.updateFormFields,jQuery.proxy(function(b,c){var d=!1;if("plugin"in c)d=this.pluginFields[c.field].validate();else{var e=jQuery("#"+this.prefix+"-"+c.field);d=e.get(0).checkValidity(),d||magic.modules.Common.flagInputError(e)}d||(a=!1)},this)),a},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.setButtonStatuses=function(a){a&&!jQuery.isEmptyObject(a)||(a={create:!0,update:!1,delete:!1,cancel:!0}),jQuery.each(this.buttons,jQuery.proxy(function(b,c){this.buttons[b].prop("disabled",!0!==a[b])},this))},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.alertResponse=function(a){var b=a.responseText;try{b=JSON.parse(a.responseText).detail}catch(a){}return b},magic.classes.endpoint_manager.EndpointManagerPanel.prototype.buttonClickFeedback=function(a,b,c){var d;this.buttons[a].hide();var e=jQuery("#"+this.buttons[a].attr("id")+(b?"-ok":"-fail"));e.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return e.fadeIn(300).delay(1200).fadeOut(300)},jQuery.when(d()).done(jQuery.proxy(function(){this.buttons[a].show()},this))};