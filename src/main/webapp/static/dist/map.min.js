var magic={config:{paths:{baseurl:window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),cdn:"https://cdn.web.bas.ac.uk/magic"}},modules:{creator:{}},classes:{creator:{},console:{}},runtime:{creator:{catalogues:{}},capabilities:{},filters:{},pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")},getScripts:function(a,b){var c=0;a.forEach(function(d){jQuery.getScript(d,function(){++c==a.length&&b()})})},preferences:{coordinate:"dd",elevation:"m",date:"Y-m-d"}}};setInterval("magic.runtime.pingSession()",3e6),magic.modules.Common=function(){return{inches_per_unit:{ins:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36,nmi:1852*39.37},default_styles:{Point:{image:"circle",radius:5,fill:"rgba(255,255,0,0.5)",stroke:"#ff0",width:1},LineString:{stroke:"#f00",width:3},Polygon:{fill:"rgba(0,255,255,0.5)",stroke:"#0ff",width:1},MultiPoint:{image:"circle",radius:5,fill:"rgba(255,0,255,0.5)",stroke:"#f0f",width:1},MultiLineString:{stroke:"#0f0",width:3},MultiPolygon:{fill:"rgba(0,0,255,0.5)",stroke:"#00f",width:1}},color_palette:["#FF6403","#800000","#DD0907","#F20884","#4700A5","#0000D3","#02ABEA","#1FB714","#006412","#562C05","#90713A","#808080","#404040","#000000"],rgbToDec:function(rgb,opacity){rgb=rgb||"#000000",opacity=jQuery.isNumeric(opacity)?opacity:1,rgb=eval("0x"+rgb.replace(/#/,""));var components={r:(16711680&rgb)>>16,g:(65280&rgb)>>8,b:255&rgb};return"rgba("+components.r+","+components.g+","+components.b+","+opacity+")"},scrollViewportToElement:function(a){var b=a.getBoundingClientRect();b.bottom>window.innerHeight&&a.scrollIntoView(!1),b.top<0&&a.scrollIntoView()},buttonFeedbackSet:function(a,b,c,d,e){return c||(c="sm"),d||(d="Save"),'<div class="btn-toolbar col-'+c+'-12" role="toolbar" style="margin-bottom:10px"><div class="btn-group btn-group-'+c+'"><button id="'+a+'-go" class="btn btn-'+c+' btn-primary" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="'+b+'"><span class="fa fa-floppy-o"></span> '+d+'</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-ok" class="btn btn-'+c+' btn-success" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Ok"><span class="fa fa-check post-ok"></span> Ok</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-error" class="btn btn-'+c+' btn-danger" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Error"><span class="fa fa-times post-error"></span> Error</button></div>'+(!0===e?'<div class="btn-group btn-group-'+c+'"><button id="'+a+'-cancel" class="btn btn-'+c+' btn-danger" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="Cancel"><span class="fa fa-times-circle"></span> Cancel</button></div>':"")+"</div>"},buttonClickFeedback:function(a,b,c){var d,e=jQuery("#"+a+"-go"),f=jQuery("#"+a+"-fb-ok"),g=jQuery("#"+a+"-fb-error");e.hide(),b?(f.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return f.fadeIn(300).delay(1200).fadeOut(300)}):(g.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return g.fadeIn(600).delay(6e3).fadeOut(600)}),jQuery.when(d()).done(function(){e.show()})},fetchStyle:function(a,b,c){var d=this.default_styles[a];if(d){var e={};return a.toLowerCase().indexOf("point")>=0?e.image=this.getPointImageStyle(b):a.toLowerCase().indexOf("linestring")>=0?e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1}):(e.fill=new ol.style.Fill({color:this.rgbToDec(this.color_palette[b],.5)}),e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1})),c&&(e.text=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:c,textAlign:"left",fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[b])}),stroke:new ol.style.Stroke({color:"#ffffff",width:1})})),[new ol.style.Style(e)]}return null},getPointImageStyle:function(a){var b=a%4;return 0==b?new ol.style.Circle({fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),radius:5,stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):1==b?new ol.style.RegularShape({rotation:0,points:5,radius1:7,radius2:2,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):2==b?new ol.style.RegularShape({points:4,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):3==b?new ol.style.RegularShape({points:3,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):void 0},labelVisibility:function(a,b,c,d){if(!a.get("_ignoreHovers")){var e=null;if(a.getStyleFunction())e=jQuery.proxy(a.getStyleFunction(),a)()[0];else if(a.getStyle())e=a.getStyle();else if(jQuery.isFunction(b.getStyleFunction)&&b.getStyleFunction()){var f=b.getStyleFunction()(a,0);e=jQuery.isArray(f)?f[0]:f}else jQuery.isFunction(b.getStyle)&&b.getStyle()&&(e=b.getStyle());if(e&&e.getText()){var g=e.clone(),h=g.getText();if(h&&h.getText()){var i=h.getText();c?h.setText(i+(d>1?" (+"+(d-1)+")":"")):h.setText(i.replace(/\s+\(\+\d+\)$/,""));var j=h.getStroke(),k=j.getColor();jQuery.isArray(k)?(k[3]=c?"1.0":"0.0",j.setColor(k)):j.setColor(k.substring(0,k.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")");var l=h.getFill(),m=l.getColor();jQuery.isArray(m)?(m[3]=c?"1.0":"0.0",l.setColor(m)):l.setColor(m.substring(0,m.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")"),a.setStyle(g),a.changed()}}}},proxyUrl:function(a){var b=a;return 0!=a.indexOf(window.location.protocol+"//"+window.location.hostname)&&(b=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(a)),b},getWxsRequestUrl:function(a,b,c){var d="";switch(b.toLowerCase()){case"getcapabilities":d=magic.modules.Endpoints.getOgcEndpoint(a,"wms")+(-1!=a.indexOf("?")?"&":"?")+"request=GetCapabilities&service=wms";break;case"describefeaturetype":d=magic.modules.Endpoints.getOgcEndpoint(a,"wfs")+"?version=1.0.0&request=DescribeFeatureType&typename="+c}return d},getCapabilities:function(a,b,c){if(magic.runtime.map_context.capabilities[a])b(magic.runtime.map_context.capabilities[a],c);else{var d=new ol.format.WMSCapabilities;jQuery.get(this.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(e){try{var f=jQuery.parseJSON(JSON.stringify(d.read(e)));if(f){var g=null;if("Capability"in f&&"Layer"in f.Capability&&"Layer"in f.Capability.Layer&&jQuery.isArray(f.Capability.Layer.Layer)){var h=f.Capability.Layer.Layer;g={},this.getFeatureTypes(g,h)}null!=g?(magic.runtime.map_context.capabilities[a]=g,b(magic.runtime.map_context.capabilities[a],c)):b(null,c,"No feature types found in GetCapabilities response from "+a)}else b(null,c,"Malformed GetCapabilities response from "+a)}catch(d){b(null,c,"Parsing GetCapabilities response from "+a+" failed with error "+d.message)}},this)).fail(function(d,e,f){var g="Failed to WMS GetCapabilities document from "+a+", error was : "+f;401==e&&(g="Not authorised to retrieve WMS GetCapabilities document from "+a),b(null,c,g)})}},defaultMouseover:function(a){var b=0,c=!1,d=null;return a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(a,e){if(null!=e&&!0!==a.get("_ignoreHovers"))return!0===a.get("_customHover")?(d=null,c=!0):0==b&&(d={feature:a,layer:e}),b++,c},this)),!c&&b>0&&this.labelVisibility(d.feature,d.layer,!0,b),jQuery("#"+a.map.getTarget()).css("cursor",d?"pointer":"help"),d},defaultMouseout:function(a){a&&a.feature&&!0!==a.feature.get("_customHover")&&this.labelVisibility(a.feature,a.layer,!1,1)},featuresAtPixel:function(a){var b=[];return a.map.forEachFeatureAtPixel(a.pixel,function(a,c){if(null!=c){var d=a.get("features");if(d&&jQuery.isArray(d))jQuery.each(d,function(a,d){if(!d.get("ignoreClicks")&&d.getGeometry()){var e=d.getProperties();b.push(jQuery.extend({},e,{layer:c}))}});else if(!a.get("_ignoreClicks")&&a.getGeometry()){var e=a.getProperties();b.push(jQuery.extend({},e,{layer:c}))}}},{layerFilter:function(a){return a.getVisible()&&a.get("metadata")&&!0===a.get("metadata").is_interactive}},this),b},getFeatureTypes:function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a[c.Name]=c:"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatureTypes(a,c.Layer)},this))},populateSelect:function(a,b,c,d,e,f){var g=null;a.find("option").remove(),!0===f&&a.append(jQuery("<option>",{value:"",selected:""==e?" selected":"",text:"Please select"})),b.sort(function(a,b){var e=a[d]?a[d].toLowerCase():a[c].toLowerCase(),f=b[d]?b[d].toLowerCase():b[c].toLowerCase();return e<f?-1:e>f?1:0}),jQuery.each(b,function(b,f){var h=jQuery("<option>",{value:f[c]}),i=f[d]||f[c];h.text(i),a.append(h),e&&f[c]==e&&(g=h)}),null!=g&&g.prop("selected","selected")},jsonToForm:function(a,b,c){jQuery.each(a,function(a,d){var e=d.field,f=d.default,g=jQuery("#"+c+"-"+e),h="object"==typeof b[e]?JSON.stringify(b[e]):b[e];"checkbox"==g.attr("type")||"radio"==g.attr("type")?g.prop("checked",b&&e in b?!0===h:f):"url"==g.attr("type")?g.val(b?e in b?h:"":f):g.val(b&&e in b?h:f)})},formToJson:function(a,b){var c={};return jQuery.each(a,function(a,d){var e=d.field,f=jQuery("#"+b+"-"+e);switch(f.attr("type")){case"checkbox":case"radio":c[e]=!!f.prop("checked");break;default:var g=f.val();"number"==f.attr("type")&&jQuery.isNumeric(g)&&(g=Math.floor(g)==g?parseInt(g):parseFloat(g)),f.attr("required")&&""==g?c[e]=d.default:c[e]=g}}),c},flagInputError:function(a){var b=a.closest("div.form-group");b&&b.addClass("has-error")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'"><p>A problem occurred - more details below:</p><p>'+a+"</p></div>")},resetFormIndicators:function(){jQuery("div.form-group").removeClass("has-error")},getScript:function(a,b){jQuery.ajax({type:"GET",url:a,success:b,dataType:"script",cache:!0})},csvToArray:function(a){var b,c="",d=[""],e=[d],f=0,g=0,h=!0;for(b in a)b=a[b],'"'===b?(h&&b===c&&(d[f]+=b),h=!h):","===b&&h?b=d[++f]="":"\n"===b&&h?("\r"===c&&(d[f]=d[f].slice(0,-1)),d=e[++g]=[b=""],f=0):d[f]+=b,c=b;return e},sortedUniqueArray:function(a){var b=[];if(!a||0==a.length)return b;var c={};return b=jQuery.map(a,function(a){return a in c?null:(c[a]=1,a)}),b.sort(),b},isUrl:function(a){if("string"==typeof a){var b=/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;return a.match(b)}return!1},isNameLike:function(a){a=a.toLowerCase();for(var b=["^name.*$","^callsign$","^[^n]*name$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLongitudeLike:function(a){a=a.toLowerCase();for(var b=["^lon.*$","^x$","^xcoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLatitudeLike:function(a){a=a.toLowerCase();for(var b=["^lat.*$","^y$","^ycoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isDatetimeLike:function(a){a=a.toLowerCase();for(var b=["^date.*$","^time.*$","^utc$","^[^u]*update.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},dateFormat:function(a,b){if(!a)return"";var c=a,d=new Date(a);if(-1==a.toLowerCase().indexOf("invalid")){var e=d.getDate();e=(e<10?"0":"")+e;var f=d.getMonth()+1;f=(f<10?"0":"")+f;var g=d.getFullYear();c="dmy"==b?e+"-"+f+"-"+g:g+"-"+f+"-"+e}return c},fileSize:function(a){var b=Math.log(a)/Math.log(1024)|0;return(a/Math.pow(1024,b)).toFixed(2)+" "+(0==b?"bytes":"kMGTPEZY"[b-1]+"B")},JsonEscape:function(a){var b=a.replace(/\&/g,"&amp;");return b=b.replace(/\"/g,"&quot;")},JsonUnescape:function(a){var b=a.replace(/\&quot;/g,'"');return b=b.replace(/\&amp;/g,"&")},linkify:function(a,b){if(!a)return"";if("string"==typeof a){if(-1!=a.indexOf("<a"))return a;if(a.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>';if(a.match(/^https?:\/\//)&&a.indexOf("?")>0){if(a.substring(0,a.indexOf("?")).match(/\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>'}var c=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,d=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/\w+@[a-zA-Z_]+?(?:\.[a-zA-Z]{2,6})+/gim;return b?a.replace(c,'<a href="$&" title="$&" target="_blank">'+b+"</a>").replace(d,'$1<a href="http://$2" target="_blank">'+b+"</a>").replace(e,'<a href="mailto:$&">'+b+"</a>"):a.replace(c,'<a href="$&" title="$&" target="_blank">[external resource]</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$&">$&</a>')}return a},chunk:function(a,b){return void 0===b&&(b=2),a.match(RegExp(".{1,"+b+"}","g")).join("<br>")},ellipsis:function(a,b){if(a.length<=b)return a;var c=a.substr(0,b),d=c.lastIndexOf(" ");return c=-1==d||d<b/2?c.substr(0,b-3)+"...":c.substr(0,d)+"..."},stringDivider:function(a,b,c){if(a.length>b){for(var d=b;d>0&&" "!=a[d]&&"-"!=a[d];d--);if(d>0){var e;e="-"==a.substring(d,d+1)?a.substring(0,d+1):a.substring(0,d);var f=a.substring(d+1);return e+c+stringDivider(f,b,c)}}return a},objectLength:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},initCap:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},unitConverter:function(a,b,c,d){d=d||1;var e=0,f=b,g=c;return f in this.inches_per_unit&&g in this.inches_per_unit&&(1==d||2==d)&&(e=a*Math.pow(this.inches_per_unit[f]/this.inches_per_unit[g],d),e=e.toFixed(3)+" "+g+(2==d?"<sup>2</sup>":"")),e},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},toRadians:function(a){return a*Math.PI/180},toDegrees:function(a){return 180*a/Math.PI},floatsEqual:function(a,b,c){return Math.abs(a-b)<=c},floatInRange:function(a,b,c,d){return(a>b||Math.abs(a-b)<=d)&&(a<c||Math.abs(a-c)<=d)}}}(),magic.modules.Endpoints=function(){return{parseUri:function(a){for(var b={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},c=b.parser[b.strictMode?"strict":"loose"].exec(a),d={},e=14;e--;)d[b.key[e]]=c[e]||"";return d[b.q.name]={},d[b.key[12]].replace(b.q.parser,function(a,c,e){c&&(d[b.q.name][c]=e)}),d},getVirtualService:function(a){var b="",c=/\/geoserver\/([^\/]+)\/wms/,d=c.exec(a);return null!=d&&(b=d[1]),b},getWmsProxiedUrl:function(a){var b=this.getEndpointBy("url",a);return b&&b.proxied_url?b.proxied_url:null},getWmsServiceUrl:function(a){var b=this.getEndpointBy("name",a);return b?b.url:null},getOgcEndpoint:function(a,b){var c=a,d=this.getEndpointsBy("url",a);return jQuery.isArray(d)&&d.length>0?c=!0===d[0].is_user_service?magic.config.paths.baseurl+"/ogc/user/"+b:magic.config.paths.baseurl+"/ogc/"+d[0].id+"/"+b:(console.log(a+" does not correspond to a known endpoint - need to proxy"),c=magic.modules.Common.proxyUrl(a)),c},getEndpointBy:function(a,b){var c=this.getEndpointsBy(a,b);return c.length>0?c[0]:null},getUserDataEndpoint:function(){if(!magic.runtime.endpoints)return null;var a=jQuery.grep(magic.runtime.endpoints,function(a){return!0===a.is_user_service});return 0==a.length?null:a[0]},getEndpointsBy:function(a,b){if(!magic.runtime.endpoints||!a||!b)return null;var c=null;return"url"==a&&(c=this.parseUri(b)),jQuery.grep(magic.runtime.endpoints,jQuery.proxy(function(d){if("id"==a)return d[a]==b;if("url"==a){var e=this.compareEndpoints(c,this.parseUri(d[a]));if(!e&&d.url_aliases)for(var f=d.url_aliases.split(","),g=0;!e&&g<f.length;g++)e=this.compareEndpoints(c,this.parseUri(f[g]));return e}if("srs"==a){return d[a].toLowerCase().split(",").indexOf(b.toLowerCase())>=0}return 0==d[a].toLowerCase().indexOf(b.toLowerCase())},this))},compareEndpoints:function(a,b){var c=a.protocol==b.protocol&&a.host==b.host&&a.port==a.port;if(c&&""!=a.path&&""!=b.path){var d=a.path;d.indexOf("/")>=0&&(d=d.substring(0,d.indexOf("/")));var e=b.path;e.indexOf("/")>=0&&(e=e.substring(0,e.indexOf("/"))),c=d==e}return c},getMidLatitudeCoastLayer:function(){var a=null,b=this.getEndpointBy("name","midlatitude");if(null!=b&&"osm"!=b.url){var c=null;-1!=b.coast_layers.indexOf(":")&&(c=b.coast_layers.split(":").shift()),a=new ol.layer.Tile({source:new ol.source.TileWMS({url:b.url,params:{LAYERS:b.coast_layers,CRS:"EPSG:3857",SRS:"EPSG:3857",VERSION:"1.3.0",WORKSPACE:c},projection:"EPSG:3857"})})}else a=new ol.layer.Tile({source:new ol.source.OSM({wrapX:!1})});return a},getMidLatitudeCoastSource:function(a){var b=this.getEndpointBy("name","midlatitude"),c={wms_source:b&&"osm"!=b.url?b.url:"osm",feature_name:b&&"osm"!=b.url?b.coast_layers:"osm",is_base:!0};return jQuery.extend({id:null,name:"Mid-latitude data",is_visible:!0},a?c:{source:c})}}}(),magic.modules.GeoUtils=function(){return{ANGULAR_TOLERANCE:.001,N_INTERP:5,WGS84:new ol.Sphere(6378137),DISTANCE_UNITS:[["km","kilometres"],["m","metres"],["mi","statute miles"],["nmi","nautical miles"]],AREA_UNITS:[["km","square kilometres"],["m","square metres"],["mi","square miles"],["nmi","square nautical miles"]],ELEVATION_UNITS:[["m","metres"],["ft","feet"]],COORDINATE_FORMATS:[["dd","decimal degrees"],["dms","degrees, minutes and seconds"],["ddm","degrees, decimal minutes"]],DEFAULT_GEO_PREFS:{distance:"km",area:"km",elevation:"m",coordinates:"dd"},DEFAULT_MAP_PARAMS:{antarctic:{projection:"EPSG:3031",proj_extent:[-5e6,-5e6,5e6,5e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140,56,28,14,5.6,2.8,1.4,.56]},antarctic_laea:{projection:"EPSG:102020",proj_extent:[-55e5,-55e5,55e5,55e5],center:[0,0],zoom:0,rotation:0,resolutions:[14e3,7e3,2800,1400,560,280,140]},arctic:{projection:"EPSG:3995",proj_extent:[-4e6,-4e6,4e6,4e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140]},southgeorgia:{projection:"EPSG:3762",proj_extent:[-929362.849,-1243855.108,1349814.294,556833.528],center:[-1e3,61900],zoom:4,rotation:0,resolutions:[3360,1680,840,420,210,105,42,21,10.5,4.2,2.1,1.12,.56,.28,.14]},midlatitudes:{projection:"EPSG:3857",proj_extent:[-20026376.39,-20048966.1,20026376.39,20048966.1],center:[0,0],zoom:0,rotation:0,resolutions:[]}},defaultEmbeddedLayers:function(a){return this.getBaseLayers(a,!0).concat(this.getTopoLayers(a,!0))},defaultLayers:function(a){return"antarctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic",!1)}]:"antarctic_laea"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic_laea",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic_laea",!1)}]:"arctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("arctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("arctic",!1)}]:"southgeorgia"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("southgeorgia",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("southgeorgia",!1)}]:"midlatitudes"==a?[{id:null,name:"OpenStreetMap",expanded:!0,layers:this.getBaseLayers("midlatitudes",!1)}]:[]},getBaseLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_hillshade_and_bathymetry",is_base:!0},b)]:"antarctic_laea"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:hillshade_and_bathymetry",is_base:!0},b)]:"arctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"southgeorgia"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"midlatitudes"==a?[magic.modules.Endpoints.getMidLatitudeCoastSource(b)]:[]},getTopoLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_coastline"},b),this.layerSpecification("Sub-Antarctic coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:sub_antarctic_coastline"},b)]:"antarctic_laea"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:coastline"},b)]:"arctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_coastline"},b)]:"southgeorgia"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_coastline"},b),this.layerSpecification("Surface",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_surface"},b)]:[]},layerSpecification:function(a,b,c){return jQuery.extend({id:null,name:a,is_visible:!0},c?b:{source:b})},headingFromTrackGeometry:function(a){var b=0,c=a.getCoordinates();if(jQuery.isArray(c)&&c.length>=2){var d=c[c.length-2],e=c[c.length-1],f=new Vector(e[0]-d[0],e[1]-d[1]),g=new Vector(0,1);b=Math.acos(f.unit().dot(g))}return b},getGeometryType:function(a){var b="point";return a instanceof ol.geom.LineString||a instanceof ol.geom.MultiLineString?b="line":a instanceof ol.geom.Polygon||a instanceof ol.geom.MultiPolygon?b="polygon":a instanceof ol.geom.GeometryCollection&&(b="collection"),b},formatCoordinate:function(a,b,c,d){var e=null;if(d||0==d||(d=4),this.validCoordinate(a,"lat"==c,!1)){var f=this.toDecDegrees(a);if(isNaN(f))e=a;else switch(f=parseFloat(f.toFixed(d)),b){case"dms":e=this.toDMS(f,c,"dms");break;case"ddm":e=this.toDDM(f,c);break;default:e=f}}else e=a;return e},toDMS:function(a,b){var c="";if("lon"==b){var d=[a,.1],e=ol.coordinate.toStringHDMS(d),f="N";c=e.substring(e.indexOf(f)+2)}else{var d=[0,a],e=ol.coordinate.toStringHDMS(d),f=a<0?"S":"N";c=e.substring(0,e.indexOf(f)+1)}return c},toDDM:function(a,b){var c="",d=this.toDMS(a,b),e=d.split(/[^A-Za-z0-9.]+/);if(4==e.length){var f=parseFloat(e[1])+parseFloat(e[2]/60);c=e[3]+e[0]+" "+f.toFixed(3)}return c},toDecDegrees:function(a){var b=a;if(!jQuery.isNumeric(a)){b=Number.NaN,a=a.trim().toUpperCase();var c="X",d=0,e=0,f=0,g=a.charAt(0),h=a.charAt(a.length-1);if("N"==g||"S"==g||"E"==g||"W"==g?(c=g,a=a.substring(1)):"N"!=h&&"S"!=h&&"E"!=h&&"W"!=h||(c=h,a=a.substring(0,a.length-1)),"X"!=c){a=a.replace(/[^0-9.]{1,}/g," "),a=a.trim();var i=a.split(" ");d=parseFloat(i[0]),i.length>1&&(e=parseFloat(i[1])),i.length>2&&(f=parseFloat(i[2])),b=(d+e/60+f/3600)*("S"==c||"W"==c?-1:1)}}return isNaN(b)?Number.NaN:parseFloat(b)},validCoordinate:function(a,b,c){var d=!1;if(!a&&c)d=!0;else{var e=b?-90:-180,f=b?90:180,g=this.toDecDegrees(a);isNaN(g)||(d=magic.modules.Common.floatInRange(g,e,f,1e-8))}return d},validHemisphere:function(a){return 1==a.length&&a.match(/N|E|S|W|n|e|s|w/)},formatSpatial:function(a,b,c,d,e){if(!jQuery.isNumeric)return"";e||0==e||(e=1);var f=a;if(d!=c){var g={m:1,ft:3.2808399,km:.001,mi:.000621371192,nm:.000539956803};if(a=parseFloat(a),"m"!=d)for(var h=0;h<b;h++)a*=1/g[d];if("m"!=c)for(var h=0;h<b;h++)a*=g[c];f=a.toFixed(e)+c}else f+=c;return f},formatBbox:function(a,b){if(!a)return"";b||0==b||(b=1);var c=jQuery.map(a,function(a){return a}),d=["minx","miny","maxx","maxy"],e=[];return jQuery.each(c,function(a,c){e.push(d[a]+" : "+parseFloat(c).toFixed(b))}),e.join("<br>")},bufferExtent:function(a,b){var c=a.slice(0);b=b||1e4;var d=[.5*(a[2]-a[0]),.5*(a[3]-a[1])];return a[2]-a[0]<b&&(c[0]=d[0]-.5*b,c[2]=d[0]+.5*b),a[3]-a[1]<b&&(c[1]=d[1]-.5*b,c[3]=d[1]+.5*b),c},formatProjection:function(a){var b=a.split(":").pop();return!isNaN(parseInt(b))&&(b<32768||102020==b)?'<a href="https://epsg.io/?q='+b+'" target="_blank">'+a+"</a>":a},applyPref:function(a,b,c,d,e){var f=b;if(null==b||void 0==b)return"";switch(c||"coordinates"!=a||(c="lon"),d||(d=magic.runtime.preferences[a]),e||"distance"!=a&&"area"!=a&&"elevation"!=a||(e="m"),a){case"coordinates":f=this.formatCoordinate(b,d,c);break;case"distance":f=this.formatSpatial(b,1,d,e,2);break;case"area":f=this.formatSpatial(b,2,d,e,2);break;case"elevation":f=this.formatSpatial(b,1,d,e,1)}return f},isPolarProjection:function(a){switch(a){case"EPSG:3031":case"EPSG:3995":case"EPSG:102020":return!0;default:return!1}},projectionLatLonExtent:function(a){var b=[];switch(a){case"EPSG:3031":b=[-180,-90,180,-50];break;case"EPSG:3995":b=[-180,60,180,90];break;case"EPSG:3762":b=[-50,-65,-18,-50];break;case"EPSG:102020":b=[-180,-89,180,-30];break;default:b=[-180,-85.06,180,85.06]}return b},withinExtent:function(a,b){return magic.modules.Common.floatInRange(a[0],b[0],b[2],this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatInRange(a[1],b[1],b[3],this.ANGULAR_TOLERANCE)},alongDateline:function(a,b){return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&(magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)||magic.modules.Common.floatsEqual(a,180,this.ANGULAR_TOLERANCE))},crossesDateline:function(a,b){return a>0&&b<0&&!magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)},atPole:function(a,b,c){var d=c?"S"==c?-90:90:-90;return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(a,d,this.ANGULAR_TOLERANCE)},isCircumpolar:function(a,b){return magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(b,180,this.ANGULAR_TOLERANCE)},geodesicLength:function(a,b){b=b||magic.runtime.map;for(var c=0,d=a.getCoordinates(),e=0,f=d.length-1;e<f;++e){var g=ol.proj.transform(d[e],b.getView().getProjection().getCode(),"EPSG:4326"),h=ol.proj.transform(d[e+1],b.getView().getProjection().getCode(),"EPSG:4326");c+=this.WGS84.haversineDistance(g,h)}return c},geodesicArea:function(a,b){var c=a.clone().transform(b.getView().getProjection().getCode(),"EPSG:4326");return Math.abs(this.WGS84.geodesicArea(c.getLinearRing[0].getCoordinates()))},uniteExtents:function(a){if(!a||jQuery.isArray(a)&&0==a.length)return null;for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)b=null==b?a[f][0]:Math.min(b,a[f][0]),c=null==c?a[f][1]:Math.min(c,a[f][1]),d=null==d?a[f][2]:Math.max(d,a[f][2]),e=null==e?a[f][3]:Math.max(e,a[f][3]);return[b,c,d,e]},extentFromWgs84Extent:function(a,b){if(!b){if(!magic.runtime.map)return a;b=magic.runtime.map.getView().getProjection().getCode()}var c=[],d=null,e=a[0],f=a[1],g=a[2],h=a[3],i=ol.proj.get("EPSG:4326");if(this.isCircumpolar(e,g)){var j=new ol.geom.Point([0,h]);j.transform(i,b);var k=j.getCoordinates()[1];d=[-k,-k,k,k]}else{this.crossesDateline(e,g)?(c.push([e,f,180,h]),c.push([-180,f,g,h])):c.push([e,f,g,h]);for(var l=0;l<c.length;l++){var m=this.densify(c[l]);m.transform(i,b),null==d?d=m.getExtent():d.extend(m.getExtent())}}return d},densify:function(a){for(var b=[],c=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]],d=0;d<c.length;d++)for(var e=(d+1)%4,f=parseFloat(c[e][0]-c[d][0]),g=parseFloat(c[e][1]-c[d][1]),h=0;h<=this.N_INTERP;h++){var i=parseFloat(h)/parseFloat(this.N_INTERP+1);b.push([parseFloat(c[d][0])+i*f,parseFloat(c[d][1])+i*g])}return new ol.geom.Polygon([b],"XY")},getCurrentMapScale:function(a){a=a||magic.runtime.map;var b=a.getView().getResolution(),c=a.getView().getProjection().getUnits(),d=25.4/.28,e=ol.proj.METERS_PER_UNIT[c],f=b*e*39.37*d;return parseFloat(f)},getResolutionFromScale:function(a,b,c){if(!(b&&c||magic.runtime.map))return 0;b=b||magic.runtime.map.getView().getResolutions(),c=c||magic.runtime.map.getView().getProjection();var d=b[0];if(!isNaN(a)){var e=c.getUnits(),f=25.4/.28,g=ol.proj.METERS_PER_UNIT[e];d=parseFloat(a)/(39.37*g*f)}return d},headingWrtTrueNorth:function(a,b){var c=a.getCoordinates(),d=new Vector(c[0],c[1]),e=new ol.geom.Point([0,1]),f=new Vector(e.x,e.y),g=d.unit().dot(f);return(b-180*Math.acos(g)/Math.PI)%360}}}(),magic.modules.VectorStyles=function(){function a(a){var b=null;return jQuery.each(a,function(a,c){if(magic.modules.Common.isNameLike(a))return b=c,!1}),b}function b(b){return function(){var d=a(this.getProperties()),e=new ol.style.Style({image:new ol.style.Icon({scale:.8,anchor:[.5,1],src:magic.config.paths.cdn+"/images/map-markers/marker_"+b+".png"})});return null!=d&&e.setText(new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,offsetY:-10,text:d,textAlign:"left",fill:new ol.style.Fill({color:magic.modules.Common.rgbToDec(c[b],0)}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})),[e]}}var c={red:"#f20000",orange:"#ff776b",green:"#5af23f",gold:"#ffd700",gray:"#777777"};return{bas_aircraft:function(a){return function(){var b=this.getProperties(),c=b.callsign||"unknown aircraft",d=b.speed||0,e=b.heading||0,f=new Date(b.utc).getTime(),g=(new Date).getTime(),h=parseFloat(g-f)/36e5,i=d>=10&&h<=1?"green":"red",j=!("EPSG:4326"==a||"EPSG:3857"==a),k=j?magic.modules.GeoUtils.headingWrtTrueNorth(this.getGeometry(),e):e;return[new ol.style.Style({image:new ol.style.Icon({rotateWithView:j,rotation:magic.modules.Common.toRadians(k),src:magic.config.paths.cdn+"/images/asset-symbols/airplane_"+i+"_roundel.png"}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:c,textAlign:"left",fill:new ol.style.Fill({color:"red"==i?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},bas_ship:function(a){return function(){var a=this.getProperties(),b=a.callsign||"unknown ship",c=a.speed||0,d=c>0?"green":"red",e=a.heading||0;return[new ol.style.Style({image:new ol.style.Icon({rotateWithView:!0,rotation:e,src:magic.config.paths.cdn+"/images/asset-symbols/ship_"+d+"_roundel.png"}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:b,textAlign:"left",fill:new ol.style.Fill({color:"red"==d?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},comnap_asset:function(){return function(){for(var a=[],b=this.getProperties(),c=b.name||"unknown asset",d=b.speed||0,e=d>0?"green":"red",f=0,g=this.getGeometry().getGeometries(),h=0;h<g.length;h++){var i=magic.modules.GeoUtils.getGeometryType(g[h]);"line"==i&&(f=magic.modules.GeoUtils.headingFromTrackGeometry(g[h]))}var j="unknown";switch(b.type.toLowerCase()){case"ship":j="ship";break;case"aeroplane":j="airplane";break;case"helicopter":j="helicopter"}"unknown asset"!=c&&b.description&&(c=b.description+" ("+c+")");for(var k=magic.config.paths.cdn+"/images/asset-symbols/"+j+"_"+e+"_roundel.png",h=0;h<g.length;h++){var i=magic.modules.GeoUtils.getGeometryType(g[h]);"point"==i?a.push(new ol.style.Style({geometry:g[h],image:new ol.style.Icon({rotateWithView:!0,rotation:f,src:k}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:c,textAlign:"left",fill:new ol.style.Fill({color:"red"==e?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})):a.push(new ol.style.Style({geometry:g[h],fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})}))}return a}},antarctic_facility:function(){return function(){var a=this.getProperties(),b="rgba(255, 0, 0, 0.4)";return a.current_status&&"seasonal"!=a.current_status.toLowerCase()||(b="rgba(255, 255, 255, 0.8)"),[new ol.style.Style({image:new ol.style.Circle({radius:4.5,fill:new ol.style.Fill({color:b}),stroke:new ol.style.Stroke({color:"rgba(255, 0, 0, 1.0)",width:1.5})}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:7,text:a.facility_name,textAlign:"left",fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},bas_field_party:function(){return function(){var a=this.getProperties(),b=a.rgba||"rgba(255, 0, 0, 1.0)",c=b.replace("1.0)","0.0)");return[new ol.style.Style({image:new ol.style.RegularShape({rotateWithView:!0,rotation:0,points:3,radius:6,fill:new ol.style.Fill({color:b}),stroke:new ol.style.Stroke({color:b})}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:a.sledge,textAlign:"left",fill:new ol.style.Fill({color:c}),stroke:new ol.style.Stroke({color:c})})})]}},red_map_pin:function(){return b("red")},orange_map_pin:function(){return b("orange")},green_map_pin:function(){return b("green")},gold_map_pin:function(){return b("gold")},gray_map_pin:function(){return b("gray")}}}(),magic.classes.AssetPositionButton=function(a,b,c){this.name=a,this.ribbon=b,this.title=(c.title||"Asset")+" positions",this.iconClass=c.iconClass||"fa fa-circle",this.inactiveTitle="Show latest "+this.title+" positions",this.activeTitle="Hide "+this.title+" positions",this.active=!1,this.timer=null,this.geoJson=null,this.layer=null,this.insetLayer=null,this.data={inside:[],outside:[]},this.attribute_map=[{name:"name",alias:"Name",displayed:!0},{name:"longitude",alias:"Longitude",displayed:!0},{name:"latitude",alias:"Latitude",displayed:!0}],this.btn=jQuery("<button>",{id:"btn-"+this.name,class:"btn btn-default ribbon-middle-tool","data-toggle":"tooltip","data-placement":"bottom",title:this.inactiveTitle,html:'<span class="'+this.iconClass+'"></span>'}),this.btn.on("click",jQuery.proxy(function(){this.isActive()?this.deactivate():this.activate()},this)),jQuery(document).on("insetmapopened",jQuery.proxy(function(a){if(magic.runtime.inset&&(this.insetLayer=new ol.layer.Vector({name:this.title+"_inset",visible:this.isActive(),source:new ol.source.Vector({features:[]}),metadata:{is_interactive:!0,attribute_map:this.attribute_map}}),magic.runtime.inset.addLayer(this.insetLayer),this.data.outside.length>0)){var b=jQuery.map(this.data.outside,function(a){return a.clone()});this.insetLayer.getSource().addFeatures(b)}},this)),jQuery(document).on("insetmapclosed",jQuery.proxy(function(a){this.insetLayer=null},this))},magic.classes.AssetPositionButton.prototype.getButton=function(){return this.btn},magic.classes.AssetPositionButton.prototype.isActive=function(){return this.active},magic.classes.AssetPositionButton.prototype.activate=function(){this.active=!0,this.timer=window.setInterval(jQuery.proxy(this.getData,this),6e5),this.geoJson||(this.geoJson=new ol.format.GeoJSON({geometryName:"geom"})),this.layer?this.layer.setVisible(!0):(this.layer=new ol.layer.Vector({name:this.title,visible:!0,source:new ol.source.Vector({features:[]}),metadata:{is_interactive:!0,attribute_map:this.attribute_map}}),this.layer.setZIndex(500),magic.runtime.map.addLayer(this.layer)),this.insetLayer&&this.insetLayer.setVisible(!0),this.getData(),this.btn.toggleClass("active"),this.btn.attr("data-original-title",this.activeTitle).tooltip("fixTitle")},magic.classes.AssetPositionButton.prototype.deactivate=function(){this.active=!1,null==this.timer&&(window.clearInterval(this.timer),this.timer=null),this.layer.setVisible(!1),this.insetLayer&&(this.insetLayer.setVisible(!1),this.insetLayer.getSource().clear()),jQuery.isFunction(magic.runtime.layer_visibility_change_callback)&&magic.runtime.layer_visibility_change_callback(),this.btn.toggleClass("active"),this.btn.attr("data-original-title",this.inactiveTitle).tooltip("fixTitle"),magic.runtime.inset.deactivate()},magic.classes.AssetPositionButton.prototype.getData=function(){},magic.classes.CustomFormInput=function(a){this.id=a.id,this.tipText=a.tipText,this.tipPosition=a.tipPosition,this.defaultValue=a.defaultValue,this.required=a.required,this.element=jQuery("#"+this.id)},magic.classes.CustomFormInput.prototype.getElement=function(){return this.element},magic.classes.DemAwareTool=function(a){this.id=a.id,this.map=a.map||magic.runtime.map,this.demLayers=this.getDemLayers(),this.units="m",this.target=a.target||null,this.activeTooltip="Deactivate tool",this.inactiveTooltip="Activate tool"},magic.classes.DemAwareTool.prototype.getUnits=function(){return this.units},magic.classes.DemAwareTool.prototype.setUnits=function(a){this.units=a},magic.classes.DemAwareTool.prototype.getTarget=function(){return this.target},magic.classes.DemAwareTool.prototype.setTarget=function(a,b,c){this.target=jQuery("#"+a),this.activeTooltip=b||"Deactivate tool",this.inactiveTooltip=c||"Activate tool"},magic.classes.DemAwareTool.prototype.getDemLayers=function(){var a=[];return this.map&&this.map.getLayers().forEach(function(b){var c=b.get("metadata");c&&c.source&&!0===c.source.is_dem&&a.push(b)}),a},magic.classes.DemAwareTool.prototype.currentlyVisibleDems=function(){var a=[];return this.demLayers.length>0&&(a=jQuery.map(this.demLayers,function(a,b){if(a.getVisible())return a.get("metadata").source.feature_name})),a},magic.classes.DemAwareTool.prototype.queryElevation=function(a,b,c){var d=a.coordinate,e=this.getGfiUrl(d);e&&jQuery.ajax({url:magic.modules.Common.proxyUrl(e),method:"GET"}).done(jQuery.proxy(function(a){var c=ol.proj.transform(d,this.map.getView().getProjection().getCode(),"EPSG:4326"),e=magic.modules.GeoUtils.applyPref("coordinates",parseFloat(c[0]).toFixed(2),"lon"),f=magic.modules.GeoUtils.applyPref("coordinates",parseFloat(c[1]).toFixed(2),"lat"),g=this.getDemValue(a);b(d,e,f,g)},this)).fail(jQuery.proxy(function(a){c(d,a)},this))},magic.classes.DemAwareTool.prototype.getGfiUrl=function(a){var b=null,c=this.currentlyVisibleDems();return c.length>0&&(b=this.demLayers[0].getSource().getGetFeatureInfoUrl(a,this.map.getView().getResolution(),this.map.getView().getProjection().getCode(),{LAYERS:c.join(","),QUERY_LAYERS:c.join(","),INFO_FORMAT:"application/json",FEATURE_COUNT:this.demLayers.length})),b},magic.classes.DemAwareTool.prototype.getDemValue=function(a){var b=Number.NaN;return jQuery.isArray(a.features)&&a.features.length>0&&jQuery.each(a.features,function(a,c){c.properties&&jQuery.each(c.properties,function(a,c){var d=parseFloat(c);!isNaN(d)&&Math.abs(d)<9e3&&(isNaN(b)||d>b)&&(b=Math.ceil(d))})}),b},magic.classes.MapControlButton=function(a){this.name=a.name,this.ribbon=a.ribbon,this.inactiveTitle=a.inactiveTitle,this.activeTitle=a.activeTitle,this.activeBtnClass=a.activeBtnClass,this.inactiveBtnClass=a.inactiveBtnClass,this.startActive=!0===a.startActive||!1,this.map=a.map||magic.runtime.map,this.onActivate=a.onActivate,this.onDeactivate=a.onDeactivate,this.active=this.startActive,this.btn=jQuery("<button>",{id:"btn-"+this.name,class:"btn btn-default ribbon-middle-tool"+(this.startActive?" active":""),"data-toggle":"tooltip","data-placement":"bottom",title:this.startActive?this.activeTitle:this.inactiveTitle,html:'<span class="'+(this.startActive?this.activeBtnClass:this.inactiveBtnClass)+'"></span>'}),this.btn.on("click",jQuery.proxy(function(){this.isActive()?this.deactivate():this.activate()},this))},magic.classes.MapControlButton.prototype.getButton=function(){return this.btn},magic.classes.MapControlButton.prototype.isActive=function(){return this.active},magic.classes.MapControlButton.prototype.activate=function(){this.active=!0,this.btn.addClass("active"),this.btn.children("span").removeClass(this.inactiveBtnClass).addClass(this.activeBtnClass),this.btn.attr("data-original-title",this.activeTitle).tooltip("fixTitle"),jQuery.isFunction(this.onActivate)&&this.onActivate()},magic.classes.MapControlButton.prototype.deactivate=function(){this.active=!1,this.btn.removeClass("active"),this.btn.children("span").removeClass(this.activeBtnClass).addClass(this.inactiveBtnClass),this.btn.attr("data-original-title",this.inactiveTitle).tooltip("fixTitle"),jQuery.isFunction(this.onDeactivate)&&this.onDeactivate()},magic.classes.NavigationBarTool=function(a){this.id=a.id,this.target=jQuery("#"+a.target),this.caption=a.caption||"Untitled",this.popoverClass=a.popoverClass||"",this.popoverContentClass=a.popoverContentClass||"",this.layername=a.layername,this.map=a.map||magic.runtime.map,this.active=!1,null==this.layername?this.layer=null:this.layer=new ol.layer.Vector({name:this.layername,visible:!1,source:new ol.source.Vector({features:[]}),style:null,metadata:{}}),this.controlCallbacks={},this.layerAdded=!1,this.template='<div class="popover popover-auto-width'+(this.popoverClass?" "+this.popoverClass:"")+'" role="popover"><div class="arrow"></div><h3 class="popover-title">'+this.caption+'</h3><div class="popover-content'+(this.popoverContentClass?" "+this.popoverContentClass:"")+'"></div></div>'},magic.classes.NavigationBarTool.prototype.getTarget=function(){return this.target},magic.classes.NavigationBarTool.prototype.getTemplate=function(){return this.template},magic.classes.NavigationBarTool.prototype.isActive=function(){return this.active},magic.classes.NavigationBarTool.prototype.titleMarkup=function(){return"<span><big><strong>"+this.caption+'</strong></big><button type="button" class="close dialog-deactivate" style="margin-left:5px">&times;</button><button type="button" class="close dialog-minimise" data-toggle="tooltip" data-placement="bottom" title="Minimise pop-up to see the map better - does not reset dialog"><i class="fa fa-caret-up"></i></button></span>'},magic.classes.NavigationBarTool.prototype.setCallbacks=function(a){this.controlCallbacks=a},magic.classes.NavigationBarTool.prototype.assignCloseButtonHandler=function(){jQuery("."+this.popoverClass).find("button.dialog-deactivate").click(jQuery.proxy(function(){this.deactivate()},this)),jQuery("."+this.popoverClass).find("button.dialog-minimise").click(jQuery.proxy(function(){jQuery.isFunction(this.controlCallbacks.onMinimise)&&this.controlCallbacks.onMinimise(),this.target.popover("hide")},this))},magic.classes.NavigationBarTool.prototype.activate=function(){null==this.layer||this.layerAdded||(this.map.addLayer(this.layer),this.layer.setZIndex(1e3),this.layerAdded=!0),this.interactsMap()&&jQuery(document).trigger("mapinteractionactivated",[this]),this.active=!0,null!=this.layer&&this.layer.setVisible(!0),this.assignCloseButtonHandler(),jQuery.isFunction(this.controlCallbacks.onActivate)&&this.controlCallbacks.onActivate()},magic.classes.NavigationBarTool.prototype.deactivate=function(){this.active=!1,null!=this.layer&&(this.layer.getSource().clear(),this.layer.setVisible(!1)),this.interactsMap()&&jQuery(document).trigger("mapinteractiondeactivated",[this]),jQuery.isFunction(this.controlCallbacks.onDeactivate)&&this.controlCallbacks.onDeactivate()},magic.classes.NavigationBarTool.prototype.infoLinkButtonMarkup=function(a){return'<div style="display:inline-block;float:right"><a href="JavaScript:void(0)" class="fa fa-info-circle further-info" data-toggle="tooltip" data-placement="bottom" title="'+a+'">&nbsp;<span class="fa fa-caret-down"></span></a></div>'},magic.classes.NavigationBarTool.prototype.infoAreaMarkup=function(){return'<div id="'+this.id+'-further-info" class="alert alert-info hidden"></div>'},magic.classes.NavigationBarTool.prototype.infoButtonHandler=function(a,b){jQuery("a.further-info").click(jQuery.proxy(function(c){var d=jQuery("#"+this.id+"-further-info");d.toggleClass("hidden"),d.hasClass("hidden")?(jQuery(c.currentTarget).children("span").removeClass("fa-caret-up").addClass("fa-caret-down"),jQuery(c.currentTarget).attr("data-original-title","Show "+a).tooltip("fixTitle")):(d.html(b),jQuery(c.currentTarget).children("span").removeClass("fa-caret-down").addClass("fa-caret-up"),jQuery(c.currentTarget).attr("data-original-title","Hide "+a).tooltip("fixTitle"))},this))},magic.classes.NavigationBarTool.prototype.formatErrors=function(a){var b="";for(var c in a)b+="<p>"+c+" - "+a[c]+"</p>";return b},magic.classes.PopupForm=function(a){this.id=a.id,this.target=jQuery("#"+a.target),this.caption=a.caption||"Popup edit form",this.popoverClass=a.popoverClass||"",this.popoverContentClass=a.popoverContentClass||"",this.prePopulator=a.prePopulator||{},this.subForms={},this.active=!1,this.controlCallbacks={onActivate:jQuery.proxy(function(a){this.prePopulator=a,this.target.popover("show")},this),onDeactivate:jQuery.proxy(function(a){!a&&this.formDirty()?bootbox.confirm({message:"Unsaved edits - save before closing?",buttons:{confirm:{label:"Yes",className:"btn-success"},cancel:{label:"No",className:"btn-danger"}},callback:jQuery.proxy(function(a){a?jQuery.isFunction(this.saveForm)&&(jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(a,b){jQuery.isFunction(b.saveForm)&&b.saveForm()}),this.saveForm()):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)}):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)},this.formEdited=!1,this.clearState(),this.template='<div class="popover popover-auto-width'+(this.popoverClass?" "+this.popoverClass:"")+'" role="popover"><div class="arrow"></div><h3 class="popover-title">'+this.caption+'</h3><div class="popover-content'+(this.popoverContentClass?" "+this.popoverContentClass:"")+'"></div></div>'},magic.classes.PopupForm.prototype.getFormValue=function(){return this.savedState},magic.classes.PopupForm.prototype.getTarget=function(){return this.target},magic.classes.PopupForm.prototype.getTemplate=function(){return this.template},magic.classes.PopupForm.prototype.getCaption=function(){return this.caption},magic.classes.PopupForm.prototype.setCaption=function(a){this.caption=a},magic.classes.PopupForm.prototype.isActive=function(){return this.active},magic.classes.PopupForm.prototype.titleMarkup=function(){return"<span><big><strong>"+this.caption+'</strong></big><button type="button" class="close dialog-deactivate" style="margin-left:5px">&times;</button></span>'},magic.classes.PopupForm.prototype.setCallbacks=function(a){this.controlCallbacks=a},magic.classes.PopupForm.prototype.assignCloseButtonHandler=function(){jQuery("."+this.popoverClass).find("button.dialog-deactivate").off("click").on("click",jQuery.proxy(function(){this.deactivate(!1)},this))},magic.classes.PopupForm.prototype.activate=function(a){this.active=!0,jQuery.isFunction(this.controlCallbacks.onActivate)&&this.controlCallbacks.onActivate(a)},magic.classes.PopupForm.prototype.deactivate=function(a){this.active=!1,jQuery.isFunction(this.controlCallbacks.onDeactivate)&&this.controlCallbacks.onDeactivate(a)},magic.classes.PopupForm.prototype.delayedDeactivate=function(a){setTimeout(jQuery.proxy(function(){this.deactivate(!0)},this),a)},magic.classes.PopupForm.prototype.clearState=function(){this.savedState={}},magic.classes.PopupForm.prototype.formDirty=function(){return this.formEdited},magic.classes.PopupForm.prototype.cleanForm=function(){this.formEdited=!1},magic.classes.PopupForm.prototype.tidyUp=function(a){jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(b,c){null!=c&&jQuery.isFunction(c.deactivate)&&c.deactivate(a)})},magic.classes.DragZoomButton=function(a,b){var c={name:a,ribbon:b,inactiveBtnClass:"fa fa-plus-square-o",activeBtnClass:"fa fa-arrows",inactiveTitle:"Zoom in by dragging a box on map",activeTitle:"Click to stop box drag mode",onActivate:jQuery.proxy(this.onActivate,this),onDeactivate:jQuery.proxy(this.onDeactivate,this)};magic.classes.MapControlButton.call(this,c),this.dragZoomInteraction=new ol.interaction.DragZoom({condition:ol.events.condition.always}),this.dragZoomInteraction.setActive(!1),magic.runtime.map.addInteraction(this.dragZoomInteraction)},magic.classes.DragZoomButton.prototype=Object.create(magic.classes.MapControlButton.prototype),magic.classes.DragZoomButton.prototype.constructor=magic.classes.DragZoomButton,magic.classes.DragZoomButton.prototype.onActivate=function(){this.dragZoomInteraction.setActive(!0)},magic.classes.DragZoomButton.prototype.onDeactivate=function(){this.dragZoomInteraction.setActive(!1)},magic.classes.FullScreenButton=function(a,b){var c={name:a,ribbon:b,inactiveBtnClass:"fa fa-arrows-alt",activeBtnClass:"fa fa-arrows-alt",inactiveTitle:"Full screen map",activeTitle:"Click or press ESC to exit full screen map",onActivate:jQuery.proxy(this.onActivate,this),onDeactivate:jQuery.proxy(this.onDeactivate,this)};magic.classes.MapControlButton.call(this,c),magic.runtime.map.addControl(new ol.control.FullScreen),jQuery("div.ol-full-screen.ol-unselectable.ol-control").css("display","none")},magic.classes.FullScreenButton.prototype=Object.create(magic.classes.MapControlButton.prototype),magic.classes.FullScreenButton.prototype.constructor=magic.classes.FullScreenButton,magic.classes.FullScreenButton.prototype.onActivate=function(){jQuery("div.ol-full-screen.ol-unselectable.ol-control").children("button").click()},magic.classes.FullScreenButton.prototype.onDeactivate=function(){jQuery("div.ol-full-screen.ol-unselectable.ol-control").children("button").click()},magic.classes.GeolocationButton=function(a,b,c){var d={name:a,ribbon:b,map:c,inactiveBtnClass:"fa fa-location-arrow",activeBtnClass:"fa fa-location-arrow",inactiveTitle:"Show my location",activeTitle:"Hide my location",onActivate:jQuery.proxy(this.onActivate,this),onDeactivate:jQuery.proxy(this.onDeactivate,this)};magic.classes.MapControlButton.call(this,d),this.marker=null,this.geolocation=null,this.deviceOrientation=null},magic.classes.GeolocationButton.prototype=Object.create(magic.classes.MapControlButton.prototype),magic.classes.GeolocationButton.prototype.constructor=magic.classes.GeolocationButton,magic.classes.GeolocationButton.prototype.onActivate=function(){null==this.marker&&(this.marker=new ol.Overlay({element:jQuery("#geolocation")[0],positioning:"center-center"}),this.map.addOverlay(this.marker)),null==this.geolocation?(this.geolocation=new ol.Geolocation({tracking:!0,trackingOptions:{enableHighAccuracy:!0},projection:this.map.getView().getProjection()}),this.geolocation.on("change:position",this.showLocation,this)):(this.geolocation.setTracking(!0),this.showLocation()),null==this.deviceOrientation?(this.deviceOrientation=new ol.DeviceOrientation({tracking:!0}),this.deviceOrientation.on("change:heading",this.showHeading,this)):(this.deviceOrientation.setTracking(!0),this.showHeading())},magic.classes.GeolocationButton.prototype.onDeactivate=function(){this.marker&&jQuery("#geolocation").addClass("hidden"),this.geolocation.setTracking(!1),this.deviceOrientation.setTracking(!1)},magic.classes.GeolocationButton.prototype.showLocation=function(){var a=this.geolocation.getPosition();if(a){var b=ol.proj.transform(a,this.map.getView().getProjection(),"EPSG:4326");magic.modules.GeoUtils.withinExtent(b,magic.modules.GeoUtils.projectionLatLonExtent(this.map.getView().getProjection()))?(jQuery("#geolocation").removeClass("hidden"),this.marker.setPosition(a),this.map.getView().setCenter(a),this.btn.attr("data-original-title",this.activeTitle).tooltip("fixTitle")):this.btn.attr("data-original-title","Your location is out of range of the map").tooltip("fixTitle")}},magic.classes.GeolocationButton.prototype.showHeading=function(){var a=this.deviceOrientation.getHeading(),b=jQuery("#geolocation")[0];b.style["-webkit-transform"]="rotate("+a+"rad)",b.style.transform="rotate("+a+"rad)"},magic.classes.GraticuleButton=function(a,b){var c={name:a,ribbon:b,startActive:!0,inactiveBtnClass:"fa fa-table",activeBtnClass:"fa fa-table",inactiveTitle:"Show graticule",activeTitle:"Hide graticule",onActivate:jQuery.proxy(this.onActivate,this),onDeactivate:jQuery.proxy(this.onDeactivate,this)};magic.classes.MapControlButton.call(this,c),this.graticule=null,this.graticuleLayer=null;var d=this.map.getView().getProjection(),e=d.getCode(),f=magic.modules.GeoUtils.projectionLatLonExtent(e);if(magic.modules.GeoUtils.isPolarProjection(e)){if(!this.graticuleLayer){for(var g=null,h=magic.modules.Endpoints.getEndpointsBy("srs",e),i=0;i<h.length;i++)if(h[i].graticule_layer){g=h[i];break}if(g){var j=new ol.source.ImageWMS({url:magic.modules.Endpoints.getOgcEndpoint(g.url,"wms"),params:{LAYERS:g.graticule_layer},projection:d}),k=this.map.getView().getResolutions();this.graticuleLayer=new ol.layer.Image({name:"automated_graticule_layer",visible:!0,source:j,minResolution:k[k.length-1],maxResolution:k[0]+1}),this.map.addLayer(this.graticuleLayer),this.graticuleLayer.setZIndex(199)}else alert("No endpoint exports a graticule layer - none therefore available")}}else this.graticule||(d.setWorldExtent(f),d.setExtent(f),this.graticule=new ol.Graticule({showLabels:!0})),this.graticule.setMap(this.map)},magic.classes.GraticuleButton.prototype=Object.create(magic.classes.MapControlButton.prototype),magic.classes.GraticuleButton.prototype.constructor=magic.classes.GraticuleButton,magic.classes.GraticuleButton.prototype.onActivate=function(){this.graticule?this.graticule.setMap(this.map):this.graticuleLayer&&this.graticuleLayer.setVisible(!0)},magic.classes.GraticuleButton.prototype.onDeactivate=function(){this.graticule?this.graticule.setMap(null):this.graticuleLayer&&this.graticuleLayer.setVisible(!1)},magic.classes.ResetRotationButton=function(a,b){var c={name:a,ribbon:b,inactiveBtnClass:"fa fa-repeat",activeBtnClass:"fa fa-repeat",inactiveTitle:"Reset map rotation (shift-drag on map to start rotation)",activeTitle:"Reset map rotation (shift-drag on map to start rotation)"};magic.classes.MapControlButton.call(this,c),this.dragRotateZoomInteraction=new ol.interaction.DragRotateAndZoom,this.dragRotateZoomInteraction.setActive(!0),this.map.addInteraction(this.dragRotateZoomInteraction),this.originalRotation=this.map.getView().getRotation(),this.btn.addClass("disabled"),this.btn.off("click").on("click",jQuery.proxy(function(){this.map.getView().setRotation(this.originalRotation),this.btn.addClass("disabled")},this)),this.map.getView().on("change:rotation",jQuery.proxy(function(){this.btn.removeClass("disabled")},this))},magic.classes.ResetRotationButton.prototype=Object.create(magic.classes.MapControlButton.prototype),magic.classes.ResetRotationButton.prototype.constructor=magic.classes.ResetRotationButton,magic.classes.GazetteerSearchInput=function(a,b,c,d,e){this.LOCATIONS_API="https://api.bas.ac.uk/locations/v1/gazetteer",this.container=jQuery("#"+a),this.baseId=b||"geosearch",this.suggestionCallbacks=c||{},this.gazetteers=d||["cga"],this.minLength=e||4,this.searchSuggestions={},this.currentSearch=null,this.sources=null,this.gazetteerData={},jQuery.getJSON(this.LOCATIONS_API,jQuery.proxy(function(a){jQuery.map(a.data,jQuery.proxy(function(a){this.gazetteerData[a.gazetteer]=a},this)),this.sources=jQuery.map(this.gazetteers,jQuery.proxy(function(a){return{source:jQuery.proxy(function(b,c,d){jQuery.getJSON(this.LOCATIONS_API+"/"+a+"/"+b+"/brief",function(a){d(a.data)})},this),name:a,display:jQuery.proxy(function(b){return b.placename+(this.gazetteerData[a].composite?" ("+b.gazetteer+")":"")},this),limit:100,templates:{notFound:'<div class="suggestion-group-header">'+this.gazetteerData[a].title+'</div><p class="suggestion">No results</p>',header:'<div class="suggestion-group-header">'+this.gazetteerData[a].title+"</div>",suggestion:jQuery.proxy(function(b){var c=b.placename+(this.gazetteerData[a].composite?" ("+b.gazetteer+")":"");return this.searchSuggestions[c]=jQuery.extend({},b,{__gaz_name:a}),'<p class="suggestion">'+c+"</p>"},this)}}},this))},this))},magic.classes.GazetteerSearchInput.prototype.init=function(){jQuery("#"+this.baseId+"-ta").typeahead({minLength:this.minLength,highlight:!0},this.sources).on("typeahead:autocompleted",jQuery.proxy(this.selectHandler,this)).on("typeahead:selected",jQuery.proxy(this.selectHandler,this)).on("typeahead:render",jQuery.proxy(function(){jQuery.isFunction(this.suggestionCallbacks.mouseover)&&jQuery("p.suggestion").off("mouseover").on("mouseover",{suggestions:this.searchSuggestions},this.suggestionCallbacks.mouseover),jQuery.isFunction(this.suggestionCallbacks.mouseout)&&jQuery("p.suggestion").off("mouseout").on("mouseout",{suggestions:this.searchSuggestions},this.suggestionCallbacks.mouseout)},this)),jQuery("#"+this.baseId+"-placename-go").click(this.suggestionCallbacks.search)},magic.classes.GazetteerSearchInput.prototype.selectHandler=function(a,b){var c="";jQuery.each(this.searchSuggestions,function(a,d){if(d.id==b.id)return c=d.__gaz_name,!1});var d=jQuery.extend({},b,{__gaz_name:c});this.currentSearch=d,jQuery.isFunction(this.suggestionCallbacks.select)&&this.suggestionCallbacks.select(a,{suggestions:this.searchSuggestions})},magic.classes.GazetteerSearchInput.prototype.getSelection=function(){return this.currentSearch},magic.classes.GazetteerSearchInput.prototype.getSearch=function(a){return jQuery("#"+this.baseId+"-ta").val()},magic.classes.GazetteerSearchInput.prototype.setSearch=function(a){jQuery("#"+this.baseId+"-ta").val(a)},magic.classes.GazetteerSearchInput.prototype.markup=function(){return'<div class="form-group form-group-sm"><div class="input-group"><input id="'+this.baseId+'-ta" class="form-control typeahead border-lh-round" type="text" placeholder="Search for place-name" required="required" autofocus="true"></input><span class="input-group-btn"><button id="'+this.baseId+'-placename-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Search gazetteer"><span class="fa fa-search"></span></button></span></div></div>'},magic.classes.GazetteerSearchInput.prototype.getAttributions=function(){return jQuery.map(this.gazetteers,jQuery.proxy(function(a){return"<strong>"+this.gazetteerData[a].title+'</strong><p style="font-size:smaller">'+magic.modules.Common.linkify(this.gazetteerData[a].attribution+". "+this.gazetteerData[a].website)+"</p>"},this)).join("")},magic.classes.LayerEditorPopup=function(a){a=jQuery.extend({},{id:"layer-editor-popup-tool",caption:"Edit layer data",popoverClass:"layer-editor-popover",popoverContentClass:"layer-editor-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.inputs=["id","caption","description","allowed_usage","styledef"],this.subForms.styler=null,this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,trigger:"manual",content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(a){jQuery("#"+this.id+"-layer-caption").focus(),this.savedState={},this.assignCloseButtonHandler(),this.subForms.styler=new magic.classes.StylerPopup({target:this.id+"-layer-style-edit",onSave:jQuery.proxy(this.writeStyle,this)}),this.payloadToForm(this.prePopulator),this.assignHandlers(this.prePopulator),this.restoreState(),this.initDropzone()},this))},magic.classes.LayerEditorPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.LayerEditorPopup.prototype.constructor=magic.classes.LayerEditorPopup,magic.classes.LayerEditorPopup.prototype.markup=function(){return'<div id="'+this.id+'-edit-view-fs" class="col-sm-12 well well-sm"><input type="hidden" id="'+this.id+'-layer-id"></input><input type="hidden" id="'+this.id+'-layer-styledef"></input><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-layer-caption"><span class="label label-danger">Name</span></label><div class="col-sm-8"><input type="text" id="'+this.id+'-layer-caption" class="form-control" placeholder="Layer caption" maxlength="100" data-toggle="tooltip" data-placement="right" title="Layer name (required)" required="required"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-layer-description">Description</label><div class="col-sm-8"><textarea id="'+this.id+'-layer-description" class="form-control" style="height:8em !important" placeholder="Detailed layer description, purpose, content etc" data-toggle="tooltip" data-placement="right" title="Longer description of the layer"></textarea></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-layer-style-mode">Style</label><div class="form-inline col-sm-8"><select id="'+this.id+'-layer-style-mode" class="form-control" style="width:80%" data-toggle="tooltip" data-placement="top" title="Layer styling"><option value="default" default>Default</option><option value="file">Use style in file</option><option value="point">Point style</option><option value="line">Line style</option><option value="polygon">Polygon style</option></select><button id="'+this.id+'-layer-style-edit" style="width:20%" data-trigger="manual" data-container="body" data-toggle="popover" data-placement="left"  type="button" role="button"class="btn btn-sm btn-primary"><span class="fa fa-pencil"></span></button></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-layer-allowed_usage">Share</label><div class="col-sm-8"><select name="'+this.id+'-layer-allowed_usage" id="'+this.id+'-layer-allowed_usage" class="form-control" data-toggle="tooltip" data-placement="right" title="Sharing permissions"><option value="owner" default>no</option><option value="public">with everyone</option><option value="login">with logged-in users only</option></select></div></div><div id="publish-files-dz" class="dropzone col-sm-12"></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label">Modified</label><div class="col-sm-8"><p id="'+this.id+'-layer-last-mod" class="form-control-static"></p></div></div>'+magic.modules.Common.buttonFeedbackSet(this.id,"Publish layer","sm","Publish",!0)+"</div>"},magic.classes.LayerEditorPopup.prototype.assignHandlers=function(a){var b=jQuery("#"+this.id+"-layer-style-mode"),c=jQuery("#"+this.id+"-layer-style-edit");this.formEdited=!1,jQuery("#"+this.id+"-edit-view-fs :input").change(jQuery.proxy(function(){this.formEdited=!0},this)),b.change(jQuery.proxy(function(a){var b=jQuery(a.currentTarget).val();jQuery("#"+this.id+"-layer-styledef").val('{"mode":"'+b+'"}'),c.prop("disabled","file"==b||"default"==b)},this)),c.click(jQuery.proxy(function(a){var c=jQuery("#"+this.id+"-layer-styledef").val();"string"==typeof c?c=JSON.parse(c):c||(c={mode:b.val()||"default"}),this.subForms.styler.activate(c)},this)),jQuery("#"+this.id+"-cancel").click(jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this)),b.val("default"),c.prop("disabled",!0),a.styledef=this.subForms.styler.convertLegacyFormats(a.styledef);var d=a.styledef.mode;b.val(d),c.prop("disabled","predefined"==d||"default"==d||"file"==d)},magic.classes.LayerEditorPopup.prototype.writeStyle=function(a){a=a||{mode:"default"},jQuery("#"+this.id+"-layer-styledef").val(JSON.stringify(a))},magic.classes.LayerEditorPopup.prototype.saveForm=function(){jQuery("#"+this.id+"-go").trigger("click")},magic.classes.LayerEditorPopup.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.LayerEditorPopup.prototype.restoreState=function(){jQuery.isEmptyObject(this.savedState)||(this.payloadToForm(this.savedState),this.clearState())},magic.classes.LayerEditorPopup.prototype.formToPayload=function(){var a={},b=jQuery("#"+this.id+"-layer-style-mode").val();return jQuery.each(this.inputs,jQuery.proxy(function(c,d){a[d]="styledef"!=d||"default"!=b&&"file"!=b?jQuery("#"+this.id+"-layer-"+d).val():'{"mode": "'+b+'"}'},this)),a},magic.classes.LayerEditorPopup.prototype.payloadToForm=function(a){a=a||{};var b=this.subForms.styler.convertLegacyFormats(a.styledef);jQuery.each(this.inputs,jQuery.proxy(function(c,d){"styledef"==d?jQuery("#"+this.id+"-layer-"+d).val(JSON.stringify(b)):jQuery("#"+this.id+"-layer-"+d).val(a[d]||"")},this));var c=jQuery("#"+this.id+"-layer-last-mod");a.modified_date?(c.closest("div.form-group").removeClass("hidden"),c.text(magic.modules.Common.dateFormat(a.modified_date,"dmy"))):c.closest("div.form-group").addClass("hidden"),jQuery("#"+this.id+"-layer-style-mode").val(b.mode),jQuery("#"+this.id+"-layer-style-edit").prop("disabled","file"==b.mode||"default"==b.mode)},magic.classes.LayerEditorPopup.prototype.validate=function(){var a=!0,b=jQuery("#"+this.id+"-edit-view-fs");return jQuery.each(b.find("input[required='required']"),function(b,c){var d=jQuery(c),e=d.closest("div.form-group");d.prop("validity").valid?e.removeClass("has-error"):(e.addClass("has-error"),a=!1)}),a},magic.classes.LayerEditorPopup.prototype.destroyDropzone=function(){try{Dropzone.forElement("div#publish-files-dz").destroy()}catch(a){}},magic.classes.LayerEditorPopup.prototype.initDropzone=function(){var a=this,b=jQuery("#"+this.id+"-go");this.destroyDropzone(),new Dropzone("div#publish-files-dz",{url:magic.config.paths.baseurl+"/userlayers/save",paramName:"file",maxFilesize:100,uploadMultiple:!1,autoProcessQueue:!1,maxFiles:1,parallelUploads:1,previewTemplate:'<div class="row col-sm-12"><div class="row col-sm-12"><p class="name" data-dz-name style="font-weight:bold"></p></div><div class="row"><div class="col-sm-4"><p class="size" data-dz-size=""></p></div><div class="col-sm-6 publish-feedback"><div class="progress progress-striped active show" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div></div><div class="publish-feedback-msg hidden"></div></div><div class="col-sm-2"><button data-dz-remove class="btn btn-xs btn-danger publish-delete show"><i class="fa fa-trash-o"></i><span>&nbsp;Delete</span></button><button class="btn btn-xs btn-success publish-success hidden"><i class="fa fa-check"></i><span>&nbsp;Publish ok</span></button><button class="btn btn-xs btn-warning publish-error hidden"><i class="fa fa-times"></i><span>&nbsp;Publish failed</span></button></div></div><div class="row col-sm-12"><strong class="error text-danger" data-dz-errormessage></strong></div></div>',headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")},init:function(){this.on("complete",jQuery.proxy(function(a){var b=JSON.parse(a.xhr.responseText);b.status<400?(this.lep.cleanForm(),magic.modules.Common.buttonClickFeedback(this.lep.id,!0,b.detail),jQuery.isFunction(this.lep.controlCallbacks.onSave)&&this.lep.controlCallbacks.onSave(),this.lep.delayedDeactivate(2e3)):magic.modules.Common.showAlertModal("Failed to save user layer data - details : "+b.detail,"warning"),this.pfdz.removeAllFiles()},{pfdz:this,lep:a})),this.on("maxfilesexceeded",function(a){this.removeAllFiles(),this.addFile(a)}),this.on("addedfile",function(a){jQuery("div#publish-files-dz").find("p.name").html(a.name)}),this.on("error",jQuery.proxy(function(){window.setTimeout(jQuery.proxy(this.removeAllFiles,this),3e3)},this)),b.off("click").on("click",jQuery.proxy(function(){if(this.lep.validate()){var a=this.lep.formToPayload();jQuery.isArray(this.pfdz.files)&&0!=this.pfdz.files.length?(this.pfdz.on("sending",function(b,c,d){jQuery.each(a,function(a,b){d.append(a,b)})}),this.pfdz.processQueue()):a.id?jQuery.ajax({url:magic.config.paths.baseurl+"/userlayers/update/"+a.id,data:JSON.stringify(a),method:"POST",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")}}).done(jQuery.proxy(function(a){this.cleanForm(),magic.modules.Common.buttonClickFeedback(this.id,jQuery.isNumeric(a)||a.status<400,a.detail),jQuery.isFunction(this.controlCallbacks.onSave)&&this.controlCallbacks.onSave(),this.delayedDeactivate(2e3)},this.lep)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to save user layer data - details : "+b,"warning")}):magic.modules.Common.showAlertModal("No uploaded file found - please specify the data to upload","warning")}else magic.modules.Common.showAlertModal("Please correct the marked errors in your input and try again","error")},{pfdz:this,lep:a}))},accept:function(a,b){switch(a.type){case"text/csv":case"application/vnd.ms-excel":case"application/gpx+xml":case"application/vnd.google-earth.kml+xml":case"application/zip":case"application/x-zip-compressed":break;case"":if(null!=a.name.match(/\.gpx$/))a.type="application/gpx+xml";else{if(null==a.name.match(/\.kml$/))return void b(this.options.dictInvalidFileType);a.type="application/vnd.google-earth.kml+xml"}break;default:return void b(this.options.dictInvalidFileType)}b()},dictDefaultMessage:"Upload GPX, KML, CSV or zipped Shapefiles by dragging and dropping them here",dictInvalidFileType:"Not a GPX, KML, CSV or zipped Shapefile",dictFileTooBig:"File is too large ({{filesize}} bytes) - maximum size is {{maxFileSize}}",dictResponseError:"Publication failed - server responded with code {{statusCode}}",dictCancelUpload:"Cancel upload",dictCancelUploadConfirmation:"Are you sure?"})},magic.classes.MapEditorPopup=function(a){a=jQuery.extend({},{id:"map-editor-popup-tool",caption:"Edit map data",popoverClass:"map-editor-popover",popoverContentClass:"map-editor-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.inputs=["id","basemap","name","allowed_usage","data"],this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,trigger:"manual",content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(a){jQuery("#"+this.id+"-map-name").focus(),this.savedState={},this.assignCloseButtonHandler(),this.payloadToForm(this.prePopulator),this.assignHandlers(),this.restoreState()},this))},magic.classes.MapEditorPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.MapEditorPopup.prototype.constructor=magic.classes.MapEditorPopup,magic.classes.MapEditorPopup.prototype.markup=function(){return'<div id="'+this.id+'-edit-view-fs" class="col-sm-12 well well-sm"><input type="hidden" id="'+this.id+'-map-id"></input><input type="hidden" id="'+this.id+'-map-basemap"></input><input type="hidden" id="'+this.id+'-map-data"></input><div class="form-group form-group-sm col-sm-12"><label class="col-sm-3 control-label" for="'+this.id+'-map-name"><span class="label label-danger">Name</span></label><div class="col-sm-9"><input type="text" id="'+this.id+'-map-name" class="form-control" placeholder="Map name" maxlength="100" data-toggle="tooltip" data-placement="right" title="Map name (required)" required="required"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-3" for="'+this.id+'-map-allowed_usage">Share</label><div class="col-sm-9"><select id="'+this.id+'-map-allowed_usage" class="form-control" data-toggle="tooltip" data-placement="right" title="Sharing permissions"><option value="owner" default>no</option><option value="public">with everyone</option><option value="login">with logged-in users only</option></select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-3 control-label">Modified</label><div class="col-sm-9"><p id="'+this.id+'-map-last-mod" class="form-control-static"></p></div></div>'+magic.modules.Common.buttonFeedbackSet(this.id,"Save map state","sm","Save",!0)+"</div>"},magic.classes.MapEditorPopup.prototype.assignHandlers=function(){this.formEdited=!1,jQuery("#"+this.id+"-edit-view-fs :input").change(jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").click(jQuery.proxy(function(){if(this.validate()){var a=this.formToPayload();jQuery.ajax({url:magic.config.paths.baseurl+"/usermaps/"+(a.id?"update/"+a.id:"save"),data:JSON.stringify(a),method:"POST",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")}}).done(jQuery.proxy(function(a){this.cleanForm(),magic.modules.Common.buttonClickFeedback(this.id,jQuery.isNumeric(a)||a.status<400,a.detail),this.delayedDeactivate(2e3),jQuery.isFunction(this.controlCallbacks.onSave)&&this.controlCallbacks.onSave()},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to save user map - details : "+b,"warning")})}else magic.modules.Common.showAlertModal("Please correct the marked errors in your input and try again","error")},this)),jQuery("#"+this.id+"-cancel").click(jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.MapEditorPopup.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.MapEditorPopup.prototype.restoreState=function(){jQuery.isEmptyObject(this.savedState)||(this.payloadToForm(this.savedState),this.clearState())},magic.classes.LayerEditorPopup.prototype.saveForm=function(){jQuery("#"+this.id+"-go").trigger("click")},magic.classes.MapEditorPopup.prototype.formToPayload=function(){var a={};return jQuery.each(this.inputs,jQuery.proxy(function(b,c){a[c]=jQuery("#"+this.id+"-map-"+c).val()},this)),a},magic.classes.MapEditorPopup.prototype.payloadToForm=function(a){a=a||{},jQuery.each(this.inputs,jQuery.proxy(function(b,c){jQuery("#"+this.id+"-map-"+c).val(a[c])},this));var b=jQuery("#"+this.id+"-map-last-mod");a.modified_date?(b.closest("div.form-group").removeClass("hidden"),b.text(magic.modules.Common.dateFormat(a.modified_date,"dmy"))):b.closest("div.form-group").addClass("hidden")},magic.classes.MapEditorPopup.prototype.validate=function(){var a=!0,b=jQuery("#"+this.id+"-map-name");return!1===b[0].checkValidity()?(b.closest("div.form-group").addClass("has-error"),a=!1):b.closest("div.form-group").removeClass("has-error"),a},magic.classes.MapViewManagerForm=function(a){this.id=a.id||"map-manager",this.map=a.map||magic.runtime.map,this.mapData=null,this.baseMapOrder=[],this.editorPopups={add:null,edit:null},this.inputBaseNames=["id","basemap","name","allowed_usage","data"],this.controls={},this.savedState={}},magic.classes.MapViewManagerForm.prototype.init=function(){var a=jQuery.ajax({url:magic.config.paths.baseurl+"/maps/dropdown",method:"GET",dataType:"json",contentType:"application/json"});this.mapData={},this.baseMapOrder=[];var b=a.then(jQuery.proxy(function(a){return jQuery.each(a,jQuery.proxy(function(a,b){var c=b.name.split(":");this.mapData[c[1]]={sharing:c[0],title:b.title,views:[]},this.baseMapOrder.push(c[1])},this)),jQuery.ajax({url:magic.config.paths.baseurl+"/usermaps/data",method:"GET",dataType:"json"})},this));b.done(jQuery.proxy(function(a){jQuery.each(a,jQuery.proxy(function(a,b){this.mapData[b.basemap].views.push(b.id),this.mapData[b.id]=b},this)),this.mapMarkup(),this.assignHandlers(),this.hasSavedState()?this.restoreState():(this.setSelection(this.baseMapOrder[0]),this.setButtonStates(null))},this)),b.fail(function(){magic.modules.Common.showAlertModal("Failed to load available map views","error")})},magic.classes.MapViewManagerForm.prototype.markup=function(){return'<form id="'+this.id+'-form" class="form-horizontal" role="form" style="margin-top:10px"><input type="hidden" id="'+this.id+'-id"></input><input type="hidden" id="'+this.id+'-basemap"></input><input type="hidden" id="'+this.id+'-data"></input><div class="form-group form-group-sm col-sm-12"><strong>Available base maps and user views</strong></div><div class="btn-toolbar" style="margin-bottom:10px"><div class="btn-group" role="group"><button id="'+this.id+'-map-select" type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" style="width:180px">Select a map view&nbsp;&nbsp;<span class="caret"></span></button><ul id="'+this.id+'-maps" class="dropdown-menu"></ul></div><div class="btn-group" role="group"><button id="'+this.id+'-map-add" class="btn btn-sm btn-primary" type="button" data-toggle="popover" data-trigger="manual" data-placement="bottom"><i data-toggle="tooltip" data-placement="top" title="Save current map view" class="fa fa-star"></i></button><button type="button" class="btn btn-sm btn-warning" id="'+this.id+'-map-edit" data-toggle="popover" data-trigger="manual" data-placement="bottom"><i style="font-size:14px" data-toggle="tooltip" data-placement="top" title="Edit selected map view data" class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-danger" id="'+this.id+'-map-del"><i data-toggle="tooltip" data-placement="top" title="Delete selected map view" class="fa fa-trash"></i></button></div><div class="btn-group" role="group"><button id="'+this.id+'-map-bmk" class="btn btn-sm btn-primary" type="button"><i data-toggle="tooltip" data-placement="top" title="Bookmarkable URL for selected map view" class="fa fa-bookmark"></i></button><button id="'+this.id+'-map-load" class="btn btn-sm btn-primary" type="button"><i data-toggle="tooltip" data-placement="top" title="Load selected map view" class="fa fa-arrow-circle-right"></i></button></div></div><div class="checkbox" style="padding-top:0px"><label><input id="'+this.id+'-map-load-new-tab" type="checkbox" checked data-toggle="tooltip" data-placement="left" title="Load map in a new browser tab"></input> maps load in new browser tab</label></div></form>'},magic.classes.MapViewManagerForm.prototype.mapMarkup=function(){var a=jQuery("#"+this.id+"-maps");if(a.empty(),0==this.baseMapOrder.length)a.append('<li class="dropdown-header">No base maps or user views available</li>');else{var b=this.id;jQuery.each(this.baseMapOrder,jQuery.proxy(function(c,d){var e=this.mapData[d];a.append('<li data-pk="'+d+'"><a id="'+b+"-"+d+'-map-select" href="JavaScript:void(0)"><strong>'+e.title+"</strong></a></li>"),e.views.length>0&&(a.append('<li class="dropdown-header"><div style="margin-left:20px">Your views of '+e.title+"</div></li>"),jQuery.each(e.views,jQuery.proxy(function(c,d){a.append('<li data-pk="'+d+'"><a style="margin-left:20px" id="'+b+"-"+d+'-map-select" href="JavaScript:void(0)">'+this.mapData[d].name+"</a></li>")},this)))},this))}},magic.classes.MapViewManagerForm.prototype.setButtonStates=function(a){if(!a){var b=this.getSelection();a={load:!b,bmk:!b,add:!1,edit:!b,del:!b}}jQuery.each(this.controls.btn,function(b,c){a[b]?c.prop("disabled",!0):c.prop("disabled",!1)})},magic.classes.MapViewManagerForm.prototype.assignHandlers=function(){var a=jQuery("#"+this.id+"-form");this.controls={btn:{load:jQuery("#"+this.id+"-map-load"),bmk:jQuery("#"+this.id+"-map-bmk"),add:jQuery("#"+this.id+"-map-add"),edit:jQuery("#"+this.id+"-map-edit"),del:jQuery("#"+this.id+"-map-del")},cb:{newtab:jQuery("#"+this.id+"-map-load-new-tab")}},a.find("a[id$='-map-select']").off("click").on("click",jQuery.proxy(this.selectMap,this)),this.controls.btn.load.off("click").on("click",jQuery.proxy(function(){window.open(this.selectedMapLoadUrl(),this.controls.cb.newtab.prop("checked")?"_blank":"_self")},this)),this.controls.btn.bmk.off("click").on("click",jQuery.proxy(function(){bootbox.prompt({size:"small",title:"Bookmarkable URL",value:this.selectedMapLoadUrl(),callback:function(){}})},this)),this.controls.btn.add.off("click").on("click",jQuery.proxy(function(a){this.editorPopups.add=new magic.classes.MapEditorPopup({id:"map-add-popup-tool",caption:"Save current map view",target:a.currentTarget.id,onSave:jQuery.proxy(this.init,this)}),this.editorPopups.edit&&this.editorPopups.edit.deactivate();var b=this.mapData[this.getSelection()];this.editorPopups.add.activate({id:"",basemap:b.basemap||this.getSelection(),data:this.mapPayload()})},this)),this.controls.btn.edit.off("click").on("click",jQuery.proxy(function(a){this.editorPopups.edit=new magic.classes.MapEditorPopup({id:"map-edit-popup-tool",caption:"Edit selected map view",target:a.currentTarget.id,onSave:jQuery.proxy(this.init,this)}),this.editorPopups.add&&this.editorPopups.add.deactivate(),this.editorPopups.edit.activate(this.mapData[this.getSelection()])},this)),this.controls.btn.del.off("click").on("click",jQuery.proxy(function(){bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete this view?</div>',jQuery.proxy(function(a){if(a){var b=this.getSelection();jQuery.ajax({url:magic.config.paths.baseurl+"/usermaps/delete/"+b,method:"DELETE",beforeSend:function(a){a.setRequestHeader(jQuery("meta[name='_csrf_header']").attr("content"),jQuery("meta[name='_csrf']").attr("content"))}}).done(jQuery.proxy(this.init,this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to delete user map view - details : "+b,"warning")}),bootbox.hideAll()}else bootbox.hideAll()},this))},this))},magic.classes.MapViewManagerForm.prototype.selectMap=function(a){var b=null,c=a.currentTarget.id,d=jQuery("#"+c);if(d.length>0&&(b=d.closest("li").attr("data-pk")),null!=b&&""!=b){var e=this.mapData[b].basemap?this.mapData[b].name:this.mapData[b].title;d.closest(".dropdown-menu").prev().html(magic.modules.Common.ellipsis(e,20)+'&nbsp;&nbsp;<span class="caret"></span>'),this.setSelection(b),this.mapData[b].basemap?this.setButtonStates(null):this.setButtonStates({load:!1,bmk:!1,add:!1,edit:!0,del:!0})}},magic.classes.MapViewManagerForm.prototype.setSelection=function(a){this.currentSelection=a||null},magic.classes.MapViewManagerForm.prototype.getSelection=function(){return this.currentSelection},magic.classes.MapViewManagerForm.prototype.saveState=function(){this.savedState={selection:this.getSelection()}},magic.classes.MapViewManagerForm.prototype.restoreState=function(){this.savedState.selection&&(jQuery("#"+this.id+"-"+this.savedState.selection+"-map-select").trigger("click"),this.clearState())},magic.classes.MapViewManagerForm.prototype.clearState=function(){this.savedState={}},magic.classes.MapViewManagerForm.prototype.hasSavedState=function(){return!jQuery.isEmptyObject(this.savedState)&&this.savedState.selection},magic.classes.MapViewManagerForm.prototype.formDirty=function(){return this.formEdited},magic.classes.MapViewManagerForm.prototype.cleanForm=function(){this.formEdited=!1},magic.classes.MapViewManagerForm.prototype.populateAllowedUsage=function(a){if(this.userMapData[a]){var b=this.userMapData[a].basemap;if(this.baseMapData[b]){var c=this.baseMapData[b].sharing,d=jQuery("#"+this.id+"-allowed_usage");d.empty(),d.append(jQuery("<option>",{value:"owner",text:"no"})),"public"==c?d.append(jQuery("<option>",{value:"public",text:"with everyone"})):"owner"!=c&&d.append(jQuery("<option>",{value:"login",text:"with logged-in users only"})),d.val(this.userMapData[a].allowed_usage)}}},magic.classes.MapViewManagerForm.prototype.mapPayload=function(){var a={};return this.map&&(a.center=this.map.getView().getCenter(),a.zoom=parseInt(this.map.getView().getZoom()),a.rotation=this.map.getView().getRotation(),a.layers={},this.map.getLayers().forEach(function(b){if(b.get("metadata")){var c=b.get("metadata").id;c&&(a.layers[c]={visibility:b.getVisible(),opacity:b.getOpacity()})}}),a.groups={},jQuery("div[id^='layer-group-panel']").each(function(b,c){var d=c.id.replace("layer-group-panel-","");a.groups[d]=jQuery(c).hasClass("in")})),JSON.stringify(a)},magic.classes.MapViewManagerForm.prototype.selectedMapLoadUrl=function(){var a=this.getSelection();return this.mapData[a].basemap&&(a=this.mapData[a].basemap+"/"+a),magic.config.paths.baseurl+"/home/"+a},magic.classes.MultiSelectInput=function(a){a=jQuery.extend({},{tipText:"",tipPosition:"left",required:!1,defaultValue:""},a),magic.classes.CustomFormInput.call(this,a),this.tipText=this.tipText||this.element.data("original-title"),this.element.attr("multiple","multiple"),this.element.addClass("selectpicker"),this.element.selectpicker({iconBase:"fa",tickIcon:"fa-check"}),this.element.closest("div.bootstrap-select").tooltip({title:this.tipText,placement:this.tipPosition,container:"body"}),""==this.defaultValue?this.reset():this.setValue(this.defaultValue)},magic.classes.MultiSelectInput.prototype=Object.create(magic.classes.CustomFormInput.prototype),magic.classes.MultiSelectInput.prototype.constructor=magic.classes.MultiSelectInput,magic.classes.MultiSelectInput.prototype.reset=function(){this.element.selectpicker("deselectAll")},magic.classes.MultiSelectInput.prototype.setValue=function(a){a?(jQuery.isArray(a)||(a=a.split(",")),a.length>0&&this.element.selectpicker("val",a)):this.reset()},magic.classes.MultiSelectInput.prototype.getValue=function(a){return a?this.element.val():this.element.val().join(",")},magic.classes.MultiSelectInput.prototype.validate=function(){var a=this.element.closest("div.form-group"),b=!this.required||""!=this.getValue(!1);return b?a.removeClass("has-error"):a.addClass("has-error"),b},magic.classes.SeasonSelect=function(a,b,c,d,e){if(this.RECORD_START_YEAR=1976,this.SEASON_START_DAY="10-01",this.SEASON_END_DAY="03-31",this.container=jQuery("#"+a),this.baseId=b||"season",this.startYear=c||this.RECORD_START_YEAR,this.endYear=d||(new Date).getFullYear(),this.popoverWidth=e||400,this.container.empty(),this.container.append('<div class="form-inline"><div class="form-group form-group-sm"><select id="'+this.baseId+'-range" class="form-control" style="width:'+(this.popoverWidth-30)+'px"><option value="any" selected="selected">Any</option><option value="in">In</option><option value="before">Before</option><option value="after">After</option><option value="between">Between</option></select></div><div class="form-group form-group-sm hidden"><select id="'+this.baseId+'-start" class="form-control"></select></div><div class="form-group form-group-sm hidden"><label for="'+this.baseId+'-end" style="width:50px">&nbsp;&nbsp;and</label><select id="'+this.baseId+'-end" class="form-control"></select></div></div>'),this.rangeElt=jQuery("#"+this.baseId+"-range"),this.startElt=jQuery("#"+this.baseId+"-start"),this.endElt=jQuery("#"+this.baseId+"-end"),this.startElt.length>0){this.startElt.empty();for(var f=this.startYear;f<=this.endYear;f++){var g=jQuery("<option>",{value:f});g.text(f+"-"+(f+1+"").substr(2)),this.startElt.append(g)}}if(this.endElt.length>0){this.endElt.empty();for(var f=this.startYear;f<=this.endYear;f++){var g=jQuery("<option>",{value:f});g.text(f+"-"+(f+1+"").substr(2)),this.endElt.append(g)}}this.rangeElt.change(jQuery.proxy(function(a){this.rangeChanger(jQuery(a.currentTarget).val())},this))},magic.classes.SeasonSelect.prototype.rangeChanger=function(a,b,c){switch("any"==a?(this.startElt.closest("div").addClass("hidden"),this.endElt.closest("div").addClass("hidden"),this.rangeElt.css("width",this.popoverWidth-30+"px")):"between"==a?(this.rangeElt.css("width",.33*(this.popoverWidth-80)+"px"),this.startElt.closest("div").removeClass("hidden"),this.startElt.css("width",.33*(this.popoverWidth-80)+"px"),this.endElt.closest("div").removeClass("hidden"),this.endElt.css("width",.33*(this.popoverWidth-80)+"px")):(this.startElt.closest("div").removeClass("hidden"),this.rangeElt.css("width",.5*(this.popoverWidth-30)+"px"),this.startElt.css("width",.5*(this.popoverWidth-30)+"px"),this.endElt.closest("div").addClass("hidden")),a){case"between":this.startElt.val(b||this.startYear),this.endElt.val(c||this.endYear);break;case"before":this.startElt.val(b||this.endYear);break;case"after":case"in":this.startElt.val(b||this.startYear);break;default:this.startElt.val("any")}},magic.classes.SeasonSelect.prototype.payload=function(){var a={},b=this.rangeElt.val(),c=this.startElt.val(),d=this.endElt.val();switch(b){case"before":a.startdate=this.RECORD_START_YEAR+"-"+this.SEASON_START_DAY,a.enddate=c+"-"+this.SEASON_START_DAY;break;case"after":a.startdate=c+"-"+this.SEASON_END_DAY,a.enddate=this.endYear+"-"+this.SEASON_END_DAY;break;case"between":a.startdate=c+"-"+this.SEASON_START_DAY,a.enddate=d+"-"+this.SEASON_END_DAY;break;case"in":a.startdate=c+"-"+this.SEASON_START_DAY,a.enddate=c+"-"+this.SEASON_END_DAY;break;default:a.startdate=this.RECORD_START_YEAR+"-"+this.SEASON_START_DAY,a.enddate=this.endYear+"-"+this.SEASON_END_DAY}return a},magic.classes.SeasonSelect.prototype.reset=function(){this.rangeElt.val("any"),this.startElt.closest("div").addClass("hidden"),this.endElt.closest("div").addClass("hidden"),this.rangeElt.css("width",this.popoverWidth-30+"px")},magic.classes.SeasonSelect.prototype.saveState=function(){return{range:this.rangeElt.val(),start:this.startElt.val(),end:this.endElt.val()}},magic.classes.SeasonSelect.prototype.restoreState=function(a){a&&!jQuery.isEmptyObject(a)&&(this.rangeElt.val(a.range),this.rangeChanger(a.range,a.start,a.end))},magic.classes.SeasonSelect.prototype.validate=function(a){var b=!0,c=this.rangeElt.closest("div.form-group");return"between"==this.rangeElt.val()&&(b=this.startElt.val()<=this.endElt.val(),b?c.removeClass("has-error"):(c.addClass("has-error"),a["Season end date"]="should be after start date")),b},magic.classes.StylerPopup=function(a){a=jQuery.extend({},{id:"styler-popup-tool",styleMode:"default",caption:"Edit symbology",popoverClass:"styler-popover",popoverContentClass:"styler-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.styleInputs=["mode","graphic_marker","graphic_radius","stroke_width","stroke_color","stroke_opacity","stroke_linestyle","fill_color","fill_opacity"],this.inputDefaults={mode:"point",graphic:{marker:"circle",radius:5},stroke:{width:1,color:"#000000",opacity:1,linestyle:"solid"},fill:{color:"#ffffff",opacity:1}},this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(a){this.savedState={},this.assignCloseButtonHandler(),this.payloadToForm(this.prePopulator),this.assignHandlers(),this.restoreState()},this))},magic.classes.StylerPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.StylerPopup.prototype.constructor=magic.classes.StylerPopup,magic.classes.StylerPopup.prototype.assignHandlers=function(a){this.formEdited=!1,jQuery("div[id='"+this.id+"-fs'] :input").change(jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").click(jQuery.proxy(function(){this.cleanForm(),jQuery.isFunction(this.controlCallbacks.onSave)&&this.controlCallbacks.onSave(this.formToPayload()),this.deactivate(!0)},this)),jQuery("#"+this.id+"-cancel").click(jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.StylerPopup.prototype.saveForm=function(){jQuery("#"+this.id+"-go").trigger("click")},magic.classes.StylerPopup.prototype.markup=function(){return'<div id="'+this.id+'-fs"><input type="hidden" id="'+this.id+'-mode"></input><div id="'+this.id+'-point-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-graphic_marker">Marker</label><div class="col-sm-8"><select class="form-control" id="'+this.id+'-graphic_marker" data-toggle="tooltip" data-placement="right" title="Choose a marker type"><option value="circle">Circle</option><option value="triangle">Triangle</option><option value="square">Square</option><option value="pentagon">Pentagon</option><option value="hexagon">Hexagon</option><option value="star">Star</option></select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-graphic_radius">Size</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-graphic_radius" placeholder="Radius of graphic marker in pixels" min="3" max="20" step="0.2" value="5" data-toggle="tooltip" data-placement="right" title="Radius of graphic marker in pixels, default 5"></input></div></div></div><div id="'+this.id+'-line-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_width">Outline width</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-stroke_width" placeholder="Width of outline in pixels" min="0.2" max="20" step="0.2" value="1.0" data-toggle="tooltip" data-placement="right" title="Width of outline in pixels, default 1"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_color">Outline colour</label><div class="col-sm-8"><input type="color" class="form-control" id="'+this.id+'-stroke_color" data-toggle="tooltip" data-placement="right" title="Colour of the graphic outline, default black"</input></div></div><div class="form-group form-group-sm col-sm-12"><label for="'+this.id+'-stroke_opacity" class="col-sm-4 control-label">Outline opacity</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-stroke_opacity" placeholder="Outline opacity (0->1)" min="0" max="1" step="0.1" value="1.0" data-toggle="tooltip" data-placement="right" title="Outline opacity (0.0 = transparent, 1.0 = opaque)"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_linestyle">Line style</label><div class="col-sm-8"><select class="form-control" id="'+this.id+'-stroke_linestyle" data-toggle="tooltip" data-placement="right" title="Type of line"><option value="solid">Solid</option><option value="dotted">Dotted</option><option value="dashed">Dashed</option><option value="dotted-dashed">Dash/dot</option></select></div></div></div><div id="'+this.id+'-polygon-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-fill_color">Fill colour</label><div class="col-sm-8"><input type="color" class="form-control" id="'+this.id+'-fill_color" data-toggle="tooltip" data-placement="right" title="Colour of the graphic interior fill, default black"</input></div></div><div class="form-group form-group-sm col-sm-12"><label for="'+this.id+'-fill_opacity" class="col-sm-4 control-label">Fill opacity</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-fill_opacity" placeholder="Fill opacity (0->1)" min="0" max="1" step="0.1" value="1.0" data-toggle="tooltip" data-placement="right" title="Fill opacity (0.0 = transparent, 1.0 = opaque)"></input></div></div></div>'+magic.modules.Common.buttonFeedbackSet(this.id,"Save style","sm","Save",!0)+"</div>"},magic.classes.StylerPopup.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.StylerPopup.prototype.restoreState=function(){jQuery.isEmptyObject(this.savedState)||(this.payloadToForm(this.savedState),this.clearState())},magic.classes.StylerPopup.prototype.formToPayload=function(){var a=jQuery.extend(!0,{},this.inputDefaults);return jQuery.each(this.styleInputs,jQuery.proxy(function(b,c){var d=c.split("_"),e=jQuery("#"+this.id+"-"+c).val();2==d.length?a[d[0]][d[1]]=e:a[c]=e},this)),a},magic.classes.StylerPopup.prototype.payloadToForm=function(a){a=this.convertLegacyFormats(a);var b={point:{point:1,line:1,polygon:1},line:{point:0,line:1,polygon:0},polygon:{point:0,line:1,polygon:1}};b[a.mode]&&(jQuery.each(b[a.mode],jQuery.proxy(function(a,b){var c=this.id+"-"+a+"-fs";1===b?(jQuery("#"+c).removeClass("hidden"),jQuery("#"+c+" :input").prop("disabled",!1)):(jQuery("#"+c).addClass("hidden"),jQuery("#"+c+" :input").prop("disabled",!0))},this)),jQuery.each(this.styleInputs,jQuery.proxy(function(b,c){var d=c.split("_"),e=jQuery("#"+this.id+"-"+c);2==d.length?a[d[0]]&&a[d[0]][d[1]]?e.val(a[d[0]][d[1]]):e.val(this.inputDefaults[d[0]][d[1]]):e.val(a[c])},this)))},magic.classes.StylerPopup.prototype.convertLegacyFormats=function(a){if(!a||jQuery.isEmptyObject(a))return jQuery.extend(!0,{},this.inputDefaults);if("string"==typeof a)try{a=JSON.parse(a)}catch(a){return jQuery.extend(!0,{},this.inputDefaults)}return"predefined"==a.mode||"default"==a.mode?a:a.graphic||a.stroke||a.fill?a:(a.stroke&&a.stroke.style&&(a.stroke.linestyle=a.stroke.style,delete a.stroke.style),{mode:a.mode,graphic:{marker:a.marker||this.inputDefaults.graphic.marker,radius:a.radius||this.inputDefaults.graphic.radius},stroke:{width:a.stroke_width||this.inputDefaults.stroke.width,color:a.stroke_color||this.inputDefaults.stroke.color,linestyle:a.stroke_linestyle||this.inputDefaults.stroke.linestyle,opacity:a.stroke_opacity||this.inputDefaults.stroke.opacity},fill:{color:a.fill_color||this.inputDefaults.fill.color,opacity:a.fill_opacity||this.inputDefaults.fill.opacity}})},magic.classes.TagsInput=function(a){if(a=jQuery.extend({},{tipText:"",tipPosition:"left",required:!1,defaultValue:"",tagValidator:function(a){return!0}},a),magic.classes.CustomFormInput.call(this,a),this.tagValidator=a.tagValidator,this.tipText=this.tipText||this.element.data("original-title"),this.element.length>0&&(this.element.tagsinput({trimValue:!0,allowDuplicates:!1,cancelConfirmKeysOnEmpty:!1}),this.tipText)){var b=this.element.closest("div").find(".bootstrap-tagsinput :input");b&&(b.attr("data-toggle","tooltip"),b.attr("data-placement",this.tipPosition),b.attr("title",this.tipText))}this.setValue(this.defaultValue)},magic.classes.TagsInput.prototype=Object.create(magic.classes.CustomFormInput.prototype),magic.classes.TagsInput.prototype.constructor=magic.classes.TagsInput,magic.classes.TagsInput.prototype.reset=function(){this.element.tagsinput("removeAll")},magic.classes.TagsInput.prototype.setValue=function(a){a?(jQuery.isArray(a)||(a=a.split(",")),a.length>0&&jQuery.each(a,jQuery.proxy(function(a,b){this.element.tagsinput("add",b)},this))):this.reset()},magic.classes.TagsInput.prototype.getValue=function(a){return!0===a?this.element.tagsinput("items"):this.element.val()},magic.classes.TagsInput.prototype.validate=function(){var a=!this.required||""!=this.getValue(!1),b=this.element.closest("div.form-group");if(a){var c=this.getValue(!0);if(c.length>0){a=jQuery.grep(c,jQuery.proxy(function(a){return this.tagValidator(a)},this)).length==c.length}}return a?b.removeClass("has-error"):b.addClass("has-error"),a},magic.classes.UserLayerManagerForm=function(a){this.id=a.id||"layer-manager",this.map=a.map||magic.runtime.map,this.stylerPopup=null,this.editorPopups={add:null,edit:null},this.controls={user:{},community:{}},this.zIndexWmsStack=-1,this.userPayloadConfig=magic.runtime.map_context.userdata?magic.runtime.map_context.userdata.layers||{}:{},this.userLayerData={},this.savedState={},this.clearState(),this.currentSelection=null,this.setSelection(),this.initialisedLayers=!1},magic.classes.UserLayerManagerForm.prototype.init=function(){this.editorPopups={add:null,edit:null},this.zIndexWmsStack=this.getWmsStackTop(this.map),this.fetchLayers(jQuery.proxy(function(a){var b;jQuery.each(a,jQuery.proxy(function(a,c){this.initialisedLayers||(b=!!this.userPayloadConfig[c.id]&&this.userPayloadConfig[c.id].visibility),this.provisionLayer(c,b,this.initialisedLayers)},this)),this.layerMarkup(),this.assignHandlers(),this.hasSavedState()?this.restoreState():this.setButtonStates(null)},this)),this.initialisedLayers=!0},magic.classes.UserLayerManagerForm.prototype.refreshLayerLists=function(){this.zIndexWmsStack=this.getWmsStackTop(this.map),this.layerMarkup(),this.assignHandlers()},magic.classes.UserLayerManagerForm.prototype.setButtonStates=function(a){if(!a){var b=this.getSelection("user"),c=this.getSelection("community");a={user:{legend:null==b,add:!1,edit:null==b,del:null==b,actions:null==b},community:{legend:null==c,actions:null==c}}}for(var d in this.controls)jQuery.each(this.controls[d].btn,function(b,c){a[d][b]?c.prop("disabled",!0):c.prop("disabled",!1)})},magic.classes.UserLayerManagerForm.prototype.assignHandlers=function(){var a=jQuery("#"+this.id+"-form");this.controls={user:{btn:{legend:jQuery("#"+this.id+"-user-layer-legend"),add:jQuery("#"+this.id+"-user-layer-add"),edit:jQuery("#"+this.id+"-user-layer-edit"),del:jQuery("#"+this.id+"-user-layer-del"),actions:jQuery("#"+this.id+"-user-layer-actions")},dd:{ztl:jQuery("#"+this.id+"-user-layer-ztl"),wms:jQuery("#"+this.id+"-user-layer-wms"),url:jQuery("#"+this.id+"-user-layer-url"),dld:jQuery("#"+this.id+"-user-layer-dld")}},community:{btn:{legend:jQuery("#"+this.id+"-community-layer-legend"),actions:jQuery("#"+this.id+"-community-layer-actions")},dd:{ztl:jQuery("#"+this.id+"-community-layer-ztl"),wms:jQuery("#"+this.id+"-community-layer-wms"),url:jQuery("#"+this.id+"-community-layer-url"),dld:jQuery("#"+this.id+"-community-layer-dld")}}};for(var b in this.controls)a.find("a[id$='-"+b+"-layer-select']").off("click").on("click",{type:b},jQuery.proxy(this.selectLayer,this)),a.find("[id$='-"+b+"-layer-vis']").off("change").on("change",{type:b},jQuery.proxy(this.selectLayer,this)),this.controls[b].dd.ztl.off("click").on("click",{type:b},jQuery.proxy(function(a){var b=this.getSelection(a.data.type);b&&jQuery.ajax({url:magic.config.paths.baseurl+"/userlayers/"+b+"/extent",method:"GET",dataType:"json",contentType:"application/json"}).done(jQuery.proxy(function(a){jQuery.isArray(a)||(a=JSON.parse(a));var b=magic.modules.GeoUtils.extentFromWgs84Extent(a);b&&this.map.getView().fit(b,this.map.getSize())},this))},this)),this.controls[b].dd.wms.off("click").on("click",{type:b},jQuery.proxy(function(a){bootbox.prompt({title:"WMS URL",value:this.layerWmsUrl(a.data.type),callback:function(){}})},this)),this.controls[b].dd.url.off("click").on("click",{type:b},jQuery.proxy(function(a){bootbox.prompt({title:"Direct data feed URL",value:this.layerDirectUrl(a.data.type),callback:function(){}})},this)),this.controls[b].dd.dld.off("click").on("click",{type:b},jQuery.proxy(function(a){window.open(this.layerDirectUrl(a.data.type))},this));this.addLegendHoverHandler("user"),this.addLegendHoverHandler("community"),this.controls.user.btn.add.off("click").on("click",jQuery.proxy(function(a){this.editorPopups.add=new magic.classes.LayerEditorPopup({id:"layer-add-popup-tool",caption:"Add new layer",target:a.currentTarget.id,onSave:jQuery.proxy(this.init,this)}),this.editorPopups.edit&&this.editorPopups.edit.deactivate(),this.editorPopups.add.activate({})},this)),this.controls.user.btn.edit.off("click").on("click",jQuery.proxy(function(a){this.editorPopups.edit=new magic.classes.LayerEditorPopup({id:"layer-edit-popup-tool",caption:"Edit existing layer data",target:a.currentTarget.id,onSave:jQuery.proxy(this.init,this)}),this.editorPopups.add&&this.editorPopups.add.deactivate(),this.editorPopups.edit.activate(this.userLayerData[this.currentSelection.user])},this)),this.controls.user.btn.del.off("click").on("click",jQuery.proxy(function(a){a.preventDefault(),bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete this layer?</div>',jQuery.proxy(function(a){if(a){var b=this.currentSelection.user;jQuery.ajax({url:magic.config.paths.baseurl+"/userlayers/delete/"+b,method:"DELETE",beforeSend:function(a){var b=jQuery("meta[name='_csrf']").attr("content"),c=jQuery("meta[name='_csrf_header']").attr("content");a.setRequestHeader(c,b)}}).done(jQuery.proxy(function(a){this.userLayerData[b]&&this.userLayerData[b].olLayer&&this.map.removeLayer(this.userLayerData[b].olLayer),delete this.userLayerData[b],this.refreshLayerLists(),jQuery("#"+this.id+"-user-layer-select").html('Select a layer&nbsp;&nbsp;<span class="caret"></span>'),this.setSelection("user",null),this.setButtonStates(null)},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to delete user layer - details : "+b,"warning")}),bootbox.hideAll()}else bootbox.hideAll()},this))},this))},magic.classes.UserLayerManagerForm.prototype.addLegendHoverHandler=function(a){this.controls[a].btn.legend.popover("destroy"),this.controls[a].btn.legend.popover({container:"body",html:!0,trigger:"hover",content:jQuery.proxy(function(b){var c="No legend available",d=this.currentSelection[a];if(d&&this.userLayerData[d]){var e=this.userLayerData[d],f="&buster="+(new Date).getTime();c='<img src="'+(e.service+"?service=WMS&request=GetLegendGraphic&format=image/png&width=20&height=20&styles=&layer="+e.layer+"&legend_options=fontName:Bitstream Vera Sans Mono;fontAntiAliasing:true;fontColor:0xffffff;fontSize:6;bgColor:0x272b30;dpi:180"+f)+'" alt="Legend"></img>'}return'<div style="width:120px">'+c+"</div>"},this)})},magic.classes.UserLayerManagerForm.prototype.layerMarkup=function(){var a={user:[],community:[]};jQuery.each(this.userLayerData,function(b,c){c.owner==magic.runtime.map_context.username?a.user.push(c):a.community.push(c)}),a.user.sort(function(a,b){return a.caption.localeCompare(b.caption)}),a.community.sort(function(a,b){return a.caption.localeCompare(b.caption)});for(var b=["user","community"],c=0;c<b.length;c++){var d=b[c],e=jQuery("#"+this.id+"-"+d+"-layers");if(e.empty(),0==a[d].length)e.append('<li class="dropdown-header">There are currently no user uploaded layers</li>');else{var f=this.id;e.append('<li class="dropdown-header"><div style="display:inline-block;width:20px">Vis</div><div style="display:inline-block;width:100px">Owner</div><div style="display:inline-block;width:200px">Name</div></li>'),jQuery.each(a[d],function(a,b){e.append('<li data-pk="'+b.id+'"><a id="'+f+"-"+b.id+"-"+d+'-layer-select" href="JavaScript:void(0)"><div style="display:inline-block;width:20px"><input id="'+f+"-"+b.id+"-"+d+'-layer-vis" type="checkbox"'+(null!=b.olLayer&&b.olLayer.getVisible()?' checked="checked"':"")+'></input></div><div style="display:inline-block;width:100px">'+b.owner+'</div><div style="display:inline-block;width:200px" data-toggle="tooltip" data-html="true" data-placement="bottom" title="'+b.caption+"<br>"+b.description+"<br>Modified on : "+magic.modules.Common.dateFormat(b.modified_date,"dmy")+'">'+magic.modules.Common.ellipsis(b.caption,30)+"</div></a></li>")})}}},magic.classes.UserLayerManagerForm.prototype.markup=function(){for(var a=["user","community"],b='<form id="'+this.id+'-form" class="form-horizontal" role="form" enctype="multipart/form-data" style="margin-top:10px">',c=0;c<a.length;c++){var d=a[c];b+='<div class="form-group form-group-sm col-sm-12"><strong>'+("user"==d?"My":"Community")+' uploaded layers</strong></div><div class="btn-toolbar" style="margin-bottom:10px"><div class="btn-group" role="group"><button id="'+this.id+"-"+d+'-layer-select" type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" style="width:180px">Select a layer&nbsp;&nbsp;<span class="caret"></span></button><ul id="'+this.id+"-"+d+'-layers" class="dropdown-menu"></ul></div><div class="btn-group" role="group"><button id="'+this.id+"-"+d+'-layer-legend" class="btn btn-sm btn-info" type="button" data-toggle="popover" data-trigger="manual" data-placement="bottom" ><i style="pointer-events:none" title="Legend for selected layer" class="fa fa-list"></i></button>'+("user"==d?'<button id="'+this.id+"-"+d+'-layer-add" class="btn btn-sm btn-primary" type="button" data-toggle="popover" data-trigger="manual" data-placement="bottom"><i data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Add a new layer" class="fa fa-star"></i></button><button type="button" class="btn btn-sm btn-warning" id="'+this.id+"-"+d+'-layer-edit" data-toggle="popover" data-trigger="manual" data-placement="bottom"><i style="font-size:14px" data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Edit selected layer data" class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-danger" id="'+this.id+"-"+d+'-layer-del"><i data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Delete selected layer" class="fa fa-trash"></i></button>':"")+'</div><div class="btn-group dropdown" role="group"><button id="'+this.id+"-"+d+'-layer-actions" type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" data-container="body"><i data-toggle="tooltip" data-placement="top" data-trigger="hover" title="Further actions" class="fa fa-ellipsis-h"></i>&nbsp;&nbsp;<span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-right" style="overflow:auto"><li><a id="'+this.id+"-"+d+'-layer-ztl" href="Javascript:void(0)">Zoom to layer extent</a></li><li role="separator" class="divider"></li><li><a id="'+this.id+"-"+d+'-layer-wms" href="Javascript:void(0)">OGC WMS</a></li><li><a id="'+this.id+"-"+d+'-layer-url" href="Javascript:void(0)">Direct data URL</a></li><li><a id="'+this.id+"-"+d+'-layer-dld" href="Javascript:void(0)">Download data</a></li></ul></div></div>'}return b+="</form>"},magic.classes.UserLayerManagerForm.prototype.setSelection=function(a,b){a?this.currentSelection[a]=b:this.currentSelection={user:null,community:null}},magic.classes.UserLayerManagerForm.prototype.getSelection=function(a){return this.currentSelection[a]},magic.classes.UserLayerManagerForm.prototype.selectLayer=function(a){var b=null,c=a.data.type,d=a.currentTarget.id,e=jQuery("#"+d);if(e.length>0&&(b=e.closest("li").attr("data-pk")),null!=b&&""!=b){var f=!1;f="checkbox"==e.attr("type")?e.prop("checked"):e.find("input[type='checkbox']").prop("checked"),this.provisionLayer(this.userLayerData[b],f,!1),f?this.controls[c].dd.ztl.closest("li").prop("disabled",!1):this.controls[c].dd.ztl.closest("li").prop("disabled",!0),e.closest(".dropdown-menu").prev().html('<i class="fa fa-eye'+(f?"":"-slash")+'" style="font-size:16px"></i>&nbsp;&nbsp;'+magic.modules.Common.ellipsis(this.userLayerData[b].caption,20)+'&nbsp;&nbsp;<span class="caret"></span>'),this.setSelection(c,b),this.setButtonStates(null)}},magic.classes.UserLayerManagerForm.prototype.saveState=function(){this.savedState={user:{selection:this.currentSelection.user||null},community:{selection:this.currentSelection.community||null}}},magic.classes.UserLayerManagerForm.prototype.restoreState=function(){if(!jQuery.isEmptyObject(this.savedState)){var a=this.savedState.user.selection,b=this.savedState.community.selection;this.clearState(),null!=a&&jQuery("#"+this.id+"-"+a+"-user-layer-select").trigger("click"),null!=b&&jQuery("#"+this.id+"-"+b+"-community-layer-select").trigger("click")}},magic.classes.UserLayerManagerForm.prototype.clearState=function(){this.savedState={user:{selection:null},community:{selection:null}}},magic.classes.UserLayerManagerForm.prototype.hasSavedState=function(){return!jQuery.isEmptyObject(this.savedState)&&(this.savedState.user&&this.savedState.user.selection||this.savedState.community&&this.savedState.community.selection)},magic.classes.UserLayerManagerForm.prototype.fetchLayers=function(a){jQuery.ajax({url:magic.config.paths.baseurl+"/userlayers/data",method:"GET",dataType:"json",contentType:"application/json"}).done(jQuery.proxy(function(b){b.sort(function(a,b){return a.caption.localeCompare(b.caption)}),a(b)},this)).fail(function(){magic.modules.Common.showAlertModal("Failed to load available user layers","error")})},magic.classes.UserLayerManagerForm.prototype.provisionLayer=function(a,b,c){var d=null,e=this.userLayerData[a.id],f=e?e.olLayer:null;if(null==f&&this.map.getLayers().forEach(function(b){var c=b.get("metadata");c&&c.id==a.id&&(f=b)}),null==f){if(b){var g={legend_graphic:null,refresh_rate:0,min_scale:1,max_scale:5e7,opacity:1,is_visible:!1,is_interactive:!0,is_filterable:!1},h={style_name:null,is_base:!1,is_singletile:!1,is_dem:!1,is_time_dependent:!1},i=a.styledef;"string"==typeof i&&(i=JSON.parse(i));var j="file"==i.mode||"default"==i.mode?"unknown":i.mode,k=jQuery.extend({},{id:a.id,name:a.caption,geom_type:j,attribute_map:null},g);k.source=jQuery.extend({},{wms_source:a.service,feature_name:a.layer},h);var l=this.map.getView().getProjection(),m=magic.runtime.map.getView().getResolutions(),n=new ol.source.TileWMS({url:magic.modules.Endpoints.getOgcEndpoint(k.source.wms_source,"wms"),params:{LAYERS:k.source.feature_name,STYLES:"",TRANSPARENT:!0,CRS:l.getCode(),SRS:l.getCode(),VERSION:"1.3.0",TILED:!0},tileGrid:new ol.tilegrid.TileGrid({resolutions:m,origin:l.getExtent().slice(0,2)}),projection:l});d=new ol.layer.Tile({name:k.name,visible:b,opacity:this.userPayloadConfig[a.id]?this.userPayloadConfig[a.id].opacity:1,minResolution:m[m.length-1],maxResolution:m[0]+1,metadata:k,source:n}),k.layer=d,k.layer.setZIndex(this.zIndexWmsStack++),this.map.addLayer(d)}}else d=f,jQuery.isFunction(d.getSource().updateParams)&&d.getSource().updateParams(jQuery.extend({},d.getSource().getParams(),{LAYERS:a.layer,buster:(new Date).getTime()})),c||d.setVisible(b);return a.olLayer=d,this.userLayerData[a.id]=a,d},magic.classes.UserLayerManagerForm.prototype.layerWmsUrl=function(a){var b=this.getSelection(a);if(b&&this.userLayerData[b]){var c=this.userLayerData[b];return magic.config.paths.baseurl+"/ogc/user/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS="+c.layer+"&CRS="+this.map.getView().getProjection().getCode()+"&SRS="+this.map.getView().getProjection().getCode()+"&TILED=true&WIDTH=1000&HEIGHT=1000&STYLES=&BBOX="+magic.runtime.map.getView().getProjection().getExtent().join(",")}return""},magic.classes.UserLayerManagerForm.prototype.layerDirectUrl=function(a){var b=this.getSelection(a);return b?magic.config.paths.baseurl+"/userlayers/"+b+"/data":""},magic.classes.UserLayerManagerForm.prototype.getWmsStackTop=function(a){var b=-1;return a.getLayers().forEach(function(a){var c=a.getZIndex();c<400&&c>b&&(b=c)}),b},magic.classes.UserLayerManagerForm.prototype.tidyUp=function(a,b){a=a||!1,b=b||!1,this.editorPopups.edit&&this.editorPopups.edit.isActive()&&(this.editorPopups.edit.deactivate(a),this.editorPopups.edit=null),this.editorPopups.add&&this.editorPopups.add.isActive()&&(this.editorPopups.add.deactivate(a),this.editorPopups.add=null),b&&(jQuery.each(this.userLayerData,function(a,b){b.olLayer&&b.olLayer.setVisible(!1)}),this.setSelection())},magic.classes.UserPreferencesForm=function(a){this.id=a.id||"unit-prefs",this.inputBaseNames=["distance","area","elevation","coordinates","dates"],this.mgrForm=jQuery("#"+this.id+"-form"),this.formEdited=!1,this.savedState={}},magic.classes.UserPreferencesForm.prototype.init=function(){this.formEdited=!1,jQuery("#"+this.id+"-form :input").change(jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").click(jQuery.proxy(function(a){var b=this.formToPayload();jQuery.ajax({url:magic.config.paths.baseurl+"/prefs/set",data:JSON.stringify(b),method:"POST",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")},success:jQuery.proxy(function(a){magic.modules.Common.buttonClickFeedback(this.id,a.status<400,a.detail),a.status<400&&(magic.runtime.preferences=jQuery.extend(magic.runtime.preferences,b),this.formEdited=!1)},this),fail:jQuery.proxy(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to save preferences - details : "+b,"warning")},this)})},this)),this.payloadToForm(magic.runtime.preferences),this.restoreState()},magic.classes.UserPreferencesForm.prototype.markup=function(){return'<form id="'+this.id+'-form" class="form-horizontal" style="margin-top:10px"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4" for="'+this.id+'-distance">Length</label><div class="col-sm-8"><select id="'+this.id+'-distance" class="form-control">'+this.getOptions(magic.modules.GeoUtils.DISTANCE_UNITS,magic.runtime.preferences.distance)+'</select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4" for="'+this.id+'-area">Area</label><div class="col-sm-8"><select id="'+this.id+'-area" class="form-control">'+this.getOptions(magic.modules.GeoUtils.AREA_UNITS,magic.runtime.preferences.area)+'</select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4" for="'+this.id+'-elevation">Height</label><div class="col-sm-8"><select id="'+this.id+'-elevation" class="form-control">'+this.getOptions(magic.modules.GeoUtils.ELEVATION_UNITS,magic.runtime.preferences.elevation)+'</select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4" for="'+this.id+'-coordinates">Coords</label><div class="col-sm-8"><select id="'+this.id+'-coordinates" class="form-control">'+this.getOptions(magic.modules.GeoUtils.COORDINATE_FORMATS,magic.runtime.preferences.coordinates)+'</select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4" for="'+this.id+'-dates">Dates</label><div class="col-sm-8"><select id="'+this.id+'-dates" class="form-control">'+this.getOptions([["dmy","dd-mm-yyyy"],["ymd","yyyy-mm-dd"]],magic.runtime.preferences.dates)+"</select></div></div>"+magic.modules.Common.buttonFeedbackSet(this.id,"Set preferences","sm","Save",!1)+"</form>"},magic.classes.UserPreferencesForm.prototype.saveForm=function(){jQuery("#"+this.id+"-go").trigger("click")},magic.classes.UserPreferencesForm.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.UserPreferencesForm.prototype.restoreState=function(){jQuery.isEmptyObject(this.savedState)||(this.payloadToForm(this.savedState),this.clearState())},magic.classes.UserPreferencesForm.prototype.clearState=function(){this.savedState={}},magic.classes.UserPreferencesForm.prototype.formDirty=function(){return this.formEdited},magic.classes.UserPreferencesForm.prototype.cleanForm=function(){this.formEdited=!1},magic.classes.UserPreferencesForm.prototype.formToPayload=function(){var a={};return jQuery.each(this.inputBaseNames,jQuery.proxy(function(b,c){a[c]=jQuery("#"+this.id+"-"+c).val()},this)),a},magic.classes.UserPreferencesForm.prototype.payloadToForm=function(a){jQuery.each(this.inputBaseNames,jQuery.proxy(function(b,c){jQuery("#"+this.id+"-"+c).val(a[c])},this))},magic.classes.UserPreferencesForm.prototype.getOptions=function(a,b){var c="";if(a)for(var d=0;d<a.length;d++){var e=a[d][0]==b?" selected":"";c+='<option value="'+a[d][0]+'"'+e+">"+a[d][1]+"</option>"}return c},magic.classes.DownloadRepo=function(a){this.id=a.id||"download-repo",this.target=jQuery("#"+a.target),"nobody"!=magic.runtime.map_context.allowed_download&&magic.runtime.map_context.repository?this.target.on("click",function(a){a.stopPropagation(),window.open(magic.runtime.map_context.repository,"_blank")}):this.target.closest("li").hide()};magic.classes.DownloadRepo.prototype.interactsMap=function(){return!1},magic.classes.Feedback=function(a){a=jQuery.extend({},{id:"feedback-tool",layername:null,caption:"Feedback on service or data issues",popoverClass:"feedback-tool-popover",popoverContentClass:"feedback-tool-popover-content"},a),magic.classes.NavigationBarTool.call(this,a),this.setCallbacks({onActivate:jQuery.proxy(this.onActivateHandler,this),onDeactivate:jQuery.proxy(function(){this.target.popover("hide")},this),onMinimise:jQuery.proxy(function(){this.saveState()},this)}),this.inputs=["trackerId","subject","description","reporter"],this.savedState={},this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(){this.activate(),this.savedState&&!jQuery.isEmptyObject(this.savedState)&&this.restoreState()},this))},magic.classes.Feedback.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.Feedback.prototype.constructor=magic.classes.Feedback,magic.classes.Feedback.prototype.markup=function(){return'<div id="'+this.id+'-content"><form id="'+this.id+'-feedback-form" class="form" role="form"><input type="hidden" id="'+this.id+'-payload"></input><div class="panel"><div class="panel-body alert-info">Your chance to improve service quality by reporting data or interface problems. Give a short description below e.g. &quot;Contours appear in the sea&quot; or &quot;Failed to find a certain place-name&quot; and configure the map to show the issue.  The complete state of the map will be saved automatically</div></div><div class="form-group"><label for="'+this.id+'-trackerId">This is an issue with</label><select name="trackerId" id="'+this.id+'-trackerId" class="form-control" data-toggle="tooltip" data-placement="right" title="What type of problem is this?"><option value="4">Data</option><option value="1">Interface</option></select></div><div class="form-group"><label for="'+this.id+'-subject">One line summary</label><input type="text" name="subject" id="'+this.id+'-subject" class="form-control" placeholder="Short outline of the problem" maxlength="150" data-toggle="tooltip" data-placement="right" title="Short problem description (required)" required="required"></input></div><div class="form-group"><label for="'+this.id+'-description">Detailed description</label><textarea name="description" id="'+this.id+'-description" class="form-control" style="height:5em !important" placeholder="More details about the problem" data-toggle="tooltip" data-placement="right" title="Longer description of the problem (required)" required="required"></textarea></div><div class="form-group"><label for="'+this.id+'-reporter">Your email address</label><input type="email" name="reporter" id="'+this.id+'-reporter" class="form-control" placeholder="Not used for any other purpose" maxlength="150" data-toggle="tooltip" data-placement="right" title="Your email (required - used to communicate with you about this issue and for no other purpose)" required="required"></input></div><div><button id="'+this.id+'-go" class="btn btn-primary" type="button" data-toggle="tooltip" data-placement="right" title="Send feedback"><span class="fa fa-paper-plane"></span></button></div></form></div>'},magic.classes.Feedback.prototype.onActivateHandler=function(){jQuery("#"+this.id+"-go").click(jQuery.proxy(function(a){if(jQuery(a.currentTarget).tooltip("hide"),this.validate()){var b=this.formToPayload();b.description=JSON.stringify(jQuery.extend({},this.mapPayload(),{description:b.description}));var c=jQuery.ajax({url:magic.config.paths.baseurl+"/feedback",method:"POST",processData:!1,data:JSON.stringify(b),headers:{"Content-Type":"application/json","X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")}});c.done(jQuery.proxy(function(a){bootbox.alert('<div class="alert alert-info" style="margin-bottom:0"><p>Successfully sent your feedback</p></div>'),this.deactivate()},this)),c.fail(function(a){var b=JSON.parse(a.responseText).detail;bootbox.alert('<div class="alert alert-warning" style="margin-bottom:0"><p>Error occurred - details below:</p><p>'+b+"</p></div>")})}else bootbox.alert('<div class="alert alert-danger" style="margin-bottom:0"><p>Please correct the errors marked in your input</p></div>')},this))},magic.classes.Feedback.prototype.interactsMap=function(){return!1},magic.classes.Feedback.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.Feedback.prototype.restoreState=function(){this.payloadToForm(this.savedState),this.savedState={}},magic.classes.Feedback.prototype.payloadToForm=function(a){jQuery.each(this.inputs,jQuery.proxy(function(b,c){jQuery("#"+this.id+"-"+c).val(a[c])},this))},magic.classes.Feedback.prototype.formToPayload=function(){var a={};return jQuery.each(this.inputs,jQuery.proxy(function(b,c){a[c]=jQuery("#"+this.id+"-"+c).val()},this)),a},magic.classes.Feedback.prototype.mapPayload=function(){var a={};return this.map&&(a.submission="automatic",a.center=this.map.getView().getCenter(),a.zoom=this.map.getView().getZoom(),a.visible={},magic.runtime.map.getLayers().forEach(function(b){a.visible[b.get("name")]=b.getVisible()}),a.mapUrl=window.location.href,a.userAgent=navigator.userAgent),a},magic.classes.Feedback.prototype.validate=function(){var a=!0;return jQuery("#"+this.id+"-feedback-form")[0].checkValidity(),jQuery.each(this.inputs,jQuery.proxy(function(b,c){var d=jQuery("#"+this.id+"-"+c),e=d.closest("div.form-group");d.prop("validity").valid?e.removeClass("has-error").addClass("has-success"):(a=!1,e.removeClass("has-success").addClass("has-error"))},this)),a},magic.classes.Geosearch=function(a){a=jQuery.extend({},{id:"geosearch",caption:"Search by",layername:"Geosearch location",gazetteers:["cga"],popoverClass:"geosearch-popover",popoverContentClass:"geosearch-popover-content"},a),magic.classes.NavigationBarTool.call(this,a),this.gazetteers=a.gazetteers,this.searchInput=new magic.classes.GazetteerSearchInput(this.id+"-placename",this.id,{mouseover:jQuery.proxy(this.mouseoverSuggestion,this),mouseout:jQuery.proxy(this.mouseoutSuggestion,this),search:jQuery.proxy(this.placenameSearchHandler,this)},this.gazetteers),this.setCallbacks({onActivate:jQuery.proxy(function(){this.searchInput.init(),this.infoButtonHandler("gazetteer sources",this.searchInput.getAttributions()),jQuery("#"+this.id+"-position-go").click(jQuery.proxy(this.positionSearchHandler,this)),this.populateSearchHistoryDropdown()},this),onDeactivate:jQuery.proxy(function(){this.searchedFeatureCache=[],this.suggestionFeatures={},this.savedState={},this.target.popover("hide")},this),onMinimise:jQuery.proxy(this.saveState,this)}),this.suggestionStyle=this.getIconStyle(.6,"marker_orange"),this.invisibleStyle=this.getIconStyle(0,"marker_orange"),this.resultStyle=this.getIconStyle(.8,"marker_green"),this.layer.setStyle(this.resultStyle),this.layer.set("metadata",{geom_type:"point",is_interactive:!0,attribute_map:[{name:"name",displayed:!0,alias:"Name",type:"xsd:string"},{name:"lon",displayed:!0,alias:"Longitude",type:"xsd:decimal"},{name:"lat",displayed:!0,alias:"Latitude",type:"xsd:decimal"}]}),this.searchedFeatureCache=[],this.suggestionFeatures={},this.savedState={},this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(){this.activate(),this.savedState&&!jQuery.isEmptyObject(this.savedState)&&this.restoreState()},this))},magic.classes.Geosearch.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.Geosearch.prototype.constructor=magic.classes.Geosearch,magic.classes.Geosearch.prototype.interactsMap=function(){return!0},magic.classes.Geosearch.prototype.markup=function(){return'<div id="'+this.id+'-content"><form class="form-horizontal" role="form"><div role="tabpanel"><ul class="nav nav-tabs" role="tablist"><li role="presentation" class="active"><a role="tab" data-toggle="tab" href="#'+this.id+'-placename" aria-controls="'+this.id+'-placename">Place-name</a></li><li role="presentation"><a role="tab" data-toggle="tab" href="#'+this.id+'-position" aria-controls="'+this.id+'-position">Lat/long</a></li></ul></div><div class="tab-content geosearch-tabs"><div id="'+this.id+'-placename" role="tabpanel" class="tab-pane active">'+this.searchInput.markup()+'</div><div id="'+this.id+'-position" role="tabpanel" class="tab-pane"><div class="form-group form-group-sm"><input id="'+this.id+'-lon" class="form-control" type="text" placeholder="Longitude" data-toggle="tooltip" data-placement="bottom" title="Examples: -65.5, 65 30 00W (dms), W65 30.00 (ddm)" required="required" autofocus="true"></input></div><div class="form-group form-group-sm"><input id="'+this.id+'-lat" class="form-control" type="text" placeholder="Latitude" data-toggle="tooltip" data-placement="bottom" title="Examples: -60.25, 60 15 00S (dms), S60 15.00 (ddm)" required="required"></input></div><div class="form-group form-group-sm"><div class="input-group"><input id="'+this.id+'-label" class="form-control" type="text" placeholder="Label" data-toggle="tooltip" data-placement="bottom" title="Type a label for the point"></input><span class="input-group-btn"><button id="'+this.id+'-position-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Show position"><span class="fa fa-search"></span></button></span></div></div></div><div class="form-group form-group-sm"><div class="checkbox geosearch-tmt" style="float:left"><label><input id="'+this.id+'-tmt" type="checkbox" checked data-toggle="tooltip" data-placement="bottom" title="Zoom the map to this location"></input> Take me there</label></div>'+this.infoLinkButtonMarkup("Show gazetteer sources")+this.historyMarkup()+"</div>"+this.infoAreaMarkup()+"</div></form></div>"},magic.classes.Geosearch.prototype.historyMarkup=function(){return'<div style="inline-block;float:right;margin-right:10px"><div class="btn-group dropdown" role="group"><button id="'+this.id+'-history" type="button" style="width:100px" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" data-container="body"><i data-toggle="tooltip" data-placement="top" title="Searched location history" class="fa fa-history"></i>&nbsp;&nbsp;<span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-left" style="overflow:auto"></ul></div></div>'},magic.classes.Geosearch.prototype.populateSearchHistoryDropdown=function(){var a=jQuery("#"+this.id+"-history").next("ul");if(a.empty(),0==this.searchedFeatureCache.length)a.append('<li class="dropdown-header">No search history</li>');else{a.html(this.markupHistoryHeader());for(var b=0;b<this.searchedFeatureCache.length;b++)a.children().first().after(this.markupHistoryEntry(b)),jQuery("#"+this.id+"-"+this.searchedFeatureCache[b].getProperties().__id+"-history-entry-vis").change(jQuery.proxy(this.historyEntryVisHandler,this))}},magic.classes.Geosearch.prototype.saveState=function(){this.savedState={},this.savedState.placename=this.searchInput.getSearch(),this.savedState.lon=jQuery("#"+this.id+"-lon").val(),this.savedState.lat=jQuery("#"+this.id+"-lat").val(),this.savedState.label=jQuery("#"+this.id+"-label").val();var a=jQuery("#"+this.id+"-content").find("div.tab-pane.active");a.length>0&&(this.savedState.activeTab=a[0].id)},magic.classes.Geosearch.prototype.restoreState=function(){this.searchInput.setSearch(this.savedState.placename),jQuery("#"+this.id+"-lon").val(this.savedState.lon),jQuery("#"+this.id+"-lat").val(this.savedState.lat),jQuery("#"+this.id+"-label").val(this.savedState.label),this.savedState.activeTab&&jQuery("a[href='#"+this.savedState.activeTab+"']").tab("show"),this.savedState={}},magic.classes.Geosearch.prototype.addActiveClass=function(a,b){return this.savedState&&!jQuery.isEmptyObject(this.savedState)&&this.savedState.activeTab?this.savedState.activeTab.indexOf("-"+a)>0?" active":"":b?" active":""},magic.classes.Geosearch.prototype.mouseoverSuggestion=function(a){var b=a.target.innerText,c=a.data.suggestions;if(c[b]){var d=this.suggestionFeatures[b];if(!d){var e=ol.proj.transform([c[b].lon,c[b].lat],"EPSG:4326",magic.runtime.map.getView().getProjection().getCode());d=new ol.Feature({geometry:new ol.geom.Point(e),layer:this.layer,__suggestion:!0}),this.suggestionFeatures[b]=d,this.layer.getSource().addFeature(d)}d.setStyle(this.suggestionStyle)}},magic.classes.Geosearch.prototype.mouseoutSuggestion=function(a){var b=a.target.innerText;this.suggestionFeatures[b]&&this.suggestionFeatures[b].setStyle(this.invisibleStyle)},magic.classes.Geosearch.prototype.placenameSearchHandler=function(a){this.saveState();var b=this.searchInput.getSelection(),c=b.__gaz_name,d=this.featurePositionInHistory(b.id,c);if(d<0)jQuery.getJSON("https://api.bas.ac.uk/locations/v1/placename/"+c+"/"+b.id,jQuery.proxy(function(a){var d=a.data;delete d.__suggestion;var e=new ol.Feature(jQuery.extend({__id:magic.modules.Common.uuid(),name:b.placename,geometry:this.computeProjectedGeometry(c,d),layer:this.layer,__gaz_name:c},d));e.setStyle(this.resultStyle),this.layer.getSource().addFeature(e),jQuery("#"+this.id+"-tmt").prop("checked")&&this.flyTo(e.getGeometry().getCoordinates(),function(){}),this.addHistoryEntry(e)},this));else{var e=this.getHistoryEntry(d);e.setStyle(this.resultStyle),jQuery("#"+this.id+"-tmt").prop("checked")&&this.flyTo(e.getGeometry().getCoordinates(),function(){})}},magic.classes.Geosearch.prototype.computeProjectedGeometry=function(a,b){var c,d=magic.runtime.map.getView().getProjection().getCode();return"sgssi"==a&&"EPSG:3031"==d||"sgssi"!=a&&"EPSG:3762"==d?(c=new ol.geom.Point([b.lon,b.lat]),c.transform("EPSG:4326",d)):c=new ol.geom.Point([b.x,b.y]),c},magic.classes.Geosearch.prototype.flyTo=function(a,b){function c(a){--f,g||0!==f&&a||(g=!0,b(a))}var d=2e3,e=magic.runtime.map.getView().getZoom(),f=2,g=!1;magic.runtime.map.getView().animate({center:a,duration:d},c),magic.runtime.map.getView().animate({zoom:e-1,duration:d/2},{zoom:e,duration:d/2},c)},magic.classes.Geosearch.prototype.positionSearchHandler=function(a){this.saveState();var b=jQuery("#"+this.id+"-lon"),c=jQuery("#"+this.id+"-lat"),d=jQuery("#"+this.id+"-label"),e=b.closest("div.form-group"),f=c.closest("div.form-group");if(magic.modules.GeoUtils.validCoordinate(b.val(),!1,!1)&&magic.modules.GeoUtils.validCoordinate(c.val(),!0,!1)){var g=magic.modules.GeoUtils.toDecDegrees(b.val()),h=magic.modules.GeoUtils.toDecDegrees(c.val()),i=new ol.geom.Point([g,h]);i.transform("EPSG:4326",magic.runtime.map.getView().getProjection().getCode());var j=new ol.Feature({__id:magic.modules.Common.uuid(),__gaz_name:null,geometry:i,lon:g,lat:h,name:d.val(),layer:this.layer});this.layer.getSource().addFeature(j),j.setStyle(this.resultStyle),this.addHistoryEntry(j),jQuery("#"+this.id+"-tmt").prop("checked")&&this.flyTo(j.getGeometry().getCoordinates(),function(){}),e.removeClass("has-error"),f.removeClass("has-error")}else e.removeClass("has-success").addClass("has-error"),f.removeClass("has-success").addClass("has-error")},magic.classes.Geosearch.prototype.addHistoryEntry=function(a,b){b=b||jQuery("#"+this.id+"-history").next("ul");var c=0==this.searchedFeatureCache.length;this.searchedFeatureCache.unshift(a),c&&b.html(this.markupHistoryHeader()),b.children().first().after(this.markupHistoryEntry(0)),jQuery("#"+this.id+"-"+a.getProperties().__id+"-history-entry-vis").change(jQuery.proxy(this.historyEntryVisHandler,this))},magic.classes.Geosearch.prototype.markupHistoryHeader=function(){return'<li class="dropdown-header"><div style="display:inline-block;width:20px">&nbsp;</div><div style="display:inline-block;width:150px">Name</div><div style="display:inline-block;width:40px">Gaz</div><div style="display:inline-block;width:80px">Lon</div><div style="display:inline-block;width:80px">Lat</div></li>'},magic.classes.Geosearch.prototype.markupHistoryEntry=function(a){var b=this.searchedFeatureCache[a],c=b.getProperties(),d="";return c.name&&c.name.length>20&&(d=' data-toggle="tooltip" data-placement="right" title="'+c.name+'"'),'<li><a id="'+this.id+"-"+c.__id+'-history-entry-select" href="JavaScript:void(0)"><div style="display:inline-block;width:20px"><input id="'+this.id+"-"+c.__id+'-history-entry-vis" type="checkbox"'+(b.getStyle()==this.resultStyle?' checked="checked"':"")+'></input></div><div style="display:inline-block;width:150px"'+d+">"+magic.modules.Common.ellipsis(c.name,20)+'</div><div style="display:inline-block;width:40px">'+(c.__gaz_name||"")+'</div><div style="display:inline-block;width:80px">'+magic.modules.GeoUtils.applyPref("coordinates",c.lon,"lon")+'</div><div style="display:inline-block;width:80px">'+magic.modules.GeoUtils.applyPref("coordinates",c.lat,"lon")+"</div></a></li>"},magic.classes.Geosearch.prototype.historyEntryVisHandler=function(a){var b=a.currentTarget.id.replace(this.id+"-","").replace("-history-entry-vis","");if(b){var c=this.featurePositionInHistory(b);if(-1!=c){this.searchedFeatureCache[c].setStyle(jQuery(a.currentTarget).prop("checked")?this.resultStyle:this.invisibleStyle)}}},magic.classes.Geosearch.prototype.getHistoryEntry=function(a){return this.searchedFeatureCache[a]},magic.classes.Geosearch.prototype.featurePositionInHistory=function(a){var b=-1;return jQuery.each(this.searchedFeatureCache,jQuery.proxy(function(c,d){if(d.getProperties().__id==a)return b=c,!1},this)),b},magic.classes.Geosearch.prototype.getIconStyle=function(a,b,c){return new ol.style.Style({image:new ol.style.Icon({anchor:c||[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:a,src:magic.config.paths.cdn+"/images/map-markers/"+b+".png"})})},magic.classes.InfoModal=function(a){this.target=a?a.target:"information-modal",this.infolink=a?a.infolink:null,this.fetched=!1,jQuery("#"+this.target).on("shown.bs.modal",jQuery.proxy(function(){null==this.infolink?(jQuery('a[href="#information-credits"]').tab("show"),jQuery('a[href="#information-background"]').parent().addClass("hidden")):this.getBackgroundInfo()},this))},magic.classes.InfoModal.prototype.getBackgroundInfo=function(){this.fetched||null==this.infolink||(0!=this.infolink.indexOf(magic.config.paths.baseurl)&&(this.infolink=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(this.infolink)),jQuery("#information-background").load(this.infolink,function(){jQuery('a[href="#information-background"]').tab("show")}),this.fetched=!0)},magic.classes.Measurement=function(a){a=jQuery.extend({},{id:"measure-tool",caption:"Measure on the map",layername:"_measurement",popoverClass:"measure-tool-popover",popoverContentClass:"measure-tool-popover-content"},a),magic.classes.NavigationBarTool.call(this,a),this.setCallbacks({onActivate:jQuery.proxy(this.onActivateHandler,this),onDeactivate:jQuery.proxy(function(){this.stopMeasuring(),this.target.popover("hide")},this),onMinimise:jQuery.proxy(function(){this.stopMeasuring(),this.saveState()},this)}),this.layer.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff8c00",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ff8c00"})})})),this.heightgraphSketchStyle=new ol.style.Style({stroke:new ol.style.Stroke({color:"#800000",width:2})}),this.sketch=null,this.helpTooltipJq=null,this.helpTooltip=null,this.measureTooltipJq=null,this.measureTooltip=null,this.measureOverlays=[],this.elevationTool=new magic.classes.ElevationPopup({id:this.id+"-elevation-tool"}),this.heightgraphTool=new magic.classes.HeightGraphPopup({id:this.id+"-heightgraph-tool"}),this.actionType="distance",this.measuring=!1,this.savedState={},this.target.popover({template:this.template,container:"body",title:this.titleMarkup(),html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(){this.activate(),this.savedState&&!jQuery.isEmptyObject(this.savedState)&&this.restoreState()},this))},magic.classes.Measurement.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.Measurement.prototype.constructor=magic.classes.Measurement,magic.classes.Measurement.prototype.interactsMap=function(){return!0},magic.classes.Measurement.prototype.onActivateHandler=function(){this.actionType="distance",jQuery("button[id$='-go']").click(jQuery.proxy(function(a){this.measuring?this.stopMeasuring():this.startMeasuring()},this)),jQuery("a[href='#"+this.id+"-distance']").on("shown.bs.tab",jQuery.proxy(function(){jQuery("#"+this.id+"-distance-units").focus(),this.actionType="distance",this.stopMeasuring()},this)),jQuery("a[href='#"+this.id+"-area']").on("shown.bs.tab",jQuery.proxy(function(){jQuery("#"+this.id+"-area-units").focus(),this.actionType="area",this.stopMeasuring()},this)),jQuery("a[href='#"+this.id+"-elevation']").on("shown.bs.tab",jQuery.proxy(function(){if(this.elevationTool.setTarget(this.id+"-elevation-go","Click to stop measuring elevations","Click map to measure elevation at a point"),this.elevationTool.currentlyVisibleDems().length>0)jQuery("#"+this.id+"-no-dem-info").addClass("hidden"),jQuery("#"+this.id+"-dem-info").removeClass("hidden"),jQuery("#"+this.id+"-elevation-units").focus(),this.actionType="elevation";else{var a="",b=this.elevationTool.getDemLayers();b.length>0?a="<p>One of the DEM layers below:</p><p><strong>"+jQuery.map(b,function(a,b){return a.get("name")}).join("<br/>")+"</strong></p><p>needs to be visible to see elevations</p>":(a="<p>No base layer in this map contains elevation data</p>",jQuery("a[href='"+this.id+"-elevation']").prop("disabled","disabled")),jQuery("#"+this.id+"-dem-info").addClass("hidden"),jQuery("#"+this.id+"-no-dem-info").removeClass("hidden").html(a)}this.stopMeasuring()},this)),jQuery("a[href='#"+this.id+"-heightgraph']").on("shown.bs.tab",jQuery.proxy(function(){if(this.heightgraphTool.setTarget(this.id+"-heightgraph-go","Click to close height graph","Draw line on the map along which to view elevation graph"),this.heightgraphTool.currentlyVisibleDems().length>0)jQuery("#"+this.id+"-no-dem-info-hg").addClass("hidden"),jQuery("#"+this.id+"-dem-info-hg").removeClass("hidden"),jQuery("#"+this.id+"-heightgraph-units").focus(),this.actionType="heightgraph";else{var a="",b=this.heightgraphTool.getDemLayers();b.length>0?a="<p>One of the DEM layers below:</p><p><strong>"+jQuery.map(b,function(a,b){return a.get("name")}).join("<br/>")+"</strong></p><p>needs to be visible to view height graphs</p>":(a="<p>No base layer in this map contains elevation data</p>",jQuery("a[href='"+this.id+"-heightgraph']").prop("disabled","disabled")),jQuery("#"+this.id+"-dem-info-hg").addClass("hidden"),jQuery("#"+this.id+"-no-dem-info-hg").removeClass("hidden").html(a)}this.stopMeasuring()},this)),jQuery("select[id$='-units']").change(jQuery.proxy(function(a){"elevation"==this.actionType?this.elevationTool.setUnits(jQuery(a.currentTarget).val()):"heightgraph"==this.actionType&&this.heightgraphTool.setUnits(jQuery(a.currentTarget).val()),this.stopMeasuring()},this)),jQuery("#"+this.id+"-heightgraph-sampling").change(jQuery.proxy(function(a){"heightgraph"==this.actionType&&(this.heightgraphTool.setInterpolation(jQuery(a.currentTarget).val()),this.stopMeasuring())},this)),jQuery("#"+this.id+"-distance-units").focus()},magic.classes.Measurement.prototype.startMeasuring=function(){this.measuring=!0,jQuery("#"+this.id+"-"+this.actionType+"-go span").removeClass("fa-play").addClass("fa-stop"),"distance"==this.actionType||"area"==this.actionType||"heightgraph"==this.actionType?(this.layer.setVisible(!0),this.layer.getSource().clear(),this.drawInt&&this.map.removeInteraction(this.drawInt),this.drawInt=new ol.interaction.Draw({source:this.layer.getSource(),type:"area"==this.actionType?"Polygon":"LineString"}),this.map.addInteraction(this.drawInt),this.createMeasurementTip(),this.createHelpTooltip(),this.drawInt.on("drawstart",function(a){this.sketch=a.feature,this.sketch.getGeometry().on("change",this.sketchChangeHandler,this)},this),this.drawInt.on("drawend",function(a){"heightgraph"==this.actionType?(this.sketch.setStyle(this.heightgraphSketchStyle),this.drawInt&&setTimeout(jQuery.proxy(function(){this.map.removeInteraction(this.drawInt),this.drawInt=null},this),500),this.map.un("pointermove",this.pointerMoveHandler,this),this.heightgraphTool.activate(this.sketch.getGeometry())):(this.measureTooltipJq.attr("className","measure-tool-tooltip measure-tool-tooltip-static"),this.measureTooltip.setOffset([0,-7]),this.sketch=null,this.measureTooltipJq=null,this.createMeasurementTip())},this),this.map.un("pointermove",this.pointerMoveHandler,this),this.map.on("pointermove",this.pointerMoveHandler,this),jQuery(this.map.getViewport()).on("mouseout",jQuery.proxy(function(){this.helpTooltipJq.addClass("hidden")},this)),"heightgraph"==this.actionType&&this.heightgraphTool.setUnits(jQuery("#"+this.id+"-heightgraph-units").val())):(this.elevationTool.setUnits(jQuery("#"+this.id+"-elevation-units").val()),this.elevationTool.activate())},magic.classes.Measurement.prototype.stopMeasuring=function(){this.measuring=!1,jQuery("#"+this.id+"-"+this.actionType+"-go span").removeClass("fa-stop").addClass("fa-play"),"distance"==this.actionType||"area"==this.actionType||"heightgraph"==this.actionType?(jQuery.each(this.measureOverlays,jQuery.proxy(function(a,b){this.map.removeOverlay(b)},this)),this.measureOverlays=[],this.map.removeOverlay(this.helpTooltip),this.layer.setVisible(!1),this.layer.getSource().clear(),this.drawInt&&this.map.removeInteraction(this.drawInt),this.drawInt=null,this.sketch=null,this.map.un("pointermove",this.pointerMoveHandler,this),"heightgraph"==this.actionType&&this.heightgraphTool.deactivate()):this.elevationTool.deactivate()},magic.classes.Measurement.prototype.markup=function(){return'<div id="'+this.id+'-content"><form class="form-horizontal" role="form"><div role="tabpanel"><ul class="nav nav-tabs" role="tablist"><li role="presentation" class="active"><a role="tab" data-toggle="tab" href="#'+this.id+'-distance">Distance</a></li><li role="presentation"><a role="tab" data-toggle="tab" href="#'+this.id+'-area">Area</a></li><li role="presentation"><a role="tab" data-toggle="tab" href="#'+this.id+'-elevation">Elevation</a></li><li role="presentation"><a role="tab" data-toggle="tab" href="#'+this.id+'-heightgraph">Height graph</a></li></ul></div><div class="tab-content measure-tabs"><div id="'+this.id+'-distance" role="tabpanel" class="tab-pane active"><div class="form-group form-group-sm"><label for="'+this.id+'-distance-units">Distance units</label><div class="input-group"><select id="'+this.id+'-distance-units" class="form-control"><option value="km"'+("km"==magic.runtime.preferences.distance?" selected":"")+'>kilometres</option><option value="m"'+("m"==magic.runtime.preferences.distance?" selected":"")+'>metres</option><option value="mi"'+("mi"==magic.runtime.preferences.distance?" selected":"")+'>miles</option><option value="nmi"'+("nmi"==magic.runtime.preferences.distance?" selected":"")+'>nautical miles</option></select><span class="input-group-btn"><button id="'+this.id+'-distance-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Draw line to measure on map - double-click to finish"><span class="fa fa-play""></span></button></span></div></div><div class="form-group form-group-sm"><div class="checkbox measure-true"><label><input id="'+this.id+'-true" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="Check to use true distance on earth\'s surface"></input> Geodesic</label></div></div></div><div id="'+this.id+'-area" role="tabpanel" class="tab-pane"><div class="form-group form-group-sm"><label for="'+this.id+'-area-units">Area units</label><div class="input-group"><select id="'+this.id+'-area-units" class="form-control"><option value="km"'+("km"==magic.runtime.preferences.area?" selected":"")+'>square kilometres</option><option value="m"'+("m"==magic.runtime.preferences.area?" selected":"")+'>square metres</option><option value="mi"'+("mi"==magic.runtime.preferences.area?" selected":"")+'>square miles</option><option value="nmi"'+("nmi"==magic.runtime.preferences.area?" selected":"")+'>square nautical miles</option></select><span class="input-group-btn"><button id="'+this.id+'-area-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Draw area to measure on map - click once to finish"><span class="fa fa-play"></span></button></span></div></div><div class="form-group form-group-sm"><div class="checkbox measure-true"><label><input id="'+this.id+'-true" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="Check to use true distance on earth\'s surface"></input> Geodesic</label></div></div></div><div id="'+this.id+'-elevation" role="tabpanel" class="tab-pane"><div id="'+this.id+'-no-dem-info" class="alert alert-info hidden"></div><div id="'+this.id+'-dem-info"><div class="form-group form-group-sm"><label for="'+this.id+'-elevation-units">Elevation units</label><div class="input-group"><select id="'+this.id+'-elevation-units" class="form-control"><option value="m"'+("m"==magic.runtime.preferences.elevation?" selected":"")+'>metres</option><option value="ft"'+("ft"==magic.runtime.preferences.elevation?" selected":"")+'>feet</option></select><span class="input-group-btn"><button id="'+this.id+'-elevation-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Click map to measure elevation at a point"><span class="fa fa-play"></span></button></span></div></div></div></div><div id="'+this.id+'-heightgraph" role="tabpanel" class="tab-pane"><div id="'+this.id+'-no-dem-info-hg" class="alert alert-info hidden"></div><div id="'+this.id+'-dem-info-hg"><div class="form-group form-group-sm"><label for="'+this.id+'-heightgraph-units">Height graph altitude units</label><select id="'+this.id+'-heightgraph-units" class="form-control"><option value="m"'+("m"==magic.runtime.preferences.elevation?" selected":"")+'>metres</option><option value="ft"'+("ft"==magic.runtime.preferences.elevation?" selected":"")+'>feet</option></select></div><div class="form-group form-group-sm"><label for="'+this.id+'-heightgraph-sampling">Sample points for each segment</label><div class="input-group"><select id="'+this.id+'-heightgraph-sampling" class="form-control"><option value="5" selected>5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="100">100</option></select><span class="input-group-btn"><button id="'+this.id+'-heightgraph-go" class="btn btn-primary btn-sm" type="button" data-toggle="tooltip" data-placement="right" title="Draw line on the map along which to view elevation graph"><span class="fa fa-play"></span></button></span></div></div></div></div></div></form></div>'},magic.classes.Measurement.prototype.saveState=function(){this.savedState={},jQuery.each(["heightgraph-units","heightgraph-sampling","elevation-units","area-units","distance-units"],jQuery.proxy(function(a,b){this.savedState[b]=jQuery("#"+this.id+"-"+b).val()},this));var a=jQuery("#"+this.id+"-content").find("div.tab-pane.active");a.length>0&&(this.savedState.activeTab=a[0].id)},magic.classes.Measurement.prototype.restoreState=function(){jQuery.each(["heightgraph-units","heightgraph-sampling","elevation-units","area-units","distance-units"],jQuery.proxy(function(a,b){jQuery("#"+this.id+"-"+b).val(this.savedState[b])},this)),this.savedState.activeTab&&jQuery("a[href='#"+this.savedState.activeTab+"']").tab("show"),this.savedState={}},magic.classes.Measurement.prototype.sketchChangeHandler=function(a){if("heightgraph"!=this.actionType){var b,c,d,e=1,f=jQuery("#"+this.id+"-true").prop("checked"),g=this.sketch.getGeometry();"area"==this.actionType?(b=f?magic.modules.GeoUtils.geodesicArea(g,this.map):g.getArea(),e=2,c=jQuery("#"+this.id+"-area-units").val(),d=g.getInteriorPoint().getCoordinates()):"distance"==this.actionType&&(b=f?magic.modules.GeoUtils.geodesicLength(g,this.map):g.getLength(),c=jQuery("#"+this.id+"-distance-units").val(),d=g.getLastCoordinate()),this.measureTooltipJq.html(magic.modules.Common.unitConverter(b,"m",c,e)),this.measureTooltip.setPosition(d)}},magic.classes.Measurement.prototype.pointerMoveHandler=function(a){if(!a.dragging&&this.sketch){var b;switch(this.actionType){case"distance":b="Click to continue sketching line";break;case"area":b="Click to continue sketching polygon";break;case"heightgraph":b="Click to continue adding to line, and double click to see the height profile";break;default:b="Click to start sketching"}this.helpTooltipJq.removeClass("hidden").html(b),this.helpTooltip.setPosition(a.coordinate)}},magic.classes.Measurement.prototype.createHelpTooltip=function(){jQuery.isArray(this.helpTooltipJq)&&this.helpTooltipJq.length>0&&this.helpTooltipJq.parent().remove(".measure-tool-tooltip"),this.helpTooltipJq=jQuery("<div>",{class:"measure-tool-tooltip hidden"}),this.helpTooltip=new ol.Overlay({element:this.helpTooltipJq[0],offset:[15,0],positioning:"center-left"}),this.map.addOverlay(this.helpTooltip)},magic.classes.Measurement.prototype.createMeasurementTip=function(){jQuery.isArray(this.measureTooltipJq)&&this.measureTooltipJq.length>0&&this.measureTooltipJq.parent().remove(".measure-tool-tooltip"),this.measureTooltipJq=jQuery("<div>",{class:"measure-tool-tooltip measure-tool-tooltip-out"});var a=new ol.Overlay({element:this.measureTooltipJq[0],offset:[0,-15],positioning:"bottom-center"});this.measureOverlays.push(a),this.measureTooltip=a,this.map.addOverlay(this.measureTooltip)},magic.classes.OverviewMap=function(a){this.id=a.id||"overview-map-tool",this.target=jQuery("#"+a.target),this.layertree=a.layertree||null,this.control=null,this.template='<div class="popover overview-map-popover" role="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content overview-map-popover-content"></div></div>',this.target.popover({template:this.template,title:'<span><big><strong>Overview map</strong><big><button type="button" class="close">&times;</button></span>',container:"body",html:!0,content:"Overview map"}).on("show.bs.popover",jQuery.proxy(function(){return this.setEnabledStatus()},this)).on("shown.bs.popover",jQuery.proxy(function(){this.initControl(),jQuery(".overview-map-popover").find("button.close").click(jQuery.proxy(function(){this.target.popover("hide")},this))},this)),jQuery(document).on("baselayerchanged",jQuery.proxy(this.initControl,this))},magic.classes.OverviewMap.prototype.initControl=function(){var a=jQuery("div.overview-map-popover-content");a.html(""),null!=this.control&&(magic.runtime.map.removeControl(this.control),this.control=null),this.control=new ol.control.OverviewMap({target:a[0],collapsed:!1,className:"ol-overviewmap custom-overview-map",layers:this.getOverviewLayers(),view:new ol.View({projection:magic.runtime.map.getView().getProjection().getCode(),rotation:magic.runtime.map.getView().getRotation()})}),magic.runtime.map.addControl(this.control),jQuery("button[title='Overview map']").addClass("hidden")},magic.classes.OverviewMap.prototype.interactsMap=function(){return!1},magic.classes.OverviewMap.prototype.getTarget=function(){return this.target},magic.classes.OverviewMap.prototype.getTemplate=function(){return this.template},magic.classes.OverviewMap.prototype.getOverviewLayers=function(){var a=[];return null!=this.layertree?(jQuery.each(this.layertree.getBaseLayers(),jQuery.proxy(function(b,c){if(c.getVisible())return a.push(c),!1},this)),a.length>0&&jQuery.each(this.layertree.getWmsOverlayLayers(),jQuery.proxy(function(b,c){var d=c.get("metadata");if(d.source&&d.source.wms_source){d.source.feature_name.indexOf("coastline")>=0&&a.push(c)}},this))):a=[magic.runtime.map.getLayers().item(0)],a},magic.classes.OverviewMap.prototype.setEnabledStatus=function(){var a=!1;return magic.runtime.map&&(a=magic.runtime.map.getView().getResolution()<=500),a?this.target.attr("title",""):(this.target.popover("hide"),this.target.attr("title","Overview disabled for zoomed out maps")),a},magic.classes.PersonalData=function(a){a=jQuery.extend({},{id:"personal-data-tool",caption:"My data",layername:null,popoverClass:"personal-data-tool-popover",popoverContentClass:"personal-data-tool-popover-content"},a),magic.classes.NavigationBarTool.call(this,a),this.setCallbacks({onActivate:jQuery.proxy(this.onActivateHandler,this),onDeactivate:jQuery.proxy(this.onDeactivateHandler,this),onMinimise:jQuery.proxy(this.onMinimiseHandler,this)}),this.tabForms={maps:new magic.classes.MapViewManagerForm({}),layers:new magic.classes.UserLayerManagerForm({}),prefs:new magic.classes.UserPreferencesForm({})},this.savedState={},this.target.popover({template:this.template,container:"body",title:this.titleMarkup(),html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(this.activate,this))},magic.classes.PersonalData.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.PersonalData.prototype.constructor=magic.classes.PersonalData,magic.classes.PersonalData.prototype.interactsMap=function(){return!0},magic.classes.PersonalData.prototype.onActivateHandler=function(){jQuery.each(this.tabForms,jQuery.proxy(function(a,b){b.init()},this)),jQuery("#"+this.id+"-content").find("a[data-toggle='tab']").on("shown.bs.tab",jQuery.proxy(function(a){var b=jQuery(a.relatedTarget).attr("href"),c=b.substring(b.lastIndexOf("-")+1);jQuery.isFunction(this.tabForms[c].tidyUp)&&this.tabForms[c].tidyUp(!1,!1)},this)),jQuery.isEmptyObject(this.savedState)||this.restoreState()},magic.classes.PersonalData.prototype.onDeactivateHandler=function(){var a=this.activeTab();jQuery.isFunction(this.tabForms[a].formDirty)&&this.tabForms[a].formDirty()?bootbox.confirm({message:"Unsaved edits - save before closing?",buttons:{confirm:{label:"Yes",className:"btn-success"},cancel:{label:"No",className:"btn-danger"}},callback:jQuery.proxy(function(b){b?jQuery.isFunction(this.tabForms[a].saveForm)&&this.tabForms[a].saveForm():(this.tidyUp(!0,!0),this.savedState={},this.target.popover("hide"))},this)}):(this.tidyUp(!0,!0),this.savedState={},this.target.popover("hide"))},magic.classes.PersonalData.prototype.onMinimiseHandler=function(){this.tidyUp(!0,!1),this.saveState()},magic.classes.PersonalData.prototype.markup=function(){return'<div id="'+this.id+'-content"><div role="tabpanel"><ul class="nav nav-tabs" role="tablist"><li role="presentation" class="active" data-toggle="tooltip" data-placement="top" title="Manage your own custom views of this and other maps"><a role="tab" data-toggle="tab" href="#'+this.id+'-maps">Map views</a></li><li role="presentation"  data-toggle="tooltip" data-placement="top" title="Upload and style your own data on this map"><a role="tab" data-toggle="tab" href="#'+this.id+'-layers">Data layers</a></li><li role="presentation" data-toggle="tooltip" data-placement="top" title="Change your format and unit settings for quantities displayed in the map interface"><a role="tab" data-toggle="tab" href="#'+this.id+'-prefs">Unit preferences</a></li></ul></div><div class="tab-content personal-data-tabs"><div id="'+this.id+'-maps" role="tabpanel" class="tab-pane active">'+this.tabForms.maps.markup()+'</div><div id="'+this.id+'-layers" role="tabpanel" class="tab-pane">'+this.tabForms.layers.markup()+'</div><div id="'+this.id+'-prefs" role="tabpanel" class="tab-pane">'+this.tabForms.prefs.markup()+"</div></div></div>"},magic.classes.PersonalData.prototype.saveState=function(){var a=this.activeTab();this.savedState={openTab:a},jQuery.each(this.tabForms,function(b,c){b==a&&jQuery.isFunction(c.saveState)?c.saveState():b!=a&&jQuery.isFunction(c.clearState)&&c.clearState()})},magic.classes.PersonalData.prototype.restoreState=function(){if(!jQuery.isEmptyObject(this.savedState)){this.activeTab()!=this.savedState.openTab&&jQuery("a[href$='-"+this.savedState.openTab+"']").tab("show")}},magic.classes.PersonalData.prototype.tidyUp=function(a,b){jQuery.each(this.tabForms,function(c,d){jQuery.isFunction(d.tidyUp)&&d.tidyUp(a,b)})},magic.classes.PersonalData.prototype.activeTab=function(){var a=jQuery("#"+this.id+"-content").find("div[role='tabpanel'].active");return a.length>0?a.attr("id").replace(this.id+"-",""):"maps"},magic.classes.AircraftPositionButton=function(a,b,c){magic.classes.AssetPositionButton.call(this,a,b,c),this.attribute_map=[{name:"callsign",alias:"Call sign",displayed:!0},{name:"checktimestamp",alias:"Date",displayed:!0},{name:"longitude",alias:"Longitude",displayed:!0},{name:"latitude",alias:"Latitude",displayed:!0},{name:"speed",alias:"Speed",displayed:!1}]},magic.classes.AircraftPositionButton.prototype=Object.create(magic.classes.AssetPositionButton.prototype),magic.classes.AircraftPositionButton.prototype.constructor=magic.classes.AircraftPositionButton,magic.classes.AircraftPositionButton.prototype.getData=function(){jQuery.ajax({url:"https://add.data.bas.ac.uk/geoserver/assets/wfs?service=wfs&request=getfeature&version=2.0.0&typeNames=assets:latest_aircraft_positions&outputFormat=json",method:"GET",success:jQuery.proxy(function(a){if(this.geoJson){this.data={inside:[],outside:[]};var b=this.geoJson.readFeatures(a),c=magic.modules.GeoUtils.projectionLatLonExtent(magic.runtime.map.getView().getProjection().getCode());if(jQuery.each(b,jQuery.proxy(function(a,b){var d=jQuery.extend({},b.getProperties()),e=b.clone();e.setProperties(d),b.getGeometry().intersectsExtent(c)?(e.getGeometry().transform("EPSG:4326",magic.runtime.map.getView().getProjection().getCode()),e.setStyle(magic.modules.VectorStyles.bas_aircraft(magic.runtime.map.getView().getProjection().getCode())),this.data.inside.push(e)):(e.getGeometry().transform("EPSG:4326","EPSG:3857"),e.setStyle(magic.modules.VectorStyles.bas_aircraft("EPSG:3857")),this.data.outside.push(e))},this)),this.layer.getSource().clear(),this.data.inside.length>0&&this.layer.getSource().addFeatures(this.data.inside),this.data.outside.length>0){if(this.insetLayer){this.insetLayer.getSource().clear();var d=jQuery.map(this.data.outside,function(a){return a.clone()});this.insetLayer.getSource().addFeatures(d)}magic.runtime.inset&&magic.runtime.inset.activate()}}},this),error:function(a,b,c){console.log("Failed to get aircraft positional data - potential network outage?")}})},magic.classes.ElevationPopup=function(a){magic.classes.DemAwareTool.call(this,a);var b=jQuery("#height-popup");0==b.length&&(jQuery("body").append('<div id="height-popup" title="Elevation"></div>'),b=jQuery("#height-popup")),this.heightPopup=new ol.Overlay({element:b[0]}),this.map.addOverlay(this.heightPopup)},magic.classes.ElevationPopup.prototype=Object.create(magic.classes.DemAwareTool.prototype),magic.classes.ElevationPopup.prototype.constructor=magic.classes.ElevationPopup,magic.classes.ElevationPopup.prototype.activate=function(){this.target.attr("data-original-title",this.activeTooltip).tooltip("fixTitle"),this.map.on("singleclick",this.showHeightPopover,this),this.map.on("moveend",this.destroyPopup,this)},magic.classes.ElevationPopup.prototype.deactivate=function(){this.destroyPopup(),this.target.attr("data-original-title",this.inactiveTooltip).tooltip("fixTitle"),this.map.un("singleclick",this.showHeightPopover,this),this.map.un("moveend",this.destroyPopup,this)},magic.classes.ElevationPopup.prototype.showHeightPopover=function(a){this.queryElevation(a,jQuery.proxy(function(a,b,c,d){var e=jQuery(this.heightPopup.getElement());e.popover("destroy"),this.heightPopup.setPosition(a),e.popover({container:"body",placement:"top",animation:!1,html:!0,content:magic.modules.GeoUtils.formatSpatial(d,1,this.units,"m",0)+" at ("+b+", "+c+")"}),e.popover("show")},this),jQuery.proxy(function(a,b){var c=jQuery(this.heightPopup.getElement());c.popover("destroy"),this.heightPopup.setPosition(a);var d=401==b.status?"Not authorised to query DEM":"Failed to get height";c.popover({container:"body",placement:"top",animation:!1,html:!0,content:d}),c.popover("show")},this))},magic.classes.ElevationPopup.prototype.destroyPopup=function(){jQuery(this.heightPopup.getElement()).popover("destroy")},magic.classes.FieldPartyPositionButton=function(a){this.PHONETIC_ALPHABET=["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India","Juliett","Kilo","Lima","Mike","November","Oscar","Papa","Quebec","Romeo","Sierra","Tango","Uniform","Victor","Whiskey","X-ray","Yankee","Zulu"],this.BUTTONS_PER_ROW=4,this.WFS_FETCH="http://mapengine-dev.nerc-bas.ac.uk:8080/geoserver/opsgis2/wfs?service=wfs&request=getfeature&version=2.0.0&typeNames=opsgis2:ops_field_deployments&outputFormat=json&sortBy=fix_date+D&cql_filter=season=1819",this.featureMap={},this.clickedSledge=null,this.extraResourcesLoaded=!1,magic.classes.NavigationBarTool.call(this,a),this.setCallbacks({onActivate:jQuery.proxy(this.onActivate,this),onDeactivate:jQuery.proxy(this.onDeactivate,this),onMinimise:jQuery.proxy(this.saveState,this)}),this.layer.set("metadata",{is_interactive:!0,attribute_map:[{name:"sledge",alias:"Sledge",displayed:!0},{name:"season",alias:"Season",displayed:!1},{name:"fix_date",alias:"Fix at",displayed:!0},{name:"updated",alias:"Updated",displayed:!1},{name:"updater",alias:"By",displayed:!0},{name:"lat",alias:"Lat",displayed:!0},{name:"lon",alias:"Lon",displayed:!0},{name:"height",alias:"Altitude",displayed:!1},{name:"notes",alias:"Notes",displayed:!0}]}),this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:"Loading field party data..."}).on("shown.bs.popover",jQuery.proxy(function(){this.extraResourcesLoaded||(jQuery("head").append('<link href="'+magic.config.paths.cdn+'/css/bootstrap-combobox/1.1.6-font-awesome/bootstrap-combobox.min.css" rel="stylesheet" type="text/css">'),jQuery("head").append('<link href="'+magic.config.paths.cdn+'/css/bootstrap-datetimepicker/4.17.47/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css">'),jQuery("head").append('<script type="text/javascript" src="'+magic.config.paths.cdn+'/js/bootstrap-combobox/1.1.6-font-awesome/bootstrap-combobox.min.js"><\/script>'),jQuery("head").append('<script type="text/javascript" src="'+magic.config.paths.cdn+'/js/bootstrap-datetimepicker/4.17.47/bootstrap-datetimepicker.min.js"><\/script>'),this.extraResourcesLoaded=!0),jQuery.ajax({url:magic.config.paths.baseurl+"/fpp/layout",dataType:"html",success:jQuery.proxy(function(a){jQuery(".field-party-popover-content").html(a),this.activate()},this),error:function(){jQuery(".field-party-popover-content").html("Failed to retrieve content for pop-up")}})},this))},magic.classes.FieldPartyPositionButton.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.FieldPartyPositionButton.prototype.constructor=magic.classes.FieldPartyPositionButton,magic.classes.FieldPartyPositionButton.prototype.interactsMap=function(){return!0},magic.classes.FieldPartyPositionButton.prototype.saveState=function(){},magic.classes.FieldPartyPositionButton.prototype.restoreState=function(){},magic.classes.FieldPartyPositionButton.prototype.onActivate=function(){jQuery.ajax({url:this.WFS_FETCH,method:"GET",success:jQuery.proxy(function(a){var b=new ol.format.GeoJSON({geometryName:"geometry"}),c=b.readFeatures(a);jQuery.each(c,jQuery.proxy(function(a,b){var c=b.getProperties(),d=c.sledge,e=c.fix_date;this.featureMap[d]||(this.featureMap[d]={}),this.featureMap[d][e]=b},this)),jQuery.each(this.featureMap,jQuery.proxy(function(a,b){var c=Object.keys(b);c.sort(),c.reverse();for(var d=255/c.length,e=0;e<c.length;e++){var f="rgba("+parseInt(255-e*d)+",0,"+parseInt(e*d)+",1.0)";b[c[e]].setProperties({rgba:f},!0),b[c[e]].setStyle(magic.modules.VectorStyles.bas_field_party())}},this)),this.layer.getSource().clear(),this.layer.getSource().addFeatures(c),jQuery("."+this.popoverContentClass).html(this.markup()),jQuery("#btn-activate-sledge").click(jQuery.proxy(function(a){var b=jQuery("#sel-activate-sledge").val();if(""!=b){this.featureMap[b]={};var c=jQuery("."+this.popoverContentClass);c.empty(),c.html(this.markup()),this.assignHandlers()}},this)),this.assignHandlers()},this),error:function(){console.log("Failed to get field party positional data - potential network outage?")}})},magic.classes.FieldPartyPositionButton.prototype.onDeactivate=function(){this.target.popover("hide")},magic.classes.HeightGraphPopup=function(a){magic.classes.DemAwareTool.call(this,a),this.target=a.target?jQuery("#"+a.target):null,this.interpolation=5},magic.classes.HeightGraphPopup.prototype=Object.create(magic.classes.DemAwareTool.prototype),magic.classes.HeightGraphPopup.prototype.constructor=magic.classes.HeightGraphPopup,magic.classes.HeightGraphPopup.prototype.activate=function(a){var b=this.currentlyVisibleDems();if(b.length>0){for(var c=[],d=[],e=a.getCoordinates(),f=0;f<e.length;f++)for(var g=e[f],h=f==e.length-1?null:e[f+1],i=f==e.length-1?1:this.interpolation,j=0;j<i;j++){var k=1==i?g:[g[0]+j*(h[0]-g[0])/i,g[1]+j*(h[1]-g[1])/i],l=ol.proj.transform(k,this.map.getView().getProjection(),"EPSG:4326");l.push(0),d.push(l);var m=jQuery.get(this.getGfiUrl(k),{LAYERS:b.join(","),QUERY_LAYERS:b.join(","),INFO_FORMAT:"application/json",FEATURE_COUNT:this.demLayers.length},jQuery.proxy(function(a,b,c){var e=parseFloat(this.getDemValue(a));d[c.offset][2]=isNaN(e)?0:e},this));m.offset=d.length-1,c.push(m)}jQuery.when.apply(jQuery,c).always(jQuery.proxy(function(){this.target.attr("data-original-title",this.activeTooltip).tooltip("fixTitle"),this.target.popover({template:'<div class="popover" role="popover"><div class="arrow"></div><div id="'+this.id+'-height-graph-vis" style="width:550px;height:350px" class="popover-content"></div></div>',placement:"bottom",container:"body",html:!0,trigger:"manual",content:"Loading height graph..."}).on("shown.bs.popover",null,{coords:d},jQuery.proxy(function(a){var b=a.data.coords;magic.modules.Common.getScript("https://cdn.web.bas.ac.uk/magic/js/vis-graph3d/4.21.0/vis-graph3d.min.js",jQuery.proxy(function(){this.renderGraph(b)},this))},this)).on("hidden.bs.popover",jQuery.proxy(function(){this.target.attr("data-original-title",this.inactiveTooltip).tooltip("fixTitle")},this)),this.target.popover("show")},this)).fail(jQuery.proxy(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to generate data for height graph - details : "+b,"warning")},this))}},magic.classes.HeightGraphPopup.prototype.renderGraph=function(a){for(var b=new vis.DataSet,c=Number.NaN,d=Number.NaN,e=Number.NaN,f=Number.NaN,g=0;g<a.length;g++){var h=a[g][0],i=a[g][1],j=a[g][2];(isNaN(c)||h<c)&&(c=h),(isNaN(d)||h>d)&&(d=h),(isNaN(e)||i<e)&&(e=i),(isNaN(f)||i>f)&&(f=i),b.add({x:h,y:i,z:j})}var k=Math.max((d-c)/a.length,.005),l=Math.max((f-e)/a.length,.005),m={width:"500px",height:"300px",style:"bar",showLegend:!0,showPerspective:!0,showGrid:!0,showShadow:!1,keepAspectRatio:!1,tooltip:function(a){var b=magic.modules.GeoUtils.applyPref("coordinates",a.x,"lon"),c=magic.modules.GeoUtils.applyPref("coordinates",a.y,"lat");return magic.modules.GeoUtils.applyPref("elevation",a.z,this.units)+" at ("+b+","+c+")"},tooltipStyle:{content:{background:"rgba(255, 255, 255, 0.7)",padding:"10px",borderRadius:"10px"},line:{borderLeft:"1px dotted rgba(0, 0, 0, 0.5)"},dot:{border:"5px solid rgba(0, 0, 0, 0.5)"}},verticalRatio:.4,xBarWidth:k,yBarWidth:l,xLabel:"Lon",yLabel:"Lat",zLabel:"Altitude"},n=jQuery("#"+this.id+"-height-graph-vis");new vis.Graph3d(n[0],b,m)},magic.classes.HeightGraphPopup.prototype.deactivate=function(){this.target&&this.target.popover("hide")},magic.classes.HeightGraphPopup.prototype.getInterpolation=function(){return this.interpolation},magic.classes.HeightGraphPopup.prototype.setInterpolation=function(a){this.interpolation=a},magic.classes.IssueInformation=function(a){this.target=jQuery(".issue-info"),this.issueData=magic.runtime.map_context.issuedata,this.issueData&&!jQuery.isEmptyObject(this.issueData)?this.target.removeClass("hidden").html('<table class="table table-condensed" style="margin-bottom:0px"><tr><th>Issue ID</th><td>'+this.issueData.id+"</td></tr><tr><th>Subject</th><td>"+this.issueData.subject+"</td></tr><tr><th>Last updated</th><td>"+this.issueData.updated_on+"</td></tr></table>"):this.target.addClass("hidden")},magic.classes.IssueInformation.prototype.getPayload=function(){var a="None";if(!jQuery.isEmptyObject(this.issueData))try{a=JSON.parse(this.issueData.description).description}catch(a){}return a},magic.classes.RotheraReportSearch=function(a){magic.classes.NavigationBarTool.call(this,a),this.layer.setStyle(this.styleFunction),this.tagsInputs={},this.setCallbacks({onActivate:jQuery.proxy(function(){this.tagsInputs={locations:new magic.classes.TagsInput({id:this.id+"-locations"}),people:new magic.classes.TagsInput({id:this.id+"-people"}),keywords:new magic.classes.TagsInput({id:this.id+"-keywords"})},this.seasonSelect=new magic.classes.SeasonSelect(this.id+"-season-select-div"),this.layer.set("fetcher",jQuery.proxy(this.fullFeatureDataFetch,this),!0),this.setHoverHandlers(),this.infoButtonHandler("source information","Jo Rae to supply"),jQuery("#"+this.id+"-locations").closest("div").find(".bootstrap-tagsinput :input").focus()},this),onDeactivate:jQuery.proxy(function(){this.map.un("pointermove"),this.savedSearch={},this.target.popover("hide")},this),onMinimise:jQuery.proxy(this.saveSearchState,this)}),this.seasonSelect=null,this.savedSearch={},this.mousedOver=null,this.attribute_map=[{name:"id",alias:"Archives ref",displayed:!0,type:"xsd:string"},{name:"title",alias:"Title",displayed:!0,type:"xsd:string"},{name:"description",alias:"Description",displayed:!0,type:"xsd:string"},{name:"people",alias:"Personnel",displayed:!0,type:"xsd:string"},{name:"season",alias:"Season",displayed:!0,type:"xsd:string"},{name:"report",alias:"Report file",displayed:!0,type:"xsd:string"}],this.layer.set("metadata",{attribute_map:this.attribute_map,is_interactive:!0}),this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(){this.activate(),this.isActive()&&!jQuery.isEmptyObject(this.savedSearch)&&this.restoreSearchState(),jQuery("#"+this.id+"-reset").click(jQuery.proxy(function(a){this.savedSearch={},this.tagsInputs.locations.reset(),this.tagsInputs.people.reset(),this.tagsInputs.keywords.reset(),this.seasonSelect.reset(),this.layer.getSource().clear(),jQuery("#"+this.id+"-results").addClass("hidden").html("")},this)),jQuery("#"+this.id+"-search").click(jQuery.proxy(function(a){var b={};this.validate(b)?(this.saveSearchState(),jQuery.ajax({url:magic.config.paths.baseurl+"/rothera_reports",data:JSON.stringify(this.payload()),method:"POST",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":jQuery("meta[name='_csrf']").attr("content")}}).done(jQuery.proxy(function(a){bootbox.hideAll();var b=jQuery("#"+this.id+"-results");b.html(a.length),b.removeClass("hidden"),this.layer.getSource().clear();for(var c=0;c<a.length;c++){var d=a[c];if(null!=d.centroid){var e=d.centroid.replace(/^POINT\(/,"").replace(/\)$/,"").split(" "),f=new ol.geom.Point([parseFloat(e[0]),parseFloat(e[1])]);f.transform("EPSG:4326",magic.runtime.map.getView().getProjection().getCode());var g=new ol.Feature({id:d.id,geometry:f,layer:this.layer,_customHover:!0,_ignoreClicks:!1,_ignoreHovers:!1,_locations:d.strplaces,_associates:[]});this.layer.getSource().addFeature(g)}}if(a.length>1){var h=magic.modules.GeoUtils.bufferExtent(this.layer.getSource().getExtent());this.map.getView().fit(h,{padding:[20,20,20,20]})}this.savedSearch.nresults=a.length},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to execute your search - details : "+b,"warning")}),bootbox.dialog({title:"Please wait",message:'<p><i class="fa fa-spin fa-spinner"></i> Searching for reports...</p>'})):magic.modules.Common.showAlertModal("Please correct the problems indicated below:<br/><br/>"+this.formatErrors(b),"error")},this))},this))},magic.classes.RotheraReportSearch.prototype=Object.create(magic.classes.NavigationBarTool.prototype),magic.classes.RotheraReportSearch.prototype.constructor=magic.classes.RotheraReportSearch,magic.classes.RotheraReportSearch.prototype.payload=function(){var a={};return a.locations=jQuery("#"+this.id+"-locations").val(),a.people=jQuery("#"+this.id+"-people").val(),a.keywords=jQuery("#"+this.id+"-keywords").val(),a=jQuery.extend(a,this.seasonSelect.payload())},magic.classes.RotheraReportSearch.prototype.saveSearchState=function(){this.savedSearch={},this.savedSearch.locations=jQuery("#"+this.id+"-locations").val(),this.savedSearch.people=jQuery("#"+this.id+"-people").val(),this.savedSearch.keywords=jQuery("#"+this.id+"-keywords").val(),this.savedSearch.season=jQuery.extend(this.savedSearch,this.seasonSelect.saveState())},magic.classes.RotheraReportSearch.prototype.restoreSearchState=function(){this.tagsInputs.locations.setValue(this.savedSearch.locations),this.tagsInputs.people.setValue(this.savedSearch.people),this.tagsInputs.keywords.setValue(this.savedSearch.keywords),this.seasonSelect.restoreState(this.savedSearch.season);var a=jQuery("#"+this.id+"-results");a.html(this.savedSearch.nresults),a.removeClass("hidden")},magic.classes.RotheraReportSearch.prototype.validate=function(a){return this.seasonSelect.validate()},magic.classes.RotheraReportSearch.prototype.markup=function(){return'<form id="'+this.id+'-form"><div class="form-group form-group-sm"><label for="'+this.id+'-locations">Fieldwork location(s)</label><input type="text" class="form-control" id="'+this.id+'-locations" title="Enter location(s) of interest - click or type \'enter\' after each separate name"></div><div class="form-group form-group-sm"><label for="'+this.id+'-people">Participant(s)</label><input type="text" class="form-control" id="'+this.id+'-people" title="Enter participant name(s) - click or type \'enter\' after each name"></div><div class="form-group form-group-sm"><label>Season(s)</label><div id="'+this.id+'-season-select-div"></div></div><div class="form-group form-group-sm"><label for="'+this.id+'-locations">Keywords</label><input type="text" class="form-control" id="'+this.id+'-keywords" title="Enter relevant keyword(s) - click or type \'enter\' after each word"></div><div class="form-group form-group-sm"><button id="'+this.id+'-search" class="btn btn-sm btn-primary" type="button" data-toggle="tooltip" data-placement="bottom" title="Show locations having fieldwork reports on the map"><span class="fa fa-search"></span>&nbsp;Search<span id="'+this.id+'-results" class="badge badge-alert hidden" style="margin-left:10px"></span></button><button id="'+this.id+'-reset" class="btn btn-sm btn-danger" type="button" style="margin-left:5px" data-toggle="tooltip" data-placement="bottom" title="Reset the form and clear results"><span class="fa fa-times-circle"></span>&nbsp;Reset</button>'+this.infoLinkButtonMarkup("Further information on sources")+"</div>"+this.infoAreaMarkup()+"</form>"},magic.classes.RotheraReportSearch.prototype.styleFunction=function(a){var b=null;if(-1!=a.get("id").indexOf("-location")){var c=1,d=.8;a.get("hidden")?c=d=0:b=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:magic.modules.Common.rgbToDec("#ff0000",d)}),radius:3,stroke:new ol.style.Stroke({color:magic.modules.Common.rgbToDec("#ff0000",c),width:1})}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:0,offsetY:-10,text:a.get("name"),textAlign:"left",fill:new ol.style.Fill({color:magic.modules.Common.rgbToDec("#ff0000",c)})})})}else if(-1!=a.get("id").indexOf("-connector")){var e=a.get("hidden")?0:.5;b=new ol.style.Style({stroke:new ol.style.Stroke({color:magic.modules.Common.rgbToDec("#ff0000",e),width:1.5})})}else b=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:1,src:magic.config.paths.cdn+"/images/asset-symbols/field_report.png"})});return b},magic.classes.RotheraReportSearch.prototype.mouseover=function(a){if(a){var b=a.get("id");if(!a.get("_ignoreHovers")&&jQuery.isArray(a.get("_associates"))){if(0==a.get("_associates").length){var c=[];if(a.get("_locations")){for(var d=a.get("_locations").split("~"),e=0;e<d.length;e++){var f=d[e].split(/\sPOINT\(/),g=f[1].replace(/\)$/,"").split(" "),h=new ol.geom.Point([parseFloat(g[0]),parseFloat(g[1])]);h.transform("EPSG:4326",magic.runtime.map.getView().getProjection().getCode());var i={id:b+"-location",name:f[0],layer:this.layer,geometry:h,hidden:!0,_ignoreClicks:!0,_ignoreHovers:!0},j=new ol.Feature(i);this.layer.getSource().addFeature(j),c.push(j);var k={id:b+"-connector",geometry:new ol.geom.LineString([a.getGeometry().getCoordinates(),h.getCoordinates()]),layer:this.layer,hidden:!0,_ignoreClicks:!0,_ignoreHovers:!0},l=new ol.Feature(k);this.layer.getSource().addFeature(l),c.push(l)}a.set("_associates",c)}}jQuery.each(a.get("_associates"),function(a,b){b.set("hidden",!1)}),this.mousedOver=a}}},magic.classes.RotheraReportSearch.prototype.mouseout=function(){if(this.mousedOver){var a=this.mousedOver.get("_associates");a&&jQuery.isArray(a)&&jQuery.each(a,function(a,b){b.set("hidden",!0)}),this.mousedOver=null}},magic.classes.RotheraReportSearch.prototype.setHoverHandlers=function(){this.isActive()&&this.map.on("pointermove",jQuery.proxy(function(a){this.mouseout(),jQuery("#"+a.map.getTarget()).css("cursor","help"),a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(b,c){if(c==this.layer)return this.mouseover(b),jQuery("#"+a.map.getTarget()).css("cursor","pointer"),!0},this))},this))},magic.classes.RotheraReportSearch.prototype.fullFeatureDataFetch=function(a,b,c){jQuery.ajax({url:magic.config.paths.baseurl+"/rothera_reports/data?id="+encodeURIComponent(b.id),method:"GET",dataType:"json",contentType:"application/json"}).done(jQuery.proxy(function(d){var e={id:d.id,title:d.title,description:d.description.replace("~","'"),people:d.people?d.people.split("~").join("<br>"):"",season:d.startdate&&d.enddate?d.startdate.substr(d.startdate.length-4)+" - "+(parseInt(d.startdate.substr(d.startdate.length-4))+1):NaN,report:magic.config.paths.baseurl+"/rothera_reports/serve?filename="+d.filename};b=jQuery.extend(b,e),a(b,c)},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to get full attribute data for this report - details : "+b,"warning")})},magic.classes.RotheraReportSearch.prototype.interactsMap=function(){return!0},magic.classes.ShipPositionButton=function(a,b,c){magic.classes.AssetPositionButton.call(this,a,b,c),this.attribute_map=[{name:"callsign",alias:"Call sign",displayed:!0},{name:"checktimestamp",alias:"Date",displayed:!0},{name:"longitude",alias:"Longitude",displayed:!0},{name:"latitude",alias:"Latitude",displayed:!0},{name:"speed",alias:"Speed",displayed:!1}]},magic.classes.ShipPositionButton.prototype=Object.create(magic.classes.AssetPositionButton.prototype),magic.classes.ShipPositionButton.prototype.constructor=magic.classes.ShipPositionButton,magic.classes.ShipPositionButton.prototype.getData=function(){jQuery.ajax({url:"https://add.data.bas.ac.uk/geoserver/assets/wfs?service=wfs&request=getfeature&version=2.0.0&typeNames=assets:latest_ship_positions&outputFormat=json",method:"GET",success:jQuery.proxy(function(a){if(this.geoJson){this.data={inside:[],outside:[]};var b=this.geoJson.readFeatures(a),c=magic.modules.GeoUtils.projectionLatLonExtent(magic.runtime.map.getView().getProjection().getCode());if(jQuery.each(b,jQuery.proxy(function(a,b){var d=jQuery.extend({},b.getProperties()),e=b.clone();e.setProperties(d),b.getGeometry().intersectsExtent(c)?(e.getGeometry().transform("EPSG:4326",magic.runtime.map.getView().getProjection().getCode()),e.setStyle(magic.modules.VectorStyles.bas_ship(magic.runtime.map.getView().getProjection().getCode())),this.data.inside.push(e)):(e.getGeometry().transform("EPSG:4326","EPSG:3857"),e.setStyle(magic.modules.VectorStyles.bas_ship("EPSG:3857")),this.data.outside.push(e))},this)),this.layer.getSource().clear(),this.data.inside.length>0&&this.layer.getSource().addFeatures(this.data.inside),this.data.outside.length>0){if(this.insetLayer){this.insetLayer.getSource().clear();var d=jQuery.map(this.data.outside,function(a){return a.clone()});this.insetLayer.getSource().addFeatures(d)}magic.runtime.inset&&magic.runtime.inset.activate()}}},this),error:function(a,b,c){console.log("Failed to get ship positional data - potential network outage?")}})},magic.classes.AppContainer=function(){this.highlighted=null,this.fitMapToViewport(),magic.runtime.issue=new magic.classes.IssueInformation,magic.runtime.preferences=jQuery.extend({},magic.modules.GeoUtils.DEFAULT_GEO_PREFS,{dates:"dmy"},magic.runtime.map_context.preferencedata);var a=this.initView();magic.runtime.endpoints=magic.runtime.map_context.endpoints,this.layertree=new magic.classes.LayerTree("layer-tree",this),this.ddGpxKml=new magic.classes.DragDropGpxKml({}),magic.runtime.map=new ol.Map({renderer:"canvas",loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0,layers:this.layertree.getLayers(),controls:[new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-top",units:"metric"}),new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-bottom",units:"imperial"}),new ol.control.MousePosition({projection:"EPSG:4326",className:"custom-mouse-position",coordinateFormat:function(a){return"Lat : "+magic.modules.GeoUtils.applyPref("coordinates",a[1].toFixed(2),"lat")+", lon : "+magic.modules.GeoUtils.applyPref("coordinates",a[0].toFixed(2),"lon")}})],interactions:ol.interaction.defaults().extend([this.ddGpxKml.getDdInteraction()]),target:"map",view:a}),new magic.classes.ControlButtonRibbon,this.featureinfotool=new magic.classes.FeatureInfoTool,this.featureinfotool.activate(),magic.runtime.layer_visibility_change_callback=jQuery.proxy(this.featureinfotool.layerVisibilityHandler,this.featureinfotool),new magic.classes.InfoModal,magic.runtime.inset=new magic.classes.InsetMap,this.navbarTools={geosearch:this.allocateNavbarTool("geosearch","Geosearch",{gazetteers:magic.runtime.map_context.data.gazetteers,target:"geosearch-tool"}),measurement:this.allocateNavbarTool("measurement","Measurement",{target:"measure-tool"}),overview_map:this.allocateNavbarTool("overview_map","OverviewMap",{target:"overview-map-tool",layertree:this.layertree}),feedback:this.allocateNavbarTool("feedback","Feedback",{target:"feedback-tool"}),personaldata:this.allocateNavbarTool("personaldata","PersonalData",{target:"personaldata-tool"}),download_data:this.allocateNavbarTool("download_data","DownloadRepo",{target:"repo-tool"}),rothera_reports:this.allocateNavbarTool("rothera_reports","RotheraReportSearch",{id:"rothera-reports-tool",target:"rothera_reports",caption:"Search fieldwork reports",layername:"Rothera fieldwork reports",popoverClass:"reports-popover",popoverContentClass:"reports-popover-content"}),field_party_position:this.allocateNavbarTool("field_party_position","FieldPartyPositionButton",{id:"field-party-position-tool",target:"field_party_position",caption:"Current Field Party positions",layername:"Current Field Party positions",popoverClass:"field-party-popover",popoverContentClass:"field-party-popover-content"})},jQuery(window).on("resize",jQuery.proxy(function(){this.fitMapToViewport()},this)),magic.runtime.map.getView().on("change:resolution",function(a){this.navbarTools.overview_map&&this.navbarTools.overview_map.setEnabledStatus()},this),this.initMapMetadata(),this.activateLogoutMenu(),this.setMapInteractionToolHandlers(),this.enableScalelinePopover(),this.setVectorLayerLabelHandler(),this.layertree.initAutoLoadGroups(magic.runtime.map),this.displayWatermark(),this.displayAnnouncement()},magic.classes.AppContainer.prototype.initMapMetadata=function(){var a=magic.runtime.map_context;jQuery("#apptitle").text(a.title),jQuery(document).attr("title",a.title),jQuery("meta[name='description']").attr("content",a.title),a.logo&&jQuery("#applogo").attr("src",a.logo),jQuery("#appurl").attr("href",a.metadata_url)},magic.classes.AppContainer.prototype.allocateNavbarTool=function(a,b,c){var d=null,e=jQuery("#"+c.target);return e.length>0&&(-1!=jQuery.inArray(a,magic.runtime.map_context.data.controls)?(d=new magic.classes[b](c),e.closest("li").show()):e.closest("li").hide()),d},magic.classes.AppContainer.prototype.initView=function(){var a,b=magic.runtime.map_context.data,c=ol.proj.get(b.projection),d=magic.runtime.issue.getPayload(),e="None"==d?jQuery.isEmptyObject(magic.runtime.map_context.userdata)?b.center:magic.runtime.map_context.userdata.center:d.center,f="None"==d?jQuery.isEmptyObject(magic.runtime.map_context.userdata)?b.zoom:magic.runtime.map_context.userdata.zoom:d.zoom,g=b.rotation?magic.modules.Common.toRadians(b.rotation):0;return jQuery.isEmptyObject(magic.runtime.map_context.userdata)||(g=magic.runtime.map_context.userdata.rotation||0),"EPSG:3857"==b.projection?a=new ol.View({center:e,rotation:g,zoom:f,projection:c,minZoom:1,maxZoom:20}):(c.setExtent(b.proj_extent),c.setWorldExtent(b.proj_extent),a=new ol.View({center:e,rotation:g,zoom:f,projection:c,proj_extent:b.proj_extent,extent:b.proj_extent,maxResolution:b.resolutions[0],resolutions:b.resolutions})),a},magic.classes.AppContainer.prototype.fitMapToViewport=function(){var a=jQuery("div#layer-tree"),b=0,c=jQuery("#map-container");0==a.length||a.is(":hidden")?c.css("left",0):(b=a.width(),c.css("left",b)),c.height(window.innerHeight-jQuery("div.navbar-header").height()),c.width(window.innerWidth-b),magic.runtime.map&&magic.runtime.map.updateSize()},magic.classes.AppContainer.prototype.activateLogoutMenu=function(){jQuery("ul.navbar-right").removeClass("hidden").show();var a=jQuery("#log-out-user");a.length>0&&a.click(function(a){a.preventDefault(),jQuery("#logout-form").submit()})},magic.classes.AppContainer.prototype.setMapInteractionToolHandlers=function(){jQuery(document).on("mapinteractionactivated",jQuery.proxy(function(a,b){a&&(jQuery.each(this.navbarTools,jQuery.proxy(function(a,c){null!=c&&b!=c&&(jQuery.isFunction(c.deactivate)&&c.deactivate(),jQuery.isFunction(c.getTarget)&&c.getTarget().popover("hide"))},this)),b!=this.navbarTools.measurement?this.featureinfotool.activate():this.featureinfotool.deactivate())},this)),jQuery(document).on("mapinteractiondeactivated",jQuery.proxy(function(a,b){if(a){var c=0;jQuery.each(this.navbarTools,function(a,d){null!=d&&jQuery.isFunction(d.interactsMap)&&!0===d.interactsMap()&&b!=d&&jQuery.isFunction(d.isActive)&&d.isActive()&&c++}),0==c&&this.featureinfotool.activate()}},this))},magic.classes.AppContainer.prototype.enableScalelinePopover=function(){jQuery(".custom-scale-line-top").popover({container:"body",content:function(){var a=magic.modules.GeoUtils.getCurrentMapScale(magic.runtime.map)+"",b=a.indexOf(".");if(b>=0){var c=a.indexOf("9"),d=Math.pow(10,b-c);a=d*Math.round(parseFloat(a)/d)}return"Map scale 1:"+a},placement:"right",title:"",trigger:"hover"})},magic.classes.AppContainer.prototype.setVectorLayerLabelHandler=function(){magic.runtime.map.on("pointermove",jQuery.proxy(function(a){magic.modules.Common.defaultMouseout(this.highlighted),this.highlighted=magic.modules.Common.defaultMouseover(a)},this))},magic.classes.AppContainer.prototype.displayWatermark=function(){var a=magic.runtime.map_context.watermark;if(a){var b=jQuery("div.watermark");b.length>0&&b.append('<img src="'+a+'" alt="watermark"></img>')}},magic.classes.AppContainer.prototype.displayAnnouncement=function(){var a=magic.runtime.map_context.newslink;if(a){var b=jQuery("#announcement-modal"),c="announcement_seen_"+magic.runtime.map_context.name;if(b.length>0&&""==Cookies.get(c)){0!=a.indexOf(magic.config.paths.baseurl)&&(a=magic.modules.Commmon.proxyUrl(a));var d=b.find(".modal-body"),e=d.find("#announcement-content");e.length>0&&e.load(a,function(a,e){"success"==e&&(d.css({width:"auto",height:"auto","max-height":"90%"}),jQuery("#announcement-close").on("click",function(a){jQuery("#announcement-dismiss").prop("checked")&&Cookies.set(c,"yes",{expires:1e3}),b.modal("hide")}),b.modal("show"))})}}},magic.classes.AppContainer.prototype.getLayerByName=function(a){var b=null;return magic.runtime.map.getLayers().forEach(function(c){c.get("name")==a&&(b=c)}),b},magic.classes.AttributionModal=function(a){this.target=a.target,this.wms=a.wms,this.layer=null,this.caption="",this.metadataRecord=[{name:"abstract",caption:"Abstract",type:"long_text"},{name:"srs",caption:"Projection",type:"text"},{name:"wmsfeed",caption:"OGC WMS",type:"text"},{name:"keywords",caption:"Keywords",type:"text"},{name:"bboxsrs",caption:"Bounds (SRS)",type:"text"},{name:"bboxwgs84",caption:"Bounds (WGS84)",type:"text"},{name:"attribution",caption:"Attribution",type:"text"},{name:"metadataurl",caption:"Metadata URL",type:"text"},{name:"dataurl",caption:"Get data URL",type:"text"}],0==jQuery("#attribution-modal").length&&jQuery("#map-container").after('\x3c!-- Attribution modal --\x3e<div class="modal fade" id="attribution-modal" tabindex="-1" role="dialog" aria-labelledby="attribution-title" aria-hidden="true"><div class="modal-dialog modal-sm"><div class="modal-content" style="width:400px"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="attribution-title">Layer name</h4></div><div class="modal-body attribution-content"><div role="tabpanel"><ul class="nav nav-tabs" role="tablist"><li role="presentation" class="active"><a role="tab" data-toggle="tab" href="#attribution-legend" aria-controls="attribution-legend">Legend</a></li><li role="presentation"><a role="tab" data-toggle="tab" href="#attribution-metadata" aria-controls="attribution-metadata">Metadata</a></li></ul><div class="tab-content"><div id="attribution-legend" role="tabpanel" class="tab-pane active">Loading legend...</div><div id="attribution-metadata" role="tabpanel" class="tab-pane">Loading metadata...</div></div></div></div><div class="modal-footer attribution-footer"><button type="button" class="btn-sm btn-primary" data-dismiss="modal">Close</button></div></div></div></div>'),jQuery("#"+this.target).on("shown.bs.modal",jQuery.proxy(function(){this.legendMarkup(),jQuery('a[href="#attribution-legend"]').tab("show")},this)),jQuery('a[href="#attribution-legend"]').on("shown.bs.tab",jQuery.proxy(function(a){this.legendMarkup()},this)),jQuery('a[href="#attribution-metadata"]').on("shown.bs.tab",jQuery.proxy(function(a){this.metadataMarkup()},this))},magic.classes.AttributionModal.prototype.show=function(a){this.layer=a,jQuery("#attribution-title").html(a.get("name")),jQuery("#"+this.target).modal("show")},magic.classes.AttributionModal.prototype.legendMarkup=function(){var a=null,b='<div class="attribution-legend-content">';if(this.layer&&this.layer.get("metadata")){var c=this.layer.get("metadata");if(c.legend_graphic)a=c.legend_graphic;else if(c.source.wms_source){var d=c.source.wms_source,e="";jQuery.isFunction(this.layer.getSource().getParams)&&(e=this.layer.getSource().getParams().STYLES);var f="&buster="+(new Date).getTime(),g="&legend_options=fontName:Bitstream Vera Sans Mono;fontAntiAliasing:true;fontColor:0xffffff;fontSize:6;bgColor:0x272b30;dpi:180";a=magic.modules.Endpoints.getOgcEndpoint(d,"wms")+"?service=WMS&request=GetLegendGraphic&format=image/png&width=20&height=20&style="+e+"&layer="+c.source.feature_name+g+f}}b+=null!=a?'<div style="width:100%;background-color:#272b30"><img style="padding:10px;background-color:#272b30" src="'+a+'" alt="legend"></img></div>':'<div class="attribution-title">No legend available</div>',b+="</div>",jQuery("#attribution-legend").html(b)},magic.classes.AttributionModal.prototype.metadataMarkup=function(){var a=this.layer.get("metadata");if(a)if(a.source.wms_source||a.source.geojson_source&&a.source.feature_name){var b;b=a.source.geojson_source?a.source.geojson_source.replace("wfs","wms"):a.source.wms_source,magic.modules.Common.getCapabilities(b,jQuery.proxy(this.populateRecordWms,this),a.source.feature_name)}else{var c=null;if(a.source.geojson_source?c=a.source.geojson_source:a.source.gpx_source?c=a.source.gpx_source:a.source.kml_source&&(c=a.source.kml_source),null!=c&&null!=c.match("/entry/get")&&null!=c.match(/[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}/)){var d=c.replace("/get","/show")+"&output=json";jQuery.getJSON(d,jQuery.proxy(this.populateRecordRamadda,this)).fail(function(a,b,c){var d="Failed to get metadata from Ramadda, error was : "+c;jQuery("#attribution-metadata").html(d)})}else jQuery("#attribution-metadata").html("No metadata available")}else jQuery("#attribution-metadata").html("No metadata available")},magic.classes.AttributionModal.prototype.populateRecordRamadda=function(a){var b={},c=a[0];if(c){var d=[];if(jQuery.each(["name","description","typeName","createDate","filename","filesize"],function(a,b){c[b]&&d.push(b+" : "+c[b])}),b.abstract=d.join("<br>"),b.srs=magic.modules.GeoUtils.formatProjection("EPSG:4326"),b.keywords=c.type,b.bboxwgs84=magic.modules.GeoUtils.formatBbox(c.bbox,1),jQuery.isArray(c.services)){var e=[];jQuery.each(c.services,function(a,b){e.push('<a href="'+b.url+'" target="_blank">[external resource]</a>')}),b.metadataurl=e.join("<br>")}}else b={error:"Malformed metadata from Ramadda"};this.tabulate(b)},magic.classes.AttributionModal.prototype.populateRecordWms=function(a,b,c){var d={};if(a){var e=magic.runtime.map.getView().getProjection().getCode(),f=this.findFeatureInCaps(a,b);if(null!=f){if(d.abstract=f.Abstract||"",d.srs=magic.modules.GeoUtils.formatProjection("EPSG:4326"),jQuery.isArray(f.CRS))for(var g=0;g<f.CRS.length;g++)if(f.CRS[g]==e){d.srs=magic.modules.GeoUtils.formatProjection(f.CRS[g]);break}var h=this.layer.get("metadata").source.wms_source;if(d.wmsfeed=h?magic.modules.Endpoints.getOgcEndpoint(h,"wms")+"?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS="+b+"&CRS="+e+"&SRS="+e+"&TILED=true&WIDTH=1000&HEIGHT=1000&STYLES=&BBOX="+magic.runtime.map.getView().getProjection().getExtent().join(","):"Not available",d.keywords=f.KeywordList?f.KeywordList.join("<br>"):"",jQuery.isArray(f.BoundingBox)&&jQuery.each(f.BoundingBox,function(a,b){if(b.crs==magic.runtime.map.getView().getProjection().getCode())return d.bboxsrs=magic.modules.GeoUtils.formatBbox(b.extent,0),!1}),jQuery.isArray(f.EX_GeographicBoundingBox)&&(d.bboxwgs84=magic.modules.GeoUtils.formatBbox(f.EX_GeographicBoundingBox,0)),f.Attribution){var i=f.Attribution;"source"in i&&"url"in i&&(d.attribution='<a href="'+i.url+'">'+i.source+"</a>")}if(f.MetadataURL){var i=f.MetadataURL;jQuery.isArray(i)||(i=[i]);var j=[];jQuery.each(i,function(a,b){j.push('<a href="'+b.OnlineResource+'" target="_blank">[external resource]</a>')}),d.metadataurl=j.join("<br>")}if(f.DataURL){var i=f.DataURL;jQuery.isArray(i)||(i=[i]);var j=[];jQuery.each(i,function(a,b){j.push('<a href="'+b.OnlineResource+'" target="_blank">[get data]</a>')}),d.dataurl=j.join("<br>")}}else d={error:"No entry for feature in capabilities document - has it been deleted?"}}else d={error:c};this.tabulate(d)},magic.classes.AttributionModal.prototype.findFeatureInCaps=function(a,b){if(a[b])return a[b];var c=[];for(var d in a)b==d.split(":").pop()&&c.push(d);return 1==c.length?a[c[0]]:null},magic.classes.AttributionModal.prototype.tabulate=function(a){var b='<table id="attribution-metadata-content" class="table table-striped table-condensed metadata-table show">';null!=a?a.error?b+='<tr><td colspan="2">'+a.error+"</td></tr>":jQuery.each(this.metadataRecord,function(c,d){var e=a[d.name];if(e){var f="<strong>"+d.caption+"</strong>",g=magic.modules.Common.linkify(e);b+="<tr>","long_text"==d.type?b+='<td colspan="2" class="metadata" style="background-color: inherit">'+f+"<div>"+g+"</div></td>":b+='<td valign="top" style="width:120px">'+f+'</td><td class="metadata" style="width:270px">'+g+"</td>",b+="</tr>"}}):b+='<tr><td colspan="2">No metadata available</td></tr>',b+="</table>",jQuery("#attribution-metadata").html(b)},magic.classes.ControlButtonRibbon=function(a,b){this.buttons=a||magic.runtime.map_context.data.controls,this.map=b||magic.runtime.map;var c="control-button-ribbon",d=c+"-group",e="maximise-"+d,f="0px",g=jQuery("nav.navbar");g.length>0&&(f=g.outerHeight()-50+"px"),jQuery(this.map.getTargetElement()).find("div.ol-overlaycontainer-stopevent").prepend('<div id="'+c+'" style="position:absolute; left:  0px; top: '+f+'" class="btn-toolbar"><div id="'+d+'" class="btn-group button-ribbon show"></div><div id="'+e+'" class="btn-group button-ribbon hidden"></div></div>'),this.ribbonDiv=jQuery("#"+d),this.maximiseDiv=jQuery("#"+e),jQuery("body").tooltip({selector:"[data-toggle=tooltip]",container:"body"}),jQuery(this.map.getTargetElement()).parent().popover({selector:"[data-toggle=popover]",container:"#"+this.map.getTargetElement().id}),jQuery.each(this.buttons,jQuery.proxy(function(a,b){switch(b){case"zoom_world":this.createControlButton("zoom-world","fa fa-globe",a,"Reset to original map extent").on("click",jQuery.proxy(this.zoomToMaxExtent,this));break;case"zoom_in":this.createControlButton("zoom-in","fa fa-search-plus",a,"Zoom map in").on("click",{delta:1},jQuery.proxy(this.zoomByDelta,this));break;case"zoom_out":this.createControlButton("zoom-out","fa fa-search-minus",a,"Zoom map out").on("click",{delta:-1},jQuery.proxy(this.zoomByDelta,this));break;case"box_zoom":this.appendControlButton(new magic.classes.DragZoomButton("box-zoom",this).getButton());break;case"full_screen":this.appendControlButton(new magic.classes.FullScreenButton("full-screen",this).getButton());break;case"rotation":this.appendControlButton(new magic.classes.ResetRotationButton("rotation",this).getButton());break;case"graticule":this.appendControlButton(new magic.classes.GraticuleButton("graticule",this).getButton());break;case"geolocation":this.appendControlButton(new magic.classes.GeolocationButton("geolocation",this).getButton());break;case"aircraft":this.appendControlButton(new magic.classes.AircraftPositionButton("aircraft-position",this,{title:"BAS aircraft",iconClass:"fa fa-plane"}).getButton());break;case"ships":this.appendControlButton(new magic.classes.ShipPositionButton("ship-position",this,{title:"BAS ships",iconClass:"fa fa-ship"}).getButton())}},this)),this.createControlButton("minimise-control-ribbon","fa fa-caret-left",this.buttons.length,"Minimise control toolbar").on("click",jQuery.proxy(function(){this.maximiseDiv.toggleClass("hidden"),this.ribbonDiv.toggleClass("hidden")},this)),this.createControlButton("maximise-control-ribbon","fa fa-caret-right",-1,"Maximise control toolbar",this.maximiseDiv).on("click",jQuery.proxy(function(){this.ribbonDiv.toggleClass("hidden"),this.maximiseDiv.toggleClass("hidden")},this))},magic.classes.ControlButtonRibbon.prototype.getDiv=function(){return this.ribbonDiv},magic.classes.ControlButtonRibbon.prototype.appendControlButton=function(a){a.appendTo(this.ribbonDiv)},magic.classes.ControlButtonRibbon.prototype.createControlButton=function(a,b,c,d,e){e||(e=this.ribbonDiv);var f="ribbon-middle-tool";c==this.buttons.length?f="ribbon-last-tool maxmin-button":c<0&&(f="ribbon-last-tool maxmin-button");var g=jQuery("<button>",{id:"btn-"+a,class:"btn btn-default "+f,"data-toggle":"tooltip","data-placement":c<=0?"right":"bottom",title:d,html:'<span class="'+b+'"></span>'});return g.appendTo(e),g},magic.classes.ControlButtonRibbon.prototype.zoomToMaxExtent=function(){this.map.getView().setZoom(magic.runtime.map_context.data.zoom),this.map.getView().setCenter(magic.runtime.map_context.data.center)},magic.classes.ControlButtonRibbon.prototype.zoomByDelta=function(a){var b=this.map.getView(),c=b.getResolution(),d=b.constrainResolution(c,a.data.delta);b.setResolution(d)},magic.classes.DragDropGpxKml=function(a){this.id=a.id||"dd-gpx-kml",this.map=a.map||null,this.userlayers=[],this.dd=new ol.interaction.DragAndDrop({formatConstructors:[ol.format.GPX,ol.format.KML]}),this.dd.on("addfeatures",jQuery.proxy(function(a){null==this.map&&(this.map=magic.runtime.map);var b=new ol.source.Vector({features:a.features});jQuery.each(a.features,jQuery.proxy(function(a,b){b.setStyle(this.constructStyle(b))},this));var c=new ol.layer.Vector({name:a.file&&a.file.name?a.file.name:"_user_layer_"+this.userlayers.length,source:b,renderMode:"image",metadata:{is_interactive:!0}});this.map.addLayer(c);var d=magic.modules.GeoUtils.bufferExtent(b.getExtent());this.map.getView().fit(d,{padding:[20,20,20,20]}),this.userlayers.push(c)},this))},magic.classes.DragDropGpxKml.prototype.getDdInteraction=function(){return this.dd},magic.classes.DragDropGpxKml.prototype.constructStyle=function(a){var b=a.getGeometry().getType(),c=this.userlayers.length%magic.modules.Common.color_palette.length,d=null;return jQuery.each(a.getProperties(),function(a,b){if(magic.modules.Common.isNameLike(a))return d=b,!1}),magic.modules.Common.fetchStyle(b,c,d)},magic.classes.FeatureInfoTool=function(a,b){this.name=a||"feature-info-tool",this.map=b||magic.runtime.map,this.active=!1,this.featureinfo=new magic.classes.FeaturePopup},magic.classes.FeatureInfoTool.prototype.isActive=function(){return this.active},magic.classes.FeatureInfoTool.prototype.activate=function(){this.active=!0,jQuery("#"+this.map.getTarget()).css("cursor","help"),this.map.on("singleclick",this.queryFeatures,this)},magic.classes.FeatureInfoTool.prototype.deactivate=function(){this.active=!1,this.featureinfo.hide(),jQuery("#"+this.map.getTarget()).css("cursor","default"),this.map.un("singleclick",this.queryFeatures,this)},magic.classes.FeatureInfoTool.prototype.queryFeatures=function(a){var b=magic.modules.Common.featuresAtPixel(a),c=[];this.map.forEachLayerAtPixel(a.pixel,function(d){var e=null,f=d.get("metadata");magic.modules.Endpoints.getEndpointBy("url",f.source.wms_source);(e=d.getSource().getGetFeatureInfoUrl(a.coordinate,this.map.getView().getResolution(),this.map.getView().getProjection(),{LAYERS:f.source.feature_name,QUERY_LAYERS:f.source.feature_name,INFO_FORMAT:"application/json",FEATURE_COUNT:10,buffer:20}))&&c.push(jQuery.get(magic.modules.Common.proxyUrl(e),function(a){"string"==typeof a&&(a=JSON.parse(a)),jQuery.isArray(a.features)&&a.features.length>0&&jQuery.each(a.features,function(a,c){c.geometry&&b.push(jQuery.extend({},c.properties,{layer:d}))})}))},this,function(a){var b=a.get("metadata");return!0===a.getVisible()&&b&&b.source&&b.source.wms_source&&!0===b.is_interactive},this),jQuery.when.apply(jQuery,c).done(jQuery.proxy(function(){this.featureinfo.show(a.coordinate,b)},this))},magic.classes.FeatureInfoTool.prototype.layerVisibilityHandler=function(){this.featureinfo.hideInvisibleLayerPopups()},magic.classes.FeaturePopup=function(a){a||(a={}),this.featureCollection=a.features||[],this.popupId=a.popupId||"popup",this.map=a.map||magic.runtime.map,this.continuation="all-attributes-modal",this.initPager=!1,this.featurePointer=0,this.LONG_FIELD_THRESHOLD=120,0==jQuery("#"+this.popupId).length&&jQuery("#map-container").after('\x3c!-- Pop-up overlay --\x3e<div id="'+this.popupId+'" class="ol-popup"><div id="'+this.popupId+'-content"></div></div>'),this.popupElt=jQuery("#"+this.popupId),this.popup=new ol.Overlay({element:this.popupElt[0],positioning:"center-center"}),this.map.addOverlay(this.popup),0==jQuery(this.continuation).length&&jQuery("#map-container").after('\x3c!-- Full attribute set modal --\x3e<div class="modal fade" id="'+this.continuation+'" tabindex="-1" role="dialog" aria-labelledby="'+this.continuation+'-title" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="'+this.continuation+'-title">Raw attribute set (unformatted)</h4></div><div id="'+this.continuation+'-content" class="modal-body">Loading attributes...</div><div class="modal-footer"><button type="button" class="btn-sm btn-primary" data-dismiss="modal">Close</button></div></div></div></div>')},magic.classes.FeaturePopup.prototype.show=function(a,b){jQuery("#"+this.popupId).popover("destroy"),b.length>0&&(this.popup.setPosition(a),jQuery.extend(this,{featurePointer:0,initPager:!1,featureCollection:b}),this.popupElt.popover({placement:jQuery.proxy(function(){var b="bottom",c=this.map.getPixelFromCoordinate(a),d=jQuery("#map-container").children(":first").outerHeight(),e=c[1]-400;return c[1]+400>d&&(b=e>0?"top":"bottom"),b},this),animation:!1,title:this.title(),html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(){jQuery("span[id^='"+this.popupId+"-title-']").find("button.close").click(jQuery.proxy(function(){this.popupElt.popover("hide")},this)),this.selectFeature()},this)),jQuery("#"+this.popupId).popover("show"))},magic.classes.FeaturePopup.prototype.hide=function(){this.popupElt.popover("destroy")},magic.classes.FeaturePopup.prototype.title=function(){var a="";return jQuery.each(this.featureCollection,jQuery.proxy(function(b,c){var d=c.layer.get("name");a+='<span id="'+this.popupId+"-title-"+b+'" class="feature-popup-title-cont '+(b>0?"hidden":"show")+'">'+magic.modules.Common.ellipsis(d,25)+'<button type="button" style="float:right" class="close">&times;</button></span>'},this)),a},magic.classes.FeaturePopup.prototype.markup=function(){var a="";return jQuery.each(this.featureCollection,jQuery.proxy(function(b,c){a+='<div id="'+this.popupId+"-table-"+b+'" class="feature-popup-table-cont '+(b>0?"hidden":"show")+'">',a+=this.featureAttributeTableMarkup(c,b),a+="</div>"},this)),this.featureCollection.length>1&&(a+='<div id="'+this.popupId+'-pager"><div class="btn-group btn-group-xs" role="group"><button id="'+this.popupId+'-pager-first" type="button" class="btn btn-default disabled"><span class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="left" title="First feature"></span></button><button id="'+this.popupId+'-pager-prev" type="button" class="btn btn-default disabled"><span class="fa fa-angle-left" data-toggle="tooltip" data-placement="top" title="Previous feature"></span></button><div class="popup-pager-xofy" id="'+this.popupId+'-pager-xofy">Showing 1 of '+this.featureCollection.length+'</div><button id="'+this.popupId+'-pager-next" type="button" class="btn btn-default"><span class="fa fa-angle-right" data-toggle="tooltip" data-placement="top" title="Next feature"></span></button><button id="'+this.popupId+'-pager-last" type="button" class="btn btn-default"><span class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="right" title="Last feature"></span></button></div></div>'),a},magic.classes.FeaturePopup.prototype.featureAttributeTableMarkup=function(a,b){var c='<table class="table table-striped table-condensed feature-popup-table">',d=0,e=-1,f=!1,g=!1;if(a.layer){var h=a.layer.get("metadata");if(h){var i=h.attribute_map;jQuery.isArray(i)&&i.length>0?i.sort(function(a,b){var c=a.ordinal||999,d=b.ordinal||999;return c<d?-1:c>d?1:0}):(i=this.minimumPopupAttrs(a),f=!0),h.source&&magic.modules.Common.isUrl(h.source.esrijson_source)&&(g=!0),e=i.length,jQuery.each(i,jQuery.proxy(function(b,e){var f=!1;if(!0===e.displayed){var g=e.alias||e.name;if("xsd:string"==e.type){var h="";if(a[e.name]){var i=a[e.name].indexOf('"'),j=a[e.name].lastIndexOf('"');if(-1!=i&&-1!=j)h=magic.modules.Common.linkify(a[e.name].substring(j+2),a[e.name].substring(i+1,j));else{var k=magic.modules.Common.linkify(a[e.name]);a[e.name].length>this.LONG_FIELD_THRESHOLD?(h+='<button class="btn btn-default btn-sm long-field-extension" role="button" data-toggle="popover" data-placement="right"><span class="fa fa-ellipsis-h"></span><div style="display:none">'+k+"</div></button>",f=!0):h=k}c+="<tr><td>"+g+"</td><td"+(f?' align="right"':"")+">"+h+"</td></tr>",d++}}else if(a[e.name]||jQuery.isNumeric(a[e.name])){var l=this.attributeValue(e.name,a[e.name]);""!=l&&(c+="<tr><td>"+g+'</td><td align="right">'+this.attributeValue(e.name,a[e.name])+"</td></tr>",d++)}}},this))}}return(-1==e||e>d||f||g)&&(c+='<tr><td colspan="2" align="center"><button type="button" id="'+this.popupId+"-full-attr-set-"+b+'" class="btn btn-primary btn-xs">Full attribute set</button></td></tr>'),c+="</table>"},magic.classes.FeaturePopup.prototype.minimumPopupAttrs=function(a){var b=[];if(a&&!jQuery.isEmptyObject(a)){var c=null,d=null,e=null,f=null;for(var g in a)!c&&magic.modules.Common.isNameLike(g)&&a[g]&&(c=g),a[g]&&"string"==typeof a[g]&&!jQuery.isNumeric(a[g])&&(d=g),!e&&magic.modules.Common.isLongitudeLike(g)&&jQuery.isNumeric(a[g])&&(e=g),!f&&magic.modules.Common.isLatitudeLike(g)&&jQuery.isNumeric(a[g])&&(f=g);c=c||d,c&&b.push({name:c,displayed:!0,alias:magic.modules.Common.initCap(c),type:"xsd:string"}),e&&b.push({name:e,displayed:!0,alias:magic.modules.Common.initCap(e),type:"xsd:decimal"}),f&&b.push({name:f,displayed:!0,alias:magic.modules.Common.initCap(f),type:"xsd:decimal"})}return b},magic.classes.FeaturePopup.prototype.selectFeature=function(){this.featureCollection.length>1&&jQuery("#"+this.popupId+"-pager-xofy").html("Showing "+(this.featurePointer+1)+" of "+this.featureCollection.length),jQuery("span[id^='"+this.popupId+"-title-']").each(jQuery.proxy(function(a,b){a==this.featurePointer?jQuery(b).removeClass("hidden").addClass("show"):jQuery(b).removeClass("show").addClass("hidden")},this)),jQuery("div[id^='"+this.popupId+"-table-']").each(jQuery.proxy(function(a,b){if(a==this.featurePointer){var c=this.featureCollection[a];jQuery.isFunction(c.layer.get("fetcher"))?c.layer.get("fetcher")(jQuery.proxy(function(a,c){jQuery(b).html(this.featureAttributeTableMarkup(a,c)),this.longFieldPopoverHandler(b),this.fixPopoverPosition(),this.assignFullSetHandler(b)},this),c,a):(this.longFieldPopoverHandler(b),this.assignFullSetHandler(b)),jQuery(b).removeClass("hidden").addClass("show")}else jQuery(b).removeClass("show").addClass("hidden")},this)),this.featureCollection.length>1&&(this.initPager||(jQuery("#"+this.popupId+"-pager div button").off("click").on("click",jQuery.proxy(function(a){switch(a.currentTarget.id){case this.popupId+"-pager-first":this.featurePointer=0;break;case this.popupId+"-pager-prev":this.featurePointer>0&&this.featurePointer--;break;case this.popupId+"-pager-next":this.featurePointer<this.featureCollection.length-1&&this.featurePointer++;break;case this.popupId+"-pager-last":this.featurePointer=this.featureCollection.length-1}0==this.featurePointer?(jQuery("#"+this.popupId+"-pager-first").prop("disabled",!0).addClass("disabled"),jQuery("#"+this.popupId+"-pager-prev").prop("disabled",!0).addClass("disabled"),jQuery("#"+this.popupId+"-pager-next").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-last").prop("disabled",!1).removeClass("disabled")):this.featurePointer==this.featureCollection.length-1?(jQuery("#"+this.popupId+"-pager-first").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-prev").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-next").prop("disabled",!0).addClass("disabled"),jQuery("#"+this.popupId+"-pager-last").prop("disabled",!0).addClass("disabled")):(jQuery("#"+this.popupId+"-pager-first").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-prev").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-next").prop("disabled",!1).removeClass("disabled"),jQuery("#"+this.popupId+"-pager-last").prop("disabled",!1).removeClass("disabled")),this.selectFeature(),this.fixPopoverPosition()},this)),this.initPager=!0))},magic.classes.FeaturePopup.prototype.longFieldPopoverHandler=function(a){jQuery(a).find("button.long-field-extension").each(function(a,b){var c=jQuery(b).children("div");c.length>0&&jQuery(b).popover({title:!1,html:!0,content:'<div style="width:200px">'+jQuery(c[0]).html()+"</div>"})})},magic.classes.FeaturePopup.prototype.assignFullSetHandler=function(a){jQuery(a).find("button[id^='"+this.popupId+"-full-attr-set-']").off("click").on("click",jQuery.proxy(function(a){var b=a.currentTarget.id,c=parseInt(b.substring(b.lastIndexOf("-")+1));if(!isNaN(c)&&c<this.featureCollection.length){var d=this.featureCollection[c],e=[];for(var f in d)"layer"!=f&&"bbox"!=f&&"geometry"!=f&&0!=f.indexOf("_")&&e.push(f);var g='<table class="table table-striped table-condensed feature-popup-table">';jQuery.each(e.sort(),function(a,b){var c=d[b];if(jQuery.isNumeric(c))g+="<tr><td>"+magic.modules.Common.initCap(b)+'</td><td align="right">'+c+"</td></tr>";else if(c&&-1==b.toLowerCase().indexOf("geom")){var e="";if(c){var f=c.indexOf('"'),h=c.lastIndexOf('"');e=-1!=f&&-1!=h?magic.modules.Common.linkify(c.substring(h+2),c.substring(f+1,h)):magic.modules.Common.linkify(c)}g+="<tr><td>"+magic.modules.Common.initCap(b)+"</td><td>"+e+"</td></tr>"}}),g+="</table>",jQuery("#"+this.continuation+"-content").html(g),jQuery("#"+this.continuation).modal("show")}},this))},magic.classes.FeaturePopup.prototype.fixPopoverPosition=function(){var a=jQuery("div[id^='"+this.popupId+"-table-']").first().parents("div.popover");a.hasClass("top")&&a.css("top",-a.outerHeight()+"px"),a.find("div.arrow").css("left",parseInt(11600/a.innerWidth())+"%")},magic.classes.FeaturePopup.prototype.attributeValue=function(a,b){var c="";return null!=b&&""!=b&&void 0!=b&&(magic.modules.Common.isLongitudeLike(a)?(jQuery.isNumeric(b)||(b=b.replace(/&[^;]+;\s?/g," ")),c=magic.modules.GeoUtils.applyPref("coordinates",b,"lon")):magic.modules.Common.isLatitudeLike(a)?(jQuery.isNumeric(b)||(b=b.replace(/&[^;]+;\s?/g," ")),c=magic.modules.GeoUtils.applyPref("coordinates",b,"lat")):c=magic.modules.Common.isDatetimeLike(a)?magic.modules.GeoUtils.applyPref("dates",b):b),c},magic.classes.FeaturePopup.prototype.hideInvisibleLayerPopups=function(){jQuery.each(this.featureCollection,jQuery.proxy(function(a,b){if(!b.layer.getVisible())return this.hide(),!1},this))},magic.classes.InsetMap=function(a){this.id=a?a.id:"inset-map-tool",this.target=a?a.target:jQuery("button.inset-map-expand"),this.active=!1,this.map=null,this.featureInfo=null,this.highlighted=null,this.template='<div class="popover popover-auto-width popover-auto-height inset-map-popover" role="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div id="inset-map" class="popover-content inset-map-popover-content"></div></div>',this.target.popover({template:this.template,title:'<span>Mid-latitudes map<button type="button" class="close">&times;</button></span>',container:"body",html:!0,content:""}).on("shown.bs.popover",jQuery.proxy(function(){this.initMap(),jQuery(".inset-map-popover").find("button.close").click(jQuery.proxy(function(){this.target.popover("hide")},this)),jQuery.event.trigger({type:"insetmapopened"})},this)).on("hidden.bs.popover",jQuery.proxy(function(){this.featureinfo&&this.featureinfo.hide(),this.map=null,this.featureinfo=null,jQuery.event.trigger({type:"insetmapclosed"})},this))},magic.classes.InsetMap.prototype.getTarget=function(){return this.target},magic.classes.InsetMap.prototype.getTemplate=function(){return this.template},magic.classes.InsetMap.prototype.addLayer=function(a){this.map.addLayer(a)},magic.classes.InsetMap.prototype.activate=function(){this.active||(this.target.removeClass("hidden").addClass("show"),this.target.popover("show"),this.active=!0)},magic.classes.InsetMap.prototype.deactivate=function(){this.active=!1;var a=0,b=0;this.map&&this.map.getLayers().forEach(function(c,d,e){jQuery.isFunction(c.getSource().getFeatures)&&(a+=c.getSource().getFeatures().length),b++},this),0==a&&this.target.popover("hide")},magic.classes.InsetMap.prototype.isActive=function(){return this.active},magic.classes.InsetMap.prototype.initMap=function(){this.map=new ol.Map({renderer:"canvas",target:"inset-map",layers:[magic.modules.Endpoints.getMidLatitudeCoastLayer()],controls:[new ol.control.ScaleLine({minWidth:50,className:"custom-scale-line-top",units:"metric"}),new ol.control.ScaleLine({minWidth:50,className:"custom-scale-line-bottom",units:"imperial"}),new ol.control.MousePosition({projection:"EPSG:4326",className:"custom-mouse-position",coordinateFormat:function(a){return"Lon : "+a[0].toFixed(2)+", lat : "+a[1].toFixed(2)}})],interactions:ol.interaction.defaults(),view:new ol.View({center:[0,0],minZoom:1,maxZoom:10,zoom:1,projection:ol.proj.get("EPSG:3857")})}),this.featureinfo=new magic.classes.FeaturePopup({popupId:"inset-popup",map:this.map,mapdiv:"inset-map"}),this.map.on("singleclick",this.featureAtPixelHandler,this),this.map.on("pointermove",jQuery.proxy(function(a){magic.modules.Common.defaultMouseout(this.highlighted),this.highlighted=magic.modules.Common.defaultMouseover(a)},this))},magic.classes.InsetMap.prototype.featureAtPixelHandler=function(a){this.featureinfo.show(a.coordinate,magic.modules.Common.featuresAtPixel(a))},magic.classes.LayerFilter=function(a){this.nodeid=a.nodeid,this.target=a.target,this.layer=a.layer,this.attribute_map=this.layer.get("metadata").attribute_map,this.attr=null,this.comparison=null,this.op=null,this.val1=null,this.val2=null;var b="";jQuery.each(this.attribute_map,function(a,c){!0===c.filterable&&(b+='<option value="'+c.name+'">'+(c.alias||c.name)+"</option>")}),""==this.target.html()&&(this.target.html('<div class="layer-filter-panel"><form id="ftr-form-'+this.nodeid+'"><input id="ftr-comparison-type-'+this.nodeid+'" type="hidden" value="string"><div class="form-group form-group-sm col-sm-12"><select id="ftr-attr-'+this.nodeid+'" class="form-control">'+b+'</select></div><div class="form-group form-group-sm col-sm-12"><select id="ftr-op-str-'+this.nodeid+'" class="form-control"><option id="ftr-op-str-eq-'+this.nodeid+'" value="eq">equal to (case-insensitive)</option><option id="ftr-op-str-sw-'+this.nodeid+'" value="sw">starts with (case-insensitive)</option><option id="ftr-op-str-ew-'+this.nodeid+'" value="ew">Ends with (case-insensitive)</option><option id="ftr-op-str-ct-'+this.nodeid+'" value="ct">Contains (case-insensitive)</option><option id="ftr-op-str-nn-'+this.nodeid+'" value="nn">Has a non-null value</option></select></div><div class="form-group form-group-sm col-sm-12 hidden"><select id="ftr-op-str-unique-'+this.nodeid+'" class="form-control"><option id="ftr-op-str-eq-'+this.nodeid+'" value="eq">equal to</option></select></div><div class="form-group form-group-sm col-sm-12 hidden"><select id="ftr-op-num-'+this.nodeid+'" class="form-control"><option id="ftr-op-num-eq-'+this.nodeid+'" value="=" selected>equal to</option><option id="ftr-op-num-gt-'+this.nodeid+'" value=">">greater than</option><option id="ftr-op-num-lt-'+this.nodeid+'" value="<">less than</option><option id="ftr-op-num-gte-'+this.nodeid+'" value=">=">greater than or equal to</option><option id="ftr-op-num-lte-'+this.nodeid+'" value="<=">less than or equal to</option><option id="ftr-op-num-btw-'+this.nodeid+'" value="between">between</option></select></div><div class="form-group form-group-sm col-sm-12"><input id="ftr-val-str-'+this.nodeid+'" class="form-control" type="text" required="true" placeholder="Attribute value" data-toggle="tooltip" data-placement="bottom" title="Enter the attribute value to filter on"></input></div><div class="form-group form-group-sm col-sm-12 hidden"><select id="ftr-val-str-unique-'+this.nodeid+'" class="form-control" type="text" required="true" placeholder="Attribute value" data-toggle="tooltip" data-placement="bottom" title="Select the attribute value to filter on"></select></div><div class="form-group form-group-sm col-sm-12 hidden"><input id="ftr-val-num1-'+this.nodeid+'" class="form-control" type="number" required="true" placeholder="Numeric attribute value" data-toggle="tooltip" data-placement="bottom" title="Enter numeric attribute value to filter on"></input></div><div class="form-group form-group-sm col-sm-12 hidden"><input id="ftr-val-num2-'+this.nodeid+'" class="form-control" type="number" required="false" placeholder="Numeric attribute value" data-toggle="tooltip" data-placement="bottom" title="Enter upper numeric attribute value to filter on"></input></div><div class="form-group form-group-sm col-sm-12 hidden"><input id="ftr-val-date1-'+this.nodeid+'" class="form-control" type="date" required="true" placeholder="Date as yyyy-mm-dd hh:mm:ss" data-toggle="tooltip" data-placement="bottom" title="Enter date/time to filter on"></input></div><div class="form-group form-group-sm col-sm-12 hidden"><input id="ftr-val-date2-'+this.nodeid+'" class="form-control" type="date" required="false" placeholder="Date as yyyy-mm-dd hh:mm:ss" data-toggle="tooltip" data-placement="bottom" title="Enter date/time to filter on"></input></div><div class="form-group form-group-sm col-sm-12" style="margin-bottom:0px"><button id="ftr-btn-go-'+this.nodeid+'" class="btn btn-primary btn-xs" type="button" data-toggle="tooltip" data-placement="bottom" title="Set filter on layer" style="margin-right:5px"><span class="fa fa-filter"></span>Apply</button><button id="ftr-btn-reset-'+this.nodeid+'" class="btn btn-danger btn-xs" type="button" data-toggle="tooltip" data-placement="bottom" title="Remove layer filter"><span class="fa fa-minus-circle"></span>Reset</button></div></form></div>'),this.target.find("form").click(function(a){a.stopPropagation()}),jQuery("#ftr-attr-"+this.nodeid).on("change",jQuery.proxy(function(a){this.setFilterOptions("attr",jQuery(a.target).val())},this)),jQuery("#ftr-op-num-"+this.nodeid).on("change",jQuery.proxy(function(a){this.setFilterOptions("op",jQuery(a.target).val())},this)),jQuery("#ftr-btn-go-"+this.nodeid).on("click",jQuery.proxy(this.applyFilter,this)),jQuery("#ftr-btn-reset-"+this.nodeid).on("click",jQuery.proxy(this.resetFilter,this))),this.setFilterOptions("init",null)},magic.classes.LayerFilter.prototype.setFilterOptions=function(a,b){var c=jQuery("#ftr-form-"+this.nodeid),d=jQuery("#ftr-comparison-type-"+this.nodeid);if("attr"==a){c.find("input[type='text'],input[type='number'],input[type='hidden']").val(""),c.find("select").not("[id^='ftr-attr-']").prop("selectedIndex",0);var e=jQuery.grep(this.attribute_map,function(a){return a.name==b})[0],f=e.type.toLowerCase().replace(/^xsd:/,"");"string"==f?(d.val("string"),this.showFormFields(c,"string"),!0===e.unique_values&&this.getUniqueValues(e.name,null)):"datetime"==f?(d.val("date"),this.showFormFields(c,"date")):(d.val("number"),this.showFormFields(c,"number"))}else if("op"==a){var g=d.val();if("number"==g){var h=c.find("input[id*='-num2']");"between"==b?h.parent().removeClass("hidden"):h.parent().addClass("hidden")}else if("date"==g){var i=c.find("input[id*='-date2']");"between"==b?i.parent().removeClass("hidden"):i.parent().addClass("hidden")}}else if("init"==a)if(this.loadExistingFilter(),null!=this.attr){c.find("select[id^='ftr-attr-']").val(this.attr);var e=jQuery.grep(this.attribute_map,jQuery.proxy(function(a){return a.name==this.attr},this))[0];if("string"==this.comparison)if(d.val("string"),this.showFormFields(c,"string"),!0===e.unique_values)this.getUniqueValues(e.name,this.val1);else{var j=jQuery("#ftr-op-str-"+this.nodeid),k=jQuery("#ftr-val-str-"+this.nodeid);if("IS NOT NULL"==this.val1)j.val("nn"),k.val("");else{var l=0==this.val1.indexOf("%"),m=this.val&&this.val1.lastIndexOf("%")==this.val1.length-1;l&&m?j.val("ct"):l?j.val("ew"):m?j.val("sw"):j.val("eq"),k.val(this.val1.replace(/%/g,""))}}else if("number"==this.comparison){d.val("number"),this.showFormFields(c,"number"),jQuery("#ftr-op-num-"+this.nodeid).val(this.op),jQuery("#ftr-val-num1-"+this.nodeid).val(this.val1);var h=jQuery("#ftr-val-num2-"+this.nodeid);"between"==this.op?(h.val(this.val2),h.parent().removeClass("hidden").val(this.val2)):h.parent().addClass("hidden").val("")}else if("date"==this.comparison){d.val("date"),this.showFormFields(c,"date"),jQuery("#ftr-op-num-"+this.nodeid).val(this.op),jQuery("#ftr-val-date1-"+this.nodeid).val(this.val1);var i=jQuery("#ftr-val-date2-"+this.nodeid);"between"==this.op?(i.val(this.val2),i.parent().removeClass("hidden").val(this.val2)):i.parent().addClass("hidden").val("")}}else c.find("input[type='text'],input[type='number'],input[type='hidden']").val(""),c.find("select").prop("selectedIndex",0)},magic.classes.LayerFilter.prototype.showFormFields=function(a,b){"string"==b?(a.find("input[id*='-num'],select[id*='-num'],input[id*='-date']").parent().addClass("hidden"),a.find("input[id*='-str-"+this.nodeid+"'],select[id*='-str-"+this.nodeid+"']").parent().removeClass("hidden"),a.find("input[id*='-str-unique-'],select[id*='-str-unique']").parent().addClass("hidden")):"number"==b?(a.find("input[id*='-str'],select[id*='-str'],input[id*='-date']").parent().addClass("hidden"),a.find("input[id*='-num'],select[id*='-num-']").parent().removeClass("hidden")):"date"==b&&(a.find("input[id*='-str'],select[id*='-str'],input[id*='-num']").parent().addClass("hidden"),a.find("input[id*='-date'],select[id*='-num-']").parent().removeClass("hidden"))},magic.classes.LayerFilter.prototype.loadExistingFilter=function(){var a=magic.runtime.filters[this.layer.get("name")];if(a&&a.attr&&a.comparison&&a.op&&a.val1)this.attr=a.attr,this.comparison=a.comparison,this.op=a.op,this.val1=a.val1,this.val2=a.val2;else{var b=jQuery.grep(this.attribute_map,jQuery.proxy(function(a){return a.filterable},this));if(b.length>0){var c=b[0].type.toLowerCase().replace(/^xsd:/,"");this.attr=b[0].name,this.comparison="string"==c?"string":"datetime"==c?"date":"number",this.op="eq",this.val1="",this.val2=""}else this.attr=null,this.comparison="string",this.op="eq",this.val1="",this.val2=""}},magic.classes.LayerFilter.prototype.getUniqueValues=function(a,b){var c=this.layer.get("metadata").source;if(c)if(c.wms_source){var d=c.wms_source,e="?service=wfs&version=1.1.0&request=GetFeature&outputFormat=CSV&typeName="+c.feature_name+"&propertyName="+a,f=magic.modules.Endpoints.getWmsProxiedUrl(d);d=null!=f?magic.modules.Common.proxyUrl(f.replace(/wms$/,"wfs")+e):d.replace(/wms$/,"wfs")+e,jQuery.ajax(d).done(jQuery.proxy(function(c){var d=c.split(/\r?\n/);if(d.length>0){for(var e=-1,f=d[0].split(","),g=0;g<f.length;g++)if(f[g].trim()==a){e=g;break}if(-1!=e){d.shift();var h=jQuery.map(d,function(a){var b=magic.modules.Common.csvToArray(a);return jQuery.isArray(b)&&b.length>0&&jQuery.isArray(b[0])&&b[0].length>e?b[0][e]:null});this.populateUniqueValueSelection(h,b)}}},this)).fail(jQuery.proxy(function(a,b,c){},this))}else{var g=null;jQuery.isFunction(this.layer.getSource().getSource&&this.layer.getSource().getSource()instanceof ol.source.Vector)?g=this.layer.getSource().getSource():this.layer.getSource()instanceof ol.source.Vector&&(g=this.layer.getSource());var h={},i=jQuery.map(g.getFeatures(),jQuery.proxy(function(b,c){var d=b.get(a);return!0!==h[d]?(h[d]=!0,d):null},this));this.populateUniqueValueSelection(i,b)}},magic.classes.LayerFilter.prototype.applyFilter=function(){jQuery("div.layer-filter-panel").find("div.form-group").removeClass("has-error");var a=jQuery("#ftr-comparison-type-"+this.nodeid),b=jQuery("#ftr-op-str-"+this.nodeid),c=jQuery("#ftr-val-str-"+this.nodeid),d=jQuery("#ftr-op-num-"+this.nodeid),e=jQuery("#ftr-val-num1-"+this.nodeid),f=jQuery("#ftr-val-num2-"+this.nodeid),g=jQuery("#ftr-val-date1-"+this.nodeid),h=jQuery("#ftr-val-date2-"+this.nodeid),i=null,j=jQuery("#ftr-attr-"+this.nodeid).val(),k=a.val(),l=null,m=null,n=null,o=null;if(k&&"string"!=k)"number"==k?(l=d.val(),m=e.val(),null!=m&&""!=m?(o=j+" "+l+" '"+m+"'","between"==l&&(n=f.val(),null!=n&&""!=n?o+=" and "+n:(o=null,magic.modules.Common.flagInputError(f)))):magic.modules.Common.flagInputError(e)):"date"==k&&(l=d.val(),m=g.val(),null!=m&&""!=m?(o=j+" "+l+" '"+m+"'","between"==l&&(n=h.val(),null!=n&&""!=n?o+=" and "+n:(o=null,magic.modules.Common.flagInputError(h)))):magic.modules.Common.flagInputError(g));else{l="ilike",b.parent().hasClass("hidden")&&(b=jQuery("#ftr-op-str-unique-"+this.nodeid)),c.parent().hasClass("hidden")&&(c=jQuery("#ftr-val-str-unique-"+this.nodeid));var p=b.val();if("nn"==p)o=j+" IS NOT NULL";else if(null!=(m=c.val().replace(/\'/g,"''"))&&""!=m){switch(p){case"sw":m+="%";break;case"ew":m="%"+m;break;case"ct":m="%"+m+"%"}o=j+" "+l+" '"+m+"'"}else magic.modules.Common.flagInputError(c)}if(o){this.attr=j,this.comparison=k,this.op=l,this.val1=m,this.val2=n,magic.runtime.filters[this.layer.get("name")]=jQuery.extend({},{attr:this.attr,comparison:this.comparison,op:this.op,val1:this.val1,val2:this.val2});var q=this.layer.get("metadata").source;q.wms_source?(i="string"==k?o:j+" "+l+" "+m+("between"==l?" and "+n:""),this.layer.getSource().updateParams(jQuery.extend({},this.layer.getSource().getParams(),{cql_filter:i}))):q.geojson_source?this.filterVectorSource(this.layer.getSource(),!1):this.filterVectorSource(this.layer.getSource().getSource(),!1),jQuery("#ftr-btn-reset-"+this.nodeid).removeClass("disabled");var r=jQuery("#layer-filter-badge-"+this.nodeid);r.removeClass("hidden").attr("data-original-title",o+" (click to remove filter)").tooltip("fixTitle"),r.closest("a").click(jQuery.proxy(this.resetFilter,this)),jQuery("div.layer-filter-panel").find("div.form-group").removeClass("has-error")}},magic.classes.LayerFilter.prototype.resetFilter=function(){magic.runtime.filters[this.layer.get("name")]=null,this.attr=null,this.comparison=null,this.op=null,this.val1=null,this.val2=null;var a=this.layer.get("metadata").source;a.wms_source?this.layer.getSource().updateParams(jQuery.extend({},this.layer.getSource().getParams(),{cql_filter:null})):a.geojson_source?this.filterVectorSource(this.layer.getSource(),!0):this.filterVectorSource(this.layer.getSource().getSource(),!0),jQuery("#ftr-btn-reset-"+this.nodeid).prop("disabled",!0),jQuery("#layer-filter-badge-"+this.nodeid).addClass("hidden")},magic.classes.LayerFilter.prototype.filterVectorSource=function(a,b){var c=new ol.style.Style({image:""});jQuery.each(a.getFeatures(),jQuery.proxy(function(a,d){if(b)d.setStyle(null);else{var e=!1;if(null!=this.attr){var f=d.get(this.attr);switch(this.op){case"ilike":e=0==f.toLowerCase().indexOf(this.val1.toLowerCase());break;case"=":e=f==this.val1;break;case">":e=f>this.val1;break;case"<":e=f<this.val1;break;case">=":e=f>=this.val1;break;case"<=":e=f<=this.val1;break;case"between":e=f>=this.val1&&f<=this.val2}}d.setStyle(e?null:c)}},this))},magic.classes.LayerFilter.prototype.populateUniqueValueSelection=function(a,b){a=magic.modules.Common.sortedUniqueArray(a);var c=null,d=jQuery("#ftr-val-str-unique-"+this.nodeid);d.find("option").remove(),jQuery.each(a,function(a,e){var f=jQuery("<option>",{value:e});f.text(e),d.append(f),e==b&&(c=f)}),null!=c&&c.prop("selected","selected"),d.parent().removeClass("hidden"),jQuery("#ftr-op-str-unique-"+this.nodeid).prop("selectedIndex",0).parent().removeClass("hidden"),jQuery("#ftr-val-str-"+this.nodeid).parent().addClass("hidden"),jQuery("#ftr-op-str-"+this.nodeid).parent().addClass("hidden")},magic.classes.LayerTree=function(a,b){this.target=a||"layer-tree",this.container=b,this.treedata=magic.runtime.map_context.data.layers||[],this.userdata=magic.runtime.map_context.userdata,this.nodeLayerTranslation={},this.layersBySource={base:[],wms:[],geojson:[],esrijson:[],gpx:[],kml:[]},this.attribution=new magic.classes.AttributionModal({target:"attribution-modal"}),this.timeSeriesCache={},this.layerGroupDivs=[],this.moviePlayers={},this.autoloadGroups={},this.zIndexWmsStack=0,this.defaultNodeAttrs={legend_graphic:null,refresh_rate:0,min_scale:1,max_scale:5e7,opacity:1,is_visible:!1,is_interactive:!1,is_filterable:!1},this.defaultSourceAttrs={style_name:null,is_base:!1,is_singletile:!1,is_dem:!1,is_time_dependent:!1},this.defaultAttributeAttrs={displayed:!0,nillable:!0,filterable:!1,alias:"",ordinal:null,unique_values:!1},this.maxAttrs=10,this.visibilityChangeCallback=null;var c=jQuery("#"+this.target);c.append('<div class="layersearch-panel panel panel-info hidden" style="margin-bottom:0px"><div class="panel-heading" style="padding-bottom:0px"><div class="layersearch-form form-group form-group-sm"><div class="input-group"><input id="'+this.id+'-layersearch-ta" class="form-control typeahead border-lh-round" type="text" placeholder="Name of layer" required="required" autofocus="true"></input><span class="input-group-btn"><button id="'+this.id+'-layersearch-go" class="btn btn-default btn-sm" type="button" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Locate data layer in tree"><span class="fa fa-search"></span></button></span><span><button type="button" style="padding-bottom:10px" class="close">&times;</button></span></div></div></div></div>'),this.initTree(this.treedata,c,0);var d=jQuery("#"+this.target).find("div.panel-heading").eq(1);d&&d.append('<span data-toggle="tooltip" data-placement="bottom" title="Collapse layer tree" class="layer-tree-collapse fa fa-angle-double-left hidden-xs"></span><span data-toggle="tooltip" data-placement="bottom" title="Search for a data layer" class="layer-tree-search fa fa-search"></span>'),jQuery("span.layer-tree-collapse").on("click",jQuery.proxy(function(a){a.stopPropagation(),this.setCollapsed(!0)},this)),jQuery("button.layer-tree-expand").on("click",jQuery.proxy(function(a){a.stopPropagation(),this.setCollapsed(!1)},this)),this.collapsed=!1,this.layerGroupDivs=jQuery("#"+this.target).find("div.layer-group"),this.initLayerSearchTypeahead(),this.initHandlers(null),this.refreshTreeIndicators(),this.chromeRefreshWorkaround()},magic.classes.LayerTree.prototype.getTarget=function(){return this.target},magic.classes.LayerTree.prototype.getLayers=function(){return this.layersBySource.base.concat(this.layersBySource.wms,this.layersBySource.geojson,this.layersBySource.esrijson,this.layersBySource.gpx,this.layersBySource.kml)},magic.classes.LayerTree.prototype.getBaseLayers=function(){return this.layersBySource.base},magic.classes.LayerTree.prototype.getWmsOverlayLayers=function(){return this.layersBySource.wms},magic.classes.LayerTree.prototype.getNodeId=function(a){return a.substring(a.length-36)},magic.classes.LayerTree.prototype.getCollapsed=function(){return this.collapsed},magic.classes.LayerTree.prototype.setCollapsed=function(a){a?jQuery("#"+this.target).hide({complete:this.container.fitMapToViewport}):jQuery("#"+this.target).show({complete:this.container.fitMapToViewport}),this.collapsed=a},magic.classes.LayerTree.prototype.assignLayerGroupHandlers=function(a){var b=null;b=a?a.find("input.layer-vis-group-selector"):jQuery("input.layer-vis-group-selector"),b.change(jQuery.proxy(this.groupVisibilityHandler,this));var c=null;c=a?a.find("div[id^='layer-group-panel-']"):jQuery("div[id^='layer-group-panel-']"),c.on("shown.bs.collapse",jQuery.proxy(function(a){jQuery(a.currentTarget).parent().first().find("span.panel-title").attr("data-original-title","Collapse this group").tooltip("fixTitle"),a.stopPropagation()},this)).on("hidden.bs.collapse",jQuery.proxy(function(a){jQuery(a.currentTarget).parent().first().find("span.panel-title").attr("data-original-title","Expand this group").tooltip("fixTitle"),a.stopPropagation()},this))},magic.classes.LayerTree.prototype.assignLayerHandlers=function(a){var b=null;b=a?a.find("input.layer-vis-selector"):jQuery("input.layer-vis-selector"),b.change(jQuery.proxy(this.layerVisibilityHandler,this));var c=null;c=a?a.find("button[id^='layer-info-']"):jQuery("button[id^='layer-info-']"),c.on("click",jQuery.proxy(function(a){var b=a.currentTarget.id,c=this.getNodeId(b);this.attribution.show(this.nodeLayerTranslation[c])},this));var d=null;d=a?a.find("a.layer-tool"):jQuery("a.layer-tool"),d.click(jQuery.proxy(function(a){var b=a.currentTarget.id,c=this.getNodeId(b);new magic.classes.LayerTreeOptionsMenu({nodeid:c,layer:this.nodeLayerTranslation[c]})},this));var e=null;e=a?a.find("input[id^='layer-cb-']:checked"):jQuery("input[id^='layer-cb-']:checked"),e.each(jQuery.proxy(function(a,b){this.setLayerVisibility(jQuery(b))},this))},magic.classes.LayerTree.prototype.assignOneOnlyLayerGroupHandlers=function(a){if(a){a.find("a[id^='group-rb-off-']").each(jQuery.proxy(function(a,b){var c=jQuery(b);c.click(jQuery.proxy(function(a){var b={};c.closest("div.layer-group").find("input[type='radio']").each(jQuery.proxy(function(a,c){b[c.name]||(jQuery("input[name='"+c.name+"']").prop("checked",!1),b[c.name]=!0),this.setLayerVisibility(jQuery(c),!0)},this))},this))},this))}},magic.classes.LayerTree.prototype.initHandlers=function(a){this.assignLayerGroupHandlers(a),this.assignLayerHandlers(a),this.assignOneOnlyLayerGroupHandlers(a)},magic.classes.LayerTree.prototype.initTree=function(a,b,c){jQuery.each(a,jQuery.proxy(function(a,d){if(jQuery.isArray(d.layers)){var e=this.userGroupExpanded(d.id,d.expanded),f=magic.modules.Common.ellipsis(d.name,25),g=(f!=d.name?d.name+" - ":"")+(e?"Collapse":"Expand")+" this group",h=0==c?"panel-primary":1==c?"panel-info":"",i=0==a?"margin-top:5px":"",j=!0===d.base||!0===d.one_only;b.append((b.length>0&&"ul"==b[0].tagName.toLowerCase()?'<li class="list-group-item layer-list-group-group" id="layer-item-'+d.id+'">':"")+'<div class="panel '+h+' center-block layer-group" style="'+i+'"><div class="panel-heading" id="layer-group-heading-'+d.id+'"><span class="icon-layers"></span>'+(d.base?'<span style="margin:5px"></span>':d.one_only?'<a id="group-rb-off-'+d.id+'" href="Javascript:void(0)" role="button" data-toggle="tooltip" data-placement="right" title="Turn all radio button controlled layers off"><span style="margin:5px; color:'+(0==c?"white":"#202020")+'" class="fa fa-eye-slash">&nbsp;</span></a>':'<input class="layer-vis-group-selector" id="group-cb-'+d.id+'" type="checkbox"></input>')+(j?"":'<span class="badge checked-indicator-badge hidden"><span class="fa fa-eye">&nbsp;</span>0</span>')+'<span class="panel-title layer-group-panel-title" data-toggle="tooltip" data-placement="right" title="'+g+'"><a class="layer-group-tool" role="button" data-toggle="collapse" href="#layer-group-panel-'+d.id+'"><span style="font-weight:bold">'+f+'</span></a></span></div><div id="layer-group-panel-'+d.id+'" class="panel-collapse collapse'+(e?" in":"")+'"><div class="panel-body" style="padding:0px"><ul class="list-group layer-list-group '+(j?"one-only":"")+'" id="layer-group-'+d.id+'"></ul></div></div></div>'+(b.length>0&&"ul"==b[0].tagName.toLowerCase()?"</li>":"")),this.initTree(d.layers,jQuery("#layer-group-"+d.id),c+1),!0===d.autoload&&(this.autoloadGroups[d.id]={expanded:e,filter:d.autoload_filter,popups:!0===d.autoload_popups,insert:this.zIndexWmsStack},this.zIndexWmsStack++)}else this.addDataNode(d,b)},this))},magic.classes.LayerTree.prototype.addDataNode=function(a,b){if(a&&a.source){var c,d="wms_source"in a.source,e="esritile_source"in a.source,f=!!d&&!0===a.source.is_singletile,g=!(!d&&!e)&&!0===a.source.is_base,h=!0===a.is_interactive||a.source.geojson_source&&a.source.feature_name,i=a.source.is_time_dependent,j=a.refresh_rate||0,k=a.name,l=magic.modules.Common.ellipsis(a.name,30),m="Get layer legend/metadata",n=l;k!=l&&(n='<span data-toggle="tooltip" data-placement="top" title="'+k+'">'+l+"</span>");var o=this.userLayerAttribute(a.id,"visibility",a.is_visible),p=magic.runtime.issue.getPayload();"None"!=p&&p.visible&&p.visible[k]&&(o=p.visible[k]);var q=this.userLayerAttribute(a.id,"opacity",a.opacity);if(g)c='<input class="layer-vis-selector" name="base-layers-rb" id="base-layer-rb-'+a.id+'" type="radio"'+(o?' checked="checked"':"")+"></input>";else if(b.hasClass("one-only")){var r=b.attr("id");c='<input class="layer-vis-selector" name="layer-rb-'+r+'" id="layer-rb-'+a.id+'" type="radio"'+(o?' checked="checked"':"")+"></input>"}else c='<input class="layer-vis-selector" id="layer-cb-'+a.id+'" type="checkbox"'+(o?' checked="checked"':"")+"></input>";b.append('<li class="list-group-item layer-list-group-item" id="layer-item-'+a.id+'"><table style="table-layout:fixed; width:100%"><tr><td style="width:5%"><button id="layer-info-'+a.id+'" class="btn btn-default layer-info" data-toggle="tooltip" data-placement="top" data-html="true" title="'+(h?m+"<br>Click on map features for info":m)+'"><span class="fa fa-info-circle'+(h?" clickable":" non-clickable")+'"></span></button></td><td style="width:5%"><div id="vis-wrapper-'+a.id+'" style="cursor:pointer" '+(i?' data-trigger="manual" data-toggle="popover" data-placement="bottom"':"")+">"+c+'</div></td><td style="width:80%; padding-left:10px; text-overflow: ellipsis"><a href="Javascript:void(0)"><span id="layer-filter-badge-'+a.id+'" class="badge filter-badge hidden" data-toggle="tooltip" data-placement="right" title="">filter</span></a>'+n+'</td><td style="width:10%"><a class="layer-tool" id="layer-opts-'+a.id+'" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="fa fa-bars"></span><b class="caret"></b></a><ul id="layer-opts-dm-'+a.id+'" aria-labelled-by="layer-opts-'+a.id+'" class="dropdown-menu dropdown-menu-right layer-options-dd-menu"></ul></td></tr></table></li>');var s=null,t=ol.proj.get(magic.runtime.map_context.data.projection),u=magic.runtime.map_context.data.resolutions,v=void 0,w=void 0;if(a.source.wms_source&&"osm"==a.source.wms_source||u&&(v=u[u.length-1],w=u[0]+1,jQuery.isNumeric(a.min_scale)&&(v=magic.modules.GeoUtils.getResolutionFromScale(a.min_scale,u,t)),jQuery.isNumeric(a.max_scale)&&(w=magic.modules.GeoUtils.getResolutionFromScale(a.max_scale,u,t))),d){if("osm"==a.source.wms_source)s=magic.modules.Endpoints.getMidLatitudeCoastLayer(),s.set("metadata",a);else if(f){var x=new ol.source.ImageWMS({url:magic.modules.Endpoints.getOgcEndpoint(a.source.wms_source,"wms"),params:{LAYERS:a.source.feature_name,STYLES:a.source.style_name?"default"==a.source.style_name?"":a.source.style_name:""},projection:t});s=new ol.layer.Image({name:k,visible:o,opacity:q||1,metadata:a,source:x,minResolution:v,maxResolution:w})}else{var y="1.3.0",x=new ol.source.TileWMS({url:magic.modules.Endpoints.getOgcEndpoint(a.source.wms_source,"wms"),params:{LAYERS:a.source.feature_name,STYLES:a.source.style_name?"default"==a.source.style_name?"":a.source.style_name:"",TRANSPARENT:!0,CRS:t.getCode(),SRS:t.getCode(),VERSION:y,TILED:!0},tileGrid:new ol.tilegrid.TileGrid({resolutions:u,origin:t.getExtent().slice(0,2)}),projection:t});s=new ol.layer.Tile({name:k,visible:o,opacity:q||1,minResolution:v,maxResolution:w,metadata:a,source:x})}g?(s.setZIndex(0),this.layersBySource.base.push(s)):(s.setZIndex(this.zIndexWmsStack),this.zIndexWmsStack++,this.layersBySource.wms.push(s))}else if(a.source.esritile_source)s=new ol.layer.Tile({name:k,visible:o,opacity:q||1,metadata:a,minResolution:v,maxResolution:w,extent:t.getExtent(),source:new ol.source.TileArcGISRest({url:a.source.esritile_source})}),g?(s.setZIndex(0),this.layersBySource.base.push(s)):(s.setZIndex(this.zIndexWmsStack),this.zIndexWmsStack++,this.layersBySource.wms.push(s));else if(a.source.geojson_source){var z,A=a.source.feature_name?0:-magic.runtime.map_context.data.rotation,B=new ol.format.GeoJSON,C=a.source.geojson_source;a.source.feature_name?(C=magic.modules.Endpoints.getOgcEndpoint(C,"wfs")+"?service=wfs&version=2.0.0&request=getfeature&outputFormat=application/json&typenames="+a.source.feature_name+"&srsname="+(a.source.srs||magic.runtime.map.getView().getprojection().getCode()),z=new ol.source.Vector({format:B,loader:function(b){jQuery.isArray(b)&&isFinite(b[0])&&isFinite(b[1])&&isFinite(b[2])&&isFinite(b[3])||(b=magic.runtime.map_context.data.proj_extent);var c=C+"&bbox="+b.join(",");jQuery.ajax({url:c,method:"GET"}).done(function(a){z.addFeatures(B.readFeatures(a))}).fail(function(b){var c;if(401==b.status)c="Not authorised to access layer "+a.source.feature_name;else try{c=JSON.parse(b.responseText).detail}catch(a){c=b.responseText}magic.modules.Common.showAlertModal(c,"warning")})}})):(C=magic.modules.Common.proxyUrl(C),z=new ol.source.Vector({format:B,url:C})),s=new ol.layer.Vector({name:a.name,visible:o,source:z,style:this.getVectorStyle(a.source.style_definition,this.getLabelField(a.attribute_map),A),metadata:a,minResolution:v,maxResolution:w}),s.setZIndex(200),this.layersBySource.geojson.push(s)}else if(a.source.esrijson_source){var z,B=new ol.format.EsriJSON,A=-magic.runtime.map_context.data.rotation;z=new ol.source.Vector({format:B,loader:function(){jQuery.getJSON(a.source.esrijson_source,function(b){var c,d=a.source.layer_title;try{c=d?jQuery.grep(b.operationalLayers,function(a){return a.title==d}):[b.operationalLayers[0]];var e=B.readFeatures(c[0].featureCollection.layers[0].featureSet,{dataProjection:"EPSG:3857",featureProjection:magic.runtime.map_context.data.projection});z.addFeatures(e)}catch(b){magic.modules.Common.showAlertModal("Failed to parse the output from ESRI JSON service at "+a.source.esrijson_source,"warning")}}).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal(b,"warning")})}}),s=new ol.layer.Vector({name:a.name,visible:o,source:z,style:this.getVectorStyle(a.source.style_definition,this.getLabelField(a.attribute_map),A),metadata:a,minResolution:v,maxResolution:w}),s.setZIndex(200),this.layersBySource.esrijson.push(s)}else if(a.source.gpx_source){var A=-magic.runtime.map_context.data.rotation;s=new ol.layer.Vector({name:a.name,visible:o,metadata:a,source:new ol.source.Vector({format:new ol.format.GPX({readExtensions:function(a,b){try{var c=xmlToJSON.parseString(b.outerHTML.trim());if("extensions"in c&&jQuery.isArray(c.extensions)&&1==c.extensions.length){var d=c.extensions[0];for(var e in d)if(0!=e.indexOf("_")&&jQuery.isArray(d[e])&&1==d[e].length){var f=d[e][0]._text;a.set(e,f,!0)}}}catch(a){}return a}}),url:magic.modules.Common.proxyUrl(a.source.gpx_source)}),style:this.getVectorStyle(a.source.style_definition,this.getLabelField(a.attribute_map),A),renderMode:"image",minResolution:v,maxResolution:w}),s.setZIndex(400),this.layersBySource.gpx.push(s)}else if(a.source.kml_source){var D=null,A=-magic.runtime.map_context.data.rotation;if("string"==typeof a.source.style_definition){var E=JSON.parse(a.source.style_definition);"default"!=E.mode&&(D=this.getVectorStyle(a.source.style_definition,this.getLabelField(a.attribute_map),A))}s=new ol.layer.Vector({name:a.name,visible:o,metadata:a,source:new ol.source.Vector({format:new ol.format.KML({extractStyles:null==D,showPointNames:!1}),url:magic.modules.Common.proxyUrl(a.source.kml_source)}),renderMode:"image",minResolution:v,maxResolution:w}),null!=D&&s.setStyle(D),s.setZIndex(400),this.layersBySource.kml.push(s)}a.layer=s,this.nodeLayerTranslation[a.id]=s,j>0&&setInterval(jQuery.proxy(this.refreshLayer,this),6e4*j,s)}},magic.classes.LayerTree.prototype.initAutoLoadGroups=function(a){jQuery.each(this.autoloadGroups,jQuery.proxy(function(b,c){c.expanded?this.populateAutoloadGroup(a,b,c):jQuery("a[href='#layer-group-panel-"+b+"']").one("click",{id:b,o:c},jQuery.proxy(function(b){this.populateAutoloadGroup(a,b.data.id,b.data.o)},this))},this))},magic.classes.LayerTree.prototype.populateAutoloadGroup=function(a,b,c){var d=jQuery("#layer-group-"+b);d.length>0&&jQuery.ajax({url:magic.config.paths.baseurl+"/gs/layers/filter/"+encodeURIComponent(c.filter),method:"GET",dataType:"json",contentType:"application/json"}).done(jQuery.proxy(function(b){if(jQuery.isArray(b)){b.sort(function(a,b){return a.name.localeCompare(b.name)});for(var e=0;e<b.length;e++){var f=jQuery.extend({},{id:magic.modules.Common.uuid(),name:b[e].name,geom_type:b[e].geom_type,attribute_map:b[e].attribute_map},this.defaultNodeAttrs);if(f.source=jQuery.extend({},{wms_source:b[e].wms_source,feature_name:b[e].feature_name},this.defaultSourceAttrs),f.is_interactive=!0===c.popups,jQuery.isArray(f.attribute_map))for(var g=0;g<f.attribute_map.length;g++)f.attribute_map[g]=jQuery.extend({},f.attribute_map[g],this.defaultAttributeAttrs,{displayed:g<this.maxAttrs});else f.is_interactive=!1;this.addDataNode(f,d),f.layer.setZIndex(c.insert),a&&a.addLayer(f.layer),this.nodeLayerTranslation[f.id]=f.layer,this.initHandlers(d),this.refreshTreeIndicators(d.parents("div.layer-group"))}}},this)).fail(function(a){magic.modules.Common.showAlertModal(JSON.parse(a.responseText).detail,"warning")})};magic.classes.LayerTree.prototype.initLayerSearchTypeahead=function(){jQuery("#"+this.id+"-layersearch-ta").typeahead({minLength:2,highlight:!0},{limit:100,async:!0,source:jQuery.proxy(this.layerMatcher,this)(),templates:{notFound:'<p class="suggestion">No results</p>',header:'<div class="suggestion-group-header">Data layers</div>',suggestion:function(a){return'<p class="suggestion">'+a+"</p>"}}}).on("typeahead:autocompleted",jQuery.proxy(this.layerSearchSuggestionSelectHandler,this)).on("typeahead:selected",jQuery.proxy(this.layerSearchSuggestionSelectHandler,this)),jQuery("span.layer-tree-search").on("click",function(a){a.stopPropagation();var b=jQuery(".layersearch-panel");b.removeClass("hidden").addClass("show"),setTimeout(function(){b.find("input").focus()},100)}),jQuery(".layersearch-form").find(".close").on("click",function(a){a.stopPropagation(),jQuery(".layersearch-panel").removeClass("show").addClass("hidden")})},magic.classes.LayerTree.prototype.layerSearchSuggestionSelectHandler=function(a,b){var c=null;if(magic.runtime.map.getLayers().forEach(function(a){a.get("name")==b&&(c=a)}),null!=c&&c.get("metadata")){var d=c.get("metadata").id,e=jQuery("#layer-item-"+d),f={nopened:0,ntotal:0},g=jQuery.grep(e.parents("[id^='layer-group-panel']"),function(a,b){var c=jQuery(a);if(!c.hasClass("in"))return c.on("shown.bs.collapse",jQuery.proxy(function(a){++this.nopened==this.ntotal&&(magic.modules.Common.scrollViewportToElement(e[0]),e.css("background-color","#ff0000"),setTimeout(function(){e.css("background-color","#ffffff")},1e3))},f)),!0});f.ntotal=g.length,0==f.ntotal?(magic.modules.Common.scrollViewportToElement(e[0]),e.css("background-color","#ff0000"),setTimeout(function(){e.css("background-color","#ffffff")},1e3)):jQuery.each(g,function(a,b){jQuery(b).collapse("toggle")})}},magic.classes.LayerTree.prototype.refreshLayer=function(a){if("function"==typeof a.getSource().updateParams){var b=a.getSource().getParams();b.t=(new Date).getMilliseconds(),a.getSource().updateParams(b)}else a.getSource()instanceof ol.source.Vector?this.reloadVectorSource(a.getSource()):jQuery.isFunction(a.getSource().getSource)&&a.getSource().getSource()instanceof ol.source.Vector&&this.reloadVectorSource(a.getSource().getSource())},magic.classes.LayerTree.prototype.reloadVectorSource=function(a){jQuery.ajax(a.getUrl(),function(b){var c=a.getFormat();a.clear(!0),a.addFeatures(c.readFeatures(b))})},magic.classes.LayerTree.prototype.getLabelField=function(a){var b=null;return jQuery.isArray(a)&&jQuery.each(a,function(a,c){if(!0===c.label)return b=c.name,!1}),b},magic.classes.LayerTree.prototype.setLayerVisibility=function(a,b){var c=a.prop("id"),d=this.getNodeId(c),e=this.nodeLayerTranslation[d];if(0==c.indexOf("base-layer-rb"))jQuery.each(this.layersBySource.base,jQuery.proxy(function(a,b){b.setVisible(b.get("metadata").id==d)},this)),jQuery.event.trigger({type:"baselayerchanged",layer:e});else if(0==c.indexOf("layer-rb")){var f=a.prop("name");jQuery("input[name='"+f+"']").each(jQuery.proxy(function(a,c){var e=this.nodeLayerTranslation[this.getNodeId(jQuery(c).prop("id"))];!0===b?e.setVisible(!1):e.setVisible(e.get("metadata").id==d)},this))}else{e.setVisible(a.prop("checked"));var g=e.get("metadata");if(g&&g.source&&g.source.is_time_dependent){if(!this.moviePlayers[g.id]){var h=jQuery("#vis-wrapper-"+g.id).closest("li[id^='layer-item-']");this.moviePlayers[g.id]=new magic.classes.MosaicTimeSeriesPlayer({nodeid:g.id,target:"vis-wrapper-"+g.id,container:h?"#"+h.prop("id"):"body",layer:e,cache:this.timeSeriesCache})}a.prop("checked")?this.moviePlayers[g.id].activate():this.moviePlayers[g.id].deactivate()}}jQuery.isFunction(magic.runtime.layer_visibility_change_callback)&&magic.runtime.layer_visibility_change_callback()},magic.classes.LayerTree.prototype.layerVisibilityHandler=function(a){this.setLayerVisibility(jQuery(a.currentTarget)),this.refreshTreeIndicators(jQuery(a.currentTarget).parents("div.layer-group"))},magic.classes.LayerTree.prototype.groupVisibilityHandler=function(a){var b=jQuery(a.currentTarget),c=b.prop("checked");jQuery.each(b.closest("div.panel").find("input[type='checkbox']"),jQuery.proxy(function(a,b){var d=jQuery(b);d.hasClass("layer-vis-selector")?(d.off("change").prop("checked",c).change(jQuery.proxy(this.layerVisibilityHandler,this)),this.setLayerVisibility(d)):d.off("change").prop("checked",c).change(jQuery.proxy(this.groupVisibilityHandler,this))},this)),this.refreshTreeIndicators(b.parents("div.layer-group"))},magic.classes.LayerTree.prototype.refreshTreeIndicators=function(a){this.layerGroupDivs.each(jQuery.proxy(function(b,c){if(!jQuery.isArray(a)||jQuery.isArray(a)&&-1!=jQuery.inArray(c,a)){var d=jQuery(c),e=d.find("input[id^='layer-cb-']"),f=e.filter(":checked");if(f.length==e.length){var g=d.first().find("input[id^='group-cb-']");g.length>0&&g.off("change").prop("checked",!0).change(jQuery.proxy(this.groupVisibilityHandler,this))}else{var g=d.first().find("input[id^='group-cb-']");g.length>0&&g.off("change").prop("checked",!1).change(jQuery.proxy(this.groupVisibilityHandler,this))}var h=d.first().find("span.checked-indicator-badge");h.length>0&&(h.html('<span class="fa fa-eye">&nbsp;</span>'+f.length+" / "+e.length),0==f.length?h.removeClass("show").addClass("hidden"):h.removeClass("hidden").addClass("show"))}},this))},magic.classes.LayerTree.prototype.getVectorStyle=function(a,b,c){return function(d,e){var f=[],g=magic.modules.GeoUtils.getGeometryType(d.getGeometry()),h={color:"rgba(255, 0, 0, 0.6)"},i={color:"rgba(255, 0, 0, 1.0)",width:1},j=null,k=null,l=null,m=null;if(a){if("string"==typeof a&&(a=JSON.parse(a)),!jQuery.isEmptyObject(a.predefined)&&a.predefined)return jQuery.proxy(magic.modules.VectorStyles[a.predefined](),d)();if(j=a.fill?new ol.style.Fill({color:magic.modules.Common.rgbToDec(a.fill.color,a.fill.opacity)}):jQuery.extend({},h),a.stroke){var n="dashed"==a.stroke.linestyle?[3,3]:"dotted"==a.stroke.linestyle?[1,1]:void 0;k=new ol.style.Stroke({color:magic.modules.Common.rgbToDec(a.stroke.color,a.stroke.opacity),lineDash:n,width:a.stroke.width||1})}else k=jQuery.extend({},i);if(a.graphic)if("circle"==a.graphic.marker)l=new ol.style.Circle({radius:a.graphic.radius||5,fill:j,stroke:k});else if("star"==a.graphic.marker){var o=a.graphic.radius||7,p=o<7?2:o-5;l=new ol.style.RegularShape({radius1:o,radius2:p,points:5,fill:j,stroke:k})}else{var q;switch(a.graphic.marker){case"triangle":q=3;break;case"pentagon":q=5;break;case"hexagon":q=6;break;default:q=4}l=new ol.style.RegularShape({radius:a.graphic.radius||5,points:q,fill:j,stroke:k})}else l=new ol.style.Circle({radius:5,fill:j,stroke:k});if(m=void 0,b){var r=magic.modules.Common.rgbToDec(a.stroke.color,0);m=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:d.get(b)+"",textAlign:"left",fill:new ol.style.Fill({color:r}),rotation:c,stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)",width:1})})}}else j=jQuery.extend({},h),k=jQuery.extend({},i),l=new ol.style.Circle({radius:5,fill:j,stroke:k}),m=void 0;switch(g){case"polygon":f.push(new ol.style.Style({fill:j,stroke:k,text:m}));break;case"line":f.push(new ol.style.Style({stroke:k,text:m}));break;case"collection":for(var s=d.getGeometry().getGeometries(),t=0;t<s.length;t++){"point"==magic.modules.GeoUtils.getGeometryType(s[t])&&f.push(new ol.style.Style({geometry:s[t],image:l,text:m}))}break;default:f.push(new ol.style.Style({image:l,text:m}))}return f}},magic.classes.LayerTree.prototype.getLayerByFeatureName=function(a){var b=null;return jQuery.each(this.nodeLayerTranslation,jQuery.proxy(function(a,c){var d=c.get("metadata");return!(d&&d.source&&d.source.feature_name)||(b=c,!1)},this)),b},magic.classes.LayerTree.prototype.layerMatcher=function(){var a=[];return jQuery.each(this.nodeLayerTranslation,function(b,c){a.push({id:b,layer:c.get("name")})}),a.sort(function(a,b){return a.layer.localeCompare(b.layer)}),function(b,c){var d=[],e=new RegExp(b,"i");jQuery.each(a,function(a,b){e.test(b.layer)&&d.push(b.layer)}),c(d)}},magic.classes.LayerTree.prototype.userLayerAttribute=function(a,b,c){return null!=this.userdata&&"layers"in this.userdata&&a in this.userdata.layers?this.userdata.layers[a][b]:c},magic.classes.LayerTree.prototype.userGroupExpanded=function(a,b){return null!=this.userdata&&"groups"in this.userdata&&a in this.userdata.groups?this.userdata.groups[a]:b},magic.classes.LayerTree.prototype.chromeRefreshWorkaround=function(){},magic.classes.LayerTreeOptionsMenu=function(a){if(this.nodeid=a.nodeid,this.layer=a.layer,this.time_dependent_mosaics={},jQuery("#layer-opts-dm-"+this.nodeid).html('<li><a href="Javascript:void(0)" id="ztl-'+this.nodeid+'">Zoom to layer extent</a></li><li><a href="Javascript:void(0)" id="sty-'+this.nodeid+'">Apply alternate style</a><div class="panel panel-default hidden" style="margin-bottom:0px" id="wrapper-sty-'+this.nodeid+'"><div class="panel-body" style="padding:5px"><form class="form-inline"><div class="form-group form-group-sm" style="margin-bottom:0px"><select class="form-control" id="sty-alts-'+this.nodeid+'"></select></div></form></div></div></li><li><a href="Javascript:void(0)" id="ftr-'+this.nodeid+'">Filter by attribute</a><div class="panel panel-default hidden" style="margin-bottom:0px" id="wrapper-ftr-'+this.nodeid+'"><div class="panel-body" style="padding:5px"></div></div></li><li><a href="Javascript:void(0)" id="opc-'+this.nodeid+'">Change layer transparency</a><div class="panel panel-default hidden" style="margin-bottom:0px" id="wrapper-opc-'+this.nodeid+'"><div class="panel-body" style="padding:5px"><input id="opc-slider-'+this.nodeid+'" data-slider-id="opc-slider-'+this.nodeid+'" data-slider-min="0" data-slider-max="1" data-slider-step="0.1" data-slider-value="1"></input></div></div></li>'),this.layer){var b=jQuery("#ztl-"+this.nodeid),c=jQuery("#sty-"+this.nodeid),d=jQuery("#ftr-"+this.nodeid);this.canZoomToExtent()?b.off("click").on("click",jQuery.proxy(this.zoomToExtent,this)):(b.parent().addClass("disabled"),b.off("click").on("click",function(){return!1})),this.canApplyAlternateStyles()?c.off("click").on("click",jQuery.proxy(function(a){a.stopPropagation(),jQuery(a.currentTarget).next("div").find("form").click(function(a){a.stopPropagation()}),this.applyAlternateStyle()},this)):(c.parent().addClass("disabled"),c.off("click").on("click",function(){return!1})),this.canFilter()?d.off("click").on("click",jQuery.proxy(function(a){a.stopPropagation();var b=jQuery("#wrapper-ftr-"+this.nodeid);b.hasClass("hidden")?(b.removeClass("hidden"),new magic.classes.LayerFilter({target:b.find("div.panel-body"),nodeid:this.nodeid,layer:this.layer})):b.addClass("hidden")},this)):(d.parent().addClass("disabled"),d.off("click").on("click",function(){return!1})),this.addOpacitySliderHandler()}},magic.classes.LayerTreeOptionsMenu.prototype.addOpacitySliderHandler=function(){var a=jQuery("#opc-"+this.nodeid);this.layer.getVisible()?a.off("click").on("click",jQuery.proxy(function(a){a.stopPropagation();var b=jQuery("#wrapper-opc-"+this.nodeid);b.hasClass("hidden")?(b.removeClass("hidden"),jQuery("#opc-slider-"+this.nodeid).slider({min:0,max:1,step:.1,value:this.layer.getOpacity()}).off("slide").on("slide",jQuery.proxy(function(a){this.layer.setOpacity(a.value)},this))):(jQuery("#opc-slider-"+this.nodeid).slider("destroy"),b.addClass("hidden"))},this)):(a.parent().addClass("disabled"),a.off("click").on("click",function(){return!1}))},magic.classes.LayerTreeOptionsMenu.prototype.zoomToWmsExtent=function(a,b){var c=null;if(null!=a&&a[b]){var d=a[b];jQuery.isArray(d.BoundingBox)&&d.BoundingBox.length>0?(jQuery.each(d.BoundingBox,function(a,b){if(b.crs==magic.runtime.map.getView().getProjection().getCode())return c=b.extent,!1}),null==c&&(jQuery.isArray(d.EX_GeographicBoundingBox)&&4==d.EX_GeographicBoundingBox.length?(c=magic.modules.GeoUtils.extentFromWgs84Extent(d.EX_GeographicBoundingBox),0==c.length&&(c=magic.runtime.map.getView().getProjection().getExtent())):c=magic.runtime.map.getView().getProjection().getExtent())):c=jQuery.isArray(d.EX_GeographicBoundingBox)&&4==d.EX_GeographicBoundingBox.length?magic.modules.GeoUtils.extentFromWgs84Extent(d.EX_GeographicBoundingBox):magic.runtime.map.getView().getProjection().getExtent()}else c=magic.runtime.map.getView().getProjection().getExtent();magic.runtime.map.getView().fit(c,magic.runtime.map.getSize())},magic.classes.LayerTreeOptionsMenu.prototype.zoomToExtent=function(){var a=this.layer.get("metadata");if(a)if(a.source&&a.source.wms_source){var b=a.source.wms_source;magic.modules.Common.getCapabilities(b,jQuery.proxy(this.zoomToWmsExtent,this),a.source.feature_name)}else{var c=magic.runtime.map.getView().getProjection().getExtent();jQuery.isFunction(this.layer.getSource().getExtent)?c=this.layer.getSource().getExtent():jQuery.isFunction(this.layer.getSource().getSource)&&jQuery.isFunction(this.layer.getSource().getSource().getExtent)&&(c=this.layer.getSource().getSource().getExtent()),magic.runtime.map.getView().fit(c,magic.runtime.map.getSize())}else magic.runtime.map.getView().fit(magic.runtime.map.getView().getProjection().getExtent(),magic.runtime.map.getSize())},magic.classes.LayerTreeOptionsMenu.prototype.applyAlternateStyle=function(){var a=jQuery("#sty-alts-"+this.nodeid),b=jQuery("#wrapper-sty-"+this.nodeid);if(b.hasClass("hidden")){b.removeClass("hidden");var c=null,d=null;try{var e=this.layer.get("metadata");c=e.source.feature_name,d=magic.modules.Endpoints.getEndpointBy("url",e.source.wms_source)}catch(a){}if(null!=c){var f=magic.config.paths.baseurl+"/gs/styles/"+c;null!=d&&(f=f+"/"+d.id),jQuery.ajax({url:f,method:"GET",dataType:"json",contentType:"application/json"}).done(jQuery.proxy(function(b){b.styles&&"object"==typeof b.styles&&jQuery.isArray(b.styles.style)&&b.styles.style.length>1?(magic.modules.Common.populateSelect(a,b.styles.style,"name","name","",!0),a.change(jQuery.proxy(function(b){this.layer.getSource().updateParams(jQuery.extend({},this.layer.getSource().getParams(),{STYLES:a.val()}))},this))):magic.modules.Common.populateSelect(a,[{name:"Default only"}],"name","name",!1)},this)).fail(jQuery.proxy(function(b){magic.modules.Common.populateSelect(a,[{name:"Default only"}],"name","name",!1)},this))}}else b.addClass("hidden")},magic.classes.LayerTreeOptionsMenu.prototype.canZoomToExtent=function(){var a=this.layer.get("metadata");return this.layer.getVisible()&&!(a&&a.source&&"osm"==a.source.wms_source)},magic.classes.LayerTreeOptionsMenu.prototype.canApplyAlternateStyles=function(){var a=this.layer.get("metadata");return this.layer.getVisible()&&a&&a.source&&a.source.wms_source&&"osm"!=a.source.wms_source},magic.classes.LayerTreeOptionsMenu.prototype.canFilter=function(){var a=this.layer.get("metadata");return this.layer.getVisible()&&a&&!0===a.is_filterable&&jQuery.isArray(a.attribute_map)},magic.classes.LayerTreeOptionsMenu.prototype.canViewTimeSeries=function(){var a=this.layer.get("metadata");return this.layer.getVisible()&&a&&a.source&&!0===a.source.is_time_dependent},magic.classes.MosaicTimeSeriesPlayer=function(a){this.nodeid=a.nodeid,this.target=jQuery("#"+a.target),this.container=a.container,this.layer=a.layer,this.cache=a.cache,this.imagePointer=-1,this.granules=null,this.movie=null,this.template='<div class="popover popover-auto-width movieplayer-popover" role="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content movieplayer-popover-content" style="padding-top: 0px"></div></div>',this.content='<form id="mplayer-form-'+this.nodeid+'"><div class="form-group form-group-sm col-sm-12"><button class="btn btn-primary btn-sm fa fa-fast-backward mosaic-player" type="button" role="button" data-toggle="tooltip" data-placement="top" title="First image in series" disabled></button><button class="btn btn-primary btn-sm fa fa-step-backward mosaic-player" type="button" role="button" data-toggle="tooltip" data-placement="top" title="Previous image in series" disabled></button><button class="btn btn-primary btn-sm fa fa-play mosaic-player" type="button" role="button" data-toggle="tooltip" data-placement="top" title="Play movie of mosaic images" disabled></button><button class="btn btn-primary btn-sm fa fa-step-forward mosaic-player" type="button" role="button" data-toggle="tooltip" data-placement="top" title="Next image in series" disabled></button><button class="btn btn-primary btn-sm fa fa-fast-forward mosaic-player" type="button" role="button" data-toggle="tooltip" data-placement="top" title="Most recent image in series" disabled></button></div><div class="form-group form-group-sm"><label class="col-sm-4 control-label" for="mplayer-refresh-rate-'+this.nodeid+'">Refresh</label><div class="col-sm-8"><select id="mplayer-refresh-rate-'+this.nodeid+'" class="form-control" data-toggle="tooltip" data-placement="right" title="Frame refresh rate in seconds"><option value="2000" selected>every 4 sec</option><option value="4000">every 6 sec</option><option value="6000">every 8 sec</option><option value="8000">every 10 sec</option><option value="10000">every 20 sec</option></select></div></div><div class="col-sm-12" style="margin-top: 5px; margin-bottom: 10px">Data from : <span id="granule-date-'+this.nodeid+'"></span></div></form>',this.target.popover({template:this.template,title:'<span><strong>Play time series movie</strong><button type="button" class="close">&times;</button></span>',container:this.container,html:!0,content:this.content}).on("shown.bs.popover",jQuery.proxy(function(){var a=this.layer.getSource().getParams(),b=a.LAYERS;if(b)if(this.cache[this.nodeid])this.loadGranules(this.cache[this.nodeid]);else{var c=magic.modules.Endpoints.getEndpointBy("url",this.layer.get("metadata").source.wms_source),d=magic.config.paths.baseurl+"/gs/granules/"+b;null!=c&&(d=d+"/"+c.id),jQuery.getJSON(d,jQuery.proxy(function(a){this.loadGranules(a),this.cache[this.nodeid]=a},this))}var e=jQuery("#mplayer-form-"+this.nodeid).find("button");jQuery(e[0]).off("click").on("click",{pointer:"0"},jQuery.proxy(this.showImage,this)),jQuery(e[1]).off("click").on("click",{pointer:"-"},jQuery.proxy(this.showImage,this)),jQuery(e[2]).off("click").on("click",jQuery.proxy(this.changeMovieState,this)),jQuery(e[3]).off("click").on("click",{pointer:"+"},jQuery.proxy(this.showImage,this)),jQuery(e[4]).off("click").on("click",{pointer:"1"},jQuery.proxy(this.showImage,this)),jQuery("#mplayer-refresh-rate-"+this.nodeid).off("change").on("change",jQuery.proxy(function(a){var b=jQuery(e[2]);b.hasClass("fa-pause")&&b.trigger("click")},this)),jQuery(".movieplayer-popover").find("button.close").click(jQuery.proxy(function(){this.stopMovie(),this.deactivate()},this))},this)).on("hidden.bs.popover",jQuery.proxy(function(){this.stopMovie()},this))},magic.classes.MosaicTimeSeriesPlayer.prototype.activate=function(a){this.target.popover("show")},magic.classes.MosaicTimeSeriesPlayer.prototype.deactivate=function(a){this.target.popover("hide")},magic.classes.MosaicTimeSeriesPlayer.prototype.loadGranules=function(a){var b=a.features;jQuery.isArray(b)&&b.length>0?(b.sort(function(a,b){var c=a.properties.chart_date,d=b.properties.chart_date;return Date.parse(c.replace(/\+\d+$/,""))-Date.parse(d.replace(/\+\d+$/,""))}),this.granules=b,this.showInitialState()):magic.modules.Common.showAlertModal("No time series granule data received","warning")},magic.classes.MosaicTimeSeriesPlayer.prototype.showInitialState=function(){this.stopMovie(),this.imagePointer<0&&(this.imagePointer=this.granules.length-1),this.syncButtons(),this.updateLayer(),jQuery("#granule-date-"+this.nodeid).html(this.getTime())},magic.classes.MosaicTimeSeriesPlayer.prototype.showImage=function(a){a.stopPropagation(),"0"==a.data.pointer?this.imagePointer=0:"-"==a.data.pointer?this.imagePointer>0&&this.imagePointer--:"+"==a.data.pointer?this.imagePointer<this.granules.length-1&&this.imagePointer++:this.imagePointer=this.granules.length-1,this.syncButtons(),this.updateLayer()},magic.classes.MosaicTimeSeriesPlayer.prototype.changeMovieState=function(a){a.stopPropagation(),null==this.movie?this.startMovie():this.stopMovie(),this.syncButtons()},magic.classes.MosaicTimeSeriesPlayer.prototype.startMovie=function(){var a=jQuery(jQuery("#mplayer-form-"+this.nodeid).find("button")[2]);a.hasClass("fa-play")&&(a.removeClass("fa-play").addClass("fa-pause"),a.attr("data-original-title","Pause movie").tooltip("fixTitle")),this.movie=setInterval(jQuery.proxy(function(){this.imagePointer<this.granules.length-1?(this.imagePointer++,this.updateLayer()):(a.removeClass("fa-pause").addClass("fa-play"),a.attr("data-original-title","Play movie of mosaic images").tooltip("fixTitle"),clearInterval(this.movie),this.movie=null),this.syncButtons()},this),jQuery("#mplayer-refresh-rate-"+this.nodeid).val())},magic.classes.MosaicTimeSeriesPlayer.prototype.stopMovie=function(){var a=jQuery(jQuery("#mplayer-form-"+this.nodeid).find("button")[2]);a.hasClass("fa-pause")&&(a.removeClass("fa-pause").addClass("fa-play"),a.attr("data-original-title","Play movie of mosaic images").tooltip("fixTitle")),null!=this.movie&&(clearInterval(this.movie),this.movie=null)},magic.classes.MosaicTimeSeriesPlayer.prototype.syncButtons=function(){var a=jQuery("#mplayer-form-"+this.nodeid).find("button");jQuery(a[0]).prop("disabled",0==this.imagePointer),jQuery(a[1]).prop("disabled",0==this.imagePointer),jQuery(a[2]).prop("disabled",this.imagePointer==this.granules.length-1),jQuery(a[3]).prop("disabled",this.imagePointer==this.granules.length-1),jQuery(a[4]).prop("disabled",this.imagePointer==this.granules.length-1)},magic.classes.MosaicTimeSeriesPlayer.prototype.updateLayer=function(){var a=this.getTime();jQuery("#granule-date-"+this.nodeid).html(a.replace(".000Z","")),this.layer.getSource().updateParams(jQuery.extend({},this.layer.getSource().getParams(),{time:a}))},magic.classes.MosaicTimeSeriesPlayer.prototype.getTime=function(){return this.granules[this.imagePointer].properties.chart_date.substring(0,10)};