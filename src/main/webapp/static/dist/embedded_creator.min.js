var magic={config:{paths:{baseurl:window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}},modules:{creator:{}},classes:{creator:{}},runtime:{creator:{catalogues:{}},capabilities:{},filters:{},pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")},preferences:{coordinate:"dd",elevation:"m",date:"Y-m-d"}}};setInterval("magic.runtime.pingSession()",3e6),magic.classes.PopupForm=function(a){this.id=a.id,this.target=jQuery("#"+a.target),this.caption=a.caption||"Popup edit form",this.popoverClass=a.popoverClass||"",this.popoverContentClass=a.popoverContentClass||"",this.prePopulator=a.prePopulator||{},this.subForms={},this.active=!1,this.controlCallbacks={onActivate:jQuery.proxy(function(a){this.prePopulator=a,this.target.popover("show")},this),onDeactivate:jQuery.proxy(function(a){!a&&this.formDirty()?bootbox.confirm({message:"Unsaved edits - save before closing?",buttons:{confirm:{label:"Yes",className:"btn-success"},cancel:{label:"No",className:"btn-danger"}},callback:jQuery.proxy(function(a){a?jQuery.isFunction(this.saveForm)&&(jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(a,b){jQuery.isFunction(b.saveForm)&&b.saveForm()}),this.saveForm()):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)}):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)},this.formEdited=!1,this.clearState(),this.template='<div class="popover popover-auto-width'+(this.popoverClass?" "+this.popoverClass:"")+'" role="popover"><div class="arrow"></div><h3 class="popover-title">'+this.caption+'</h3><div class="popover-content'+(this.popoverContentClass?" "+this.popoverContentClass:"")+'"></div></div>'},magic.classes.PopupForm.prototype.getFormValue=function(){return this.savedState},magic.classes.PopupForm.prototype.getTarget=function(){return this.target},magic.classes.PopupForm.prototype.getTemplate=function(){return this.template},magic.classes.PopupForm.prototype.getCaption=function(){return this.caption},magic.classes.PopupForm.prototype.setCaption=function(a){this.caption=a},magic.classes.PopupForm.prototype.isActive=function(){return this.active},magic.classes.PopupForm.prototype.titleMarkup=function(){return"<span><big><strong>"+this.caption+'</strong></big><button type="button" class="close dialog-deactivate" style="margin-left:5px">&times;</button></span>'},magic.classes.PopupForm.prototype.setCallbacks=function(a){this.controlCallbacks=a},magic.classes.PopupForm.prototype.assignCloseButtonHandler=function(){jQuery("."+this.popoverClass).find("button.dialog-deactivate").off("click").on("click",jQuery.proxy(function(){this.deactivate(!1)},this))},magic.classes.PopupForm.prototype.activate=function(a){this.active=!0,jQuery.isFunction(this.controlCallbacks.onActivate)&&this.controlCallbacks.onActivate(a)},magic.classes.PopupForm.prototype.deactivate=function(a){this.active=!1,jQuery.isFunction(this.controlCallbacks.onDeactivate)&&this.controlCallbacks.onDeactivate(a)},magic.classes.PopupForm.prototype.delayedDeactivate=function(a){setTimeout(jQuery.proxy(function(){this.deactivate(!0)},this),a)},magic.classes.PopupForm.prototype.clearState=function(){this.savedState={}},magic.classes.PopupForm.prototype.formDirty=function(){return this.formEdited},magic.classes.PopupForm.prototype.cleanForm=function(){this.formEdited=!1},magic.classes.PopupForm.prototype.tidyUp=function(a){jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(b,c){null!=c&&jQuery.isFunction(c.deactivate)&&c.deactivate(a)})},magic.modules.Endpoints=function(){return{parseUri:function(a){for(var b={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},c=b.parser[b.strictMode?"strict":"loose"].exec(a),d={},e=14;e--;)d[b.key[e]]=c[e]||"";return d[b.q.name]={},d[b.key[12]].replace(b.q.parser,function(a,c,e){c&&(d[b.q.name][c]=e)}),d},getVirtualService:function(a){var b="",c=/\/geoserver\/([^\/]+)\/wms/,d=c.exec(a);return null!=d&&(b=d[1]),b},getWmsProxiedUrl:function(a){var b=this.getEndpointBy("url",a);return b&&b.proxied_url?b.proxied_url:null},getWmsServiceUrl:function(a){var b=this.getEndpointBy("name",a);return b?b.url:null},getOgcEndpoint:function(a,b){var c=a,d=this.getEndpointsBy("url",a);return jQuery.isArray(d)&&d.length>0?c=!0===d[0].is_user_service?magic.config.paths.baseurl+"/ogc/user/"+b:magic.config.paths.baseurl+"/ogc/"+d[0].id+"/"+b:(console.log(a+" does not correspond to a known endpoint - need to proxy"),c=magic.modules.Common.proxyUrl(a)),c},getEndpointBy:function(a,b){var c=this.getEndpointsBy(a,b);return c.length>0?c[0]:null},getUserDataEndpoint:function(){if(!magic.runtime.endpoints)return null;var a=jQuery.grep(magic.runtime.endpoints,function(a){return!0===a.is_user_service});return 0==a.length?null:a[0]},getEndpointsBy:function(a,b){return magic.runtime.endpoints&&a&&b?jQuery.grep(magic.runtime.endpoints,jQuery.proxy(function(c){if("id"==a)return c[a]==b;if("url"==a){var d=b.replace(/\/w[cfm]s$/,""),e=d.indexOf("/rest");-1!=e&&(d=d.substring(0,e));var f=0==c[a].indexOf(d);if(!f&&c.url_aliases)for(var g=c.url_aliases.split(","),h=0;!f&&h<g.length;h++)f=0==g[h].indexOf(d);return f}if("srs"==a){return c[a].toLowerCase().split(",").indexOf(b.toLowerCase())>=0}return 0==c[a].toLowerCase().indexOf(b.toLowerCase())},this)):null},getMidLatitudeCoastLayer:function(){var a=null,b=this.getEndpointBy("name","midlatitude");if(null!=b&&"osm"!=b.url){var c=null;-1!=b.coast_layers.indexOf(":")&&(c=b.coast_layers.split(":").shift()),a=new ol.layer.Tile({source:new ol.source.TileWMS({url:b.url,params:{LAYERS:b.coast_layers,CRS:"EPSG:3857",SRS:"EPSG:3857",VERSION:"1.3.0",WORKSPACE:c},projection:"EPSG:3857"})})}else a=new ol.layer.Tile({source:new ol.source.OSM({wrapX:!1})});return a},getMidLatitudeCoastSource:function(a){var b=this.getEndpointBy("name","midlatitude"),c={wms_source:b&&"osm"!=b.url?b.url:"osm",feature_name:b&&"osm"!=b.url?b.coast_layers:"osm",is_base:!0};return jQuery.extend({id:null,name:"Mid-latitude data",is_visible:!0},a?c:{source:c})}}}(),magic.modules.Common=function(){return{inches_per_unit:{ins:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36,nmi:1852*39.37},default_styles:{Point:{image:"circle",radius:5,fill:"rgba(255,255,0,0.5)",stroke:"#ff0",width:1},LineString:{stroke:"#f00",width:3},Polygon:{fill:"rgba(0,255,255,0.5)",stroke:"#0ff",width:1},MultiPoint:{image:"circle",radius:5,fill:"rgba(255,0,255,0.5)",stroke:"#f0f",width:1},MultiLineString:{stroke:"#0f0",width:3},MultiPolygon:{fill:"rgba(0,0,255,0.5)",stroke:"#00f",width:1}},color_palette:["#FF6403","#800000","#DD0907","#F20884","#4700A5","#0000D3","#02ABEA","#1FB714","#006412","#562C05","#90713A","#808080","#404040","#000000"],rgbToDec:function(rgb,opacity){rgb=rgb||"#000000",opacity=jQuery.isNumeric(opacity)?opacity:1,rgb=eval("0x"+rgb.replace(/#/,""));var components={r:(16711680&rgb)>>16,g:(65280&rgb)>>8,b:255&rgb};return"rgba("+components.r+","+components.g+","+components.b+","+opacity+")"},scrollViewportToElement:function(a){var b=a.getBoundingClientRect();b.bottom>window.innerHeight&&a.scrollIntoView(!1),b.top<0&&a.scrollIntoView()},buttonFeedbackSet:function(a,b,c,d,e){return c||(c="sm"),d||(d="Save"),'<div class="btn-toolbar col-'+c+'-12" role="toolbar" style="margin-bottom:10px"><div class="btn-group btn-group-'+c+'"><button id="'+a+'-go" class="btn btn-'+c+' btn-primary" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="'+b+'"><span class="fa fa-floppy-o"></span> '+d+'</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-ok" class="btn btn-'+c+' btn-success" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Ok"><span class="fa fa-check post-ok"></span> Ok</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-error" class="btn btn-'+c+' btn-danger" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Error"><span class="fa fa-times-circle post-error"></span> Error</button></div>'+(!0===e?'<div class="btn-group btn-group-'+c+'"><button id="'+a+'-cancel" class="btn btn-'+c+' btn-danger" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="Cancel"><span class="fa fa-times-circle"></span> Cancel</button></div>':"")+"</div>"},buttonClickFeedback:function(a,b,c){var d,e=jQuery("#"+a+"-go"),f=jQuery("#"+a+"-fb-ok"),g=jQuery("#"+a+"-fb-error");e.hide(),b?(f.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return f.fadeIn(300).delay(1200).fadeOut(300)}):(g.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return g.fadeIn(600).delay(6e3).fadeOut(600)}),jQuery.when(d()).done(function(){e.show()})},fetchStyle:function(a,b,c){var d=this.default_styles[a];if(d){var e={};return a.toLowerCase().indexOf("point")>=0?e.image=this.getPointImageStyle(b):a.toLowerCase().indexOf("linestring")>=0?e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1}):(e.fill=new ol.style.Fill({color:this.rgbToDec(this.color_palette[b],.5)}),e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1})),c&&(e.text=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:c,textAlign:"left",fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[b])}),stroke:new ol.style.Stroke({color:"#ffffff",width:1})})),[new ol.style.Style(e)]}return null},getPointImageStyle:function(a){var b=a%4;return 0==b?new ol.style.Circle({fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),radius:5,stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):1==b?new ol.style.RegularShape({rotation:0,points:5,radius1:7,radius2:2,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):2==b?new ol.style.RegularShape({points:4,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):3==b?new ol.style.RegularShape({points:3,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):void 0},labelVisibility:function(a,b,c,d){if(!a.get("_ignoreHovers")){var e=null;if(a.getStyleFunction())e=jQuery.proxy(a.getStyleFunction(),a)()[0];else if(a.getStyle())e=a.getStyle();else if(jQuery.isFunction(b.getStyleFunction)&&b.getStyleFunction()){var f=b.getStyleFunction()(a,0);e=jQuery.isArray(f)?f[0]:f}else jQuery.isFunction(b.getStyle)&&b.getStyle()&&(e=b.getStyle());if(e&&e.getText()){var g=e.clone(),h=g.getText();if(h&&h.getText()){var i=h.getText();i=i.replace(/<p>/g,"\n"),i=i.replace(/<br>/g,"\n"),c?h.setText(i+(d>1?" (+"+(d-1)+")":"")):h.setText(i.replace(/\s+\(\+\d+\)$/,""));var j=h.getStroke(),k=j.getColor();jQuery.isArray(k)?(k[3]=c?"1.0":"0.0",j.setColor(k)):j.setColor(k.substring(0,k.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")");var l=h.getFill(),m=l.getColor();jQuery.isArray(m)?(m[3]=c?"1.0":"0.0",l.setColor(m)):l.setColor(m.substring(0,m.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")"),a.setStyle(g),a.changed()}}}},proxyUrl:function(a){var b=a;return 0!=a.indexOf(window.location.protocol+"//"+window.location.hostname)&&(b=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(a)),b},getWxsRequestUrl:function(a,b,c){var d="";switch(b.toLowerCase()){case"getcapabilities":d=magic.modules.Endpoints.getOgcEndpoint(a,"wms")+(-1!=a.indexOf("?")?"&":"?")+"request=GetCapabilities&service=wms";break;case"describefeaturetype":d=magic.modules.Endpoints.getOgcEndpoint(a,"wfs")+"?version=1.0.0&request=DescribeFeatureType&typename="+c}return d},getCapabilities:function(a,b,c){if(magic.runtime.map_context.capabilities[a])b(magic.runtime.map_context.capabilities[a],c);else{var d=new ol.format.WMSCapabilities;jQuery.get(this.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(e){try{var f=jQuery.parseJSON(JSON.stringify(d.read(e)));if(f){var g=null;if("Capability"in f&&"Layer"in f.Capability&&"Layer"in f.Capability.Layer&&jQuery.isArray(f.Capability.Layer.Layer)){var h=f.Capability.Layer.Layer;g={},this.getFeatureTypes(g,h)}null!=g?(magic.runtime.map_context.capabilities[a]=g,b(magic.runtime.map_context.capabilities[a],c)):b(null,c,"No feature types found in GetCapabilities response from "+a)}else b(null,c,"Malformed GetCapabilities response from "+a)}catch(d){b(null,c,"Parsing GetCapabilities response from "+a+" failed with error "+d.message)}},this)).fail(function(d,e,f){var g="Failed to WMS GetCapabilities document from "+a+", error was : "+f;401==e&&(g="Not authorised to retrieve WMS GetCapabilities document from "+a),b(null,c,g)})}},defaultMouseover:function(a){var b=0,c=!1,d=null;return a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(a,e){if(null!=e&&!0!==a.get("_ignoreHovers"))return!0===a.get("_customHover")?(d=null,c=!0):0==b&&(d={feature:a,layer:e}),b++,c},this)),!c&&b>0&&this.labelVisibility(d.feature,d.layer,!0,b),jQuery("#"+a.map.getTarget()).css("cursor",d?"pointer":"help"),d},defaultMouseout:function(a){a&&a.feature&&!0!==a.feature.get("_customHover")&&this.labelVisibility(a.feature,a.layer,!1,1)},featuresAtPixel:function(a){var b=[];return a.map.forEachFeatureAtPixel(a.pixel,function(a,c){if(null!=c){var d=a.get("features");if(d&&jQuery.isArray(d))jQuery.each(d,function(a,d){if(!d.get("ignoreClicks")&&d.getGeometry()){var e=d.getProperties();b.push(jQuery.extend({},e,{layer:c}))}});else if(!a.get("_ignoreClicks")&&a.getGeometry()){var e=a.getProperties();b.push(jQuery.extend({},e,{layer:c}))}}},{layerFilter:function(a){return a.getVisible()&&a.get("metadata")&&!0===a.get("metadata").is_interactive}},this),b},getFeatureTypes:function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a[c.Name]=c:"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatureTypes(a,c.Layer)},this))},populateSelect:function(a,b,c,d,e,f){var g=null;a.find("option").remove(),!0===f&&a.append(jQuery("<option>",{value:"",selected:""==e?" selected":"",text:"Please select"})),b.sort(function(a,b){var e=a[d]?a[d].toLowerCase():a[c].toLowerCase(),f=b[d]?b[d].toLowerCase():b[c].toLowerCase();return e<f?-1:e>f?1:0}),jQuery.each(b,function(b,f){var h=jQuery("<option>",{value:f[c]}),i=f[d]||f[c];h.text(i),a.append(h),e&&f[c]==e&&(g=h)}),null!=g&&g.prop("selected","selected")},jsonToForm:function(a,b,c){jQuery.each(a,function(a,d){var e=d.field,f=d.default,g=jQuery("#"+c+"-"+e),h="object"==typeof b[e]?JSON.stringify(b[e]):b[e];"checkbox"==g.attr("type")||"radio"==g.attr("type")?g.prop("checked",b&&e in b?!0===h:f):"url"==g.attr("type")?g.val(b?e in b?h:"":f):g.val(b&&e in b?h:f)})},formToJson:function(a,b){var c={};return jQuery.each(a,function(a,d){var e=d.field,f=jQuery("#"+b+"-"+e);switch(f.attr("type")){case"checkbox":case"radio":c[e]=!!f.prop("checked");break;default:var g=f.val();"number"==f.attr("type")&&jQuery.isNumeric(g)&&(g=Math.floor(g)==g?parseInt(g):parseFloat(g)),f.attr("required")&&""==g?c[e]=d.default:c[e]=g}}),c},flagInputError:function(a){var b=a.closest("div.form-group");b&&b.addClass("has-error")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'"><p>A problem occurred - more details below:</p><p>'+a+"</p></div>")},resetFormIndicators:function(){jQuery("div.form-group").removeClass("has-error")},getScript:function(a,b){jQuery.ajax({type:"GET",url:a,success:b,dataType:"script",cache:!0})},csvToArray:function(a){var b,c="",d=[""],e=[d],f=0,g=0,h=!0;for(b in a)b=a[b],'"'===b?(h&&b===c&&(d[f]+=b),h=!h):","===b&&h?b=d[++f]="":"\n"===b&&h?("\r"===c&&(d[f]=d[f].slice(0,-1)),d=e[++g]=[b=""],f=0):d[f]+=b,c=b;return e},sortedUniqueArray:function(a){var b=[];if(!a||0==a.length)return b;var c={};return b=jQuery.map(a,function(a){return a in c?null:(c[a]=1,a)}),b.sort(),b},isUrl:function(a){if("string"==typeof a){var b=/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;return a.match(b)}return!1},isNameLike:function(a){a=a.toLowerCase();for(var b=["^name.*$","^callsign$","^[^n]*name$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLongitudeLike:function(a){a=a.toLowerCase();for(var b=["^lon.*$","^x$","^xcoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLatitudeLike:function(a){a=a.toLowerCase();for(var b=["^lat.*$","^y$","^ycoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isDatetimeLike:function(a){a=a.toLowerCase();for(var b=["^date.*$","^time.*$","^utc$","^[^u]*update.*$","timestamp$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},dateFormat:function(a,b){if(!a)return"";var c=a,d=new Date(a);if(-1==a.toLowerCase().indexOf("invalid")){var e=d.getDate();e=(e<10?"0":"")+e;var f=d.getMonth()+1;f=(f<10?"0":"")+f;var g=d.getFullYear();c="dmy"==b?e+"-"+f+"-"+g:g+"-"+f+"-"+e}return c},fileSize:function(a){var b=Math.log(a)/Math.log(1024)|0;return(a/Math.pow(1024,b)).toFixed(2)+" "+(0==b?"bytes":"kMGTPEZY"[b-1]+"B")},JsonEscape:function(a){var b=a.replace(/\&/g,"&amp;");return b=b.replace(/\"/g,"&quot;")},JsonUnescape:function(a){var b=a.replace(/\&quot;/g,'"');return b=b.replace(/\&amp;/g,"&")},linkify:function(a,b){if(!a)return"";if("string"==typeof a){if(-1!=a.indexOf("<a"))return a;if(a.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>';if(a.match(/^https?:\/\//)&&a.indexOf("?")>0){if(a.substring(0,a.indexOf("?")).match(/\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>'}var c=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,d=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/\w+@[a-zA-Z_]+?(?:\.[a-zA-Z]{2,6})+/gim;return b?a.replace(c,'<a href="$&" title="$&" target="_blank">'+b+"</a>").replace(d,'$1<a href="http://$2" target="_blank">'+b+"</a>").replace(e,'<a href="mailto:$&">'+b+"</a>"):a.replace(c,'<a href="$&" title="$&" target="_blank">[external resource]</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$&">$&</a>')}return a},chunk:function(a,b){return void 0===b&&(b=2),a.match(RegExp(".{1,"+b+"}","g")).join("<br>")},ellipsis:function(a,b){if(!a)return"";if(a.length<=b)return a;var c=a.substr(0,b),d=c.lastIndexOf(" ");return c=-1==d||d<b/2?c.substr(0,b-3)+"...":c.substr(0,d)+"..."},stringDivider:function(a,b,c){if(a.length>b){for(var d=b;d>0&&" "!=a[d]&&"-"!=a[d];d--);if(d>0){var e;e="-"==a.substring(d,d+1)?a.substring(0,d+1):a.substring(0,d);var f=a.substring(d+1);return e+c+stringDivider(f,b,c)}}return a},objectLength:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},initCap:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},unitConverter:function(a,b,c,d){d=d||1;var e=0,f=b,g=c;return f in this.inches_per_unit&&g in this.inches_per_unit&&(1==d||2==d)&&(e=a*Math.pow(this.inches_per_unit[f]/this.inches_per_unit[g],d),e=e.toFixed(3)+" "+g+(2==d?"<sup>2</sup>":"")),e},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},toRadians:function(a){return a*Math.PI/180},toDegrees:function(a){return 180*a/Math.PI},floatsEqual:function(a,b,c){return Math.abs(a-b)<=c},floatInRange:function(a,b,c,d){return(a>b||Math.abs(a-b)<=d)&&(a<c||Math.abs(a-c)<=d)}}}(),magic.modules.GeoUtils=function(){return{ANGULAR_TOLERANCE:.001,N_INTERP:5,WGS84:new ol.Sphere(6378137),DISTANCE_UNITS:[["km","kilometres"],["m","metres"],["mi","statute miles"],["nmi","nautical miles"]],AREA_UNITS:[["km","square kilometres"],["m","square metres"],["mi","square miles"],["nmi","square nautical miles"]],ELEVATION_UNITS:[["m","metres"],["ft","feet"]],COORDINATE_FORMATS:[["dd","decimal degrees"],["dms","degrees, minutes and seconds"],["ddm","degrees, decimal minutes"]],DEFAULT_GEO_PREFS:{distance:"km",area:"km",elevation:"m",coordinates:"dd"},DEFAULT_MAP_PARAMS:{antarctic:{projection:"EPSG:3031",proj_extent:[-5e6,-5e6,5e6,5e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140,56,28,14,5.6,2.8,1.4,.56]},antarctic_laea:{projection:"EPSG:102020",proj_extent:[-55e5,-55e5,55e5,55e5],center:[0,0],zoom:0,rotation:0,resolutions:[14e3,7e3,2800,1400,560,280,140]},arctic:{projection:"EPSG:3995",proj_extent:[-4e6,-4e6,4e6,4e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140]},southgeorgia:{projection:"EPSG:3762",proj_extent:[-929362.849,-1243855.108,1349814.294,556833.528],center:[-1e3,61900],zoom:4,rotation:0,resolutions:[3360,1680,840,420,210,105,42,21,10.5,4.2,2.1,1.12,.56,.28,.14]},midlatitudes:{projection:"EPSG:3857",proj_extent:[-20026376.39,-20048966.1,20026376.39,20048966.1],center:[0,0],zoom:0,rotation:0,resolutions:[]}},defaultResolution:function(a){var b=0;switch(a){case"EPSG:3762":b=this.DEFAULT_MAP_PARAMS.southgeorgia.resolutions[0];break;case"EPSG:3031":b=this.DEFAULT_MAP_PARAMS.antarctic.resolutions[0];break;case"EPSG:102020":b=this.DEFAULT_MAP_PARAMS.antarctic_laea.resolutions[0];break;case"EPSG:3995":b=this.DEFAULT_MAP_PARAMS.arctic.resolutions[0]}return b},defaultGazetteers:function(a){var b=[];switch(a){case"EPSG:3762":b=["sgssi"];break;case"EPSG:3031":case"EPSG:102020":b=["cga"];break;case"EPSG:3995":b=["arctic"]}return b},defaultEmbeddedLayers:function(a){return this.getBaseLayers(a,!0).concat(this.getTopoLayers(a,!0))},defaultLayers:function(a){return"antarctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic",!1)}]:"antarctic_laea"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic_laea",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic_laea",!1)}]:"arctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("arctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("arctic",!1)}]:"southgeorgia"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("southgeorgia",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("southgeorgia",!1)}]:"midlatitudes"==a?[{id:null,name:"OpenStreetMap",expanded:!0,layers:this.getBaseLayers("midlatitudes",!1)}]:[]},getBaseLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_hillshade_and_bathymetry",is_base:!0},b)]:"antarctic_laea"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:hillshade_and_bathymetry",is_base:!0},b)]:"arctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"southgeorgia"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"midlatitudes"==a?[magic.modules.Endpoints.getMidLatitudeCoastSource(b)]:[]},getTopoLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_coastline"},b),this.layerSpecification("Sub-Antarctic coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:sub_antarctic_coastline"},b)]:"antarctic_laea"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:coastline"},b)]:"arctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_coastline"},b)]:"southgeorgia"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_coastline"},b),this.layerSpecification("Surface",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_surface"},b)]:[]},layerSpecification:function(a,b,c){return jQuery.extend({id:null,name:a,is_visible:!0},c?b:{source:b})},headingFromTrackGeometry:function(a){var b=0,c=a.getCoordinates();if(jQuery.isArray(c)&&c.length>=2){var d=c[c.length-2],e=c[c.length-1],f=new Vector(e[0]-d[0],e[1]-d[1]),g=new Vector(0,1);b=Math.acos(f.unit().dot(g))}return b},getGeometryType:function(a){var b="point";return a instanceof ol.geom.LineString||a instanceof ol.geom.MultiLineString?b="line":a instanceof ol.geom.Polygon||a instanceof ol.geom.MultiPolygon?b="polygon":a instanceof ol.geom.GeometryCollection&&(b="collection"),b},formatCoordinate:function(a,b,c,d){var e=null;if(d||0==d||(d=4),this.validCoordinate(a,"lat"==c,!1)){var f=this.toDecDegrees(a);if(isNaN(f))e=a;else switch(f=parseFloat(f.toFixed(d)),b){case"dms":e=this.toDMS(f,c,"dms");break;case"ddm":e=this.toDDM(f,c);break;default:e=f}}else e=a;return e},toDMS:function(a,b){var c="";if("lon"==b){var d=[a,.1],e=ol.coordinate.toStringHDMS(d),f="N";c=e.substring(e.indexOf(f)+2)}else{var d=[0,a],e=ol.coordinate.toStringHDMS(d),f=a<0?"S":"N";c=e.substring(0,e.indexOf(f)+1)}return c},toDDM:function(a,b){var c="",d=this.toDMS(a,b),e=d.split(/[^A-Za-z0-9.]+/);if(4==e.length){var f=parseFloat(e[1])+parseFloat(e[2]/60);c=e[3]+e[0]+" "+f.toFixed(3)}return c},toDecDegrees:function(a){var b=a;if(!jQuery.isNumeric(a)&&"string"==typeof a){b=Number.NaN,a=a.trim().toUpperCase();var c="X",d=0,e=0,f=0,g=a.charAt(0),h=a.charAt(a.length-1);if("N"==g||"S"==g||"E"==g||"W"==g?(c=g,a=a.substring(1)):"N"!=h&&"S"!=h&&"E"!=h&&"W"!=h||(c=h,a=a.substring(0,a.length-1)),"X"!=c){a=a.replace(/[^0-9.]{1,}/g," "),a=a.trim();var i=a.split(" ");d=parseFloat(i[0]),i.length>1&&(e=parseFloat(i[1])),i.length>2&&(f=parseFloat(i[2])),b=(d+e/60+f/3600)*("S"==c||"W"==c?-1:1)}}return isNaN(b)?Number.NaN:parseFloat(b)},validCoordinate:function(a,b,c){var d=!1;if(!a&&c)d=!0;else{var e=b?-90:-180,f=b?90:180,g=this.toDecDegrees(a);isNaN(g)||(d=magic.modules.Common.floatInRange(g,e,f,1e-8))}return d},validHemisphere:function(a){return 1==a.length&&a.match(/N|E|S|W|n|e|s|w/)},formatSpatial:function(a,b,c,d,e){if(!jQuery.isNumeric)return"";e||0==e||(e=1);var f=a;if(d!=c){var g={m:1,ft:3.2808399,km:.001,mi:.000621371192,nm:.000539956803};if(a=parseFloat(a),"m"!=d)for(var h=0;h<b;h++)a*=1/g[d];if("m"!=c)for(var h=0;h<b;h++)a*=g[c];f=a.toFixed(e)+c}else f+=c;return f},formatBbox:function(a,b){if(!a)return"";b||0==b||(b=1);var c=jQuery.map(a,function(a){return a}),d=["minx","miny","maxx","maxy"],e=[];return jQuery.each(c,function(a,c){e.push(d[a]+" : "+parseFloat(c).toFixed(b))}),e.join("<br>")},bufferExtent:function(a,b){var c=a.slice(0);b=b||1e4;var d=[.5*(a[2]-a[0]),.5*(a[3]-a[1])];return a[2]-a[0]<b&&(c[0]=d[0]-.5*b,c[2]=d[0]+.5*b),a[3]-a[1]<b&&(c[1]=d[1]-.5*b,c[3]=d[1]+.5*b),c},formatProjection:function(a){var b=a.split(":").pop();return!isNaN(parseInt(b))&&(b<32768||102020==b)?'<a href="https://epsg.io/?q='+b+'" target="_blank">'+a+"</a>":a},applyPref:function(a,b,c,d,e){var f=b;if(null==b||void 0==b)return"";switch(c||"coordinates"!=a||(c="lon"),d||(d=magic.runtime.preferences[a]),e||"distance"!=a&&"area"!=a&&"elevation"!=a||(e="m"),a){case"coordinates":f=this.formatCoordinate(b,d,c);break;case"distance":f=this.formatSpatial(b,1,d,e,2);break;case"area":f=this.formatSpatial(b,2,d,e,2);break;case"elevation":f=this.formatSpatial(b,1,d,e,1)}return f},isPolarProjection:function(a){switch(a){case"EPSG:3031":case"EPSG:3995":case"EPSG:102020":return!0;default:return!1}},projectionLatLonExtent:function(a){var b=[];switch(a){case"EPSG:3031":b=[-180,-90,180,-50];break;case"EPSG:3995":b=[-180,60,180,90];break;case"EPSG:3762":b=[-50,-65,-18,-50];break;case"EPSG:102020":b=[-180,-89,180,-30];break;default:b=[-180,-85.06,180,85.06]}return b},withinExtent:function(a,b){return magic.modules.Common.floatInRange(a[0],b[0],b[2],this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatInRange(a[1],b[1],b[3],this.ANGULAR_TOLERANCE)},alongDateline:function(a,b){return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&(magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)||magic.modules.Common.floatsEqual(a,180,this.ANGULAR_TOLERANCE))},crossesDateline:function(a,b){return a>0&&b<0&&!magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)},atPole:function(a,b,c){var d=c?"S"==c?-90:90:-90;return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(a,d,this.ANGULAR_TOLERANCE)},isCircumpolar:function(a,b){return magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(b,180,this.ANGULAR_TOLERANCE)},geodesicLength:function(a,b){b=b||magic.runtime.map;for(var c=0,d=a.getCoordinates(),e=0,f=d.length-1;e<f;++e){var g=ol.proj.transform(d[e],b.getView().getProjection().getCode(),"EPSG:4326"),h=ol.proj.transform(d[e+1],b.getView().getProjection().getCode(),"EPSG:4326");c+=this.WGS84.haversineDistance(g,h)}return c},geodesicArea:function(a,b){var c=a.clone().transform(b.getView().getProjection().getCode(),"EPSG:4326");return Math.abs(this.WGS84.geodesicArea(c.getLinearRing[0].getCoordinates()))},uniteExtents:function(a){if(!a||jQuery.isArray(a)&&0==a.length)return null;for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)b=null==b?a[f][0]:Math.min(b,a[f][0]),c=null==c?a[f][1]:Math.min(c,a[f][1]),d=null==d?a[f][2]:Math.max(d,a[f][2]),e=null==e?a[f][3]:Math.max(e,a[f][3]);return[b,c,d,e]},extentFromWgs84Extent:function(a,b){if(!b){if(!magic.runtime.map)return a;b=magic.runtime.map.getView().getProjection().getCode()}var c=[],d=null,e=a[0],f=a[1],g=a[2],h=a[3],i=ol.proj.get("EPSG:4326");if(this.isCircumpolar(e,g)){var j=new ol.geom.Point([0,h]);j.transform(i,b);var k=j.getCoordinates()[1];d=[-k,-k,k,k]}else{this.crossesDateline(e,g)?(c.push([e,f,180,h]),c.push([-180,f,g,h])):c.push([e,f,g,h]);for(var l=0;l<c.length;l++){var m=this.densify(c[l]);m.transform(i,b),null==d?d=m.getExtent():d.extend(m.getExtent())}}return d},densify:function(a){for(var b=[],c=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]],d=0;d<c.length;d++)for(var e=(d+1)%4,f=parseFloat(c[e][0]-c[d][0]),g=parseFloat(c[e][1]-c[d][1]),h=0;h<=this.N_INTERP;h++){var i=parseFloat(h)/parseFloat(this.N_INTERP+1);b.push([parseFloat(c[d][0])+i*f,parseFloat(c[d][1])+i*g])}return new ol.geom.Polygon([b],"XY")},getCurrentMapScale:function(a){a=a||magic.runtime.map;var b=a.getView().getResolution(),c=a.getView().getProjection().getUnits(),d=25.4/.28,e=ol.proj.METERS_PER_UNIT[c],f=b*e*39.37*d;return parseFloat(f)},getResolutionFromScale:function(a,b,c){if(!(b&&c||magic.runtime.map))return 0;b=b||magic.runtime.map.getView().getResolutions(),c=c||magic.runtime.map.getView().getProjection();var d=b[0];if(!isNaN(a)){var e=c.getUnits(),f=25.4/.28,g=ol.proj.METERS_PER_UNIT[e];d=parseFloat(a)/(39.37*g*f)}return d},headingWrtTrueNorth:function(a,b){var c=a.getCoordinates(),d=new Vector(c[0],c[1]),e=new ol.geom.Point([0,1]),f=new Vector(e.x,e.y),g=d.unit().dot(f);return(b-180*Math.acos(g)/Math.PI)%360}}}(),magic.classes.creator.EmbeddedAttributeEditorPopup=function(a){a=jQuery.extend({},{id:"em-attr-editor",caption:"Edit attribute data",popoverClass:"em-attr-editor-popover",popoverContentClass:"em-attr-editor-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.wmsService=a.wms_source,this.featureName=a.feature_name,this.inputs=["name","type","nillable","alias","ordinal","displayed"],this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,trigger:"manual",content:'<p><i class="fa fa-spin fa-spinner"></i> Loading attributes...</p>'}).on("shown.bs.popover",jQuery.proxy(function(a){this.assignCloseButtonHandler(),this.getFeatureAttributes(this.prePopulator)},this))},magic.classes.creator.EmbeddedAttributeEditorPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.constructor=magic.classes.creator.EmbeddedAttributeEditorPopup,magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.getFeatureAttributes=function(){var a=magic.modules.Common.getWxsRequestUrl(this.wmsService,"DescribeFeatureType",this.featureName);a?this.prePopulator&&!jQuery.isEmptyObject(this.prePopulator)?(jQuery(".em-attr-editor-popover-content").html(this.markup(this.prePopulator,this.computeOgcGeomType(this.prePopulator))),this.assignHandlers()):jQuery.ajax({url:a,method:"GET",dataType:"xml"}).done(jQuery.proxy(function(a){var b=b=jQuery(a).find("xsd\\:sequence").find("xsd\\:element"),c=[];jQuery.each(b,function(a,b){var d={};jQuery.each(b.attributes,function(a,b){"type"==b.name?d[b.name]=b.value.replace("xsd:",""):d[b.name]=b.value}),c.push(d)}),jQuery(".em-attr-editor-popover-content").html(this.markup(c,this.computeOgcGeomType(c))),this.assignHandlers()},this)).fail(jQuery.proxy(function(a,b,c){401==b?magic.modules.Common.showAlertModal("Not authorised to read data","warning"):magic.modules.Common.showAlertModal("Error : "+c+" from server while reading attributes","warning")},this)):jQuery(".em-attr-editor-popover-content").html('<div class="alert alert-info">No attributes found</div>')},magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.assignHandlers=function(){this.formEdited=!1,jQuery("#"+this.id+"-attr-table :input").off("change").on("change",jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").off("click").on("click",jQuery.proxy(function(){magic.modules.Common.buttonClickFeedback(this.id,!0,"Saved ok"),jQuery.isFunction(this.controlCallbacks.onSave)&&(this.controlCallbacks.onSave(this.formToPayload()),this.delayedDeactivate(2e3))},this)),jQuery("#"+this.id+"-cancel").off("click").on("click",jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.markup=function(a,b){var c="";return 0==a.length?c='<div class="alert alert-info">No attributes found</div>':(c+='<div class="alert alert-info">Geometry type is <strong>'+b+'</strong></div><table id="'+this.id+'-attr-table" class="table table-condensed table-striped table-hover table-responsive" style="width:100%"><tr><th style="width:200px">Name</th><th style="width:60px">Type</th><th style="width:120px"><span data-toggle="tooltip" data-placement="top" title="Human-friendly name for the attribute in pop-up">Alias<span></th><th style="width:40px"><i class="fa fa-list-ol" data-toggle="tooltip" data-placement="top" title="Ordering of attribute in pop-up"><i></th><th style="width:40px"><i class="fa fa-eye" data-toggle="tooltip" data-placement="top" title="Attribute is visible in pop-ups"><i></th></tr>',jQuery.each(a,jQuery.proxy(function(a,b){c+='<input type="hidden" id="_amap_name_'+a+'" value="'+(b.name||"")+'"></input>',c+='<input type="hidden" id="_amap_type_'+a+'" value="'+(b.type||"")+'"></input>',c+='<input type="hidden" id="_amap_nillable_'+a+'" value="'+(b.nillable||"")+'"></input>',b.type&&0!=b.type.indexOf("gml:")&&(c+='<tr><td><div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'+(b.name||"")+"</div></td><td>"+b.type.replace("xsd:","")+'</td><td><input class="attr-editor-input" type="text" style="width: 120px" id="_amap_alias_'+a+'" value="'+(b.alias||"")+'"></input></td><td><input class="attr-editor-input" type="number" size="2" style="width: 37px" min="1" max="99" id="_amap_ordinal_'+a+'" value="'+(b.ordinal||"")+'"></input></td><td><input type="checkbox" id="_amap_displayed_'+a+'" value="display"'+(!0===b.displayed?' checked="checked"':"")+"></input></td></tr>")},this)),c+="</table>"+magic.modules.Common.buttonFeedbackSet(this.id,"Save attributes","md","Save",!0)),c},magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.formToPayload=function(){var a=[];return jQuery("input[id^='_amap_type']").each(jQuery.proxy(function(b,c){if(0!=jQuery(c).val().indexOf("gml:")){var d={};jQuery.each(this.inputs,jQuery.proxy(function(a,c){var e=jQuery("#_amap_"+c+"_"+b);if("checkbox"==e.attr("type"))d[c]=!0===e.prop("checked");else if("ordinal"==c){var f=parseInt(e.val());d[c]=isNaN(f)?null:f}else d[c]=e.val()},this)),a.push(d)}},this)),a},magic.classes.creator.EmbeddedAttributeEditorPopup.prototype.computeOgcGeomType=function(a){var b="unknown";return jQuery.each(a,function(a,c){if(c.type&&0==c.type.indexOf("gml:")){var d=c.type.toLowerCase();d.indexOf("point")>=0?b="point":d.indexOf("line")>=0||d.indexOf("curve")>=0?b="line":d.indexOf("polygon")>=0&&(b="polygon")}return"unknown"==b}),b},magic.classes.creator.EmbeddedLayerEditorPopup=function(a){a=jQuery.extend({},{id:"em-layer-editor",caption:"Edit layer data",popoverClass:"em-layer-editor-popover",popoverContentClass:"em-layer-editor-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.formSchema=[{field:"id",default:""},{field:"name",default:""},{field:"attribution",default:""},{field:"opacity",default:1},{field:"is_base",default:!1},{field:"is_singletile",default:!1},{field:"is_interactive",default:!1},{field:"is_extent",default:!1},{field:"is_filterable",default:!1}],this.wmsSelectors=new magic.classes.creator.WmsFeatureLinkedMenus({id:this.id}),this.subForms.attributeEditor=null,this.editedAttributes=[],this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,trigger:"manual",content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(a){jQuery("#"+this.id+"-name").focus(),this.editedAttributes=[],this.assignCloseButtonHandler(),this.assignHandlers(),this.payloadToForm(this.prePopulator)},this))},magic.classes.creator.EmbeddedLayerEditorPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.creator.EmbeddedLayerEditorPopup.prototype.constructor=magic.classes.creator.EmbeddedLayerEditorPopup,magic.classes.creator.EmbeddedLayerEditorPopup.prototype.markup=function(){return'<div id="'+this.id+'-edit-view-fs" class="col-md-12"><input type="hidden" id="'+this.id+'-id"></input><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-name"><span class="label label-danger">Name</span></label><div class="col-md-9"><input type="text" id="'+this.id+'-name" class="form-control" placeholder="Layer name" maxlength="100" data-toggle="tooltip" data-placement="left" title="Layer name (required)" required="required"></input></div></div>'+this.wmsSelectors.markup()+'<div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-attribution">Attribution</label><div class="col-md-9"><input type="text" id="'+this.id+'-attribution" class="form-control" placeholder="Data attribution" maxlength="255" data-toggle="tooltip" data-placement="left" title="Data attribution"></input></div></div><div class="form-group form-group-md col-md-12"><label for="'+this.id+'-opacity" class="col-md-3 control-label">Opacity</label><div class="col-md-9"><input type="number" class="form-control" id="'+this.id+'-opacity" placeholder="Layer opacity (0->1)" min="0" max="1" step="0.1" data-toggle="tooltip" data-placement="left" title="Layer opacity (0.0 = transparent, 1.0 = opaque)" value="1.0"></input></div></div><div class="form-group form-group-md col-md-12"><div class="checkbox" style="float:left" data-toggle="tooltip" data-placement="left" title="Layer is a base (backdrop) layer"><label><input id="'+this.id+'-is_base" type="checkbox"></input> This is a base (backdrop) layer</label></div></div><div class="form-group form-group-md col-md-12"><div class="checkbox" style="float:left" data-toggle="tooltip" data-placement="left" title="Layer renders as a single large tile, useful for place-names or rasters where tile edge effects are noticeable"><label><input id="'+this.id+'-is_singletile" type="checkbox"></input> Render a single large tile</label></div></div><div class="form-group form-group-md col-md-12"><div class="checkbox" style="float:left" data-toggle="tooltip" data-placement="left" title="This layer should display interactive pop-ups on the map"><label><input id="'+this.id+'-is_interactive" type="checkbox" data-toggle="popover" data-placement="bottom" data-trigger="manual"></input> Layer displays interactive map pop-ups</label></div></div><div class="form-group form-group-md col-md-12"><div class="checkbox" style="float:left" data-toggle="tooltip" data-placement="left" title="Use this layer to determine the starting extent of the map"><label><input id="'+this.id+'-is_extent" type="checkbox" data-toggle="popover" data-placement="bottom" data-trigger="manual"></input> Determine map extent from layer data</label></div></div><div class="form-group form-group-md col-md-12"><div class="checkbox" style="float:left" data-toggle="tooltip" data-placement="left" title="Filter this layer via the \'filter\' URL parameter"><label><input id="'+this.id+'-is_filterable" type="checkbox" data-toggle="popover" data-placement="bottom" data-trigger="manual"></input> Filter this layer via URL parameters</label></div></div>'+magic.modules.Common.buttonFeedbackSet(this.id,"Save data","sm","Save",!0)+"</div>"},magic.classes.creator.EmbeddedLayerEditorPopup.prototype.assignHandlers=function(){this.formEdited=!1,jQuery("#"+this.id+"-edit-view-fs :input").off("change").on("change",jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-is_interactive").off("change").on("change",jQuery.proxy(function(a,b){var c=jQuery(a.currentTarget).prop("checked");this.subForms.attributeEditor&&this.subForms.attributeEditor.isActive()&&this.subForms.attributeEditor.deactivate(),c&&(this.subForms.attributeEditor=new magic.classes.creator.EmbeddedAttributeEditorPopup({target:a.currentTarget.id,wms_source:this.wmsSelectors.getValue("wms_source"),feature_name:this.wmsSelectors.getValue("feature_name"),onSave:jQuery.proxy(this.saveAttributes,this)}),this.subForms.attributeEditor.activate(this.editedAttributes))},this)),jQuery("#"+this.id+"-go").off("click").on("click",jQuery.proxy(function(){this.validate()?(magic.modules.Common.buttonClickFeedback(this.id,!0,"Saved ok"),jQuery.isFunction(this.controlCallbacks.onSave)&&(this.controlCallbacks.onSave(this.formToPayload()),this.delayedDeactivate(2e3))):magic.modules.Common.buttonClickFeedback(this.id,!1,"Failed to save - please correct marked errors")},this)),jQuery("#"+this.id+"-cancel").off("click").on("click",jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.creator.EmbeddedLayerEditorPopup.prototype.formToPayload=function(){return jQuery.extend(!0,{},magic.modules.Common.formToJson(this.formSchema,this.id),{attribute_map:this.editedAttributes},this.wmsSelectors.formToPayload())},magic.classes.creator.EmbeddedLayerEditorPopup.prototype.payloadToForm=function(a){a=a||{},this.wmsSelectors.init({wms_source:a.wms_source||"",feature_name:a.feature_name||"",style_name:a.style_name||""}),magic.modules.Common.jsonToForm(this.formSchema,a,this.id),!0===a.is_interactive&&(this.editedAttributes=a.attribute_map,jQuery("#"+this.id+"-is_interactive").trigger("change"))},magic.classes.creator.EmbeddedLayerEditorPopup.prototype.validate=function(){var a=!0,b=jQuery("#"+this.id+"-edit-view-fs");return jQuery.each(b.find("input[required='required']"),function(b,c){var d=jQuery(c),e=d.closest("div.form-group");d.prop("validity").valid?e.removeClass("has-error"):(e.addClass("has-error"),a=!1)}),a},magic.classes.creator.EmbeddedLayerEditorPopup.prototype.saveAttributes=function(a){this.editedAttributes=a},magic.classes.creator.WmsFeatureLinkedMenus=function(a){this.id=a.id||"wms-linked-menus",this.projection=magic.runtime.projection,this.dropdowns={}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.getValue=function(a){return this.dropdowns[a].val()},magic.classes.creator.WmsFeatureLinkedMenus.prototype.formToPayload=function(){return{wms_source:this.dropdowns.wms_source.val(),feature_name:this.dropdowns.feature_name.val(),style_name:this.dropdowns.style_name.val()||null}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.markup=function(){return'<div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-wms_source"><span class="label label-danger">WMS</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-wms_source" data-toggle="tooltip" data-placement="left" title="Choose a WMS service from which to fetch data" required="required"></select></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-feature_name"><span class="label label-danger">Feature</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-feature_name" data-toggle="tooltip" data-placement="left" title="Choose a dataset served by above WMS" required="required"></select></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-style_name"><span class="label label-danger">Style</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-style_name" data-toggle="tooltip" data-placement="left" title="Choose a style to be used with the feature" required="required"></select></div></div>'},magic.classes.creator.WmsFeatureLinkedMenus.prototype.sourceSpecified=function(){return""!=this.dropdowns.wms_source.val()&&""!=this.dropdowns.feature_name.val()},magic.classes.creator.WmsFeatureLinkedMenus.prototype.validate=function(){var a=this.sourceSpecified();return this.dropdowns.wms_source.val()||magic.modules.Common.flagInputError(this.dropdowns.wms_source),this.dropdowns.wms_source.val()||magic.modules.Common.flagInputError(this.dropdowns.feature_name),a},magic.classes.creator.WmsFeatureLinkedMenus.prototype.init=function(a){this.dropdowns.wms_source=jQuery("#"+this.id+"-wms_source"),this.dropdowns.feature_name=jQuery("#"+this.id+"-feature_name"),this.dropdowns.style_name=jQuery("#"+this.id+"-style_name");var b=a.wms_source,c=magic.modules.Endpoints.getEndpointsBy("url",b);jQuery.isArray(c)&&c[0].url&&(b=c[0].url),magic.modules.Common.populateSelect(this.dropdowns.wms_source,magic.modules.Endpoints.getEndpointsBy("srs",this.projection),"url","name",b,!0),a.feature_name&&this.loadFeaturesFromService(b,a.feature_name,a.style_name),this.dropdowns.wms_source.off("change").on("change",jQuery.proxy(function(){var a=this.dropdowns.wms_source.val();a&&"osm"!=a?(this.dropdowns.feature_name.prop("disabled",!1),this.loadFeaturesFromService(a,"",""),this.dropdowns.style_name.prop("disabled",!0).empty()):(this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty())},this)),this.dropdowns.feature_name.off("change").on("change",jQuery.proxy(function(){var a=this.dropdowns.wms_source.val(),b=this.dropdowns.feature_name.val();b?(this.dropdowns.style_name.prop("disabled",!1),this.loadStylesForFeature(a,b,"")):this.dropdowns.style_name.prop("disabled",!0).empty()},this))},magic.classes.creator.WmsFeatureLinkedMenus.prototype.loadFeaturesFromService=function(a,b,c){if("osm"!=a){c=c||"",this.dropdowns.feature_name.prop("disabled",!1);var d=magic.runtime.creator.catalogues[a];d&&d.length>0?(magic.modules.Common.populateSelect(this.dropdowns.feature_name,d,"value","name",b,!0),this.loadStylesForFeature(a,b,c)):jQuery.get(magic.modules.Common.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(d){try{var e=jQuery.parseJSON(JSON.stringify((new ol.format.WMSCapabilities).read(d)));e?(magic.runtime.creator.catalogues[a]=this.extractFeatureTypes(e),magic.modules.Common.populateSelect(this.dropdowns.feature_name,magic.runtime.creator.catalogues[a],"value","name",b,!0),this.loadStylesForFeature(a,b,c)):(magic.modules.Common.showAlertModal("Failed to parse capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty())}catch(b){magic.modules.Common.showAlertModal("Failed to parse capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty()}},this)).fail(jQuery.proxy(function(){magic.modules.Common.showAlertModal("Failed to read capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty()},this))}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.loadStylesForFeature=function(a,b,c){b&&jQuery.isArray(magic.runtime.creator.catalogues[a])?jQuery.each(magic.runtime.creator.catalogues[a],jQuery.proxy(function(a,d){var e=b.toLowerCase().split(":").pop();return d.value.toLowerCase().split(":").pop()!=e||(jQuery.isArray(d.styles)&&d.styles.length>1?magic.modules.Common.populateSelect(this.dropdowns.style_name,d.styles,"Name","Title",c,!1):magic.modules.Common.populateSelect(this.dropdowns.style_name,[{Name:"",Title:"Default style"}],"Name","Title","",!1),!1)},this)):magic.modules.Common.populateSelect(this.dropdowns.style_name,[{Name:"",Title:"Default style"}],"Name","Title","",!1)},magic.classes.creator.WmsFeatureLinkedMenus.prototype.extractFeatureTypes=function(a){var b=[];if("Capability"in a&&"Layer"in a.Capability&&"Layer"in a.Capability.Layer&&jQuery.isArray(a.Capability.Layer.Layer)){var c=a.Capability.Layer.Layer;this.getFeatures(b,c)}else magic.modules.Common.showAlertModal("Malformed GetCapabilities response received from remote WMS","error");return b},magic.classes.creator.WmsFeatureLinkedMenus.prototype.getFeatures=function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a.push({name:c.Title,value:c.Name,styles:c.Style}):"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatures(a,c.Layer)},this))},magic.classes.creator.MapRegionSelector=function(a){this.loadContextCb=a.contextLoader||null,this.prefix=a.prefix||"region-select",this.mapTitleService=a.mapTitleService||magic.config.paths.baseurl+"/maps/dropdown",this.mapDataService=a.mapDataService||magic.config.paths.baseurl+"/maps/name",this.currentMapId="",jQuery("input[name$='action-rb']").click(jQuery.proxy(function(a){var b=jQuery(a.currentTarget);jQuery.each(["new","edit","clone"],jQuery.proxy(function(a,c){if(c==b.val()){var d=jQuery("#"+this.prefix+"-"+c);d.prop("disabled",!1);var e="";if("edit"==c){var f=window.location.search;f&&f.match(/\?name=[a-z0-9_]+$/)&&(e=f.substring(6))}"edit"!=c&&"clone"!=c||(d.find("option").remove(),jQuery.getJSON(this.mapTitleService+"/"+c,jQuery.proxy(function(a){if(magic.modules.Common.populateSelect(d,a,"name","title",e,!0),magic.modules.Common.resetFormIndicators(),e&&"edit"==c){jQuery.grep(a,function(a){return a.name==e}).length>0?this.loadContext(c,e):magic.modules.Common.showAlertModal("You are not allowed to edit the map "+e,"error")}},this)).fail(function(a,b,c){magic.modules.Common.showAlertModal("Failed to get map titles - error was : "+c,"error")}))}else jQuery("#"+this.prefix+"-"+c).prop("disabled",!0)},this))},this)),jQuery("select.map-select").change(jQuery.proxy(function(a){var b=jQuery(a.currentTarget),c=b.attr("id").split("-").pop(),d=b.val();magic.modules.Common.resetFormIndicators(),this.loadContext(c,d)},this));var b=window.location.search;b&&b.match(/\?name=[a-z0-9_]+$/)&&jQuery("#"+this.prefix+"-edit-rb").trigger("click")},magic.classes.creator.MapRegionSelector.prototype.loadContext=function(a,b){"new"==a?(this.currentMapId="",this.loadContextCb(null,jQuery("#"+this.prefix+"-new").val())):b&&jQuery.getJSON(this.mapDataService+"/"+b,jQuery.proxy(function(b){"clone"==a&&(b.id="",b.name+="_copy"),this.currentMapId="edit"==a?b.id:"",this.loadContextCb(b,null)},this)).fail(function(a,c,d){magic.modules.Common.showAlertModal("Failed to get map data for "+b+" - details : "+d,"error")})},magic.classes.creator.MapRegionSelector.prototype.validate=function(a,b){var c=jQuery("input[type='radio'][name='_"+this.prefix+"-action-rb']:checked");if(!c)return!1;var d=jQuery("#"+this.prefix+"-"+c.val());return!(0==d.length||d.length>0&&""==d.val())},magic.classes.creator.MapMetadataForm=function(a){this.formSchema=a.formSchema,this.prefix=a.prefix||"map-metadata"},magic.classes.creator.MapMetadataForm.prototype.defaultData=function(a){var b={};return jQuery.each(this.formSchema,jQuery.proxy(function(a,c){b[c.field]=c.default},this)),b},magic.classes.creator.MapMetadataForm.prototype.loadContext=function(a){jQuery("#"+this.prefix+"-form").closest("div.row").removeClass("hidden"),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.MapMetadataForm.prototype.getContext=function(){return jQuery("#"+this.prefix+"-form").closest("div.row").removeClass("hidden"),magic.modules.Common.formToJson(this.formSchema,this.prefix)},magic.classes.creator.MapMetadataForm.prototype.validate=function(){var a=!0;return jQuery.each(this.formSchema,jQuery.proxy(function(b,c){var d=jQuery("#"+this.prefix+"-"+c.field),e=d.closest("div.form-group");!1===d[0].checkValidity()?(e.addClass("has-error"),a=!1):e.removeClass("has-error")},this)),a},magic.classes.creator.MapLayerSelector=function(a){this.prefix=a.prefix||"layer-selector",this.layerDataEditor=null,this.layerEdits={}},magic.classes.creator.MapLayerSelector.prototype.defaultData=function(a){return{layers:{type:"json",value:JSON.stringify(magic.modules.GeoUtils.defaultEmbeddedLayers(a))}}},magic.classes.creator.MapLayerSelector.prototype.loadContext=function(a){jQuery("#map-layer-selector").closest("div.row").removeClass("hidden");var b=null,c=jQuery("#"+this.prefix+"-list");a.layers&&"json"==a.layers.type&&a.layers.value&&(b=JSON.parse(a.layers.value));var d=c.find("tbody tr");if(d.length>0&&d.remove(),b&&b.length>0){c.removeClass("hidden");for(var e=0;e<b.length;e++)this.layerMarkup(c,b[e]);sortable(".table-sortable tbody",{handle:"td.layerdata-name",placeholderClass:"fa fa-caret-right"})}else c.addClass("hidden");jQuery("#"+this.prefix+"-layer-add").off("click").on("click",jQuery.proxy(function(a){this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),this.layerDataEditor=new magic.classes.creator.EmbeddedLayerEditorPopup({target:a.currentTarget.id,onSave:jQuery.proxy(this.updateLayerData,this)}),this.layerDataEditor.activate({})},this))},magic.classes.creator.MapLayerSelector.prototype.getContext=function(a){if(a){return{layers:jQuery("#"+this.prefix+"-list").find("tr").map(jQuery.proxy(function(a,b){return this.layerEdits[jQuery(b).data("id")]},this)).get()}}return{}},magic.classes.creator.MapLayerSelector.prototype.validate=function(){return!0},magic.classes.creator.MapLayerSelector.prototype.layerMarkup=function(a,b){var c=magic.modules.Endpoints.getEndpointBy("url",b.wms_source),d=c?c.name:b.wms_source;b.id=b.id||magic.modules.Common.uuid(),this.layerEdits[b.id]=b,a.find("tbody").append('<tr data-id="'+b.id+'"><td class="layerdata-name"><a style="margin-right:5px" href="Javascript:void(0)" data-toggle="tooltip" data-placement="top" title="Click and drag to re-order layer stack"><span class="fa fa-arrows"></span></a>'+b.name+"</td><td>"+d+'</td><td><div class="btn-toolbar" role="toolbar"><div class="btn-group" role="group"><button type="button" class="btn btn-sm btn-warning" id="'+this.prefix+"-"+b.id+'-layer-edit" data-toggle="popover" data-trigger="manual" data-placement="left"><i style="font-size:14px" data-toggle="tooltip" data-placement="top" title="Edit/view selected layer data" class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-danger" id="'+this.prefix+"-"+b.id+'-layer-del"><i data-toggle="tooltip" data-placement="top" title="Delete selected layer" class="fa fa-trash"></i></button></div></div></td></tr>'),jQuery("#"+this.prefix+"-"+b.id+"-layer-edit").off("click").on("click",jQuery.proxy(function(a){var b=a.currentTarget.id.replace(this.prefix+"-","").replace("-layer-edit","");this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),this.layerDataEditor=new magic.classes.creator.EmbeddedLayerEditorPopup({target:a.currentTarget.id,onSave:jQuery.proxy(this.updateLayerData,this)}),this.layerDataEditor.activate(this.layerEdits[b])},this)),jQuery("#"+this.prefix+"-"+b.id+"-layer-del").off("click").on("click",jQuery.proxy(function(a){this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Ok to remove this layer?</div>',jQuery.proxy(function(c){c&&(delete this.layerEdits[b.id],jQuery(a.currentTarget).closest("tr").remove()),bootbox.hideAll()},this))},this))},magic.classes.creator.MapLayerSelector.prototype.updateLayerData=function(a){if(!a.id){a.id=magic.modules.Common.uuid();var b=jQuery("#"+this.prefix+"-list");this.layerMarkup(b,a)}this.layerEdits[a.id]=a,sortable(".table-sortable tbody",{handle:"td.layerdata-name",placeholderClass:"fa fa-caret-right"})},magic.classes.creator.MapParameterSelector=function(a){this.prefix=a.prefix||"map-parameters",this.embedded=a.embedded,this.map=null},magic.classes.creator.MapParameterSelector.prototype.defaultData=function(a){var b=magic.modules.GeoUtils.DEFAULT_MAP_PARAMS[a];return this.embedded?b:{data:b}},magic.classes.creator.MapParameterSelector.prototype.loadContext=function(a){if(jQuery("#"+this.prefix+"-selector").closest("div.row").removeClass("hidden"),!a)return void magic.modules.Common.showAlertModal("No default map parameters supplied","error");this.renderMap(this.embedded?a:a.data)},magic.classes.creator.MapParameterSelector.prototype.showContext=function(){this.map&&this.map.updateSize()},magic.classes.creator.MapParameterSelector.prototype.renderMap=function(a){var b=!1;if(this.map){b=a.projection!=this.map.getView().getProjection().getCode()}if(b||!this.map){this.map=null,jQuery("#"+this.prefix+"-selector-map").children().remove();var c=ol.proj.get(a.projection),d=null,e=parseFloat(a.rotation);e=isNaN(e)?0:Math.PI*e/180,"string"==typeof a.center&&(a.center=JSON.parse(a.center)),"string"==typeof a.proj_extent&&(a.proj_extent=JSON.parse(a.proj_extent)),"string"==typeof a.resolutions&&(a.resolutions=JSON.parse(a.resolutions)),jQuery("#"+this.prefix+"-rotation").val(a.rotation);for(var f,g=[],h=magic.modules.Endpoints.getEndpointsBy("srs",a.projection),i=0;i<h.length;i++)if(h[i].coast_layers){f=h[i];break}if(!f)return void magic.modules.Common.showAlertModal("No endpoint service defined for projection "+a.projection,"error");if("osm"==f.url)g.push(magic.modules.Endpoints.getMidLatitudeCoastLayer()),d=new ol.View({center:a.center,minZoom:1,maxZoom:20,rotation:e,zoom:parseInt(a.zoom),projection:c});else{c.setExtent(a.proj_extent),c.setWorldExtent(a.proj_extent);var j=f.coast_layers.split(",");jQuery.each(j,function(b,d){var e=new ol.source.TileWMS({url:f.url,params:{LAYERS:d,CRS:c.getCode(),SRS:c.getCode(),VERSION:"1.3.0",TILED:!0},tileGrid:new ol.tilegrid.TileGrid({resolutions:a.resolutions,origin:c.getExtent().slice(0,2)}),projection:c});g.push(new ol.layer.Tile({visible:!0,opacity:1,source:e}))});var k=[new ol.control.ZoomSlider,new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-top",units:"metric"}),new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-bottom",units:"imperial"}),new ol.control.MousePosition({projection:"EPSG:4326",className:"custom-mouse-position",coordinateFormat:function(a){return"Lon : "+a[0].toFixed(2)+", lat : "+a[1].toFixed(2)}})],l=null,m=f.graticule_layer;if(m){var n=new ol.source.ImageWMS({url:f.url,params:{LAYERS:m},projection:c});g.push(new ol.layer.Image({visible:!0,opacity:1,source:n}))}d=new ol.View({center:a.center,maxResolution:a.resolutions[0],resolutions:a.resolutions,rotation:e,zoom:parseInt(a.zoom),projection:c})}this.map=new ol.Map({renderer:"canvas",loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0,layers:g,controls:k,interactions:ol.interaction.defaults(),view:d,target:this.prefix+"-selector-map"}),null!=l&&l.setMap(this.map)}jQuery("#"+this.prefix+"-rotation-set").off("click").on("click",jQuery.proxy(function(a){var b=jQuery("#"+this.prefix+"-rotation").val();if(!isNaN(b)&&this.map){var c=Math.PI*b/180;this.map.getView().setRotation(c)}},this))},magic.classes.creator.MapParameterSelector.prototype.getContext=function(){var a=this.map.getView(),b=parseFloat(jQuery("#"+this.prefix+"-rotation").val()),c={center:a.getCenter(),zoom:parseInt(a.getZoom()),projection:a.getProjection().getCode(),proj_extent:a.getProjection().getExtent(),resolutions:a.getResolutions(),rotation:isNaN(b)?0:b};return this.embedded?c:{data:c}},magic.classes.creator.MapParameterSelector.prototype.validate=function(){return!0},magic.classes.creator.EmbeddedAppContainer=function(){this.dialogs={metadataForm:new magic.classes.creator.MapMetadataForm({formSchema:[{field:"id",default:""},{field:"name",default:"new_map"},{field:"title",default:""},{field:"description",default:""},{field:"owner_email",default:""},{field:"allowed_usage",default:"public"},{field:"allowed_edit",default:"login"}]}),mapLayerSelector:new magic.classes.creator.MapLayerSelector({}),mapParameterSelector:new magic.classes.creator.MapParameterSelector({embedded:!0})},this.regionSelector=new magic.classes.creator.MapRegionSelector({contextLoader:jQuery.proxy(this.loadContext,this),mapTitleService:magic.config.paths.baseurl+"/embedded_maps/dropdown",mapDataService:magic.config.paths.baseurl+"/embedded_maps/name"}),jQuery('[data-toggle="tooltip"]').tooltip({trigger:"hover"}),jQuery("body").tooltip({selector:'[data-toggle="tooltip"]',trigger:"hover"})},magic.classes.creator.EmbeddedAppContainer.prototype.loadContext=function(a,b){if(!a){if(!b)return void magic.modules.Common.showAlertModal("No map context or region data supplied - aborting","error");a={},jQuery.each(this.dialogs,jQuery.proxy(function(c,d){a=jQuery.extend(!0,a,d.defaultData(b))},this))}magic.runtime.projection=a.projection,jQuery.each(this.dialogs,jQuery.proxy(function(b,c){c.loadContext(a)},this));var c=jQuery("#map-save-context");c.closest("div.row").removeClass("hidden"),c.off("click").on("click",jQuery.proxy(this.saveContext,this)),jQuery("#map-delete").off("click").on("click",jQuery.proxy(function(){this.deleteMap(a.id)},this))},magic.classes.creator.EmbeddedAppContainer.prototype.saveContext=function(){var a=!0;if(jQuery.each(this.dialogs,jQuery.proxy(function(b,c){a=a&&c.validate()},this)),a){var b={};jQuery.each(this.dialogs,jQuery.proxy(function(a,c){jQuery.extend(!0,b,c.getContext(!0))},this)),this.modifyMapExtentByDataLayers(b,jQuery.proxy(function(a){jQuery.getJSON("https://cdn.web.bas.ac.uk/magic/json-schemas/embedded_web_map_schema.json",jQuery.proxy(function(b){if(tv4.validate(a,b)){var c=a.id,d=JSON.stringify(a);jQuery.ajax({url:magic.config.paths.baseurl+"/embedded_maps/"+(""!=c?"update/"+c:"save"),method:"POST",processData:!1,data:d,headers:{"Content-Type":"application/json"},beforeSend:function(a){a.setRequestHeader(jQuery("meta[name='_csrf_header']").attr("content"),jQuery("meta[name='_csrf']").attr("content"))}}).done(function(b){magic.runtime.serviceUrl=magic.config.paths.baseurl+"/embedded_maps/name/"+a.name,window.open(magic.config.paths.baseurl+"/static/html/test_embed.html")}).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to save your map - details : "+b,"warning")})}else{var e=JSON.stringify(tv4.error,null,4);magic.modules.Common.showAlertModal("Failed to validate your map data against the web map schema<br/><br/>Detailed explanation of the failure below:<br/><br/>"+e,"error")}},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to retrieve JSON schema for embedded map - details : "+b,"warning")})},this))}else magic.modules.Common.showAlertModal("Please correct the marked fields before resubmitting","warning")},magic.classes.creator.EmbeddedAppContainer.prototype.modifyMapExtentByDataLayers=function(a,b){var c=[],d=[];jQuery.each(a.layers,jQuery.proxy(function(b,e){if(!0===e.is_extent&&e.feature_name){var f=magic.config.paths.baseurl+"/gs/extent/"+e.feature_name,g=magic.modules.Endpoints.getEndpointBy("url",e.wms_source);null!=g&&(f=f+"/"+g.id),d.push(jQuery.getJSON(f,jQuery.proxy(function(b){jQuery.isArray(b)&&4==b.length&&c.push(magic.modules.GeoUtils.extentFromWgs84Extent(b,a.projection))},this)))}},this)),d.length>0?jQuery.when.apply(jQuery,d).always(jQuery.proxy(function(){jQuery.extend(!0,a,{data_extent:magic.modules.GeoUtils.uniteExtents(c)}),jQuery.isFunction(b)&&b(a)},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to calculate embedded map extent from data layers - details : "+b,"warning")}):jQuery.isFunction(b)&&(delete a.data_extent,b(a))},magic.classes.creator.EmbeddedAppContainer.prototype.deleteMap=function(a){bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete this map?</div>',jQuery.proxy(function(b){b?(jQuery.ajax({url:magic.config.paths.baseurl+"/embedded_maps/delete/"+a,method:"DELETE",beforeSend:function(a){a.setRequestHeader(jQuery("meta[name='_csrf_header']").attr("content"),jQuery("meta[name='_csrf']").attr("content"))}}).done(function(){window.location=magic.config.paths.baseurl+"/embedded_creatord"}).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to delete user map view - details : "+b,"warning")}),bootbox.hideAll()):bootbox.hideAll()},this))};