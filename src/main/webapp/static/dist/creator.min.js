var magic={config:{paths:{baseurl:window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}},modules:{creator:{}},classes:{creator:{}},runtime:{creator:{catalogues:{}},capabilities:{},filters:{},pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")},preferences:{coordinate:"dd",elevation:"m",date:"Y-m-d"}}};setInterval("magic.runtime.pingSession()",3e6),magic.classes.PopupForm=function(a){this.id=a.id,this.target=jQuery("#"+a.target),this.caption=a.caption||"Popup edit form",this.popoverClass=a.popoverClass||"",this.popoverContentClass=a.popoverContentClass||"",this.prePopulator=a.prePopulator||{},this.subForms={},this.active=!1,this.controlCallbacks={onActivate:jQuery.proxy(function(a){this.prePopulator=a,this.target.popover("show")},this),onDeactivate:jQuery.proxy(function(a){!a&&this.formDirty()?bootbox.confirm({message:"Unsaved edits - save before closing?",buttons:{confirm:{label:"Yes",className:"btn-success"},cancel:{label:"No",className:"btn-danger"}},callback:jQuery.proxy(function(a){a?jQuery.isFunction(this.saveForm)&&(jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(a,b){jQuery.isFunction(b.saveForm)&&b.saveForm()}),this.saveForm()):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)}):(this.savedState={},this.cleanForm(),this.tidyUp(),this.target.popover("hide"))},this)},this.formEdited=!1,this.clearState(),this.template='<div class="popover popover-auto-width'+(this.popoverClass?" "+this.popoverClass:"")+'" role="popover"><div class="arrow"></div><h3 class="popover-title">'+this.caption+'</h3><div class="popover-content'+(this.popoverContentClass?" "+this.popoverContentClass:"")+'"></div></div>'},magic.classes.PopupForm.prototype.getFormValue=function(){return this.savedState},magic.classes.PopupForm.prototype.getTarget=function(){return this.target},magic.classes.PopupForm.prototype.getTemplate=function(){return this.template},magic.classes.PopupForm.prototype.getCaption=function(){return this.caption},magic.classes.PopupForm.prototype.setCaption=function(a){this.caption=a},magic.classes.PopupForm.prototype.isActive=function(){return this.active},magic.classes.PopupForm.prototype.titleMarkup=function(){return"<span><big><strong>"+this.caption+'</strong></big><button type="button" class="close dialog-deactivate" style="margin-left:5px">&times;</button></span>'},magic.classes.PopupForm.prototype.setCallbacks=function(a){this.controlCallbacks=a},magic.classes.PopupForm.prototype.assignCloseButtonHandler=function(){jQuery("."+this.popoverClass).find("button.dialog-deactivate").off("click").on("click",jQuery.proxy(function(){this.deactivate(!1)},this))},magic.classes.PopupForm.prototype.activate=function(a){this.active=!0,jQuery.isFunction(this.controlCallbacks.onActivate)&&this.controlCallbacks.onActivate(a)},magic.classes.PopupForm.prototype.deactivate=function(a){this.active=!1,jQuery.isFunction(this.controlCallbacks.onDeactivate)&&this.controlCallbacks.onDeactivate(a)},magic.classes.PopupForm.prototype.delayedDeactivate=function(a){setTimeout(jQuery.proxy(function(){this.deactivate(!0)},this),a)},magic.classes.PopupForm.prototype.clearState=function(){this.savedState={}},magic.classes.PopupForm.prototype.formDirty=function(){return this.formEdited},magic.classes.PopupForm.prototype.cleanForm=function(){this.formEdited=!1},magic.classes.PopupForm.prototype.tidyUp=function(a){jQuery.isEmptyObject(this.subForms)||jQuery.each(this.subForms,function(b,c){null!=c&&jQuery.isFunction(c.deactivate)&&c.deactivate(a)})},magic.modules.Common=function(){return{inches_per_unit:{ins:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36,nmi:1852*39.37},default_styles:{Point:{image:"circle",radius:5,fill:"rgba(255,255,0,0.5)",stroke:"#ff0",width:1},LineString:{stroke:"#f00",width:3},Polygon:{fill:"rgba(0,255,255,0.5)",stroke:"#0ff",width:1},MultiPoint:{image:"circle",radius:5,fill:"rgba(255,0,255,0.5)",stroke:"#f0f",width:1},MultiLineString:{stroke:"#0f0",width:3},MultiPolygon:{fill:"rgba(0,0,255,0.5)",stroke:"#00f",width:1}},color_palette:["#FF6403","#800000","#DD0907","#F20884","#4700A5","#0000D3","#02ABEA","#1FB714","#006412","#562C05","#90713A","#808080","#404040","#000000"],rgbToDec:function(rgb,opacity){rgb=rgb||"#000000",opacity=jQuery.isNumeric(opacity)?opacity:1,rgb=eval("0x"+rgb.replace(/#/,""));var components={r:(16711680&rgb)>>16,g:(65280&rgb)>>8,b:255&rgb};return"rgba("+components.r+","+components.g+","+components.b+","+opacity+")"},scrollViewportToElement:function(a){var b=a.getBoundingClientRect();b.bottom>window.innerHeight&&a.scrollIntoView(!1),b.top<0&&a.scrollIntoView()},buttonFeedbackSet:function(a,b,c,d,e){return c||(c="sm"),d||(d="Save"),'<div class="btn-toolbar col-'+c+'-12" role="toolbar" style="margin-bottom:10px"><div class="btn-group btn-group-'+c+'"><button id="'+a+'-go" class="btn btn-'+c+' btn-primary" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="'+b+'"><span class="fa fa-floppy-o"></span> '+d+'</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-ok" class="btn btn-'+c+' btn-success" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Ok"><span class="fa fa-check post-ok"></span> Ok</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-error" class="btn btn-'+c+' btn-danger" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Error"><span class="fa fa-times post-error"></span> Error</button></div>'+(!0===e?'<div class="btn-group btn-group-'+c+'"><button id="'+a+'-cancel" class="btn btn-'+c+' btn-danger" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="Cancel"><span class="fa fa-times-circle"></span> Cancel</button></div>':"")+"</div>"},buttonClickFeedback:function(a,b,c){var d,e=jQuery("#"+a+"-go"),f=jQuery("#"+a+"-fb-ok"),g=jQuery("#"+a+"-fb-error");e.hide(),b?(f.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return f.fadeIn(300).delay(1200).fadeOut(300)}):(g.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return g.fadeIn(600).delay(6e3).fadeOut(600)}),jQuery.when(d()).done(function(){e.show()})},fetchStyle:function(a,b,c){var d=this.default_styles[a];if(d){var e={};return a.toLowerCase().indexOf("point")>=0?e.image=this.getPointImageStyle(b):a.toLowerCase().indexOf("linestring")>=0?e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1}):(e.fill=new ol.style.Fill({color:this.rgbToDec(this.color_palette[b],.5)}),e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1})),c&&(e.text=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:c,textAlign:"left",fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[b])}),stroke:new ol.style.Stroke({color:"#ffffff",width:1})})),[new ol.style.Style(e)]}return null},getPointImageStyle:function(a){var b=a%4;return 0==b?new ol.style.Circle({fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),radius:5,stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):1==b?new ol.style.RegularShape({rotation:0,points:5,radius1:7,radius2:2,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):2==b?new ol.style.RegularShape({points:4,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):3==b?new ol.style.RegularShape({points:3,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):void 0},labelVisibility:function(a,b,c,d){if(!a.get("_ignoreHovers")){var e=null;if(a.getStyleFunction())e=jQuery.proxy(a.getStyleFunction(),a)()[0];else if(a.getStyle())e=a.getStyle();else if(jQuery.isFunction(b.getStyleFunction)&&b.getStyleFunction()){var f=b.getStyleFunction()(a,0);e=jQuery.isArray(f)?f[0]:f}else jQuery.isFunction(b.getStyle)&&b.getStyle()&&(e=b.getStyle());if(e&&e.getText()){var g=e.clone(),h=g.getText();if(h&&h.getText()){var i=h.getText();c?h.setText(i+(d>1?" (+"+(d-1)+")":"")):h.setText(i.replace(/\s+\(\+\d+\)$/,""));var j=h.getStroke(),k=j.getColor();jQuery.isArray(k)?(k[3]=c?"1.0":"0.0",j.setColor(k)):j.setColor(k.substring(0,k.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")");var l=h.getFill(),m=l.getColor();jQuery.isArray(m)?(m[3]=c?"1.0":"0.0",l.setColor(m)):l.setColor(m.substring(0,m.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")"),a.setStyle(g),a.changed()}}}},proxyUrl:function(a){var b=a;return 0!=a.indexOf(window.location.protocol+"//"+window.location.hostname)&&(b=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(a)),b},getWxsRequestUrl:function(a,b,c){var d="";switch(b.toLowerCase()){case"getcapabilities":d=magic.modules.Endpoints.getOgcEndpoint(a,"wms")+(-1!=a.indexOf("?")?"&":"?")+"request=GetCapabilities&service=wms";break;case"describefeaturetype":d=magic.modules.Endpoints.getOgcEndpoint(a,"wfs")+"?version=1.0.0&request=DescribeFeatureType&typename="+c}return d},getCapabilities:function(a,b,c){if(magic.runtime.map_context.capabilities[a])b(magic.runtime.map_context.capabilities[a],c);else{var d=new ol.format.WMSCapabilities;jQuery.get(this.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(e){try{var f=jQuery.parseJSON(JSON.stringify(d.read(e)));if(f){var g=null;if("Capability"in f&&"Layer"in f.Capability&&"Layer"in f.Capability.Layer&&jQuery.isArray(f.Capability.Layer.Layer)){var h=f.Capability.Layer.Layer;g={},this.getFeatureTypes(g,h)}null!=g?(magic.runtime.map_context.capabilities[a]=g,b(magic.runtime.map_context.capabilities[a],c)):b(null,c,"No feature types found in GetCapabilities response from "+a)}else b(null,c,"Malformed GetCapabilities response from "+a)}catch(d){b(null,c,"Parsing GetCapabilities response from "+a+" failed with error "+d.message)}},this)).fail(function(d,e,f){var g="Failed to WMS GetCapabilities document from "+a+", error was : "+f;401==e&&(g="Not authorised to retrieve WMS GetCapabilities document from "+a),b(null,c,g)})}},defaultMouseover:function(a){var b=0,c=!1,d=null;return a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(a,e){if(null!=e&&!0!==a.get("_ignoreHovers"))return!0===a.get("_customHover")?(d=null,c=!0):0==b&&(d={feature:a,layer:e}),b++,c},this)),!c&&b>0&&this.labelVisibility(d.feature,d.layer,!0,b),jQuery("#"+a.map.getTarget()).css("cursor",d?"pointer":"help"),d},defaultMouseout:function(a){a&&a.feature&&!0!==a.feature.get("_customHover")&&this.labelVisibility(a.feature,a.layer,!1,1)},featuresAtPixel:function(a){var b=[];return a.map.forEachFeatureAtPixel(a.pixel,function(a,c){if(null!=c){var d=a.get("features");if(d&&jQuery.isArray(d))jQuery.each(d,function(a,d){if(!d.get("ignoreClicks")&&d.getGeometry()){var e=d.getProperties();b.push(jQuery.extend({},e,{layer:c}))}});else if(!a.get("_ignoreClicks")&&a.getGeometry()){var e=a.getProperties();b.push(jQuery.extend({},e,{layer:c}))}}},{layerFilter:function(a){return a.getVisible()&&a.get("metadata")&&!0===a.get("metadata").is_interactive}},this),b},getFeatureTypes:function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a[c.Name]=c:"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatureTypes(a,c.Layer)},this))},populateSelect:function(a,b,c,d,e,f){var g=null;a.find("option").remove(),!0===f&&a.append(jQuery("<option>",{value:"",selected:""==e?" selected":"",text:"Please select"})),b.sort(function(a,b){var e=a[d]?a[d].toLowerCase():a[c].toLowerCase(),f=b[d]?b[d].toLowerCase():b[c].toLowerCase();return e<f?-1:e>f?1:0}),jQuery.each(b,function(b,f){var h=jQuery("<option>",{value:f[c]}),i=f[d]||f[c];h.text(i),a.append(h),e&&f[c]==e&&(g=h)}),null!=g&&g.prop("selected","selected")},jsonToForm:function(a,b,c){jQuery.each(a,function(a,d){var e=d.field,f=d.default,g=jQuery("#"+c+"-"+e),h="object"==typeof b[e]?JSON.stringify(b[e]):b[e];"checkbox"==g.attr("type")||"radio"==g.attr("type")?g.prop("checked",b&&e in b?!0===h:f):"url"==g.attr("type")?g.val(b?e in b?h:"":f):g.val(b&&e in b?h:f)})},formToJson:function(a,b){var c={};return jQuery.each(a,function(a,d){var e=d.field,f=jQuery("#"+b+"-"+e);switch(f.attr("type")){case"checkbox":case"radio":c[e]=!!f.prop("checked");break;default:var g=f.val();"number"==f.attr("type")&&jQuery.isNumeric(g)&&(g=Math.floor(g)==g?parseInt(g):parseFloat(g)),f.attr("required")&&""==g?c[e]=d.default:c[e]=g}}),c},flagInputError:function(a){var b=a.closest("div.form-group");b&&b.addClass("has-error")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'"><p>A problem occurred - more details below:</p><p>'+a+"</p></div>")},resetFormIndicators:function(){jQuery("div.form-group").removeClass("has-error")},getScript:function(a,b){jQuery.ajax({type:"GET",url:a,success:b,dataType:"script",cache:!0})},csvToArray:function(a){var b,c="",d=[""],e=[d],f=0,g=0,h=!0;for(b in a)b=a[b],'"'===b?(h&&b===c&&(d[f]+=b),h=!h):","===b&&h?b=d[++f]="":"\n"===b&&h?("\r"===c&&(d[f]=d[f].slice(0,-1)),d=e[++g]=[b=""],f=0):d[f]+=b,c=b;return e},sortedUniqueArray:function(a){var b=[];if(!a||0==a.length)return b;var c={};return b=jQuery.map(a,function(a){return a in c?null:(c[a]=1,a)}),b.sort(),b},isUrl:function(a){if("string"==typeof a){var b=/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;return a.match(b)}return!1},isNameLike:function(a){a=a.toLowerCase();for(var b=["^name.*$","^callsign$","^[^n]*name$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLongitudeLike:function(a){a=a.toLowerCase();for(var b=["^lon.*$","^x$","^xcoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLatitudeLike:function(a){a=a.toLowerCase();for(var b=["^lat.*$","^y$","^ycoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isDatetimeLike:function(a){a=a.toLowerCase();for(var b=["^date.*$","^time.*$","^utc$","^[^u]*update.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},dateFormat:function(a,b){var c=a,d=new Date(a);if(-1==a.toLowerCase().indexOf("invalid")){var e=d.getDate();e=(e<10?"0":"")+e;var f=d.getMonth()+1;f=(f<10?"0":"")+f;var g=d.getFullYear();c="dmy"==b?e+"-"+f+"-"+g:g+"-"+f+"-"+e}return c},fileSize:function(a){var b=Math.log(a)/Math.log(1024)|0;return(a/Math.pow(1024,b)).toFixed(2)+" "+(0==b?"bytes":"kMGTPEZY"[b-1]+"B")},JsonEscape:function(a){var b=a.replace(/\&/g,"&amp;");return b=b.replace(/\"/g,"&quot;")},JsonUnescape:function(a){var b=a.replace(/\&quot;/g,'"');return b=b.replace(/\&amp;/g,"&")},linkify:function(a,b){if(!a)return"";if("string"==typeof a){if(-1!=a.indexOf("<a"))return a;if(a.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>';if(a.match(/^https?:\/\//)&&a.indexOf("?")>0){if(a.substring(0,a.indexOf("?")).match(/\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>'}var c=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,d=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/\w+@[a-zA-Z_]+?(?:\.[a-zA-Z]{2,6})+/gim;return b?a.replace(c,'<a href="$&" title="$&" target="_blank">'+b+"</a>").replace(d,'$1<a href="http://$2" target="_blank">'+b+"</a>").replace(e,'<a href="mailto:$&">'+b+"</a>"):a.replace(c,'<a href="$&" title="$&" target="_blank">[external resource]</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$&">$&</a>')}return a},chunk:function(a,b){return void 0===b&&(b=2),a.match(RegExp(".{1,"+b+"}","g")).join("<br>")},ellipsis:function(a,b){if(a.length<=b)return a;var c=a.substr(0,b),d=c.lastIndexOf(" ");return c=-1==d||d<b/2?c.substr(0,b-3)+"...":c.substr(0,d)+"..."},stringDivider:function(a,b,c){if(a.length>b){for(var d=b;d>0&&" "!=a[d]&&"-"!=a[d];d--);if(d>0){var e;e="-"==a.substring(d,d+1)?a.substring(0,d+1):a.substring(0,d);var f=a.substring(d+1);return e+c+stringDivider(f,b,c)}}return a},objectLength:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},initCap:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},unitConverter:function(a,b,c,d){d=d||1;var e=0,f=b,g=c;return f in this.inches_per_unit&&g in this.inches_per_unit&&(1==d||2==d)&&(e=a*Math.pow(this.inches_per_unit[f]/this.inches_per_unit[g],d),e=e.toFixed(3)+" "+g+(2==d?"<sup>2</sup>":"")),e},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},toRadians:function(a){return a*Math.PI/180},toDegrees:function(a){return 180*a/Math.PI},floatsEqual:function(a,b,c){return Math.abs(a-b)<=c},floatInRange:function(a,b,c,d){return(a>b||Math.abs(a-b)<=d)&&(a<c||Math.abs(a-c)<=d)}}}(),magic.modules.Endpoints=function(){return{parseUri:function(a){for(var b={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},c=b.parser[b.strictMode?"strict":"loose"].exec(a),d={},e=14;e--;)d[b.key[e]]=c[e]||"";return d[b.q.name]={},d[b.key[12]].replace(b.q.parser,function(a,c,e){c&&(d[b.q.name][c]=e)}),d},getVirtualService:function(a){var b="",c=/\/geoserver\/([^\/]+)\/wms/,d=c.exec(a);return null!=d&&(b=d[1]),b},getWmsProxiedUrl:function(a){var b=this.getEndpointBy("url",a);return b&&b.proxied_url?b.proxied_url:null},getWmsServiceUrl:function(a){var b=this.getEndpointBy("name",a);return b?b.url:null},getOgcEndpoint:function(a,b){var c=a,d=this.getEndpointsBy("url",a);return jQuery.isArray(d)&&d.length>0?c=!0===d[0].is_user_service?magic.config.paths.baseurl+"/ogc/user/"+b:magic.config.paths.baseurl+"/ogc/"+d[0].id+"/"+b:(console.log(a+" does not correspond to a known endpoint - need to proxy"),c=magic.modules.Common.proxyUrl(a)),c},getEndpointBy:function(a,b){var c=this.getEndpointsBy(a,b);return c.length>0?c[0]:null},getUserDataEndpoint:function(){if(!magic.runtime.endpoints)return null;var a=jQuery.grep(magic.runtime.endpoints,function(a){return!0===a.is_user_service});return 0==a.length?null:a[0]},getEndpointsBy:function(a,b){if(!magic.runtime.endpoints||!a||!b)return null;var c=null;return"url"==a&&(c=this.parseUri(b)),jQuery.grep(magic.runtime.endpoints,jQuery.proxy(function(d){if("id"==a)return d[a]==b;if("url"==a){var e=this.compareEndpoints(c,this.parseUri(d[a]));if(!e&&d.url_aliases)for(var f=d.url_aliases.split(","),g=0;!e&&g<f.length;g++)e=this.compareEndpoints(c,this.parseUri(f[g]));return e}if("srs"==a){return d[a].toLowerCase().split(",").indexOf(b.toLowerCase())>=0}return 0==d[a].toLowerCase().indexOf(b.toLowerCase())},this))},compareEndpoints:function(a,b){var c=a.protocol==b.protocol&&a.host==b.host&&a.port==a.port;if(c&&""!=a.path&&""!=b.path){var d=a.path;d.indexOf("/")>=0&&(d=d.substring(0,d.indexOf("/")));var e=b.path;e.indexOf("/")>=0&&(e=e.substring(0,e.indexOf("/"))),c=d==e}return c},getMidLatitudeCoastLayer:function(){var a=null,b=this.getEndpointBy("name","midlatitude");if(null!=b&&"osm"!=b.url){var c=null;-1!=b.coast_layers.indexOf(":")&&(c=b.coast_layers.split(":").shift()),a=new ol.layer.Tile({source:new ol.source.TileWMS({url:b.url,params:{LAYERS:b.coast_layers,CRS:"EPSG:3857",SRS:"EPSG:3857",VERSION:"1.3.0",WORKSPACE:c},projection:"EPSG:3857"})})}else a=new ol.layer.Tile({source:new ol.source.OSM({wrapX:!1})});return a},getMidLatitudeCoastSource:function(a){var b=this.getEndpointBy("name","midlatitude"),c={wms_source:b&&"osm"!=b.url?b.url:"osm",feature_name:b&&"osm"!=b.url?b.coast_layers:"osm",is_base:!0};return jQuery.extend({id:null,name:"Mid-latitude data",is_visible:!0},a?c:{source:c})}}}(),magic.modules.GeoUtils=function(){return{ANGULAR_TOLERANCE:.001,N_INTERP:5,WGS84:new ol.Sphere(6378137),DISTANCE_UNITS:[["km","kilometres"],["m","metres"],["mi","statute miles"],["nmi","nautical miles"]],AREA_UNITS:[["km","square kilometres"],["m","square metres"],["mi","square miles"],["nmi","square nautical miles"]],ELEVATION_UNITS:[["m","metres"],["ft","feet"]],COORDINATE_FORMATS:[["dd","decimal degrees"],["dms","degrees, minutes and seconds"],["ddm","degrees, decimal minutes"]],DEFAULT_GEO_PREFS:{distance:"km",area:"km",elevation:"m",coordinates:"dd"},DEFAULT_MAP_PARAMS:{antarctic:{projection:"EPSG:3031",proj_extent:[-5e6,-5e6,5e6,5e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140,56,28,14,5.6,2.8,1.4,.56]},antarctic_laea:{projection:"EPSG:102020",proj_extent:[-55e5,-55e5,55e5,55e5],center:[0,0],zoom:0,rotation:0,resolutions:[14e3,7e3,2800,1400,560,280,140]},arctic:{projection:"EPSG:3995",proj_extent:[-4e6,-4e6,4e6,4e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140]},southgeorgia:{projection:"EPSG:3762",proj_extent:[-929362.849,-1243855.108,1349814.294,556833.528],center:[-1e3,61900],zoom:4,rotation:0,resolutions:[3360,1680,840,420,210,105,42,21,10.5,4.2,2.1,1.12,.56,.28,.14]},midlatitudes:{projection:"EPSG:3857",proj_extent:[-20026376.39,-20048966.1,20026376.39,20048966.1],center:[0,0],zoom:0,rotation:0,resolutions:[]}},defaultEmbeddedLayers:function(a){return this.getBaseLayers(a,!0).concat(this.getTopoLayers(a,!0))},defaultLayers:function(a){return"antarctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic",!1)}]:"antarctic_laea"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic_laea",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic_laea",!1)}]:"arctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("arctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("arctic",!1)}]:"southgeorgia"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("southgeorgia",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("southgeorgia",!1)}]:"midlatitudes"==a?[{id:null,name:"OpenStreetMap",expanded:!0,layers:this.getBaseLayers("midlatitudes",!1)}]:[]},getBaseLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_hillshade_and_bathymetry",is_base:!0},b)]:"antarctic_laea"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:hillshade_and_bathymetry",is_base:!0},b)]:"arctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"southgeorgia"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"midlatitudes"==a?[magic.modules.Endpoints.getMidLatitudeCoastSource(b)]:[]},getTopoLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_coastline"},b),this.layerSpecification("Sub-Antarctic coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:sub_antarctic_coastline"},b)]:"antarctic_laea"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:coastline"},b)]:"arctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_coastline"},b)]:"southgeorgia"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_coastline"},b),this.layerSpecification("Surface",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_surface"},b)]:[]},layerSpecification:function(a,b,c){return jQuery.extend({id:null,name:a,is_visible:!0},c?b:{source:b})},headingFromTrackGeometry:function(a){var b=0,c=a.getCoordinates();if(jQuery.isArray(c)&&c.length>=2){var d=c[c.length-2],e=c[c.length-1],f=new Vector(e[0]-d[0],e[1]-d[1]),g=new Vector(0,1);b=Math.acos(f.unit().dot(g))}return b},getGeometryType:function(a){var b="point";return a instanceof ol.geom.LineString||a instanceof ol.geom.MultiLineString?b="line":a instanceof ol.geom.Polygon||a instanceof ol.geom.MultiPolygon?b="polygon":a instanceof ol.geom.GeometryCollection&&(b="collection"),b},formatCoordinate:function(a,b,c,d){var e=null;if(d||0==d||(d=4),this.validCoordinate(a,"lat"==c,!1)){var f=this.toDecDegrees(a);if(isNaN(f))e=a;else switch(f=parseFloat(f.toFixed(d)),b){case"dms":e=this.toDMS(f,c,"dms");break;case"ddm":e=this.toDDM(f,c);break;default:e=f}}else e=a;return e},toDMS:function(a,b){var c="";if("lon"==b){var d=[a,.1],e=ol.coordinate.toStringHDMS(d),f="N";c=e.substring(e.indexOf(f)+2)}else{var d=[0,a],e=ol.coordinate.toStringHDMS(d),f=a<0?"S":"N";c=e.substring(0,e.indexOf(f)+1)}return c},toDDM:function(a,b){var c="",d=this.toDMS(a,b),e=d.split(/[^A-Za-z0-9.]+/);if(4==e.length){var f=parseFloat(e[1])+parseFloat(e[2]/60);c=e[3]+e[0]+" "+f.toFixed(3)}return c},toDecDegrees:function(a){var b=a;if(!jQuery.isNumeric(a)){b=Number.NaN,a=a.trim().toUpperCase();var c="X",d=0,e=0,f=0,g=a.charAt(0),h=a.charAt(a.length-1);if("N"==g||"S"==g||"E"==g||"W"==g?(c=g,a=a.substring(1)):"N"!=h&&"S"!=h&&"E"!=h&&"W"!=h||(c=h,a=a.substring(0,a.length-1)),"X"!=c){a=a.replace(/[^0-9.]{1,}/g," "),a=a.trim();var i=a.split(" ");d=parseFloat(i[0]),i.length>1&&(e=parseFloat(i[1])),i.length>2&&(f=parseFloat(i[2])),b=(d+e/60+f/3600)*("S"==c||"W"==c?-1:1)}}return isNaN(b)?Number.NaN:parseFloat(b)},validCoordinate:function(a,b,c){var d=!1;if(!a&&c)d=!0;else{var e=b?-90:-180,f=b?90:180,g=this.toDecDegrees(a);isNaN(g)||(d=magic.modules.Common.floatInRange(g,e,f,1e-8))}return d},validHemisphere:function(a){return 1==a.length&&a.match(/N|E|S|W|n|e|s|w/)},formatSpatial:function(a,b,c,d,e){if(!jQuery.isNumeric)return"";e||0==e||(e=1);var f=a;if(d!=c){var g={m:1,ft:3.2808399,km:.001,mi:.000621371192,nm:.000539956803};if(a=parseFloat(a),"m"!=d)for(var h=0;h<b;h++)a*=1/g[d];if("m"!=c)for(var h=0;h<b;h++)a*=g[c];f=a.toFixed(e)+c}else f+=c;return f},formatBbox:function(a,b){if(!a)return"";b||0==b||(b=1);var c=jQuery.map(a,function(a){return a}),d=["minx","miny","maxx","maxy"],e=[];return jQuery.each(c,function(a,c){e.push(d[a]+" : "+parseFloat(c).toFixed(b))}),e.join("<br>")},bufferExtent:function(a,b){var c=a.slice(0);b=b||1e4;var d=[.5*(a[2]-a[0]),.5*(a[3]-a[1])];return a[2]-a[0]<b&&(c[0]=d[0]-.5*b,c[2]=d[0]+.5*b),a[3]-a[1]<b&&(c[1]=d[1]-.5*b,c[3]=d[1]+.5*b),c},formatProjection:function(a){var b=a.split(":").pop();return!isNaN(parseInt(b))&&(b<32768||102020==b)?'<a href="https://epsg.io/?q='+b+'" target="_blank">'+a+"</a>":a},applyPref:function(a,b,c,d,e){var f=b;switch(c||"coordinates"!=a||(c="lon"),d||(d=magic.runtime.preferences[a]),e||"distance"!=a&&"area"!=a&&"elevation"!=a||(e="m"),a){case"coordinates":f=this.formatCoordinate(b,d,c);break;case"distance":f=this.formatSpatial(b,1,d,e,2);break;case"area":f=this.formatSpatial(b,2,d,e,2);break;case"elevation":f=this.formatSpatial(b,1,d,e,1)}return f},isPolarProjection:function(a){switch(a){case"EPSG:3031":case"EPSG:3995":case"EPSG:102020":return!0;default:return!1}},projectionLatLonExtent:function(a){var b=[];switch(a){case"EPSG:3031":b=[-180,-90,180,-50];break;case"EPSG:3995":b=[-180,60,180,90];break;case"EPSG:3762":b=[-50,-65,-18,-50];break;case"EPSG:102020":b=[-180,-89,180,-30];break;default:b=[-180,-85.06,180,85.06]}return b},withinExtent:function(a,b){return magic.modules.Common.floatInRange(a[0],b[0],b[2],this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatInRange(a[1],b[1],b[3],this.ANGULAR_TOLERANCE)},alongDateline:function(a,b){return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&(magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)||magic.modules.Common.floatsEqual(a,180,this.ANGULAR_TOLERANCE))},crossesDateline:function(a,b){return a>0&&b<0&&!magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)},atPole:function(a,b,c){var d=c?"S"==c?-90:90:-90;return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(a,d,this.ANGULAR_TOLERANCE)},isCircumpolar:function(a,b){return magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(b,180,this.ANGULAR_TOLERANCE)},geodesicLength:function(a,b){b=b||magic.runtime.map;for(var c=0,d=a.getCoordinates(),e=0,f=d.length-1;e<f;++e){var g=ol.proj.transform(d[e],b.getView().getProjection().getCode(),"EPSG:4326"),h=ol.proj.transform(d[e+1],b.getView().getProjection().getCode(),"EPSG:4326");c+=this.WGS84.haversineDistance(g,h)}return c},geodesicArea:function(a,b){var c=a.clone().transform(b.getView().getProjection().getCode(),"EPSG:4326");return Math.abs(this.WGS84.geodesicArea(c.getLinearRing[0].getCoordinates()))},uniteExtents:function(a){if(!a||jQuery.isArray(a)&&0==a.length)return null;for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)b=null==b?a[f][0]:Math.min(b,a[f][0]),c=null==c?a[f][1]:Math.min(c,a[f][1]),d=null==d?a[f][2]:Math.max(d,a[f][2]),e=null==e?a[f][3]:Math.max(e,a[f][3]);return[b,c,d,e]},extentFromWgs84Extent:function(a,b){if(!b){if(!magic.runtime.map)return a;b=magic.runtime.map.getView().getProjection().getCode()}var c=[],d=null,e=a[0],f=a[1],g=a[2],h=a[3],i=ol.proj.get("EPSG:4326");if(this.isCircumpolar(e,g)){var j=new ol.geom.Point([0,h]);j.transform(i,b);var k=j.getCoordinates()[1];d=[-k,-k,k,k]}else{this.crossesDateline(e,g)?(c.push([e,f,180,h]),c.push([-180,f,g,h])):c.push([e,f,g,h]);for(var l=0;l<c.length;l++){var m=this.densify(c[l]);m.transform(i,b),null==d?d=m.getExtent():d.extend(m.getExtent())}}return d},densify:function(a){for(var b=[],c=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]],d=0;d<c.length;d++)for(var e=(d+1)%4,f=parseFloat(c[e][0]-c[d][0]),g=parseFloat(c[e][1]-c[d][1]),h=0;h<=this.N_INTERP;h++){var i=parseFloat(h)/parseFloat(this.N_INTERP+1);b.push([parseFloat(c[d][0])+i*f,parseFloat(c[d][1])+i*g])}return new ol.geom.Polygon([b],"XY")},getCurrentMapScale:function(a){a=a||magic.runtime.map;var b=a.getView().getResolution(),c=a.getView().getProjection().getUnits(),d=25.4/.28,e=ol.proj.METERS_PER_UNIT[c],f=b*e*39.37*d;return parseFloat(f)},getResolutionFromScale:function(a,b,c){if(!(b&&c||magic.runtime.map))return 0;b=b||magic.runtime.map.getView().getResolutions(),c=c||magic.runtime.map.getView().getProjection();var d=b[0];if(!isNaN(a)){var e=c.getUnits(),f=25.4/.28,g=ol.proj.METERS_PER_UNIT[e];d=parseFloat(a)/(39.37*g*f)}return d},headingWrtTrueNorth:function(a,b){var c=a.getCoordinates(),d=new Vector(c[0],c[1]),e=new ol.geom.Point([0,1]),f=new Vector(e.x,e.y),g=d.unit().dot(f);return(b-180*Math.acos(g)/Math.PI)%360}}}(),magic.modules.VectorStyles=function(){function a(a){var b=null;return jQuery.each(a,function(a,c){if(magic.modules.Common.isNameLike(a))return b=c,!1}),b}function b(b){return function(){var d=a(this.getProperties()),e=new ol.style.Style({image:new ol.style.Icon({scale:.8,anchor:[.5,1],src:magic.config.paths.cdn+"/images/map-markers/marker_"+b+".png"})});return null!=d&&e.setText(new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,offsetY:-10,text:d,textAlign:"left",fill:new ol.style.Fill({color:magic.modules.Common.rgbToDec(c[b],0)}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})),[e]}}var c={red:"#f20000",orange:"#ff776b",green:"#5af23f",gold:"#ffd700",gray:"#777777"};return{bas_aircraft:function(a){return function(){var b=this.getProperties(),c=b.callsign||"unknown aircraft",d=b.speed||0,e=b.heading||0,f=new Date(b.utc).getTime(),g=(new Date).getTime(),h=parseFloat(g-f)/36e5,i=d>=10&&h<=1?"green":"red",j=!("EPSG:4326"==a||"EPSG:3857"==a),k=j?magic.modules.GeoUtils.headingWrtTrueNorth(this.getGeometry(),e):e;return[new ol.style.Style({image:new ol.style.Icon({rotateWithView:j,rotation:magic.modules.Common.toRadians(k),src:magic.config.paths.cdn+"/images/asset-symbols/airplane_"+i+"_roundel.png"}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:c,textAlign:"left",fill:new ol.style.Fill({color:"red"==i?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},bas_ship:function(a){return function(){var a=this.getProperties(),b=a.callsign||"unknown ship",c=a.speed||0,d=c>0?"green":"red",e=a.heading||0;return[new ol.style.Style({image:new ol.style.Icon({rotateWithView:!0,rotation:e,src:magic.config.paths.cdn+"/images/asset-symbols/ship_"+d+"_roundel.png"}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:b,textAlign:"left",fill:new ol.style.Fill({color:"red"==d?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},comnap_asset:function(){return function(){for(var a=[],b=this.getProperties(),c=b.name||"unknown asset",d=b.speed||0,e=d>0?"green":"red",f=0,g=this.getGeometry().getGeometries(),h=0;h<g.length;h++){var i=magic.modules.GeoUtils.getGeometryType(g[h]);"line"==i&&(f=magic.modules.GeoUtils.headingFromTrackGeometry(g[h]))}var j="unknown";switch(b.type.toLowerCase()){case"ship":j="ship";break;case"aeroplane":j="airplane";break;case"helicopter":j="helicopter"}"unknown asset"!=c&&b.description&&(c=b.description+" ("+c+")");for(var k=magic.config.paths.cdn+"/images/asset-symbols/"+j+"_"+e+"_roundel.png",h=0;h<g.length;h++){var i=magic.modules.GeoUtils.getGeometryType(g[h]);"point"==i?a.push(new ol.style.Style({geometry:g[h],image:new ol.style.Icon({rotateWithView:!0,rotation:f,src:k}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:14,text:c,textAlign:"left",fill:new ol.style.Fill({color:"red"==e?"rgba(229, 0, 0, 0.0)":"rgba(0, 128, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})):a.push(new ol.style.Style({geometry:g[h],fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})}))}return a}},antarctic_facility:function(){return function(){var a=this.getProperties(),b="rgba(255, 0, 0, 0.4)";return a.current_status&&"seasonal"!=a.current_status.toLowerCase()||(b="rgba(255, 255, 255, 0.8)"),[new ol.style.Style({image:new ol.style.Circle({radius:4.5,fill:new ol.style.Fill({color:b}),stroke:new ol.style.Stroke({color:"rgba(255, 0, 0, 1.0)",width:1.5})}),text:new ol.style.Text({font:"Arial",scale:1.2,offsetX:7,text:a.facility_name,textAlign:"left",fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.0)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.0)"})})})]}},red_map_pin:function(){return b("red")},orange_map_pin:function(){return b("orange")},green_map_pin:function(){return b("green")},gold_map_pin:function(){return b("gold")},gray_map_pin:function(){return b("gray")}}}(),magic.classes.creator.DataSourceForm=function(a){this.prefix=a.prefix,this.sourceContext=a.sourceContext,this.region=a.region,this.formSchema=a.formSchema,this.styler=null,this.controlCallbacks={}},magic.classes.creator.DataSourceForm.prototype.loadContext=function(a){a||(a=this.defaultData()),jQuery.isFunction(this.controlCallbacks.onLoadContext)&&this.controlCallbacks.onLoadContext(a)},magic.classes.creator.DataSourceForm.prototype.formToPayload=function(a){return{source:magic.modules.Common.formToJson(this.formSchema,this.prefix)}},magic.classes.creator.DataSourceForm.prototype.setStyleHandlers=function(a){var b=jQuery("#"+this.prefix+"-style-mode"),c=jQuery("#"+this.prefix+"-style-edit"),d=jQuery("div.predefined-style-input");if(b.length>0&&c.length>0){this.styler=new magic.classes.StylerPopup({target:this.prefix+"-style-edit",onSave:jQuery.proxy(this.writeStyle,this)}),b.off("change").on("change",jQuery.proxy(function(a){var b=jQuery(a.currentTarget).val();jQuery("#"+this.prefix+"-style_definition").val('{"mode":"'+b+'"}'),d.length>0&&("predefined"==b?d.removeClass("hidden"):d.addClass("hidden")),c.prop("disabled","predefined"==b||"file"==b||"default"==b)},this)),c.off("click").on("click",jQuery.proxy(function(a){var c=jQuery("#"+this.prefix+"-style_definition").val();c?"string"==typeof c&&(c=JSON.parse(c)):c={mode:b.val()||"default"},this.styler.activate(c)},this)),b.val("default"),c.prop("disabled",!0),a.style_definition=this.styler.convertLegacyFormats(a.style_definition);var e=a.style_definition.mode;b.val(e),c.prop("disabled","predefined"==e||"default"==e||"file"==e)}},magic.classes.creator.DataSourceForm.prototype.defaultData=function(){var a={};return jQuery.each(this.formSchema,jQuery.proxy(function(b,c){a[c.field]=c.default},this)),a},magic.classes.creator.DataSourceForm.prototype.setCallbacks=function(a){this.controlCallbacks=a},magic.classes.creator.DataSourceForm.prototype.deactivateStyler=function(a){this.styler&&this.styler.deactivate(!0)},magic.classes.StylerPopup=function(a){a=jQuery.extend({},{id:"styler-popup-tool",styleMode:"default",caption:"Edit symbology",popoverClass:"styler-popover",popoverContentClass:"styler-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.styleInputs=["mode","graphic_marker","graphic_radius","stroke_width","stroke_color","stroke_opacity","stroke_linestyle","fill_color","fill_opacity"],this.inputDefaults={mode:"point",graphic:{marker:"circle",radius:5},stroke:{width:1,color:"#000000",opacity:1,linestyle:"solid"},fill:{color:"#ffffff",opacity:1}},this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,content:this.markup()}).on("shown.bs.popover",jQuery.proxy(function(a){this.savedState={},this.assignCloseButtonHandler(),this.payloadToForm(this.prePopulator),this.assignHandlers(),this.restoreState()},this))},magic.classes.StylerPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.StylerPopup.prototype.constructor=magic.classes.StylerPopup,magic.classes.StylerPopup.prototype.assignHandlers=function(a){this.formEdited=!1,jQuery("div[id='"+this.id+"-fs'] :input").change(jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").click(jQuery.proxy(function(){this.cleanForm(),jQuery.isFunction(this.controlCallbacks.onSave)&&this.controlCallbacks.onSave(this.formToPayload()),this.deactivate(!0)},this)),jQuery("#"+this.id+"-cancel").click(jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.StylerPopup.prototype.saveForm=function(){jQuery("#"+this.id+"-go").trigger("click")},magic.classes.StylerPopup.prototype.markup=function(){return'<div id="'+this.id+'-fs"><input type="hidden" id="'+this.id+'-mode"></input><div id="'+this.id+'-point-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-graphic_marker">Marker</label><div class="col-sm-8"><select class="form-control" id="'+this.id+'-graphic_marker" data-toggle="tooltip" data-placement="right" title="Choose a marker type"><option value="circle">Circle</option><option value="triangle">Triangle</option><option value="square">Square</option><option value="pentagon">Pentagon</option><option value="hexagon">Hexagon</option><option value="star">Star</option></select></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-graphic_radius">Size</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-graphic_radius" placeholder="Radius of graphic marker in pixels" min="3" max="20" step="0.2" value="5" data-toggle="tooltip" data-placement="right" title="Radius of graphic marker in pixels, default 5"></input></div></div></div><div id="'+this.id+'-line-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_width">Outline width</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-stroke_width" placeholder="Width of outline in pixels" min="0.2" max="20" step="0.2" value="1.0" data-toggle="tooltip" data-placement="right" title="Width of outline in pixels, default 1"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_color">Outline colour</label><div class="col-sm-8"><input type="color" class="form-control" id="'+this.id+'-stroke_color" data-toggle="tooltip" data-placement="right" title="Colour of the graphic outline, default black"</input></div></div><div class="form-group form-group-sm col-sm-12"><label for="'+this.id+'-stroke_opacity" class="col-sm-4 control-label">Outline opacity</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-stroke_opacity" placeholder="Outline opacity (0->1)" min="0" max="1" step="0.1" value="1.0" data-toggle="tooltip" data-placement="right" title="Outline opacity (0.0 = transparent, 1.0 = opaque)"></input></div></div><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-stroke_linestyle">Line style</label><div class="col-sm-8"><select class="form-control" id="'+this.id+'-stroke_linestyle" data-toggle="tooltip" data-placement="right" title="Type of line"><option value="solid">Solid</option><option value="dotted">Dotted</option><option value="dashed">Dashed</option><option value="dotted-dashed">Dash/dot</option></select></div></div></div><div id="'+this.id+'-polygon-fs"><div class="form-group form-group-sm col-sm-12"><label class="col-sm-4 control-label" for="'+this.id+'-fill_color">Fill colour</label><div class="col-sm-8"><input type="color" class="form-control" id="'+this.id+'-fill_color" data-toggle="tooltip" data-placement="right" title="Colour of the graphic interior fill, default black"</input></div></div><div class="form-group form-group-sm col-sm-12"><label for="'+this.id+'-fill_opacity" class="col-sm-4 control-label">Fill opacity</label><div class="col-sm-8"><input type="number" class="form-control" id="'+this.id+'-fill_opacity" placeholder="Fill opacity (0->1)" min="0" max="1" step="0.1" value="1.0" data-toggle="tooltip" data-placement="right" title="Fill opacity (0.0 = transparent, 1.0 = opaque)"></input></div></div></div>'+magic.modules.Common.buttonFeedbackSet(this.id,"Save style","sm","Save",!0)+"</div>"},magic.classes.StylerPopup.prototype.saveState=function(){this.savedState=this.formToPayload()},magic.classes.StylerPopup.prototype.restoreState=function(){jQuery.isEmptyObject(this.savedState)||(this.payloadToForm(this.savedState),this.clearState())},magic.classes.StylerPopup.prototype.formToPayload=function(){var a=jQuery.extend(!0,{},this.inputDefaults);return jQuery.each(this.styleInputs,jQuery.proxy(function(b,c){var d=c.split("_"),e=jQuery("#"+this.id+"-"+c).val();2==d.length?a[d[0]][d[1]]=e:a[c]=e},this)),a},magic.classes.StylerPopup.prototype.payloadToForm=function(a){a=this.convertLegacyFormats(a);var b={point:{point:1,line:1,polygon:1},line:{point:0,line:1,polygon:0},polygon:{point:0,line:1,polygon:1}};b[a.mode]&&(jQuery.each(b[a.mode],jQuery.proxy(function(a,b){var c=this.id+"-"+a+"-fs";1===b?(jQuery("#"+c).removeClass("hidden"),jQuery("#"+c+" :input").prop("disabled",!1)):(jQuery("#"+c).addClass("hidden"),jQuery("#"+c+" :input").prop("disabled",!0))},this)),jQuery.each(this.styleInputs,jQuery.proxy(function(b,c){var d=c.split("_"),e=jQuery("#"+this.id+"-"+c);2==d.length?a[d[0]]&&a[d[0]][d[1]]?e.val(a[d[0]][d[1]]):e.val(this.inputDefaults[d[0]][d[1]]):e.val(a[c])},this)))},magic.classes.StylerPopup.prototype.convertLegacyFormats=function(a){if(!a||jQuery.isEmptyObject(a))return jQuery.extend(!0,{},this.inputDefaults);if("string"==typeof a)try{a=JSON.parse(a)}catch(a){return jQuery.extend(!0,{},this.inputDefaults)}return"predefined"==a.mode||"default"==a.mode?a:a.graphic||a.stroke||a.fill?a:(a.stroke&&a.stroke.style&&(a.stroke.linestyle=a.stroke.style,delete a.stroke.style),{mode:a.mode,graphic:{marker:a.marker||this.inputDefaults.graphic.marker,radius:a.radius||this.inputDefaults.graphic.radius},stroke:{width:a.stroke_width||this.inputDefaults.stroke.width,color:a.stroke_color||this.inputDefaults.stroke.color,linestyle:a.stroke_linestyle||this.inputDefaults.stroke.linestyle,opacity:a.stroke_opacity||this.inputDefaults.stroke.opacity},fill:{color:a.fill_color||this.inputDefaults.fill.color,opacity:a.fill_opacity||this.inputDefaults.fill.opacity}})},magic.classes.creator.AttributeEditorPopup=function(a){a=jQuery.extend({},{id:"attr-editor",caption:"Edit attribute data",popoverClass:"attr-editor-popover",popoverContentClass:"attr-editor-popover-content"},a),magic.classes.PopupForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSave:a.onSave})),this.serviceType=null,this.serviceUrl=null,this.serviceSrs=null,this.attributeMap=[],this.featureName=null,this.inputs=["name","type","nillable","alias","ordinal","label","displayed","filterable","unique_values"],this.target.popover({template:this.template,title:this.titleMarkup(),container:"body",html:!0,trigger:"manual",content:'<p><i class="fa fa-spin fa-spinner"></i> Loading attributes...</p>'}).on("shown.bs.popover",jQuery.proxy(function(a){this.assignCloseButtonHandler(),this.extractSourceInfo(),this.serviceType&&("wms"==this.serviceType?this.getWmsFeatureAttributes():this.getVectorFeatureAttributes())},this))},magic.classes.creator.AttributeEditorPopup.prototype=Object.create(magic.classes.PopupForm.prototype),magic.classes.creator.AttributeEditorPopup.prototype.constructor=magic.classes.creator.AttributeEditorPopup,magic.classes.creator.AttributeEditorPopup.prototype.getVectorFeatureAttributes=function(){if("esrijson"==this.serviceType)this.esriJsonMarkup(),this.assignHandlers(),jQuery("#"+this.id+"-new-row").off("click").on("click",jQuery.proxy(function(){var a=jQuery(".attr-editor-popover-content"),b=a.find("table");if(0==b.length&&(a.append(this.esriTableMarkup()),b=jQuery("#"+this.id+"-attr-table"),this.assignHandlers()),b.length>0){var c=b.find("tr").length-1;b.find("tr").last().after(this.esriRowMarkup(c,{}))}},this));else if(this.attributeMap.length>0)jQuery(".attr-editor-popover-content").html(this.markup()),this.assignHandlers();else{var a=null,b=this.serviceUrl;"geojson"==this.serviceType?this.serviceUrl&&(this.serviceUrl.indexOf("/wfs")>0?this.featureName&&this.serviceSrs&&(a=new ol.format.GeoJSON,b=magic.modules.Endpoints.getOgcEndpoint(this.serviceUrl,"wfs")+"?service=wfs&version=2.0.0&request=getfeature&outputFormat=application/json&typenames="+this.featureName+"&srsname="+this.serviceSrs+"&count=1"):a=new ol.format.GeoJSON):"gpx"==this.serviceType?a=new ol.format.GPX({readExtensions:function(a,b){try{var c=xmlToJSON.parseString(b.outerHTML.trim());if("extensions"in c&&jQuery.isArray(c.extensions)&&1==c.extensions.length){var d=c.extensions[0];for(var e in d)if(0!=e.indexOf("_")&&jQuery.isArray(d[e])&&1==d[e].length){var f=d[e][0]._text;a.set(e,f,!0)}}}catch(a){}return a}}):"kml"==this.serviceType&&(a=new ol.format.KML({showPointNames:!1})),b&&a&&jQuery.ajax({url:magic.modules.Common.proxyUrl(b),method:"GET",dataType:"text"}).done(jQuery.proxy(function(c,d,e){var f=a.readFeatures(c);if(jQuery.isArray(f)&&f.length>0){var g=f[0];if(g){var h=g.getKeys();if(jQuery.isArray(h)&&h.length>0){var i=jQuery.grep(h,function(a){return 0==a.indexOf("geom")||"bbox"==a||0==a.indexOf("extension")},!0);this.attributeMap=[],this.geomType="unknown",jQuery.each(i,jQuery.proxy(function(a,b){var c=g.get(b);this.attributeMap.push({name:b,type:jQuery.isNumeric(c)?"decimal":"string",nillable:!0,alias:"",ordinal:"",displayed:!1,filterable:!1,unique_values:!1})},this)),this.geomType=g.getGeometry().getType().toLowerCase(),jQuery(".attr-editor-popover-content").html(this.markup()),this.assignHandlers()}}else magic.modules.Common.showAlertModal("Error : Failed to parse test feature from "+b+" from server while reading attributes","warning")}else magic.modules.Common.showAlertModal("Error :  Failed to parse test feature from "+b,"warning")},this)).fail(jQuery.proxy(function(a,b,c){401==b?magic.modules.Common.showAlertModal("Not authorised to read data","warning"):magic.modules.Common.showAlertModal("Error : "+c+" from server while reading attributes","warning")},this))}},magic.classes.creator.AttributeEditorPopup.prototype.getWmsFeatureAttributes=function(){var a=magic.modules.Common.getWxsRequestUrl(this.serviceUrl,"DescribeFeatureType",this.featureName);a?this.attributeMap.length>0?(jQuery(".attr-editor-popover-content").html(this.markup()),this.assignHandlers()):jQuery.ajax({url:a,method:"GET",dataType:"xml"}).done(jQuery.proxy(function(a){var b=b=jQuery(a).find("xsd\\:sequence").find("xsd\\:element");this.attributeMap=[],jQuery.each(b,jQuery.proxy(function(a,b){var c={};jQuery.each(b.attributes,function(a,b){"type"==b.name?c[b.name]=b.value.replace(/^xsd?:/,""):c[b.name]=b.value}),this.attributeMap.push(c)},this)),this.geomType=this.computeOgcGeomType(this.attributeMap),jQuery(".attr-editor-popover-content").html(this.markup()),this.assignHandlers()},this)).fail(jQuery.proxy(function(a,b,c){401==b?magic.modules.Common.showAlertModal("Not authorised to read data","warning"):magic.modules.Common.showAlertModal("Error : "+c+" from server while reading attributes","warning")},this)):jQuery(".attr-editor-popover-content").html('<div class="alert alert-info">No attributes found</div>')},magic.classes.creator.AttributeEditorPopup.prototype.assignHandlers=function(){this.formEdited=!1,jQuery("#"+this.id+"-attr-table :input").off("change").on("change",jQuery.proxy(function(){this.formEdited=!0},this)),jQuery("#"+this.id+"-go").off("click").on("click",jQuery.proxy(function(){magic.modules.Common.buttonClickFeedback(this.id,!0,"Saved ok"),jQuery.isFunction(this.controlCallbacks.onSave)&&(this.controlCallbacks.onSave(this.formToPayload()),this.delayedDeactivate(2e3))},this)),jQuery("#"+this.id+"-cancel").off("click").on("click",jQuery.proxy(function(){this.cleanForm(),this.deactivate()},this))},magic.classes.creator.AttributeEditorPopup.prototype.esriJsonMarkup=function(){var a=jQuery(".attr-editor-popover-content");if(a.empty(),a.append('<div class="form-group col-md-12"><label for="'+this.id+'-geomtype" class="col-md-3 control-label">Source type</label><div class="col-md-9"><select class="form-control" id="'+this.id+'-geomtype" data-toggle="tooltip" data-placement="left" title="Type of data geometry"><option value="point"'+("point"==this.geomType?' selected="selected"':"")+'>Point</option><option value="line"'+("line"==this.geomType?' selected="selected"':"")+'>Line</option><option value="polygon"'+("polygon"==this.geomType?' selected="selected"':"")+">Polygon</option></select></div></div>"),this.attributeMap.length>0){a.append(this.esriTableMarkup());var b=jQuery("#"+this.id+"-attr-table");b.length>0&&jQuery.each(this.attributeMap,jQuery.proxy(function(a,c){b.find("tr").last().after(this.esriRowMarkup(a,c))},this))}a.append('<div class="form-group col-md-12"><button id="'+this.id+'-new-row" type="button" class="btn btn-primary"><span class="fa fa-star"></span> Add attribute</button></div>')},magic.classes.creator.AttributeEditorPopup.prototype.esriTableMarkup=function(){return'<table id="'+this.id+'-attr-table" class="table table-condensed table-striped table-hover table-responsive" style="width:100%"><tr><th style="width:140px">Name</th><th style="width:120px"><span data-toggle="tooltip" data-placement="top" title="Human-friendly name for the attribute in pop-up">Alias<span></th><th style="width:80px"><span data-toggle="tooltip" data-placement="top" title="Data type of attribute">Type</span></th><th style="width:40px"><i class="fa fa-list-ol" data-toggle="tooltip" data-placement="top" title="Ordering of attribute in pop-up"><i></th><th style="width:40px"><i class="fa fa-tag" data-toggle="tooltip" data-placement="top" title="Use attribute as a feature label"><i></th><th style="width:40px"><i class="fa fa-eye" data-toggle="tooltip" data-placement="top" title="Attribute is visible in pop-ups"><i></th></tr></table>'+magic.modules.Common.buttonFeedbackSet(this.id,"Save attributes","md","Save",!0)},magic.classes.creator.AttributeEditorPopup.prototype.esriRowMarkup=function(a,b){return b||(b={name:"",alias:"",type:"string",ordinal:1,label:"",displayed:!0}),'<tr><td><input type="hidden" id="_amap_nillable_'+a+'" value="true"></input><input class="attr-editor-input" type="text" style="width:140px" id="_amap_name_'+a+'" value="'+(b.name||"")+'"></input></td><td><input class="attr-editor-input" type="text" style="width:120px" id="_amap_alias_'+a+'" value="'+(b.alias||"")+'"></input></td><td><select class="attr-editor-select" id="_amap_type_'+a+'"><option value="string"'+("string"==b.type?' selected="selected"':"")+'>String</option><option value="decimal"'+("decimal"==b.type?' selected="selected"':"")+'>Float</option><option value="integer"'+("integer"==b.type?' selected="selected"':"")+'>Integer</option></select></td><td><input class="attr-editor-input" type="number" style="width:40px" size="2" min="1" max="99" id="_amap_ordinal_'+a+'" value="'+(b.ordinal||"")+'"></input></td><td><input type="checkbox" id="_amap_label_'+a+'" value="label"'+(!0===b.label?' checked="checked"':"")+'></input></td><td><input type="checkbox" id="_amap_displayed_'+a+'" value="display"'+(!0===b.displayed?' checked="checked"':"")+"></input></td></tr>"},magic.classes.creator.AttributeEditorPopup.prototype.markup=function(){var a="";if(0==this.attributeMap.length)a='<div class="alert alert-info">No attributes found</div>';else{var b="wms"==this.serviceType?' disabled="disabled"':"";a+='<div class="alert alert-info">Geometry type is <strong>'+this.geomType+'</strong></div><table id="'+this.id+'-attr-table" class="table table-condensed table-striped table-hover table-responsive" style="width:100%"><tr><th style="width:140px">Name</th><th style="width:120px"><span data-toggle="tooltip" data-placement="top" title="Human-friendly name for the attribute in pop-up">Alias<span></th><th style="width:40px"><i class="fa fa-list-ol" data-toggle="tooltip" data-placement="top" title="Ordering of attribute in pop-up"><i></th><th style="width:40px"><i class="fa fa-tag" data-toggle="tooltip" data-placement="top" title="Use attribute as a feature label (not for WMS layers)"><i></th><th style="width:40px"><i class="fa fa-eye" data-toggle="tooltip" data-placement="top" title="Attribute is visible in pop-ups"><i></th><th style="width:40px"><i class="fa fa-filter" data-toggle="tooltip" data-placement="top" title="Can filter layer on this attribute"><i></th><th style="width:40px"><span data-toggle="tooltip" data-placement="top" title="Display unique attribute values when filtering">U</span></th></tr>',jQuery.each(this.attributeMap,jQuery.proxy(function(c,d){a+='<input type="hidden" id="_amap_name_'+c+'" value="'+(d.name||"")+'"></input>',a+='<input type="hidden" id="_amap_type_'+c+'" value="'+(d.type||"")+'"></input>',a+='<input type="hidden" id="_amap_nillable_'+c+'" value="'+(d.nillable||"")+'"></input>',d.type&&0!=d.type.indexOf("gml:")&&(a+='<tr><td><div style="max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><span data-toggle="tooltip" data-placement="top" title="Field type is : '+d.type.replace("xsd:","")+'">'+(d.name||"")+'</span></div></td><td><input class="attr-editor-input" type="text" style="width:120px" id="_amap_alias_'+c+'" value="'+(d.alias||"")+'"></input></td><td><input class="attr-editor-input" type="number" style="width:40px" size="2" min="1" max="99" id="_amap_ordinal_'+c+'" value="'+(d.ordinal||"")+'"></input></td><td><input type="checkbox" id="_amap_label_'+c+'" value="label"'+(!0===d.label?' checked="checked"':"")+b+'></input></td><td><input type="checkbox" id="_amap_displayed_'+c+'" value="display"'+(!0===d.displayed?' checked="checked"':"")+'></input></td><td><input type="checkbox" id="_amap_filterable_'+c+'" value="filter"'+(!0===d.filterable?' checked="checked"':"")+'></input></td><td><input type="checkbox" id="_amap_unique_values_'+c+'" value="unique"'+(!0===d.unique_values?' checked="checked"':"")+"></input></td></tr>")},this)),a+="</table>"+magic.modules.Common.buttonFeedbackSet(this.id,"Save attributes","md","Save",!0)}return a},magic.classes.creator.AttributeEditorPopup.prototype.formToPayload=function(){var a=[];return jQuery("[id^='_amap_type']").each(jQuery.proxy(function(b,c){if(0!=jQuery(c).val().indexOf("gml:")){var d={};jQuery.each(this.inputs,jQuery.proxy(function(a,c){var e=jQuery("#_amap_"+c+"_"+b);if("checkbox"==e.attr("type"))d[c]=!0===e.prop("checked");else if("ordinal"==c){var f=parseInt(e.val());d[c]=isNaN(f)?null:f}else d[c]=e.val()},this)),a.push(d)}},this)),"esrijson"==this.serviceType&&(this.geomType=jQuery("#"+this.id+"-geomtype").val()),{attribute_map:a,geom_type:this.geomType}},magic.classes.creator.AttributeEditorPopup.prototype.computeOgcGeomType=function(a){var b="unknown";return jQuery.each(a,function(a,c){if(c.type&&0==c.type.indexOf("gml:")){var d=c.type.toLowerCase();d.indexOf("point")>=0?b="point":d.indexOf("line")>=0||d.indexOf("curve")>=0?b="line":d.indexOf("polygon")>=0&&(b="polygon")}return"unknown"==b}),b},magic.classes.creator.AttributeEditorPopup.prototype.extractSourceInfo=function(){if(this.prePopulator&&this.prePopulator.source){var a=this.prePopulator.source;a.wms_source?(this.serviceType="wms",this.serviceUrl=a.wms_source||null):a.geojson_source?(this.serviceType="geojson",this.serviceUrl=a.geojson_source||null,this.serviceSrs=a.srs||null):a.esrijson_source?(this.serviceType="esrijson",this.serviceUrl=a.esrijson_source||null):a.gpx_source?(this.serviceType="gpx",this.serviceUrl=a.gpx_source||null):a.kml_source&&(this.serviceType="kml",this.serviceUrl=a.kml_source||null),this.featureName=a.feature_name||null,this.attributeMap=this.prePopulator.attribute_map||[],this.geomType=this.prePopulator.geom_type||"unknown"}},magic.classes.creator.EsriJsonSourceEditor=function(a){a=jQuery.extend({},{prefix:"esrijson-source-editor",sourceContext:null,formSchema:[{field:"esrijson_source",default:""},{field:"layer_title",default:""},{field:"style_definition",default:'{"mode": "default"}'}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(this.init,this),onSaveContext:a.onSaveContext}))},magic.classes.creator.EsriJsonSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.EsriJsonSourceEditor.prototype.constructor=magic.classes.creator.EsriJsonSourceEditor,magic.classes.creator.EsriJsonSourceEditor.prototype.markup=function(){return'<input type="hidden" name="'+this.prefix+'-style_definition" id="'+this.prefix+'-style_definition"></input><div class="form-group"><label for="'+this.prefix+'-esrijson_source" class="col-md-3 control-label"><span class="label label-danger">Feed URL</span></label><div class="col-md-9"><input type="url" class="form-control" id="'+this.prefix+'-esrijson_source" name="'+this.prefix+'-esrijson_source" placeholder="URL of ESRI source" required="required" data-toggle="tooltip" data-placement="left" title="Source URL for ArcGIS Online JSON feed"></input></div></div><div class="form-group"><label for="'+this.prefix+'-layer_title" class="col-md-3 control-label">Layer title</label><div class="col-md-9"><input type="text" class="form-control" id="'+this.prefix+'-layer_title" name="'+this.prefix+'-layer_title" placeholder="Title of operational data layer" data-toggle="tooltip" data-placement="left" title="Title of operational layer containing the data - leave blank to use the first available"></input></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.prefix+'-style-mode">Style</label><div class="form-inline col-md-9"><select id="'+this.prefix+'-style-mode" class="form-control" data-toggle="tooltip" data-placement="left" title="Layer styling"><option value="default" selected="selected">Default</option><option value="point">Point style</option><option value="line">Line style</option><option value="polygon">Polygon style</option></select><button id="'+this.prefix+'-style-edit" data-trigger="manual" data-container="body" data-toggle="popover" data-placement="left"  type="button" role="button"class="btn btn-md btn-primary" disabled="disabled"><span class="fa fa-pencil"></span></button></div></div>'},magic.classes.creator.EsriJsonSourceEditor.prototype.init=function(a){this.setStyleHandlers(a),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.EsriJsonSourceEditor.prototype.writeStyle=function(a){a||(a={mode:"default"}),jQuery("#"+this.prefix+"-style_definition").val(JSON.stringify(a)),jQuery("#"+this.prefix+"-style-edit").prop("disabled","predefined"==mode||"default"==mode),jQuery.isFunction(this.controlCallbacks.onSaveContext)&&this.controlCallbacks.onSaveContext()},magic.classes.creator.EsriJsonSourceEditor.prototype.sourceSpecified=function(){return magic.modules.Common.isUrl(jQuery("#"+this.prefix+"-esrijson_source").val())},magic.classes.creator.EsriJsonSourceEditor.prototype.validate=function(){magic.modules.Common.resetFormIndicators();var a=jQuery("#"+this.prefix+"-esrijson_source"),b=a.val();return!!magic.modules.Common.isUrl(b)||(magic.modules.Common.flagInputError(a),!1)},magic.classes.creator.EsriTileSourceEditor=function(a){a=jQuery.extend({},{prefix:"esritile-source-editor",sourceContext:null,formSchema:[{field:"esritile_source",default:""},{field:"is_base",default:!1}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSaveContext:jQuery.proxy(this.onSaveContext,this)})),this.wmsMenus=new magic.classes.creator.WmsFeatureLinkedMenus({id:this.prefix}),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(function(a){magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},this)}))},magic.classes.creator.EsriTileSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.EsriTileSourceEditor.prototype.constructor=magic.classes.creator.EsriTileSourceEditor,magic.classes.creator.EsriTileSourceEditor.prototype.markup=function(){return'<div class="form-group"><label for="'+this.prefix+'-esritile_source" class="col-md-3 control-label"><span class="label label-danger">Feed URL</span></label><div class="col-md-9"><input type="url" class="form-control" id="'+this.prefix+'-esritile_source" name="'+this.prefix+'-esritile_source" placeholder="URL of ESRI Tile source" required="required" data-toggle="tooltip" data-placement="left" title="Source URL for ArcGIS Online Tile feed"></input></div></div><div class="form-group"><div class="col-md-offset-3 col-md-9"><div class="checkbox"><label><input type="checkbox" id="'+this.prefix+'-is_base" name="'+this.prefix+'-is_base" value="base" data-toggle="tooltip" data-placement="left" title="Tick if base (backdrop) layer"></input>Layer is a base (backdrop) layer</label></div></div></div>'},magic.classes.creator.EsriTileSourceEditor.prototype.validate=function(){return magic.modules.Common.isUrl(jQuery("#"+this.prefix+"-esritile_source").val())},magic.classes.creator.GeoJsonSourceEditor=function(a){a=jQuery.extend({},{prefix:"geojson-source-editor",sourceContext:null,formSchema:[{field:"geojson_source",default:""},{field:"feature_name",default:""},{field:"srs",default:""},{field:"style_definition",default:'{"mode": "default"}'}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(this.init,this),onSaveContext:a.onSaveContext}))},magic.classes.creator.GeoJsonSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.GeoJsonSourceEditor.prototype.constructor=magic.classes.creator.GeoJsonSourceEditor,magic.classes.creator.GeoJsonSourceEditor.prototype.markup=function(){return'<input type="hidden" name="'+this.prefix+'-style_definition" id="'+this.prefix+'-style_definition"></input><div class="form-group"><label for="'+this.prefix+'-geojson_source" class="col-md-3 control-label"><span class="label label-danger">Feed URL</span></label><div class="col-md-9"><input type="url" class="form-control" id="'+this.prefix+'-geojson_source" name="'+this.prefix+'-geojson_source" placeholder="URL of GeoJSON source" required="required" data-toggle="tooltip" data-placement="left" title="Source URL for GeoJSON e.g. WFS feed, API output etc"></input></div></div><div class="form-group"><label class="col-md-3 control-label" for="'+this.prefix+'-feature_name">Feature</label><div class="col-md-9"><input type="text" class="form-control" id="'+this.prefix+'-feature_name" name="'+this.prefix+'-feature_name" data-toggle="tooltip" data-placement="left" title="Feature name (only relevant if data is a WFS feed)" pattern="^[a-zA-Z0-9_:]+$"></input></div></div><div class="form-group"><label class="col-md-3 control-label" for="'+this.prefix+'-srs">Projection</label><div class="col-md-9"><select class="form-control" id="'+this.prefix+'-srs" name="'+this.prefix+'-srs" data-toggle="tooltip" data-placement="left" title="Projection of GeoJSON feed data (defaults to lat/lon WGS84). If feed is WFS, set this value to reproject the data to this SRS"></select></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.prefix+'-style-mode">Style</label><div class="form-inline col-md-9"><select id="'+this.prefix+'-style-mode" class="form-control" data-toggle="tooltip" data-placement="left" title="Layer styling"><option value="default" selected="selected">Default</option><option value="predefined">Use pre-defined style</option><option value="point">Point style</option><option value="line">Line style</option><option value="polygon">Polygon style</option></select><button id="'+this.prefix+'-style-edit" data-trigger="manual" data-container="body" data-toggle="popover" data-placement="left"  type="button" role="button"class="btn btn-md btn-primary" disabled="disabled"><span class="fa fa-pencil"></span></button></div></div><div class="form-group hidden predefined-style-input"><label class="col-md-3 control-label" for="'+this.prefix+'-style-predefined">Style name</label><div class="col-md-9"><select class="form-control" id="'+this.prefix+'-style-predefined" name="'+this.prefix+'-style-predefined" data-toggle="tooltip" data-placement="left" title="Select a canned style for a vector layer"></select></div></div>'},magic.classes.creator.GeoJsonSourceEditor.prototype.init=function(a){jQuery("#"+this.prefix+"-srs").html('<option value="EPSG:4326" selected>WGS84 (lat/lon) - EPSG:4326</option><option value="'+magic.runtime.projection+'">'+magic.runtime.projection+"</option>"),this.populateCannedStylesDropdown(a.style_definition.predefined||""),this.setStyleHandlers(a);var b=jQuery("div.predefined-style-input");b.length>0&&(a.style_definition&&"predefined"==a.style_definition.mode&&a.style_definition.predefined?b.removeClass("hidden"):b.addClass("hidden")),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.GeoJsonSourceEditor.prototype.formToPayload=function(){return"predefined"==jQuery("#"+this.prefix+"-style-mode").val()&&jQuery("#"+this.prefix+"-style_definition").val(JSON.stringify({mode:"predefined",predefined:jQuery("#"+this.prefix+"-style-predefined").val()})),{source:magic.modules.Common.formToJson(this.formSchema,this.prefix)}},magic.classes.creator.GeoJsonSourceEditor.prototype.writeStyle=function(a){a||(a={mode:"default"}),jQuery("#"+this.prefix+"-style_definition").val(JSON.stringify(a)),jQuery("#"+this.prefix+"-style-edit").prop("disabled","predefined"==a.mode||"default"==a.mode),jQuery.isFunction(this.controlCallbacks.onSaveContext)&&this.controlCallbacks.onSaveContext()},magic.classes.creator.GeoJsonSourceEditor.prototype.populateCannedStylesDropdown=function(a){a=a||"";var b=[];for(var c in magic.modules.VectorStyles)b.push(c);b.sort();var d=[];jQuery.each(b,function(a,b){d.push({key:b,value:b})}),magic.modules.Common.populateSelect(jQuery("#"+this.prefix+"-style-predefined"),d,"key","value",a,!1)},magic.classes.creator.GeoJsonSourceEditor.prototype.sourceSpecified=function(){var a=jQuery("#"+this.prefix+"-geojson_source").val(),b=jQuery("#"+this.prefix+"-feature_name").val(),c=a.indexOf("/wfs")>0;return c&&magic.modules.Common.isUrl(a)&&b||!c&&magic.modules.Common.isUrl(a)},magic.classes.creator.GeoJsonSourceEditor.prototype.validate=function(){magic.modules.Common.resetFormIndicators();var a=jQuery("#"+this.prefix+"-geojson_source"),b=a.val(),c=jQuery("#"+this.prefix+"-feature_name"),d=c.val(),e=b.indexOf("/wfs")>0;return!!(e&&magic.modules.Common.isUrl(b)&&d||!e&&magic.modules.Common.isUrl(b))||(magic.modules.Common.flagInputError(a),e&&!d&&magic.modules.Common.flagInputError(c),!1)},magic.classes.creator.GpxSourceEditor=function(a){a=jQuery.extend({},{prefix:"gpx-source-editor",sourceContext:null,formSchema:[{field:"gpx_source",default:""},{field:"style_definition",default:'{"mode": "default"}'}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(this.init,this),onSaveContext:a.onSaveContext}))},magic.classes.creator.GpxSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.GpxSourceEditor.prototype.constructor=magic.classes.creator.GpxSourceEditor,magic.classes.creator.GpxSourceEditor.prototype.markup=function(){return'<input type="hidden" name="'+this.prefix+'-style_definition" id="'+this.prefix+'-style_definition"></input><div class="form-group"><label for="'+this.prefix+'-gpx_source" class="col-md-3 control-label"><span class="label label-danger">Feed URL</span></label><div class="col-md-9"><input type="url" class="form-control" id="'+this.prefix+'-gpx_source" name="'+this.prefix+'-gpx_source" placeholder="URL of GPX source" required="required" data-toggle="tooltip" data-placement="left" title="Source URL for GPX feed"></input></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.prefix+'-style-mode">Style</label><div class="form-inline col-md-9"><select id="'+this.prefix+'-style-mode" class="form-control" data-toggle="tooltip" data-placement="left" title="Layer styling"><option value="default" selected="selected">Default</option><option value="point">Point style</option><option value="line">Line style</option><option value="polygon">Polygon style</option></select><button id="'+this.prefix+'-style-edit" data-trigger="manual" data-container="body" data-toggle="popover" data-placement="left"  type="button" role="button"class="btn btn-md btn-primary" disabled="disabled"><span class="fa fa-pencil"></span></button></div></div>'},magic.classes.creator.GpxSourceEditor.prototype.init=function(a){this.setStyleHandlers(a),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.GpxSourceEditor.prototype.writeStyle=function(a){a||(a={mode:"default"}),jQuery("#"+this.prefix+"-style_definition").val(JSON.stringify(a)),jQuery("#"+this.prefix+"-style-edit").prop("disabled","default"==a.mode),jQuery.isFunction(this.controlCallbacks.onSaveContext)&&this.controlCallbacks.onSaveContext()},magic.classes.creator.GpxSourceEditor.prototype.sourceSpecified=function(){return magic.modules.Common.isUrl(jQuery("#"+this.prefix+"-gpx_source").val())},magic.classes.creator.GpxSourceEditor.prototype.validate=function(){return magic.modules.Common.resetFormIndicators(),!!this.sourceSpecifed()||(magic.modules.Common.flagInputError(jQuery("#"+this.prefix+"-gpx_source")),!1)},magic.classes.creator.KmlSourceEditor=function(a){a=jQuery.extend({},{prefix:"kml-source-editor",sourceContext:null,formSchema:[{field:"kml_source",default:""},{field:"style_definition",default:'{"mode": "default"}'}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(this.init,this),onSaveContext:a.onSaveContext}))},magic.classes.creator.KmlSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.KmlSourceEditor.prototype.constructor=magic.classes.creator.KmlSourceEditor,magic.classes.creator.KmlSourceEditor.prototype.markup=function(){return'<input type="hidden" name="'+this.prefix+'-style_definition" id="'+this.prefix+'-style_definition"></input><div class="form-group"><label for="'+this.prefix+'-kml_source" class="col-md-3 control-label"><span class="label label-danger">Feed URL</span></label><div class="col-md-9"><input type="url" class="form-control" id="'+this.prefix+'-kml_source" name="'+this.prefix+'-kml_source" placeholder="URL of KML source" required="required" data-toggle="tooltip" data-placement="left" title="Source URL for KML feed"></input></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.prefix+'-style-mode">Style</label><div class="form-inline col-md-9"><select id="'+this.prefix+'-style-mode" class="form-control" data-toggle="tooltip" data-placement="left" title="Layer styling"><option value="default" selected="selected">Use style in the file</option><option value="point">Point style</option><option value="line">Line style</option><option value="polygon">Polygon style</option></select><button id="'+this.prefix+'-style-edit" data-trigger="manual" data-container="body" data-toggle="popover" data-placement="left"  type="button" role="button"class="btn btn-md btn-primary" disabled="disabled"><span class="fa fa-pencil"></span></button></div></div>'},magic.classes.creator.KmlSourceEditor.prototype.init=function(a){this.setStyleHandlers(a),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.KmlSourceEditor.prototype.writeStyle=function(a){a||(a={mode:"default"}),jQuery("#"+this.prefix+"-style_definition").val(JSON.stringify(a)),jQuery("#"+this.prefix+"-style-edit").prop("disabled","default"==a.mode||"file"==a.mode),jQuery.isFunction(this.controlCallbacks.onSaveContext)&&this.controlCallbacks.onSaveContext()},magic.classes.creator.KmlSourceEditor.prototype.sourceSpecified=function(){return magic.modules.Common.isUrl(jQuery("#"+this.prefix+"-kml_source").val())},magic.classes.creator.KmlSourceEditor.prototype.validate=function(){return magic.modules.Common.resetFormIndicators(),!!this.sourceSpecifed()||(magic.modules.Common.flagInputError(jQuery("#"+this.prefix+"-kml_source")),!1)},magic.classes.creator.LayerEditor=function(a){this.prefix=a.prefix||"map-layers-layer",this.onSave=a.onSave||null,this.onCancel=a.onCancel||null,this.formSchema=[{field:"id",default:""},{field:"name",default:""},{field:"refresh_rate",default:0},{field:"legend_graphic",default:""},{field:"geom_type",default:"unknown"},{field:"min_scale",default:100},{field:"max_scale",default:1e8},{field:"opacity",default:1},{field:"is_visible",default:!1},{field:"is_interactive",default:!1},{field:"is_filterable",default:!1}],this.sourceEditor=null,this.attributeEditor=null,this.attrEditorUpdates={},this.active=!1,this.saveBtn=jQuery("#"+this.prefix+"-save"),this.cancelBtn=jQuery("#"+this.prefix+"-cancel"),this.formDirty=!1,this.saveBtn.off("click").on("click",jQuery.proxy(this.saveContext,this)),this.cancelBtn.off("click").on("click",jQuery.proxy(this.cancelEdit,this))},magic.classes.creator.LayerEditor.prototype.isActive=function(){return this.active},magic.classes.creator.LayerEditor.prototype.isDirty=function(){return this.formDirty||!jQuery.isEmptyObject(this.attrEditorUpdates)},magic.classes.creator.LayerEditor.prototype.loadContext=function(a){if(a){this.attributeEditor&&this.attributeEditor.deactivate(!0),this.sourceEditor&&this.sourceEditor.deactivateStyler(!0),this.attrEditorUpdates={},this.saveBtn.prop("disabled",!0);jQuery("#"+this.prefix+"-source_type").off("change").on("change",jQuery.proxy(function(a){this.formDirty?bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">You have unsaved changes - proceed?</div>',jQuery.proxy(function(b){b&&this.sourceMarkup(jQuery(a.currentTarget).val(),null),bootbox.hideAll()},this)):this.sourceMarkup(jQuery(a.currentTarget).val(),null)},this)),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix),this.sourceMarkup(null,a),jQuery("[id^='"+this.prefix+"']").filter(":input").on("change keyup",jQuery.proxy(this.setFormDirty,this));var b=jQuery("#"+this.prefix+"-is_interactive"),c=jQuery("#"+this.prefix+"-is_filterable");b.on("change",jQuery.proxy(function(a){!0===jQuery(a.currentTarget).prop("checked")?jQuery("div.attribute-editor").removeClass("hidden"):!1===c.prop("checked")&&jQuery("div.attribute-editor").addClass("hidden")},this)),b.prop("checked",a.is_interactive),c.prop("checked",a.is_filterable),!0===a.is_interactive||!0===a.is_filterable?jQuery("div.attribute-editor").removeClass("hidden"):jQuery("div.attribute-editor").addClass("hidden"),c.on("change",jQuery.proxy(function(a){!0===jQuery(a.currentTarget).prop("checked")?jQuery("div.attribute-editor").removeClass("hidden"):!1===b.prop("checked")&&jQuery("div.attribute-editor").addClass("hidden")},this)),jQuery("#"+this.prefix+"-attribute-edit").off("click").on("click",jQuery.proxy(function(b){this.attributeEditor||(this.attributeEditor=new magic.classes.creator.AttributeEditorPopup({target:this.prefix+"-attribute-edit",onSave:jQuery.proxy(this.saveAttributes,this)})),this.sourceEditor.sourceSpecified()?this.attributeEditor.activate(jQuery.extend(a,this.sourceEditor.formToPayload(),this.attrEditorUpdates)):magic.modules.Common.showAlertModal("Please specify at least a source URL (and a feature name for WFS feeds)","warning")},this)),this.formDirty=!1,this.active=!0}},magic.classes.creator.LayerEditor.prototype.saveContext=function(){if(jQuery.isFunction(this.onSave)){var a=jQuery.extend(!0,{},magic.modules.Common.formToJson(this.formSchema,this.prefix),this.sourceEditor.formToPayload(),this.attrEditorUpdates);this.onSave(a)}this.formDirty=!1,this.active=!1},magic.classes.creator.LayerEditor.prototype.saveAttributes=function(a){this.attrEditorUpdates=a,this.saveBtn.prop("disabled",!1)},magic.classes.creator.LayerEditor.prototype.cancelEdit=function(){jQuery.isFunction(this.onCancel)&&this.onCancel(),this.formDirty=!1,this.active=!1},magic.classes.creator.LayerEditor.prototype.validate=function(){magic.modules.Common.resetFormIndicators();var a=jQuery("#"+this.prefix+"-form")[0].checkValidity();return jQuery.each(jQuery("#"+this.prefix+"-form").find("input"),function(a,b){var c=jQuery(b);c.prop("validity").valid||magic.modules.Common.flagInputError(c)}),a&&(a=this.sourceEditor.validate()),a},magic.classes.creator.LayerEditor.prototype.sourceMarkup=function(a,b){a=a||this.typeFromContext(b),jQuery("#"+this.prefix+"-source_type").val(a);var c={prefix:this.prefix,sourceContext:b?b.source||null:null,onSaveContext:jQuery.proxy(this.setFormDirty,this)};switch(a){case"esritile":this.sourceEditor=new magic.classes.creator.EsriTileSourceEditor(c);break;case"geojson":this.sourceEditor=new magic.classes.creator.GeoJsonSourceEditor(c);break;case"esrijson":this.sourceEditor=new magic.classes.creator.EsriJsonSourceEditor(c);break;case"gpx":this.sourceEditor=new magic.classes.creator.GpxSourceEditor(c);break;case"kml":this.sourceEditor=new magic.classes.creator.KmlSourceEditor(c);break;default:this.sourceEditor=new magic.classes.creator.WmsSourceEditor(c)}jQuery("#"+this.prefix+"-source").removeClass("hidden").html(this.sourceEditor.markup()),this.sourceEditor.loadContext(c.sourceContext)},magic.classes.creator.LayerEditor.prototype.typeFromContext=function(a){var b="wms";if(a&&a.source)for(var c=["esritile","geojson","esrijson","gpx","kml","wms"],d=0;d<c.length;d++)if(a.source[c[d]+"_source"]){b=c[d];break}return b},magic.classes.creator.LayerEditor.prototype.setFormDirty=function(){this.saveBtn.prop("disabled",!1),this.formDirty=!0},magic.classes.creator.LayerGroupEditor=function(a){this.prefix=a.prefix||"map-layers-group",this.onSave=a.onSave||null,this.onCancel=a.onCancel||null,this.formSchema=[{field:"id",default:""},{field:"name",default:""},{field:"expanded",default:!1},{field:"base",default:!1},{field:"autoload",default:!1},{field:"autoload_filter",default:""},{field:"autoload_popups",default:!1},{field:"one_only",default:!1}],this.active=!1,this.saveBtn=jQuery("#"+this.prefix+"-save"),this.cancelBtn=jQuery("#"+this.prefix+"-cancel"),jQuery("#"+this.prefix+"-autoload").change(function(a){jQuery("#"+a.currentTarget.id+"_filter").closest("div.form-group").toggleClass("hidden"),jQuery("#"+a.currentTarget.id+"_popups").closest("div.form-group").toggleClass("hidden")}),this.formDirty=!1,jQuery("[id^='"+this.prefix+"']").filter(":input").on("change keyup",jQuery.proxy(function(){this.saveBtn.prop("disabled",!1),this.formDirty=!0},this)),this.saveBtn.off("click").on("click",jQuery.proxy(this.saveContext,this)),this.cancelBtn.off("click").on("click",jQuery.proxy(this.cancelEdit,this))},magic.classes.creator.LayerGroupEditor.prototype.isActive=function(){return this.active},magic.classes.creator.LayerGroupEditor.prototype.isDirty=function(){return this.formDirty},magic.classes.creator.LayerGroupEditor.prototype.loadContext=function(a){if(a){this.saveBtn.prop("disabled",!0);var b=jQuery("#"+this.prefix+"-autoload_filter").closest("div.form-group"),c=jQuery("#"+this.prefix+"-autoload_popups").closest("div.form-group");a.autoload?(b.removeClass("hidden"),c.removeClass("hidden")):(b.addClass("hidden"),c.addClass("hidden")),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix),this.formDirty=!1,this.active=!0}},magic.classes.creator.LayerGroupEditor.prototype.saveContext=function(){if(jQuery.isFunction(this.onSave)){var a=magic.modules.Common.formToJson(this.formSchema,this.prefix);a.layers||(a.layers=[]),this.onSave(a)}this.formDirty=!1,this.active=!1},magic.classes.creator.LayerGroupEditor.prototype.cancelEdit=function(){jQuery.isFunction(this.onCancel)&&this.onCancel(),this.formDirty=!1,this.active=!1},magic.classes.creator.LayerGroupEditor.prototype.validate=function(){magic.modules.Common.resetFormIndicators();var a=jQuery("#"+this.prefix+"-form")[0].checkValidity();if(jQuery.each(jQuery("#"+this.prefix+"-form").find("input"),function(a,b){var c=jQuery(b);c.prop("validity").valid||magic.modules.Common.flagInputError(c)}),a&&jQuery("#"+this.prefix+"-autoload").is(":checked")){var b=jQuery("#"+this.prefix+"-autoload_filter");if(b.val()){b.val().match(/[A-Za-z0-9+*?-_]+/)?b.closest("div.form-group").removeClass("has-error").addClass("hidden"):(b.closest("div.form-group").removeClass("hidden").addClass("has-error"),a=!1)}else b.closest("div.form-group").removeClass("hidden").addClass("has-error"),a=!1}return a},magic.classes.creator.WmsFeatureLinkedMenus=function(a){this.id=a.id||"wms-linked-menus",this.projection=magic.runtime.projection,this.dropdowns={}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.getValue=function(a){return this.dropdowns[a].val()},magic.classes.creator.WmsFeatureLinkedMenus.prototype.formToPayload=function(){return{wms_source:this.dropdowns.wms_source.val(),feature_name:this.dropdowns.feature_name.val(),style_name:this.dropdowns.style_name.val()||null}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.markup=function(){return'<div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-wms_source"><span class="label label-danger">WMS</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-wms_source" data-toggle="tooltip" data-placement="left" title="Choose a WMS service from which to fetch data" required="required"></select></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-feature_name"><span class="label label-danger">Feature</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-feature_name" data-toggle="tooltip" data-placement="left" title="Choose a dataset served by above WMS" required="required"></select></div></div><div class="form-group form-group-md col-md-12"><label class="col-md-3 control-label" for="'+this.id+'-style_name"><span class="label label-danger">Style</span></label><div class="col-md-9"><select class="form-control" id="'+this.id+'-style_name" data-toggle="tooltip" data-placement="left" title="Choose a style to be used with the feature" required="required"></select></div></div>'},magic.classes.creator.WmsFeatureLinkedMenus.prototype.sourceSpecified=function(){return""!=this.dropdowns.wms_source.val()&&""!=this.dropdowns.feature_name.val()},magic.classes.creator.WmsFeatureLinkedMenus.prototype.validate=function(){var a=this.sourceSpecified();return this.dropdowns.wms_source.val()||magic.modules.Common.flagInputError(this.dropdowns.wms_source),this.dropdowns.wms_source.val()||magic.modules.Common.flagInputError(this.dropdowns.feature_name),a},magic.classes.creator.WmsFeatureLinkedMenus.prototype.init=function(a){this.dropdowns.wms_source=jQuery("#"+this.id+"-wms_source"),this.dropdowns.feature_name=jQuery("#"+this.id+"-feature_name"),this.dropdowns.style_name=jQuery("#"+this.id+"-style_name"),magic.modules.Common.populateSelect(this.dropdowns.wms_source,magic.modules.Endpoints.getEndpointsBy("srs",this.projection),"url","name",a.wms_source,!0),a.feature_name&&this.loadFeaturesFromService(a.wms_source,a.feature_name,a.style_name),this.dropdowns.wms_source.off("change").on("change",jQuery.proxy(function(){var a=this.dropdowns.wms_source.val();a&&"osm"!=a?(this.dropdowns.feature_name.prop("disabled",!1),this.loadFeaturesFromService(a,"",""),this.dropdowns.style_name.prop("disabled",!0).empty()):(this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty())},this)),this.dropdowns.feature_name.off("change").on("change",jQuery.proxy(function(){var a=this.dropdowns.wms_source.val(),b=this.dropdowns.feature_name.val();b?(this.dropdowns.style_name.prop("disabled",!1),this.loadStylesForFeature(a,b,"")):this.dropdowns.style_name.prop("disabled",!0).empty()},this))},magic.classes.creator.WmsFeatureLinkedMenus.prototype.loadFeaturesFromService=function(a,b,c){if("osm"!=a){c=c||"",this.dropdowns.feature_name.prop("disabled",!1);var d=magic.runtime.creator.catalogues[a];d&&d.length>0?(magic.modules.Common.populateSelect(this.dropdowns.feature_name,d,"value","name",b,!0),this.loadStylesForFeature(a,b,c)):jQuery.get(magic.modules.Common.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(d){try{var e=jQuery.parseJSON(JSON.stringify((new ol.format.WMSCapabilities).read(d)));e?(magic.runtime.creator.catalogues[a]=this.extractFeatureTypes(e),magic.modules.Common.populateSelect(this.dropdowns.feature_name,magic.runtime.creator.catalogues[a],"value","name",b,!0),this.loadStylesForFeature(a,b,c)):(magic.modules.Common.showAlertModal("Failed to parse capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty())}catch(b){magic.modules.Common.showAlertModal("Failed to parse capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty()}},this)).fail(jQuery.proxy(function(){magic.modules.Common.showAlertModal("Failed to read capabilities for WMS "+a,"error"),this.dropdowns.feature_name.prop("disabled",!0).empty(),this.dropdowns.style_name.prop("disabled",!0).empty()},this))}},magic.classes.creator.WmsFeatureLinkedMenus.prototype.loadStylesForFeature=function(a,b,c){b&&jQuery.isArray(magic.runtime.creator.catalogues[a])?jQuery.each(magic.runtime.creator.catalogues[a],jQuery.proxy(function(a,d){var e=b.toLowerCase().split(":").pop();return d.value.toLowerCase().split(":").pop()!=e||(jQuery.isArray(d.styles)&&d.styles.length>1?magic.modules.Common.populateSelect(this.dropdowns.style_name,d.styles,"Name","Title",c,!1):magic.modules.Common.populateSelect(this.dropdowns.style_name,[{Name:"",Title:"Default style"}],"Name","Title","",!1),!1)},this)):magic.modules.Common.populateSelect(this.dropdowns.style_name,[{Name:"",Title:"Default style"}],"Name","Title","",!1)},magic.classes.creator.WmsFeatureLinkedMenus.prototype.extractFeatureTypes=function(a){var b=[];if("Capability"in a&&"Layer"in a.Capability&&"Layer"in a.Capability.Layer&&jQuery.isArray(a.Capability.Layer.Layer)){var c=a.Capability.Layer.Layer;this.getFeatures(b,c)}else magic.modules.Common.showAlertModal("Malformed GetCapabilities response received from remote WMS","error");return b},magic.classes.creator.WmsFeatureLinkedMenus.prototype.getFeatures=function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a.push({name:c.Title,value:c.Name,styles:c.Style}):"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatures(a,c.Layer)},this))},magic.classes.creator.WmsSourceEditor=function(a){a=jQuery.extend({},{prefix:"wms-source-editor",sourceContext:null,formSchema:[{field:"wms_source",default:""},{field:"feature_name",default:""},{field:"style_name",default:""},{field:"is_base",default:!1},{field:"is_singletile",default:!1},{field:"is_dem",default:!1},{field:"is_time_dependent",default:!1}],onSaveContext:function(){}},a),magic.classes.creator.DataSourceForm.call(this,a),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onSaveContext:jQuery.proxy(this.onSaveContext,this)})),this.wmsMenus=new magic.classes.creator.WmsFeatureLinkedMenus({id:this.prefix}),this.setCallbacks(jQuery.extend(this.controlCallbacks,{onLoadContext:jQuery.proxy(function(a){this.wmsMenus.init(a);var b=jQuery.grep(this.formSchema,function(a){return 0==a.field.indexOf("is_")});magic.modules.Common.jsonToForm(b,a,this.prefix)},this)}))},magic.classes.creator.WmsSourceEditor.prototype=Object.create(magic.classes.creator.DataSourceForm.prototype),magic.classes.creator.WmsSourceEditor.prototype.constructor=magic.classes.creator.WmsSourceEditor,magic.classes.creator.WmsSourceEditor.prototype.markup=function(){return this.wmsMenus.markup()+'<div class="form-group"><div class="col-md-offset-3 col-md-9"><div class="checkbox"><label><input type="checkbox" id="'+this.prefix+'-is_base" name="'+this.prefix+'-is_base" value="base" data-toggle="tooltip" data-placement="left" title="Tick if base (backdrop) layer"></input>Layer is a base (backdrop) layer</label></div></div></div><div class="form-group"><div class="col-md-offset-3 col-md-9"><div class="checkbox"><label><input type="checkbox" id="'+this.prefix+'-is_singletile" name="'+this.prefix+'-is_singletile" value="singletile" data-toggle="tooltip" data-placement="left" title="Tick to use a single tile (for large rasters, or layers that need wide area labelling)"></input>Layer rendered as one large tile</label></div></div></div><div class="form-group"><div class="col-md-offset-3 col-md-9"><div class="checkbox"><label><input type="checkbox" id="'+this.prefix+'-is_dem" name="'+this.prefix+'-is_dem" value="dem" data-toggle="tooltip" data-placement="left" title="Tick if this layer is a DEM to be used in elevation measurement"></input>Layer is a Digital Elevation Model (DEM)</label></div></div></div><div class="form-group"><div class="col-md-offset-3 col-md-9"><div class="checkbox"><label><input type="checkbox" id="'+this.prefix+'-is_time_dependent" name="'+this.prefix+'-is_time_dependent" value="timedep" data-toggle="tooltip" data-placement="left" title="Tick if this layer has a time dimension"></input>Layer has a time dimension</label></div></div></div>'},magic.classes.creator.WmsSourceEditor.prototype.sourceSpecified=function(){return this.wmsMenus.sourceSpecified()},magic.classes.creator.WmsSourceEditor.prototype.validate=function(){return this.wmsMenus.validate()},magic.classes.creator.AppContainer=function(){this.currentTabIndex=-1,this.dialogs=[new magic.classes.creator.MapMetadataForm({formSchema:[{field:"id",default:""},{field:"name",default:"new_map"},{field:"title",default:""},{field:"description",default:""},{field:"infolink",default:""},{field:"logo",default:""},{field:"metadata_url",default:""},{field:"watermark",default:""},{field:"newslink",default:""},{field:"version",default:"1.0"},{field:"owner_email",default:""}]}),new magic.classes.creator.MapLayerSelectorTree({}),new magic.classes.creator.MapControlSelector({}),new magic.classes.creator.MapParameterSelector({embedded:!1})],this.regionSelector=new magic.classes.creator.MapRegionSelector({contextLoader:jQuery.proxy(this.loadContext,this),mapTitleService:magic.config.paths.baseurl+"/maps/dropdown",mapDataService:magic.config.paths.baseurl+"/maps/name"}),jQuery("#rootwizard").bootstrapWizard({onTabShow:jQuery.proxy(function(a,b,c){if(c!=this.currentTabIndex){this.currentTabIndex=c;var d=b.find("li").length,e=c+1,f=e/d*100;jQuery("#rootwizard").find(".progress-bar").css({width:f+"%"}),jQuery.isFunction(this.dialogs[c].showContext)&&this.dialogs[c].showContext(),c==d-1?(jQuery("ul.pager li.finish").removeClass("hidden"),jQuery("ul.pager li.previous").removeClass("hidden"),jQuery("ul.pager li.next").addClass("hidden")):(jQuery("ul.pager li.finish").addClass("hidden"),jQuery("ul.pager li.next").removeClass("hidden"),0==c?jQuery("ul.pager li.previous").addClass("hidden"):jQuery("ul.pager li.previous").removeClass("hidden"))}},this),onNext:jQuery.proxy(function(a,b,c){var d=b.find("li").length,e=1!=c||this.regionSelector.validate();return!(!this.dialogs[c-1].validate()||!e)&&(c>=d-1?jQuery("ul.pager li.finish").removeClass("hidden"):jQuery("ul.pager li.finish").addClass("hidden"),!0)},this),onBack:jQuery.proxy(function(a,b,c){return this.dialogs[c-1].validate()},this),onTabClick:function(){return!1}}),jQuery("#rootwizard .finish").click(jQuery.proxy(this.saveContext,this)),jQuery('[data-toggle="tooltip"]').tooltip({trigger:"hover"}),jQuery("body").tooltip({selector:'[data-toggle="tooltip"]',trigger:"hover"}),jQuery('[data-toggle="tab"]').tooltip({trigger:"hover",placement:"top",animate:!0,container:"body"})},magic.classes.creator.AppContainer.prototype.loadContext=function(a,b){if(!a){if(!b)return void magic.modules.Common.showAlertModal("No map context or region data supplied - aborting","error");a={},jQuery.each(this.dialogs,jQuery.proxy(function(c,d){a=jQuery.extend(!0,a,d.defaultData(b))},this))}a.data&&"string"==typeof a.data.value&&(a.data=JSON.parse(a.data.value));try{magic.runtime.projection=a.data.projection}catch(a){return void magic.modules.Common.showAlertModal("Failed to determine projection - aborting","error")}jQuery.each(this.dialogs,jQuery.proxy(function(b,c){jQuery.isFunction(c.loadContext)&&c.loadContext(a)},this))},magic.classes.creator.AppContainer.prototype.saveContext=function(){var a=!0;if(jQuery.each(this.dialogs,jQuery.proxy(function(b,c){a=a&&c.validate()},this)),a){var b={};jQuery.each(this.dialogs,jQuery.proxy(function(a,c){b=jQuery.extend(!0,b,c.getContext())},this)),jQuery.getJSON("https://cdn.web.bas.ac.uk/magic/json-schemas/web_map_schema.json",jQuery.proxy(function(a){if(tv4.validate(b,a)){var c=b.id,d=jQuery("meta[name='_csrf']").attr("content"),e=jQuery("meta[name='_csrf_header']").attr("content");jQuery.ajax({url:magic.config.paths.baseurl+"/maps/"+(""!=c?"update/"+c:"save"),method:"POST",processData:!1,data:JSON.stringify(b),headers:{"Content-Type":"application/json"},beforeSend:function(a){a.setRequestHeader(e,d)}}).done(function(a){"public"==b.allowed_usage?window.open(magic.config.paths.baseurl+"/home"+(debug?"d":"")+"/"+b.name,"_blank"):window.open(magic.config.paths.baseurl+"/restricted"+(debug?"d":"")+"/"+b.name,"_blank")}).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to save your map - details : "+b,"warning")})}else{var f=JSON.stringify(tv4.error,null,4);magic.modules.Common.showAlertModal("Failed to validate your map data against the web map schema<br/><br/>Detailed explanation of the failure below:<br/><br/>"+f,"error")}},this)).fail(function(a){var b;try{b=JSON.parse(a.responseText).detail}catch(c){b=a.responseText}magic.modules.Common.showAlertModal("Failed to retrieve JSON schema for map - details : "+b,"warning")})}else magic.modules.Common.showAlertModal("Please correct the marked fields before resubmitting","warning")},magic.classes.creator.LayerDictionary=function(){this.dictionary={}},magic.classes.creator.LayerDictionary.prototype.get=function(a){return this.dictionary[a]||{}},magic.classes.creator.LayerDictionary.prototype.put=function(a){return a.id||(a.id=magic.modules.Common.uuid()),this.dictionary[a.id]=a,a.id},magic.classes.creator.LayerDictionary.prototype.del=function(a){delete this.dictionary[a]},magic.classes.creator.MapControlSelector=function(a){this.prefix=a.prefix||"map-controls"},magic.classes.creator.MapControlSelector.prototype.loadContext=function(a,b){var c=a.data.controls;jQuery.isArray(c)&&jQuery.each(c,jQuery.proxy(function(a,b){var c=jQuery("input[type='checkbox'][name='"+this.prefix+"'][value='"+b+"']");c.length>0&&c.prop("checked",!0)},this)),jQuery.each(a.allowed_usage.split(","),jQuery.proxy(function(a,b){var c=jQuery("input[name='"+this.prefix+"-allowed_usage'][value='"+b+"']");c.length>0&&c.prop("checked",!0)},this)),jQuery.each(a.allowed_edit.split(","),jQuery.proxy(function(a,b){var c=jQuery("input[name='"+this.prefix+"-allowed_edit'][value='"+b+"']");c.length>0&&c.prop("checked",!0)},this)),jQuery.each(a.allowed_download.split(","),jQuery.proxy(function(a,b){var c=jQuery("input[name='"+this.prefix+"-allowed_download'][value='"+b+"']");c.length>0&&c.prop("checked",!0)},this)),jQuery("input[name='"+this.prefix+"-repository']").val(a.repository),jQuery("input[type='checkbox'][value='login'][name='"+this.prefix+"-allowed_usage']").off("change").on("change",jQuery.proxy(function(a){var b=jQuery(a.currentTarget);jQuery("input[type='checkbox'][value!='login'][name='"+this.prefix+"-allowed_usage']").each(function(a,c){var d=jQuery(c);d.prop("checked","public"!=d.attr("value")&&!0===b.prop("checked"))})},this)),jQuery("input[type='checkbox'][value='login'][name='"+this.prefix+"-allowed_edit']").off("change").on("change",jQuery.proxy(function(a){var b=jQuery(a.currentTarget);jQuery("input[type='checkbox'][value!='login'][name='"+this.prefix+"-allowed_edit']").each(function(a,c){jQuery(c).prop("checked",!0===b.prop("checked"))})},this)),jQuery("input[type='checkbox'][value='login'][name='"+this.prefix+"-allowed_download']").off("change").on("change",jQuery.proxy(function(a){var b=jQuery(a.currentTarget);jQuery("input[type='checkbox'][value!='login'][name='"+this.prefix+"-allowed_download']").each(function(a,c){var d=jQuery(c);d.prop("checked","public"!=d.attr("value")&&!0===b.prop("checked"))})},this))},magic.classes.creator.MapControlSelector.prototype.defaultData=function(){return{data:{controls:["zoom_world","zoom_in","zoom_out","box_zoom","feature_info","graticule"]},allowed_usage:"public",allowed_edit:"owner",allowed_download:"",repository:""}},magic.classes.creator.MapControlSelector.prototype.getContext=function(){var a={data:{}},b=[],c=jQuery("input[name='"+this.prefix+"']");c.length>0&&jQuery.each(c,function(a,c){var d=jQuery(c);("checkbox"!=d.attr("type")||"checkbox"==d.attr("type")&&!0===d.prop("checked"))&&b.push(d.val())}),a.data.controls=b;var d=jQuery("input[name='"+this.prefix+"-allowed_usage']");if(d.length>0){var e=d.map(function(){var a=jQuery(this);return"checkbox"==a.attr("type")?a.prop("checked")?a.val():null:a.val()}).get();-1!=e.indexOf("login")?a.allowed_usage="login":-1!=e.indexOf("public")?a.allowed_usage="public":a.allowed_usage=e.join(",")}else a.allowed_usage="public";var f=jQuery("input[name='"+this.prefix+"-allowed_edit']");if(f.length>0){var e=f.map(function(){var a=jQuery(this);return"checkbox"==a.attr("type")?a.prop("checked")?a.val():null:a.val()}).get();-1!=e.indexOf("login")?a.allowed_edit="login":a.allowed_edit=e.join(",")}else a.allowed_edit="owner";var g=jQuery("input[name='"+this.prefix+"-allowed_download']");if(g.length>0){var e=g.map(function(){var a=jQuery(this);return"checkbox"==a.attr("type")?a.prop("checked")?a.val():null:a.val()}).get();-1!=e.indexOf("login")?a.allowed_download="login":-1!=e.indexOf("public")?a.allowed_download="public":a.allowed_download=e.join(",")}else a.allowed_download="owner";return a.repository=jQuery("input[name='"+this.prefix+"-repository']").val(),a},magic.classes.creator.MapControlSelector.prototype.validate=function(){return!0},magic.classes.creator.MapLayerSelector=function(a){this.prefix=a.prefix||"layer-selector",this.layerDataEditor=null,this.layerEdits={}},magic.classes.creator.MapLayerSelector.prototype.defaultData=function(a){return{layers:{type:"json",value:JSON.stringify(magic.modules.GeoUtils.defaultEmbeddedLayers(a))}}},magic.classes.creator.MapLayerSelector.prototype.loadContext=function(a){jQuery("#map-layer-selector").closest("div.row").removeClass("hidden");var b=null,c=jQuery("#"+this.prefix+"-list");a.layers&&"json"==a.layers.type&&a.layers.value&&(b=JSON.parse(a.layers.value));var d=c.find("tbody tr");if(d.length>0&&d.remove(),b&&b.length>0){c.removeClass("hidden");for(var e=0;e<b.length;e++)this.layerMarkup(c,b[e]);jQuery(".table-sortable tbody").sortable({handle:"td.layerdata-name",placeholderClass:"fa fa-caret-right"})}else c.addClass("hidden");jQuery("#"+this.prefix+"-layer-add").off("click").on("click",jQuery.proxy(function(a){this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),this.layerDataEditor=new magic.classes.creator.EmbeddedLayerEditorPopup({target:a.currentTarget.id,onSave:jQuery.proxy(this.updateLayerData,this)}),this.layerDataEditor.activate({})},this))},magic.classes.creator.MapLayerSelector.prototype.getContext=function(a){if(a){return{layers:jQuery("#"+this.prefix+"-list").find("tr").map(jQuery.proxy(function(a,b){return this.layerEdits[jQuery(b).data("id")]},this)).get()}}return{}},magic.classes.creator.MapLayerSelector.prototype.validate=function(){return!0},magic.classes.creator.MapLayerSelector.prototype.layerMarkup=function(a,b){var c=magic.modules.Endpoints.getEndpointBy("url",b.wms_source),d=c?c.name:b.wms_source;b.id=b.id||magic.modules.Common.uuid(),this.layerEdits[b.id]=b,a.find("tbody").append('<tr data-id="'+b.id+'"><td class="layerdata-name"><a style="margin-right:5px" href="Javascript:void(0)" data-toggle="tooltip" data-placement="top" title="Click and drag to re-order layer stack"><span class="fa fa-arrows"></span></a>'+b.name+"</td><td>"+d+'</td><td><div class="btn-toolbar" role="toolbar"><div class="btn-group" role="group"><button type="button" class="btn btn-sm btn-warning" id="'+this.prefix+"-"+b.id+'-layer-edit" data-toggle="popover" data-trigger="manual" data-placement="left"><i style="font-size:14px" data-toggle="tooltip" data-placement="top" title="Edit/view selected layer data" class="fa fa-pencil"></i></button><button type="button" class="btn btn-sm btn-danger" id="'+this.prefix+"-"+b.id+'-layer-del"><i data-toggle="tooltip" data-placement="top" title="Delete selected layer" class="fa fa-trash"></i></button></div></div></td></tr>'),jQuery("#"+this.prefix+"-"+b.id+"-layer-edit").off("click").on("click",jQuery.proxy(function(a){var b=a.currentTarget.id.replace(this.prefix+"-","").replace("-layer-edit","");this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),this.layerDataEditor=new magic.classes.creator.EmbeddedLayerEditorPopup({target:a.currentTarget.id,onSave:jQuery.proxy(this.updateLayerData,this)}),this.layerDataEditor.activate(this.layerEdits[b])},this)),jQuery("#"+this.prefix+"-"+b.id+"-layer-del").off("click").on("click",jQuery.proxy(function(a){this.layerDataEditor&&this.layerDataEditor.isActive()&&this.layerDataEditor.deactivate(),bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Ok to remove this layer?</div>',jQuery.proxy(function(c){c&&(delete this.layerEdits[b.id],jQuery(a.currentTarget).closest("tr").remove()),bootbox.hideAll()},this))},this))},magic.classes.creator.MapLayerSelector.prototype.updateLayerData=function(a){if(!a.id){a.id=magic.modules.Common.uuid();var b=jQuery("#"+this.prefix+"-list");this.layerMarkup(b,a)}this.layerEdits[a.id]=a,jQuery(".table-sortable tbody").sortable({handle:"td.layerdata-name",placeholderClass:"fa fa-caret-right"})},magic.classes.creator.MapLayerSelectorTree=function(a){this.OPENER_CSS={display:"inline-block",width:"18px",height:"18px",float:"left","margin-left":"-35px","margin-right":"5px","background-position":"center center","background-repeat":"no-repeat"},this.OPEN_MARKUP='<i class="fa fa-plus" style="font-size:20px"></i>',this.CLOSE_MARKUP='<i class="fa fa-minus" style="font-size:20px"></i>',this.BLANK_MAP_NEW_GROUP={id:null,name:"New layer group",layers:[]},this.BLANK_MAP_NEW_LAYER={id:null,name:"New layer",source:null},this.prefix=a.prefix||"map-layers",this.layerTreeUl=jQuery("#"+this.prefix+"-layertree"),this.layerDictionary=new magic.classes.creator.LayerDictionary,this.currentlyEditing=null,this.layerGroupEditor=new magic.classes.creator.LayerGroupEditor({prefix:this.prefix+"-group",onSave:jQuery.proxy(this.writeGroupData,this),onCancel:jQuery.proxy(this.cancelEdit,this)}),this.layerEditor=new magic.classes.creator.LayerEditor({prefix:this.prefix+"-layer",onSave:jQuery.proxy(this.writeLayerData,this),onCancel:jQuery.proxy(this.cancelEdit,this)})},magic.classes.creator.MapLayerSelectorTree.prototype.defaultData=function(a){return{data:{layers:magic.modules.GeoUtils.defaultLayers(a)}}},magic.classes.creator.MapLayerSelectorTree.prototype.loadContext=function(a){var b=a.data.layers;b.length>0&&(this.layerTreeUl.empty(),this.processLayers(b,this.layerTreeUl,0))},magic.classes.creator.MapLayerSelectorTree.prototype.showContext=function(){this.initSortableList(this.layerTreeUl),jQuery("button.layer-group-delete").off("click").on("click",jQuery.proxy(this.deleteHandler,this)),jQuery("button.layer-group-delete").each(function(a,b){var c=jQuery(b).closest("li").children("ul").find("li").length>0;jQuery(b).prop("disabled",c)}),jQuery("button.layer-group-edit").off("click").on("click",jQuery.proxy(this.editHandler,this)),jQuery("button.layer-delete").off("click").on("click",jQuery.proxy(this.deleteHandler,this)),jQuery("button.layer-edit").off("click").on("click",jQuery.proxy(this.editHandler,this)),jQuery("#"+this.prefix+"-new-group").off("click").on("click",jQuery.proxy(function(a){var b=this.layerDictionary.put(jQuery.extend({},this.BLANK_MAP_NEW_GROUP)),c=this.groupMarkup(b,this.layerDictionary.get(b).name);this.layerTreeUl.append(c),jQuery("<span/>").addClass("sortableListsOpener ignore-drag-item").css(this.OPENER_CSS).on("mousedown",jQuery.proxy(function(a){var b=jQuery(a.currentTarget).closest("li");b.hasClass("sortableListsClosed")?(b.removeClass("sortableListsClosed").addClass("sortableListsOpen"),b.children("ul").css("display","block"),jQuery(a.currentTarget).html(this.CLOSE_MARKUP)):(b.removeClass("sortableListsOpen").addClass("sortableListsClosed"),b.children("ul").css("display","none"),jQuery(a.currentTarget).html(this.OPEN_MARKUP))},this)).html(this.CLOSE_MARKUP).clone(!0).prependTo(c.children("div").first()),c.find("button.layer-group-edit").off("click").on("click",jQuery.proxy(this.editHandler,this)),c.find("button.layer-group-delete").off("click").on("click",jQuery.proxy(this.deleteHandler,this))},this)),jQuery("#"+this.prefix+"-new-layer").off("click").on("click",jQuery.proxy(function(a){var b=this.layerDictionary.put(jQuery.extend({},this.BLANK_MAP_NEW_LAYER)),c=this.layerMarkup(b,this.layerDictionary.get(b).name);this.layerTreeUl.append(c),c.find("button.layer-edit").off("click").on("click",jQuery.proxy(this.editHandler,this)),c.find("button.layer-delete").off("click").on("click",jQuery.proxy(this.deleteHandler,this))},this))},magic.classes.creator.MapLayerSelectorTree.prototype.editHandler=function(a){var b=jQuery(a.currentTarget),c=jQuery("#"+this.prefix+"-update-panel");c.parent().removeClass("hidden"),c.show(),null!=this.currentlyEditing&&this.currentlyEditing.isActive()&&this.currentlyEditing.isDirty()?bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">You have unsaved changes - proceed?</div>',jQuery.proxy(function(a){a&&this.showEditor(b),bootbox.hideAll()},this)):this.showEditor(b)},magic.classes.creator.MapLayerSelectorTree.prototype.deleteHandler=function(a){var b=jQuery(a.currentTarget),c=b.closest("li").attr("id"),d=b.parent().children("button").first().text();bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete '+d+"</div>",jQuery.proxy(function(a){if(a){var b=jQuery("#"+c).parents("li.list-group-item-heading").first();null!=b&&1==b.find("ul").children("li").length&&b.find("button.layer-group-delete").prop("disabled",!1),jQuery("#"+c).remove(),this.layerDictionary.del(c),jQuery("#"+this.prefix+"-update-panel").fadeOut("slow"),bootbox.hideAll()}else bootbox.hideAll()},this))},magic.classes.creator.MapLayerSelectorTree.prototype.showEditor=function(a){if(a.hasClass("layer-group-edit")){jQuery("#"+this.prefix+"-group-div").removeClass("hidden"),jQuery("#"+this.prefix+"-layer-div").addClass("hidden");var b=this.layerDictionary.get(a.closest("li").attr("id"));jQuery("#"+this.prefix+"-update-panel-title").html("Layer group : "+b.name),this.layerGroupEditor.loadContext(b),this.currentlyEditing=this.layerGroupEditor}else{jQuery("#"+this.prefix+"-layer-div").removeClass("hidden"),jQuery("#"+this.prefix+"-group-div").addClass("hidden");var b=this.layerDictionary.get(a.closest("li").attr("id"));jQuery("#"+this.prefix+"-update-panel-title").html("Data layer : "+b.name),this.layerEditor.loadContext(b),this.currentlyEditing=this.layerEditor}},magic.classes.creator.MapLayerSelectorTree.prototype.getContext=function(a){if(!a){var b=[],c=this.layerTreeUl.sortableListsToHierarchy();return this.sortLayers(b,c),{data:{layers:b}}}return{}},magic.classes.creator.MapLayerSelectorTree.prototype.sortLayers=function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=this.layerDictionary.get(d.id);"children"in d&&!("source"in e)?(this.layerDictionary.get(d.id).layers=[],this.sortLayers(this.layerDictionary.get(d.id).layers,d.children),a.push(this.layerDictionary.get(d.id))):a.push(e)}},magic.classes.creator.MapLayerSelectorTree.prototype.validate=function(){return!0},magic.classes.creator.MapLayerSelectorTree.prototype.initSortableList=function(a){a.sortableLists({placeholderCss:{"background-color":"#fcf8e3",border:"2px dashed #fce04e"},hintCss:{"background-color":"#dff0d8",border:"2px dashed #5cb85c"},isAllowed:jQuery.proxy(this.allowedDragHandler,this),listSelector:"ul",listsClass:"list-group",insertZone:50,opener:{active:!0,as:"html",close:this.CLOSE_MARKUP,open:this.OPEN_MARKUP,openerCss:this.OPENER_CSS},ignoreClass:"ignore-drag-item",onDragStart:jQuery.proxy(function(a,b){console.log("=== onDragStart handler entered ==="),console.log("--\x3e Dragged element"),console.log(b);var c=jQuery(b).parents("li.list-group-item-heading").first();console.log("--\x3e First parent li with class list-group-item-heading"),console.log(c),this.originalParent=c.length>0?c:null,console.log("--\x3e Original parent set"),console.log(this.originalParent),console.log("=== onDragStart handler exited ===")},this),onChange:jQuery.proxy(function(a){console.log("=== onChange handler entered ==="),console.log("--\x3e Dragged element according to onChange"),console.log(a);var b=jQuery(a),c=b.parents("li.list-group-item-heading").first();if(console.log("--\x3e First parent li with class list-group-item-heading according to onChange"),console.log(c),c.length>0){console.log("--\x3e Disabling group delete button..."),c.find("button.layer-group-delete").prop("disabled",!0),console.log("--\x3e Done");var d=c.find("div.btn-toolbar").first();if(d.length>0){console.log("--\x3e Button toolbar"),console.log(d);var e=d.next();if(console.log("--\x3e Opener"),console.log(e),e.length>0&&e.hasClass("sortableListsOpener")){console.log("--\x3eSortableListsOpener found, swapping positions");var f=e.clone(!0);console.log("--\x3e Cloned"),e.remove(),console.log("--\x3e Removed from DOM"),f.insertBefore(d),console.log("--\x3e Clone now inserted")}}}null!=this.originalParent&&(0==this.originalParent.find("ul").children("li").length&&this.originalParent.find("button.layer-group-delete").prop("disabled",!1),this.originalParent=null),console.log("=== onChange handler exited ===")},this)})},magic.classes.creator.MapLayerSelectorTree.prototype.processLayers=function(a,b,c){for(var d=0;d<a.length;d++){var e=this.layerDictionary.put(a[d]);if(jQuery.isArray(a[d].layers)){var f=this.groupMarkup(e,a[d].name);b.append(f),this.processLayers(a[d].layers,f.children("ul"),c+1)}else b.append(this.layerMarkup(e,a[d].name))}},magic.classes.creator.MapLayerSelectorTree.prototype.allowedDragHandler=function(a,b,c){console.log("=== allowedDragHandler entered"),console.log("--\x3e Currently dragging"),console.log(a),console.log("--\x3e Hint"),console.log(b),console.log("--\x3e Target"),console.log(c);var d=!1;if(null==c||jQuery.isEmptyObject(c)||jQuery.isArray(c)&&0==c.length)return!1;console.log("--\x3e Set hint style green"),this.setHintStyle(b,!0),console.log("--\x3e Done");var e=b.parents("li").first();return e&&(console.log("--\x3e Found drop zone"),console.log(e),e.length>0&&e[0].id?(console.log("--\x3e Dropzone id is "+e[0].id+" and is a layer group"),d=!jQuery.isEmptyObject(this.layerDictionary.get(e[0].id))&&jQuery.isArray(this.layerDictionary.get(e[0].id).layers)):0!=e.length||a.hasClass("list-group-item-info")||(console.log("--\x3e This is a group dropped at the top level"),d=!0)),d||(console.log("--\x3e Disallowing, so set hint style to red"),this.setHintStyle(b,!1)),console.log("=== allowedDragHandler exited, returning "+d),d},magic.classes.creator.MapLayerSelectorTree.prototype.groupMarkup=function(a,b){return jQuery('<li class="list-group-item list-group-item-heading sortableListsClosed" id="'+a+'"><div><div class="btn-toolbar ignore-drag-item" role="toolbar"><div class="btn-group ignore-drag-item" role="group" style="width:100%;display:flex"><button style="flex:1" type="button" class="btn btn-info ignore-drag-item name-area">'+b+'</button><button style="width:40px" type="button" class="btn btn-warning layer-group-edit ignore-drag-item" data-container="body" data-toggle="tooltip" data-placement="top" title="Edit layer group data"><i class="fa fa-pencil ignore-drag-item"></i></button><button style="width:40px" type="button" class="btn btn-danger layer-group-delete ignore-drag-item" data-container="body" data-toggle="tooltip" data-placement="top" title="Delete layer group"><i class="fa fa-times ignore-drag-item"></i></button></div></div></div><ul class="list-group" style="display:none"></ul></li>')},magic.classes.creator.MapLayerSelectorTree.prototype.layerMarkup=function(a,b){return jQuery('<li class="list-group-item list-group-item-info" id="'+a+'"><div class="class="btn-toolbar ignore-drag-item" role="toolbar"><div class="btn-group ignore-drag-item" role="group" style="display:flex"><button style="flex:1" type="button" class="btn btn-info ignore-drag-item name-area">'+b+'</button><button style="width:40px" type="button" class="btn btn-warning layer-edit ignore-drag-item" data-container="body" data-toggle="tooltip" data-placement="top" title="Edit layer data"><i class="fa fa-pencil ignore-drag-item"></i></button><button style="width:40px" type="button" class="btn btn-danger layer-delete ignore-drag-item" data-container="body" data-toggle="tooltip" data-placement="top" title="Delete layer"><i class="fa fa-times ignore-drag-item"></i></button></div></div></li>')},magic.classes.creator.MapLayerSelectorTree.prototype.writeGroupData=function(a){this.layerDictionary.put(a),jQuery("#"+a.id).find("button.name-area").first().text(a.name),jQuery("#"+this.prefix+"-update-panel").fadeOut("slow")},magic.classes.creator.MapLayerSelectorTree.prototype.writeLayerData=function(a){this.layerDictionary.put(a),jQuery("#"+a.id).find("button.name-area").first().text(a.name),jQuery("#"+this.prefix+"-update-panel").fadeOut("slow")},magic.classes.creator.MapLayerSelectorTree.prototype.cancelEdit=function(){magic.modules.Common.resetFormIndicators(),jQuery("[id$='-update-panel']").fadeOut("slow")},magic.classes.creator.MapLayerSelectorTree.prototype.setHintStyle=function(a,b){b?a.css("background-color","#dff0d8").css("border","2px dashed #5cb85c"):a.css("background-color","#f2dede").css("border","2px dashed #d9534f")},magic.classes.creator.MapMetadataForm=function(a){this.formSchema=a.formSchema,this.prefix=a.prefix||"map-metadata"},magic.classes.creator.MapMetadataForm.prototype.defaultData=function(a){var b={};return jQuery.each(this.formSchema,jQuery.proxy(function(a,c){b[c.field]=c.default},this)),b},magic.classes.creator.MapMetadataForm.prototype.loadContext=function(a){jQuery("#"+this.prefix+"-form").closest("div.row").removeClass("hidden"),magic.modules.Common.jsonToForm(this.formSchema,a,this.prefix)},magic.classes.creator.MapMetadataForm.prototype.getContext=function(){return jQuery("#"+this.prefix+"-form").closest("div.row").removeClass("hidden"),magic.modules.Common.formToJson(this.formSchema,this.prefix)},magic.classes.creator.MapMetadataForm.prototype.validate=function(){var a=!0;return jQuery.each(this.formSchema,jQuery.proxy(function(b,c){var d=jQuery("#"+this.prefix+"-"+c.field),e=d.closest("div.form-group");!1===d[0].checkValidity()?(e.addClass("has-error"),a=!1):e.removeClass("has-error")},this)),a},magic.classes.creator.MapParameterSelector=function(a){this.prefix=a.prefix||"map-parameters",this.embedded=a.embedded,this.map=null},magic.classes.creator.MapParameterSelector.prototype.defaultData=function(a){var b=magic.modules.GeoUtils.DEFAULT_MAP_PARAMS[a];return this.embedded?b:{data:b}},magic.classes.creator.MapParameterSelector.prototype.loadContext=function(a){if(jQuery("#"+this.prefix+"-selector").closest("div.row").removeClass("hidden"),!a)return void magic.modules.Common.showAlertModal("No default map parameters supplied","error");this.renderMap(this.embedded?a:a.data)},magic.classes.creator.MapParameterSelector.prototype.showContext=function(){this.map&&this.map.updateSize()},magic.classes.creator.MapParameterSelector.prototype.renderMap=function(a){var b=!1;if(this.map){b=a.projection!=this.map.getView().getProjection().getCode()}if(b||!this.map){this.map=null,jQuery("#"+this.prefix+"-selector-map").children().remove();var c=ol.proj.get(a.projection),d=null,e=parseFloat(a.rotation);e=isNaN(e)?0:Math.PI*e/180,"string"==typeof a.center&&(a.center=JSON.parse(a.center)),"string"==typeof a.proj_extent&&(a.proj_extent=JSON.parse(a.proj_extent)),"string"==typeof a.resolutions&&(a.resolutions=JSON.parse(a.resolutions)),jQuery("#"+this.prefix+"-rotation").val(a.rotation);for(var f,g=[],h=magic.modules.Endpoints.getEndpointsBy("srs",a.projection),i=0;i<h.length;i++)if(h[i].coast_layers){f=h[i];break}if(!f)return void magic.modules.Common.showAlertModal("No endpoint service defined for projection "+a.projection,"error");if("osm"==f.url)g.push(magic.modules.Endpoints.getMidLatitudeCoastLayer()),d=new ol.View({center:a.center,minZoom:1,maxZoom:20,rotation:e,zoom:parseInt(a.zoom),projection:c});else{c.setExtent(a.proj_extent),c.setWorldExtent(a.proj_extent);var j=f.coast_layers.split(",");jQuery.each(j,function(b,d){var e=new ol.source.TileWMS({url:f.url,params:{LAYERS:d,CRS:c.getCode(),SRS:c.getCode(),VERSION:"1.3.0",TILED:!0},tileGrid:new ol.tilegrid.TileGrid({resolutions:a.resolutions,origin:c.getExtent().slice(0,2)}),projection:c});g.push(new ol.layer.Tile({visible:!0,opacity:1,source:e}))});var k=[new ol.control.ZoomSlider,new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-top",units:"metric"}),new ol.control.ScaleLine({minWidth:100,className:"custom-scale-line-bottom",units:"imperial"}),new ol.control.MousePosition({projection:"EPSG:4326",className:"custom-mouse-position",coordinateFormat:function(a){return"Lon : "+a[0].toFixed(2)+", lat : "+a[1].toFixed(2)}})],l=null,m=f.graticule_layer;if(m){var n=new ol.source.ImageWMS({url:f.url,params:{LAYERS:m},projection:c});g.push(new ol.layer.Image({visible:!0,opacity:1,source:n}))}d=new ol.View({center:a.center,maxResolution:a.resolutions[0],resolutions:a.resolutions,rotation:e,zoom:parseInt(a.zoom),projection:c})}this.map=new ol.Map({renderer:"canvas",loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0,layers:g,controls:k,interactions:ol.interaction.defaults(),view:d,target:this.prefix+"-selector-map"}),null!=l&&l.setMap(this.map)}jQuery("#"+this.prefix+"-rotation-set").off("click").on("click",jQuery.proxy(function(a){var b=jQuery("#"+this.prefix+"-rotation").val();if(!isNaN(b)&&this.map){var c=Math.PI*b/180;this.map.getView().setRotation(c)}},this))},magic.classes.creator.MapParameterSelector.prototype.getContext=function(){var a=this.map.getView(),b=parseFloat(jQuery("#"+this.prefix+"-rotation").val()),c={center:a.getCenter(),zoom:parseInt(a.getZoom()),projection:a.getProjection().getCode(),proj_extent:a.getProjection().getExtent(),resolutions:a.getResolutions(),rotation:isNaN(b)?0:b};return this.embedded?c:{data:c}},magic.classes.creator.MapParameterSelector.prototype.validate=function(){return!0},magic.classes.creator.MapRegionSelector=function(a){this.loadContextCb=a.contextLoader||null,this.prefix=a.prefix||"region-select",this.mapTitleService=a.mapTitleService||magic.config.paths.baseurl+"/maps/dropdown",this.mapDataService=a.mapDataService||magic.config.paths.baseurl+"/maps/name",this.currentMapId="",jQuery("input[name$='action-rb']").click(jQuery.proxy(function(a){var b=jQuery(a.currentTarget);jQuery.each(["new","edit","clone"],jQuery.proxy(function(a,c){if(c==b.val()){var d=jQuery("#"+this.prefix+"-"+c);d.prop("disabled",!1);var e="";if("edit"==c){var f=window.location.search;f&&f.match(/\?name=[a-z0-9_]+$/)&&(e=f.substring(6))}"edit"!=c&&"clone"!=c||(d.find("option").remove(),jQuery.getJSON(this.mapTitleService+"/"+c,jQuery.proxy(function(a){if(magic.modules.Common.populateSelect(d,a,"name","title",e,!0),magic.modules.Common.resetFormIndicators(),e&&"edit"==c){jQuery.grep(a,function(a){return a.name==e}).length>0?this.loadContext(c,e):magic.modules.Common.showAlertModal("You are not allowed to edit the map "+e,"error")}},this)).fail(function(a,b,c){magic.modules.Common.showAlertModal("Failed to get map titles - error was : "+c,"error")}))}else jQuery("#"+this.prefix+"-"+c).prop("disabled",!0)},this))},this)),jQuery("select.map-select").change(jQuery.proxy(function(a){var b=jQuery(a.currentTarget),c=b.attr("id").split("-").pop(),d=b.val();magic.modules.Common.resetFormIndicators(),this.loadContext(c,d)},this));var b=window.location.search;b&&b.match(/\?name=[a-z0-9_]+$/)&&jQuery("#"+this.prefix+"-edit-rb").trigger("click")},magic.classes.creator.MapRegionSelector.prototype.loadContext=function(a,b){"new"==a?(this.currentMapId="",this.loadContextCb(null,jQuery("#"+this.prefix+"-new").val())):b&&jQuery.getJSON(this.mapDataService+"/"+b,jQuery.proxy(function(b){"clone"==a&&(b.name+="_copy"),this.currentMapId="edit"==a?b.id:"",this.loadContextCb(b,null)},this)).fail(function(a,c,d){magic.modules.Common.showAlertModal("Failed to get map data for "+b+" - details : "+d,"error")})},magic.classes.creator.MapRegionSelector.prototype.validate=function(a,b){var c=jQuery("input[type='radio'][name='_"+this.prefix+"-action-rb']:checked");if(!c)return!1;var d=jQuery("#"+this.prefix+"-"+c.val());return!(0==d.length||d.length>0&&""==d.val())};