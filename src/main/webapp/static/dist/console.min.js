var magic={config:{paths:{baseurl:window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),cdn:"https://cdn.web.bas.ac.uk/magic"}},modules:{creator:{}},classes:{creator:{},console:{}},runtime:{creator:{catalogues:{}},capabilities:{},filters:{},pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")},getScripts:function(a,b){var c=0;a.forEach(function(d){jQuery.getScript(d,function(){++c==a.length&&b()})})},preferences:{coordinate:"dd",elevation:"m",date:"Y-m-d"}}};setInterval("magic.runtime.pingSession()",3e6),magic.modules.Endpoints=function(){return{parseUri:function(a){for(var b={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},c=b.parser[b.strictMode?"strict":"loose"].exec(a),d={},e=14;e--;)d[b.key[e]]=c[e]||"";return d[b.q.name]={},d[b.key[12]].replace(b.q.parser,function(a,c,e){c&&(d[b.q.name][c]=e)}),d},getVirtualService:function(a){var b="",c=/\/geoserver\/([^\/]+)\/wms/,d=c.exec(a);return null!=d&&(b=d[1]),b},getWmsProxiedUrl:function(a){var b=this.getEndpointBy("url",a);return b&&b.proxied_url?b.proxied_url:null},getWmsServiceUrl:function(a){var b=this.getEndpointBy("name",a);return b?b.url:null},getOgcEndpoint:function(a,b){var c=a,d=this.getEndpointsBy("url",a);return jQuery.isArray(d)&&d.length>0?c=!0===d[0].is_user_service?magic.config.paths.baseurl+"/ogc/user/"+b:magic.config.paths.baseurl+"/ogc/"+d[0].id+"/"+b:(console.log(a+" does not correspond to a known endpoint - need to proxy"),c=magic.modules.Common.proxyUrl(a)),c},getEndpointBy:function(a,b){var c=this.getEndpointsBy(a,b);return c.length>0?c[0]:null},getUserDataEndpoint:function(){if(!magic.runtime.endpoints)return null;var a=jQuery.grep(magic.runtime.endpoints,function(a){return!0===a.is_user_service});return 0==a.length?null:a[0]},getEndpointsBy:function(a,b){if(!magic.runtime.endpoints||!a||!b)return null;var c=null;return"url"==a&&(c=this.parseUri(b)),jQuery.grep(magic.runtime.endpoints,jQuery.proxy(function(d){if("id"==a)return d[a]==b;if("url"==a){var e=this.parseUri(d[a]),f=c.protocol==e.protocol&&c.host==e.host&&c.port==e.port;if(f&&""!=c.path&&""!=e.path&&(f=0==c.path.indexOf(e.path)),!f&&d.url_aliases)for(var g=d.url_aliases.split(","),h=0;!f&&h<g.length;h++){var i=this.parseUri(g[h]);f=c.protocol==i.protocol&&c.host==i.host&&c.port==i.port,f&&""!=c.path&&""!=i.path&&(f=0==c.path.indexOf(i.path))}return f}if("srs"==a){return d[a].toLowerCase().split(",").indexOf(b.toLowerCase())>=0}return 0==d[a].toLowerCase().indexOf(b.toLowerCase())},this))},getMidLatitudeCoastLayer:function(){var a=null,b=this.getEndpointBy("name","midlatitude");if(null!=b&&"osm"!=b.url){var c=null;-1!=b.coast_layers.indexOf(":")&&(c=b.coast_layers.split(":").shift()),a=new ol.layer.Tile({source:new ol.source.TileWMS({url:b.url,params:{LAYERS:b.coast_layers,CRS:"EPSG:3857",SRS:"EPSG:3857",VERSION:"1.3.0",WORKSPACE:c},projection:"EPSG:3857"})})}else a=new ol.layer.Tile({source:new ol.source.OSM({wrapX:!1})});return a},getMidLatitudeCoastSource:function(a){var b=this.getEndpointBy("name","midlatitude"),c={wms_source:b&&"osm"!=b.url?b.url:"osm",feature_name:b&&"osm"!=b.url?b.coast_layers:"osm",is_base:!0};return jQuery.extend({id:null,name:"Mid-latitude data",is_visible:!0},a?c:{source:c})}}}(),magic.modules.Common=function(){return{inches_per_unit:{ins:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36,nmi:1852*39.37},default_styles:{Point:{image:"circle",radius:5,fill:"rgba(255,255,0,0.5)",stroke:"#ff0",width:1},LineString:{stroke:"#f00",width:3},Polygon:{fill:"rgba(0,255,255,0.5)",stroke:"#0ff",width:1},MultiPoint:{image:"circle",radius:5,fill:"rgba(255,0,255,0.5)",stroke:"#f0f",width:1},MultiLineString:{stroke:"#0f0",width:3},MultiPolygon:{fill:"rgba(0,0,255,0.5)",stroke:"#00f",width:1}},color_palette:["#FF6403","#800000","#DD0907","#F20884","#4700A5","#0000D3","#02ABEA","#1FB714","#006412","#562C05","#90713A","#808080","#404040","#000000"],rgbToDec:function(rgb,opacity){rgb=rgb||"#000000",opacity=jQuery.isNumeric(opacity)?opacity:1,rgb=eval("0x"+rgb.replace(/#/,""));var components={r:(16711680&rgb)>>16,g:(65280&rgb)>>8,b:255&rgb};return"rgba("+components.r+","+components.g+","+components.b+","+opacity+")"},scrollViewportToElement:function(a){var b=a.getBoundingClientRect();b.bottom>window.innerHeight&&a.scrollIntoView(!1),b.top<0&&a.scrollIntoView()},buttonFeedbackSet:function(a,b,c,d,e){return c||(c="sm"),d||(d="Save"),'<div class="btn-toolbar col-'+c+'-12" role="toolbar" style="margin-bottom:10px"><div class="btn-group btn-group-'+c+'"><button id="'+a+'-go" class="btn btn-'+c+' btn-primary" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="'+b+'"><span class="fa fa-floppy-o"></span> '+d+'</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-ok" class="btn btn-'+c+' btn-success" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Ok"><span class="fa fa-check post-ok"></span> Ok</button></div><div class="btn-group btn-group-'+c+'"><button id="'+a+'-fb-error" class="btn btn-'+c+' btn-danger" style="display:none" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="top" title="Error"><span class="fa fa-times post-error"></span> Error</button></div>'+(!0===e?'<div class="btn-group btn-group-'+c+'"><button id="'+a+'-cancel" class="btn btn-'+c+' btn-danger" type="button" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="Cancel"><span class="fa fa-times-circle"></span> Cancel</button></div>':"")+"</div>"},buttonClickFeedback:function(a,b,c){var d,e=jQuery("#"+a+"-go"),f=jQuery("#"+a+"-fb-ok"),g=jQuery("#"+a+"-fb-error");e.hide(),b?(f.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return f.fadeIn(300).delay(1200).fadeOut(300)}):(g.attr("data-original-title",c).tooltip("fixTitle"),d=function(){return g.fadeIn(600).delay(6e3).fadeOut(600)}),jQuery.when(d()).done(function(){e.show()})},fetchStyle:function(a,b,c){var d=this.default_styles[a];if(d){var e={};return a.toLowerCase().indexOf("point")>=0?e.image=this.getPointImageStyle(b):a.toLowerCase().indexOf("linestring")>=0?e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1}):(e.fill=new ol.style.Fill({color:this.rgbToDec(this.color_palette[b],.5)}),e.stroke=new ol.style.Stroke({color:this.rgbToDec(this.color_palette[b]),width:d.width||1})),c&&(e.text=new ol.style.Text({font:"Arial",scale:1.2,offsetX:10,text:c,textAlign:"left",fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[b])}),stroke:new ol.style.Stroke({color:"#ffffff",width:1})})),[new ol.style.Style(e)]}return null},getPointImageStyle:function(a){var b=a%4;return 0==b?new ol.style.Circle({fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),radius:5,stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):1==b?new ol.style.RegularShape({rotation:0,points:5,radius1:7,radius2:2,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):2==b?new ol.style.RegularShape({points:4,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):3==b?new ol.style.RegularShape({points:3,radius:5,fill:new ol.style.Fill({color:this.rgbToDec(this.color_palette[a],.5)}),stroke:new ol.style.Stroke({color:this.rgbToDec(this.color_palette[a]),width:1})}):void 0},labelVisibility:function(a,b,c,d){if(!a.get("_ignoreHovers")){var e=null;if(a.getStyleFunction())e=jQuery.proxy(a.getStyleFunction(),a)()[0];else if(a.getStyle())e=a.getStyle();else if(jQuery.isFunction(b.getStyleFunction)&&b.getStyleFunction()){var f=b.getStyleFunction()(a,0);e=jQuery.isArray(f)?f[0]:f}else jQuery.isFunction(b.getStyle)&&b.getStyle()&&(e=b.getStyle());if(e&&e.getText()){var g=e.clone(),h=g.getText();if(h&&h.getText()){var i=h.getText();c?h.setText(i+(d>1?" (+"+(d-1)+")":"")):h.setText(i.replace(/\s+\(\+\d+\)$/,""));var j=h.getStroke(),k=j.getColor();jQuery.isArray(k)?(k[3]=c?"1.0":"0.0",j.setColor(k)):j.setColor(k.substring(0,k.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")");var l=h.getFill(),m=l.getColor();jQuery.isArray(m)?(m[3]=c?"1.0":"0.0",l.setColor(m)):l.setColor(m.substring(0,m.lastIndexOf(",")+1)+(c?"1.0":"0.0")+")"),a.setStyle(g),a.changed()}}}},proxyUrl:function(a){var b=a;return 0!=a.indexOf(window.location.protocol+"//"+window.location.hostname)&&(b=magic.config.paths.baseurl+"/proxy?url="+encodeURIComponent(a)),b},getWxsRequestUrl:function(a,b,c){var d="";switch(b.toLowerCase()){case"getcapabilities":d=magic.modules.Endpoints.getOgcEndpoint(a,"wms")+(-1!=a.indexOf("?")?"&":"?")+"request=GetCapabilities&service=wms";break;case"describefeaturetype":d=magic.modules.Endpoints.getOgcEndpoint(a,"wfs")+"?version=1.0.0&request=DescribeFeatureType&typename="+c}return d},getCapabilities:function(a,b,c){if(magic.runtime.map_context.capabilities[a])b(magic.runtime.map_context.capabilities[a],c);else{var d=new ol.format.WMSCapabilities;jQuery.get(this.getWxsRequestUrl(a,"GetCapabilities"),jQuery.proxy(function(e){try{var f=jQuery.parseJSON(JSON.stringify(d.read(e)));if(f){var g=null;if("Capability"in f&&"Layer"in f.Capability&&"Layer"in f.Capability.Layer&&jQuery.isArray(f.Capability.Layer.Layer)){var h=f.Capability.Layer.Layer;g={},this.getFeatureTypes(g,h)}null!=g?(magic.runtime.map_context.capabilities[a]=g,b(magic.runtime.map_context.capabilities[a],c)):b(null,c,"No feature types found in GetCapabilities response from "+a)}else b(null,c,"Malformed GetCapabilities response from "+a)}catch(d){b(null,c,"Parsing GetCapabilities response from "+a+" failed with error "+d.message)}},this)).fail(function(d,e,f){var g="Failed to WMS GetCapabilities document from "+a+", error was : "+f;401==e&&(g="Not authorised to retrieve WMS GetCapabilities document from "+a),b(null,c,g)})}},defaultMouseover:function(a){var b=0,c=!1,d=null;return a.map.forEachFeatureAtPixel(a.pixel,jQuery.proxy(function(a,e){if(null!=e&&!0!==a.get("_ignoreHovers"))return!0===a.get("_customHover")?(d=null,c=!0):0==b&&(d={feature:a,layer:e}),b++,c},this)),!c&&b>0&&this.labelVisibility(d.feature,d.layer,!0,b),jQuery("#"+a.map.getTarget()).css("cursor",d?"pointer":"help"),d},defaultMouseout:function(a){a&&a.feature&&!0!==a.feature.get("_customHover")&&this.labelVisibility(a.feature,a.layer,!1,1)},featuresAtPixel:function(a){var b=[];return a.map.forEachFeatureAtPixel(a.pixel,function(a,c){if(null!=c){var d=a.get("features");if(d&&jQuery.isArray(d))jQuery.each(d,function(a,d){if(!d.get("ignoreClicks")&&d.getGeometry()){var e=d.getProperties();b.push(jQuery.extend({},e,{layer:c}))}});else if(!a.get("_ignoreClicks")&&a.getGeometry()){var e=a.getProperties();b.push(jQuery.extend({},e,{layer:c}))}}},{layerFilter:function(a){return a.getVisible()&&a.get("metadata")&&!0===a.get("metadata").is_interactive}},this),b},getFeatureTypes:function(a,b){jQuery.each(b,jQuery.proxy(function(b,c){"Name"in c?a[c.Name]=c:"Layer"in c&&jQuery.isArray(c.Layer)&&this.getFeatureTypes(a,c.Layer)},this))},populateSelect:function(a,b,c,d,e,f){var g=null;a.find("option").remove(),!0===f&&a.append(jQuery("<option>",{value:"",selected:""==e?" selected":"",text:"Please select"})),b.sort(function(a,b){var e=a[d]?a[d].toLowerCase():a[c].toLowerCase(),f=b[d]?b[d].toLowerCase():b[c].toLowerCase();return e<f?-1:e>f?1:0}),jQuery.each(b,function(b,f){var h=jQuery("<option>",{value:f[c]}),i=f[d]||f[c];h.text(i),a.append(h),e&&f[c]==e&&(g=h)}),null!=g&&g.prop("selected","selected")},jsonToForm:function(a,b,c){jQuery.each(a,function(a,d){var e=d.field,f=d.default,g=jQuery("#"+c+"-"+e),h="object"==typeof b[e]?JSON.stringify(b[e]):b[e];"checkbox"==g.attr("type")||"radio"==g.attr("type")?g.prop("checked",b&&e in b?!0===h:f):"url"==g.attr("type")?g.val(b?e in b?h:"":f):g.val(b&&e in b?h:f)})},formToJson:function(a,b){var c={};return jQuery.each(a,function(a,d){var e=d.field,f=jQuery("#"+b+"-"+e);switch(f.attr("type")){case"checkbox":case"radio":c[e]=!!f.prop("checked");break;default:var g=f.val();"number"==f.attr("type")&&jQuery.isNumeric(g)&&(g=Math.floor(g)==g?parseInt(g):parseFloat(g)),f.attr("required")&&""==g?c[e]=d.default:c[e]=g}}),c},flagInputError:function(a){var b=a.closest("div.form-group");b&&b.addClass("has-error")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'"><p>A problem occurred - more details below:</p><p>'+a+"</p></div>")},resetFormIndicators:function(){jQuery("div.form-group").removeClass("has-error")},getScript:function(a,b){jQuery.ajax({type:"GET",url:a,success:b,dataType:"script",cache:!0})},csvToArray:function(a){var b,c="",d=[""],e=[d],f=0,g=0,h=!0;for(b in a)b=a[b],'"'===b?(h&&b===c&&(d[f]+=b),h=!h):","===b&&h?b=d[++f]="":"\n"===b&&h?("\r"===c&&(d[f]=d[f].slice(0,-1)),d=e[++g]=[b=""],f=0):d[f]+=b,c=b;return e},sortedUniqueArray:function(a){var b=[];if(!a||0==a.length)return b;var c={};return b=jQuery.map(a,function(a){return a in c?null:(c[a]=1,a)}),b.sort(),b},isUrl:function(a){if("string"==typeof a){var b=/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/g;return a.match(b)}return!1},isNameLike:function(a){a=a.toLowerCase();for(var b=["^name.*$","^callsign$","^[^n]*name$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLongitudeLike:function(a){a=a.toLowerCase();for(var b=["^lon.*$","^x$","^xcoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isLatitudeLike:function(a){a=a.toLowerCase();for(var b=["^lat.*$","^y$","^ycoord.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},isDatetimeLike:function(a){a=a.toLowerCase();for(var b=["^date.*$","^time.*$","^utc$","^[^u]*update.*$"],c=0;c<b.length;c++){if(new RegExp(b[c]).test(a))return!0}return!1},dateFormat:function(a,b){var c=a,d=new Date(a);if(-1==a.toLowerCase().indexOf("invalid")){var e=d.getDate();e=(e<10?"0":"")+e;var f=d.getMonth()+1;f=(f<10?"0":"")+f;var g=d.getFullYear();c="dmy"==b?e+"-"+f+"-"+g:g+"-"+f+"-"+e}return c},fileSize:function(a){var b=Math.log(a)/Math.log(1024)|0;return(a/Math.pow(1024,b)).toFixed(2)+" "+(0==b?"bytes":"kMGTPEZY"[b-1]+"B")},JsonEscape:function(a){var b=a.replace(/\&/g,"&amp;");return b=b.replace(/\"/g,"&quot;")},JsonUnescape:function(a){var b=a.replace(/\&quot;/g,'"');return b=b.replace(/\&amp;/g,"&")},linkify:function(a,b){if(!a)return"";if("string"==typeof a){if(-1!=a.indexOf("<a"))return a;if(a.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>';if(a.match(/^https?:\/\//)&&a.indexOf("?")>0){if(a.substring(0,a.indexOf("?")).match(/\.(jpg|jpeg|png|gif)$/))return'<img src="'+a+'"></img>'}var c=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,d=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/\w+@[a-zA-Z_]+?(?:\.[a-zA-Z]{2,6})+/gim;return b?a.replace(c,'<a href="$&" title="$&" target="_blank">'+b+"</a>").replace(d,'$1<a href="http://$2" target="_blank">'+b+"</a>").replace(e,'<a href="mailto:$&">'+b+"</a>"):a.replace(c,'<a href="$&" title="$&" target="_blank">[external resource]</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$&">$&</a>')}return a},chunk:function(a,b){return void 0===b&&(b=2),a.match(RegExp(".{1,"+b+"}","g")).join("<br>")},ellipsis:function(a,b){if(a.length<=b)return a;var c=a.substr(0,b),d=c.lastIndexOf(" ");return c=-1==d||d<b/2?c.substr(0,b-3)+"...":c.substr(0,d)+"..."},stringDivider:function(a,b,c){if(a.length>b){for(var d=b;d>0&&" "!=a[d]&&"-"!=a[d];d--);if(d>0){var e;e="-"==a.substring(d,d+1)?a.substring(0,d+1):a.substring(0,d);var f=a.substring(d+1);return e+c+stringDivider(f,b,c)}}return a},objectLength:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},initCap:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},unitConverter:function(a,b,c,d){d=d||1;var e=0,f=b,g=c;return f in this.inches_per_unit&&g in this.inches_per_unit&&(1==d||2==d)&&(e=a*Math.pow(this.inches_per_unit[f]/this.inches_per_unit[g],d),e=e.toFixed(3)+" "+g+(2==d?"<sup>2</sup>":"")),e},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},toRadians:function(a){return a*Math.PI/180},toDegrees:function(a){return 180*a/Math.PI},floatsEqual:function(a,b,c){return Math.abs(a-b)<=c},floatInRange:function(a,b,c,d){return(a>b||Math.abs(a-b)<=d)&&(a<c||Math.abs(a-c)<=d)}}}(),magic.modules.GeoUtils=function(){return{ANGULAR_TOLERANCE:.001,N_INTERP:5,WGS84:new ol.Sphere(6378137),DISTANCE_UNITS:[["km","kilometres"],["m","metres"],["mi","statute miles"],["nmi","nautical miles"]],AREA_UNITS:[["km","square kilometres"],["m","square metres"],["mi","square miles"],["nmi","square nautical miles"]],ELEVATION_UNITS:[["m","metres"],["ft","feet"]],COORDINATE_FORMATS:[["dd","decimal degrees"],["dms","degrees, minutes and seconds"],["ddm","degrees, decimal minutes"]],DEFAULT_GEO_PREFS:{distance:"km",area:"km",elevation:"m",coordinates:"dd"},DEFAULT_MAP_PARAMS:{antarctic:{projection:"EPSG:3031",proj_extent:[-5e6,-5e6,5e6,5e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140,56,28,14,5.6,2.8,1.4,.56]},antarctic_laea:{projection:"EPSG:102020",proj_extent:[-55e5,-55e5,55e5,55e5],center:[0,0],zoom:0,rotation:0,resolutions:[14e3,7e3,2800,1400,560,280,140]},arctic:{projection:"EPSG:3995",proj_extent:[-4e6,-4e6,4e6,4e6],center:[0,0],zoom:0,rotation:0,resolutions:[11200,5600,2800,1400,560,280,140]},southgeorgia:{projection:"EPSG:3762",proj_extent:[-929362.849,-1243855.108,1349814.294,556833.528],center:[-1e3,61900],zoom:4,rotation:0,resolutions:[3360,1680,840,420,210,105,42,21,10.5,4.2,2.1,1.12,.56,.28,.14]},midlatitudes:{projection:"EPSG:3857",proj_extent:[-20026376.39,-20048966.1,20026376.39,20048966.1],center:[0,0],zoom:0,rotation:0,resolutions:[]}},defaultEmbeddedLayers:function(a){return this.getBaseLayers(a,!0).concat(this.getTopoLayers(a,!0))},defaultLayers:function(a){return"antarctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic",!1)}]:"antarctic_laea"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("antarctic_laea",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("antarctic_laea",!1)}]:"arctic"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("arctic",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("arctic",!1)}]:"southgeorgia"==a?[{id:null,name:"Base layers",expanded:!0,base:!0,layers:this.getBaseLayers("southgeorgia",!1)},{id:null,name:"Topo layers",expanded:!0,layers:this.getTopoLayers("southgeorgia",!1)}]:"midlatitudes"==a?[{id:null,name:"OpenStreetMap",expanded:!0,layers:this.getBaseLayers("midlatitudes",!1)}]:[]},getBaseLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_hillshade_and_bathymetry",is_base:!0},b)]:"antarctic_laea"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:hillshade_and_bathymetry",is_base:!0},b)]:"arctic"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"southgeorgia"==a?[this.layerSpecification("Hillshade and bathymetry",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_hillshade_and_bathymetry",is_base:!0,is_dem:!0},b)]:"midlatitudes"==a?[magic.modules.Endpoints.getMidLatitudeCoastSource(b)]:[]},getTopoLayers:function(a,b){return"antarctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:antarctic_coastline"},b),this.layerSpecification("Sub-Antarctic coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Antarctic Digital Database"),feature_name:"add:sub_antarctic_coastline"},b)]:"antarctic_laea"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("CCAMLR GIS"),feature_name:"gis:coastline"},b)]:"arctic"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("Arctic Open Data"),feature_name:"arctic:arctic_coastline"},b)]:"southgeorgia"==a?[this.layerSpecification("Coastline",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_coastline"},b),this.layerSpecification("Surface",{wms_source:magic.modules.Endpoints.getWmsServiceUrl("South Georgia GIS"),feature_name:"sggis:sg_surface"},b)]:[]},layerSpecification:function(a,b,c){return jQuery.extend({id:null,name:a,is_visible:!0},c?b:{source:b})},headingFromTrackGeometry:function(a){var b=0,c=a.getCoordinates();if(jQuery.isArray(c)&&c.length>=2){var d=c[c.length-2],e=c[c.length-1],f=new Vector(e[0]-d[0],e[1]-d[1]),g=new Vector(0,1);b=Math.acos(f.unit().dot(g))}return b},getGeometryType:function(a){var b="point";return a instanceof ol.geom.LineString||a instanceof ol.geom.MultiLineString?b="line":a instanceof ol.geom.Polygon||a instanceof ol.geom.MultiPolygon?b="polygon":a instanceof ol.geom.GeometryCollection&&(b="collection"),b},formatCoordinate:function(a,b,c,d){var e=null;if(d||0==d||(d=4),this.validCoordinate(a,"lat"==c,!1)){var f=this.toDecDegrees(a);if(isNaN(f))e=a;else switch(f=parseFloat(f.toFixed(d)),b){case"dms":e=this.toDMS(f,c,"dms");break;case"ddm":e=this.toDDM(f,c);break;default:e=f}}else e=a;return e},toDMS:function(a,b){var c="";if("lon"==b){var d=[a,.1],e=ol.coordinate.toStringHDMS(d),f="N";c=e.substring(e.indexOf(f)+2)}else{var d=[0,a],e=ol.coordinate.toStringHDMS(d),f=a<0?"S":"N";c=e.substring(0,e.indexOf(f)+1)}return c},toDDM:function(a,b){var c="",d=this.toDMS(a,b),e=d.split(/[^A-Za-z0-9.]+/);if(4==e.length){var f=parseFloat(e[1])+parseFloat(e[2]/60);c=e[3]+e[0]+" "+f.toFixed(3)}return c},toDecDegrees:function(a){var b=a;if(!jQuery.isNumeric(a)){b=Number.NaN,a=a.trim().toUpperCase();var c="X",d=0,e=0,f=0,g=a.charAt(0),h=a.charAt(a.length-1);if("N"==g||"S"==g||"E"==g||"W"==g?(c=g,a=a.substring(1)):"N"!=h&&"S"!=h&&"E"!=h&&"W"!=h||(c=h,a=a.substring(0,a.length-1)),"X"!=c){a=a.replace(/[^0-9.]{1,}/g," "),a=a.trim();var i=a.split(" ");d=parseFloat(i[0]),i.length>1&&(e=parseFloat(i[1])),i.length>2&&(f=parseFloat(i[2])),b=(d+e/60+f/3600)*("S"==c||"W"==c?-1:1)}}return isNaN(b)?Number.NaN:parseFloat(b)},validCoordinate:function(a,b,c){var d=!1;if(!a&&c)d=!0;else{var e=b?-90:-180,f=b?90:180,g=this.toDecDegrees(a);isNaN(g)||(d=magic.modules.Common.floatInRange(g,e,f,1e-8))}return d},validHemisphere:function(a){return 1==a.length&&a.match(/N|E|S|W|n|e|s|w/)},formatSpatial:function(a,b,c,d,e){if(!jQuery.isNumeric)return"";e||0==e||(e=1);var f=a;if(d!=c){var g={m:1,ft:3.2808399,km:.001,mi:.000621371192,nm:.000539956803};if(a=parseFloat(a),"m"!=d)for(var h=0;h<b;h++)a*=1/g[d];if("m"!=c)for(var h=0;h<b;h++)a*=g[c];f=a.toFixed(e)+c}else f+=c;return f},formatBbox:function(a,b){if(!a)return"";b||0==b||(b=1);var c=jQuery.map(a,function(a){return a}),d=["minx","miny","maxx","maxy"],e=[];return jQuery.each(c,function(a,c){e.push(d[a]+" : "+parseFloat(c).toFixed(b))}),e.join("<br>")},bufferExtent:function(a,b){var c=a.slice(0);b=b||1e4;var d=[.5*(a[2]-a[0]),.5*(a[3]-a[1])];return a[2]-a[0]<b&&(c[0]=d[0]-.5*b,c[2]=d[0]+.5*b),a[3]-a[1]<b&&(c[1]=d[1]-.5*b,c[3]=d[1]+.5*b),c},formatProjection:function(a){var b=a.split(":").pop();return!isNaN(parseInt(b))&&(b<32768||102020==b)?'<a href="https://epsg.io/?q='+b+'" target="_blank">'+a+"</a>":a},applyPref:function(a,b,c,d,e){var f=b;switch(c||"coordinates"!=a||(c="lon"),d||(d=magic.runtime.preferences[a]),e||"distance"!=a&&"area"!=a&&"elevation"!=a||(e="m"),a){case"coordinates":f=this.formatCoordinate(b,d,c);break;case"distance":f=this.formatSpatial(b,1,d,e,2);break;case"area":f=this.formatSpatial(b,2,d,e,2);break;case"elevation":f=this.formatSpatial(b,1,d,e,1)}return f},isPolarProjection:function(a){switch(a){case"EPSG:3031":case"EPSG:3995":case"EPSG:102020":return!0;default:return!1}},projectionLatLonExtent:function(a){var b=[];switch(a){case"EPSG:3031":b=[-180,-90,180,-50];break;case"EPSG:3995":b=[-180,60,180,90];break;case"EPSG:3762":b=[-50,-65,-18,-50];break;case"EPSG:102020":b=[-180,-89,180,-30];break;default:b=[-180,-85.06,180,85.06]}return b},withinExtent:function(a,b){return magic.modules.Common.floatInRange(a[0],b[0],b[2],this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatInRange(a[1],b[1],b[3],this.ANGULAR_TOLERANCE)},alongDateline:function(a,b){return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&(magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)||magic.modules.Common.floatsEqual(a,180,this.ANGULAR_TOLERANCE))},crossesDateline:function(a,b){return a>0&&b<0&&!magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)},atPole:function(a,b,c){var d=c?"S"==c?-90:90:-90;return magic.modules.Common.floatsEqual(a,b,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(a,d,this.ANGULAR_TOLERANCE)},isCircumpolar:function(a,b){return magic.modules.Common.floatsEqual(a,-180,this.ANGULAR_TOLERANCE)&&magic.modules.Common.floatsEqual(b,180,this.ANGULAR_TOLERANCE)},geodesicLength:function(a,b){b=b||magic.runtime.map;for(var c=0,d=a.getCoordinates(),e=0,f=d.length-1;e<f;++e){var g=ol.proj.transform(d[e],b.getView().getProjection().getCode(),"EPSG:4326"),h=ol.proj.transform(d[e+1],b.getView().getProjection().getCode(),"EPSG:4326");c+=this.WGS84.haversineDistance(g,h)}return c},geodesicArea:function(a,b){var c=a.clone().transform(b.getView().getProjection().getCode(),"EPSG:4326");return Math.abs(this.WGS84.geodesicArea(c.getLinearRing[0].getCoordinates()))},uniteExtents:function(a){if(!a||jQuery.isArray(a)&&0==a.length)return null;for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)b=null==b?a[f][0]:Math.min(b,a[f][0]),c=null==c?a[f][1]:Math.min(c,a[f][1]),d=null==d?a[f][2]:Math.max(d,a[f][2]),e=null==e?a[f][3]:Math.max(e,a[f][3]);return[b,c,d,e]},extentFromWgs84Extent:function(a,b){if(!b){if(!magic.runtime.map)return a;b=magic.runtime.map.getView().getProjection().getCode()}var c=[],d=null,e=a[0],f=a[1],g=a[2],h=a[3],i=ol.proj.get("EPSG:4326");if(this.isCircumpolar(e,g)){var j=new ol.geom.Point([0,h]);j.transform(i,b);var k=j.getCoordinates()[1];d=[-k,-k,k,k]}else{this.crossesDateline(e,g)?(c.push([e,f,180,h]),c.push([-180,f,g,h])):c.push([e,f,g,h]);for(var l=0;l<c.length;l++){var m=this.densify(c[l]);m.transform(i,b),null==d?d=m.getExtent():d.extend(m.getExtent())}}return d},densify:function(a){for(var b=[],c=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]],d=0;d<c.length;d++)for(var e=(d+1)%4,f=parseFloat(c[e][0]-c[d][0]),g=parseFloat(c[e][1]-c[d][1]),h=0;h<=this.N_INTERP;h++){var i=parseFloat(h)/parseFloat(this.N_INTERP+1);b.push([parseFloat(c[d][0])+i*f,parseFloat(c[d][1])+i*g])}return new ol.geom.Polygon([b],"XY")},getCurrentMapScale:function(a){a=a||magic.runtime.map;var b=a.getView().getResolution(),c=a.getView().getProjection().getUnits(),d=25.4/.28,e=ol.proj.METERS_PER_UNIT[c],f=b*e*39.37*d;return parseFloat(f)},getResolutionFromScale:function(a,b,c){if(!(b&&c||magic.runtime.map))return 0;b=b||magic.runtime.map.getView().getResolutions(),c=c||magic.runtime.map.getView().getProjection();var d=b[0];if(!isNaN(a)){var e=c.getUnits(),f=25.4/.28,g=ol.proj.METERS_PER_UNIT[e];d=parseFloat(a)/(39.37*g*f)}return d},headingWrtTrueNorth:function(a,b){var c=a.getCoordinates(),d=new Vector(c[0],c[1]),e=new ol.geom.Point([0,1]),f=new Vector(e.x,e.y),g=d.unit().dot(f);return(b-180*Math.acos(g)/Math.PI)%360}}}(),magic.classes.console.WebMapPanel=function(){var a=magic.config.paths.baseurl+"/static/images/thumbnail_cache/bas.jpg";window.ondragover=function(a){return a=a||event,a.preventDefault(),!1},window.ondrop=function(a){return a=a||event,a.preventDefault(),!1},jQuery("div[data-name]").each(jQuery.proxy(function(b,c){var d=jQuery(c).data("name"),e=jQuery("meta[name='_csrf']").attr("content");jQuery("#tn-"+d).dropzone({url:magic.config.paths.baseurl+"/thumbnail/save/"+d,method:"post",headers:{"X-CSRF-TOKEN":e},clickable:!1,maxFileSize:1,maxFiles:1,autoProcessQueue:!0,createImageThumbnails:!0,thumbnailWidth:200,thumbnailHeight:150,acceptedFiles:"image/jpg,image/jpeg,image/png,image/gif",init:function(){this.on("success",jQuery.proxy(function(){jQuery("#tn-"+this.name).attr("src",magic.config.paths.baseurl+"/thumbnail/show/"+this.name+"?buster="+(new Date).getTime())},{name:d})),this.on("complete",function(a){this.removeFile(a)}),this.on("error",jQuery.proxy(function(a,b){bootbox.alert('<div class="alert alert-warning" style="margin-bottom:0"><p>Failed to upload thumbnail for map '+this.name+" - details below:</p><p>"+b+"</p></div>")},{name:d}))}});var f=jQuery(c).find("a.map-remove-thumbnail-button");f.length>0&&f.click(d,function(b){bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Really delete thumbnail for '+b.data+"</div>",function(c){c?(jQuery.ajax({url:magic.config.paths.baseurl+"/thumbnail/delete/"+b.data,method:"DELETE",beforeSend:function(a){var b=jQuery("meta[name='_csrf']").attr("content"),c=jQuery("meta[name='_csrf_header']").attr("content");a.setRequestHeader(c,b)}}).done(function(){jQuery("#tn-"+b.data).attr("src",a)}).fail(function(a,c){var d=JSON.parse(a.responseText).detail;bootbox.alert('<div class="alert alert-warning" style="margin-bottom:0"><p>Failed to remove thumbnail for map '+b.data+" - details below:</p><p>"+d+"</p></div>")}),bootbox.hideAll()):bootbox.hideAll()})});var g=jQuery(c).find("a.map-delete-button");g.length>0&&g.click(d,function(a){bootbox.confirm('<div class="alert alert-danger" style="margin-top:10px">Are you sure you want to delete '+a.data+"</div>",function(b){b?(jQuery.ajax({url:magic.config.paths.baseurl+"/maps/deletebyname/"+a.data,method:"DELETE",beforeSend:function(a){var b=jQuery("meta[name='_csrf']").attr("content"),c=jQuery("meta[name='_csrf_header']").attr("content");a.setRequestHeader(c,b)}}).done(function(){location.reload(!0)}).fail(function(b){var c=JSON.parse(b.responseText).detail;bootbox.alert('<div class="alert alert-warning" style="margin-bottom:0"><p>Failed to delete map '+a.data+" - details below:</p><p>"+c+"</p></div>")}),bootbox.hideAll()):bootbox.hideAll()})})},this))};